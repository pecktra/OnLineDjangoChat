{% extends 'room_v3.html' %}
{% load static %}
{{ block.super }}
{% block content %}
<style>
.total-chat {
    position: relative;
}

.chat-content {
    position: relative;
}

/* 关闭按钮样式（默认隐藏，仅小屏显示） */
.chat-close-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 32px;
    height: 32px;
    border: 0;
    border-radius: 999px;
    background: rgba(0,0,0,0.6);
    color: #fff;
    display: none;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1;
}

/* 关闭按钮里的图标大小 */
.chat-close-btn svg {
    width: 16px;
    height: 16px;
}

.chat-close-btn {
    display: none;
}
/* 小屏（<768px）规则 */
@media (max-width: 768px) {
    /* 小屏显示评论按钮 */
    .comment-btn {
        display: inline-flex !important;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    /* 小屏默认隐藏聊天面板：作为底部抽屉，初始在视口外 */
    .chat-panel {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        height: 50%;
        max-height: 80vh;
        background: #fff;
        transform: translateY(100%);
        transition: transform 0.28s ease-in-out;
        z-index: 1040; /* 高于常规内容 */
        box-shadow: 0 -8px 24px rgba(0,0,0,0.15);
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        display: flex;
    }

    /* 抽屉打开状态 */
    .chat-panel.open {
        transform: translateY(0);
    }

    /* 小屏时直播容器填满可用空间（聊天面板未打开时即全宽） */
    .live-container {
        width: 100%;
    }

    .chat-close-btn {
        display: inline-flex;
    }
}

/* 大屏（≥768px）规则 */
@media (min-width: 768px) {
    /* 大屏隐藏评论按钮 */
    .comment-btn {
        display: none !important;
    }

    /* 大屏正常显示右侧面板，取消抽屉定位 */
    .chat-panel {
        position: static;
        transform: none;
        height: auto;
        max-height: none;
        box-shadow: none;
        border-radius: 0;
        display: block;
    }
}
</style>
    <!--中间live聊天-->
<div class="total-chat" >
    <div class="live-container">
    <div class="streamer-info">
        <div class="streamer-left">
            <div class="streamer-details d-flex align-items-center">
                <!-- 主播头像 -->
                <div class="position-relative me-3">
                    <img src="{% static 'svg/person-circle.svg' %}" alt="主播头像"
                        class="rounded-circle border border-3 border-primary">
                </div>

                <div>
                    <h5 class="mb-0">
                        <!-- <i class="bi bi-person-check-fill text-primary me-2"></i> -->
                        <span id="streamerName">loading...</span>
                    </h5>
                    <!-- <p class="mb-0 text-muted">
                        <i class="bi bi-people-fill me-2"></i>
                        <span id="viewerCount">0</span>人观看
                    </p> -->
                </div>
            </div>
            <!-- 房间标题 -->
            <div class="streamer-title mt-2 d-none">
                <span class="badge text-truncate d-inline-block" style="max-width: 800px;"></span>
            </div>
            <!-- 房间描述 -->
            <div class="streamer-describe mt-2 d-none">
                <span class="badge text-truncate d-inline-block" style="max-width: 800px;"></span>
            </div>
        </div>

        <div class="streamer-actions">
            <!-- <button class="btn btn-primary follow-btn follow2-btn">favourite</button>
            <button class="btn btn-primary follow-btn subscription-btn">subscription</button>
            <button class="btn btn-primary follow-btn reward-btn">tip</button> -->
            <span class="action-icon follow2-btn" data-tooltip="Favourite">
                <svg viewBox="0 0 24 24" class="star-icon">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                </svg>
            </span>
            <span class="action-icon subscription-btn" data-tooltip="Subscription">
                <svg viewBox="0 0 24 24" class="heart-icon">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                </svg>
            </span>
            <span class="action-icon reward-btn" data-tooltip="Reward">
                <svg viewBox="0 0 24 24" class="gift-icon">
                    <path d="M19 8h-2.3c.2-.6.3-1.3.3-2 0-2.8-2.2-5-5-5S7 3.2 7 6c0 .7.1 1.4.3 2H5c-1.1 0-2 .9-2 2v2h18V10c0-1.1-.9-2-2-2zm-7-5c1.7 0 3 1.3 3 3 0-1.7-1.3-3-3-3zm0 3c-1.7 0-3-1.3-3-3 0 1.7 1.3 3 3 3zm-9 6v8c0 1.1.9 2 2 2h7v-10H3zm18 10h-7v-10h7c1.1 0 2 .9 2 2v8z" />
                </svg>
            </span>
            <span class="action-icon comment-btn" style="display: none;" data-tooltip="Comment">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M416 208C416 305.2 330 384 224 384C197.3 384 171.9 379 148.8 370L67.2 413.2C57.9 418.1 46.5 416.4 39 409C31.5 401.6 29.8 390.1 34.8 380.8L70.4 313.6C46.3 284.2 32 247.6 32 208C32 110.8 118 32 224 32C330 32 416 110.8 416 208zM416 576C321.9 576 243.6 513.9 227.2 432C347.2 430.5 451.5 345.1 463 229.3C546.3 248.5 608 317.6 608 400C608 439.6 593.7 476.2 569.6 505.6L605.2 572.8C610.1 582.1 608.4 593.5 601 601C593.6 608.5 582.1 610.2 572.8 605.2L491.2 562C468.1 571 442.7 576 416 576z"></path></svg>
            </span>
        </div>
        </div>
            <!-- 动态聊天区域 -->
            <div class="chat-area" id="chatArea">
                <!-- 这里会被JavaScript动态填充 -->
                <div class="text-center py-4 text-muted">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <span>loading...</span>
                </div>
            </div>
        </div>

    <!--右侧聊天-->
    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <div class="live-user-header">
                <img src="{% static 'svg/person-circle.svg' %}" alt="">
                <span id="streamerName1">黑猫警长</span>
            </div>
            <!-- 钻石收益区域 -->
            <div class="diamond-display" style="display: flex; align-items: center; background: rgba(255,215,0,0.1); padding: 5px 10px; border-radius: 16px; margin-left: 15px;">
                <!-- 钻石图标 -->
                <svg width="16" height="16" viewBox="0 0 24 24" fill="#FFD700" style="margin-right: 6px;">
                    <path d="M12 1.5L6 9H18L12 1.5ZM6 9L1 15H23L18 9H6ZM1 15L6 21H18L23 15H1ZM12 15L9 9H15L12 15Z"/>
                </svg>
                <!-- 钻石数量 -->
                <span id="diamond" class="diamond-count" style="font-weight: bold; color: #FFD700;">0</span>
                <!-- “+”按钮 -->
                <button id="open-pay-modal" style="margin-left: 8px; background: none; border: none; color: #FFD700; font-size: 16px; cursor: pointer;">+</button>
            </div>
        {% include 'pay.html' %}

        </div>
        <button type="button" class="chat-close-btn" aria-label="关闭">
            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.9a1 1 0 0 0 1.41-1.41L13.41 12l4.9-4.89a1 1 0 0 0-.01-1.4z"/>
            </svg>
        </button>
        <div class="chat-content">
            <!-- <button class="chat-close-btn" title="关闭聊天">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button> -->
            <div class="text-center py-4 loading-container">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">loading...</span>
                </div>
                <div class="mt-2 text-muted">loading...</div>
            </div>
        </div>
        <div class="input-group">
            <label for="chatMessageInput"></label><input type="text" class="form-control" id="chatMessageInput" placeholder="输入消息" />
            <div class="input-group-append">
                <button class="btn btn-success" id="chatMessageSend" type="button">send</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        const commentBtn = document.querySelector('.comment-btn');
        const chatPanel = document.getElementById('chatPanel');
        const chatCloseBtn = document.querySelector('.chat-close-btn');
        if (commentBtn && chatPanel) {
            commentBtn.addEventListener('click', function () {
                // 小屏下切换抽屉
                if (window.matchMedia('(max-width: 768px)').matches) {
                    chatPanel.classList.toggle('open');
                }
            });

            // 视口变化时，确保状态一致
            const mq = window.matchMedia('(min-width: 768px)');
            const syncState = () => {
                if (mq.matches) {
                    chatPanel.classList.remove('open'); // 大屏使用常规右侧面板
                }
            };
            mq.addEventListener ? mq.addEventListener('change', syncState) : mq.addListener(syncState);
        }

        if (chatCloseBtn && chatPanel) {
            chatCloseBtn.addEventListener('click', function () {
                chatPanel.classList.remove('open');
            });
        }
    })();
    </script>
{% endblock %}
