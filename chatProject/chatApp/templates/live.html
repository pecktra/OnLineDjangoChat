{% extends 'room_v3.html' %}
{% load static %}
{{ block.super }}
{% block content %}
<style>
.total-chat {
    position: relative;
}

.chat-content {
    position: relative;
}

/* 关闭按钮样式（默认隐藏，仅小屏显示） */
.chat-close-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 32px;
    height: 32px;
    border: 0;
    border-radius: 999px;
    background: rgba(0,0,0,0.6);
    color: #fff;
    display: none;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 1;
}

/* 关闭按钮里的图标大小 */
.chat-close-btn svg {
    width: 16px;
    height: 16px;
}

.chat-close-btn {
    display: none;
}
/* 小屏（<768px）规则 */
@media (max-width: 768px) {
    /* 小屏显示评论按钮 */
    .comment-btn {
        display: inline-flex !important;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    /* 小屏默认隐藏聊天面板：作为底部抽屉，初始在视口外 */
    .chat-panel {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        height: 50%;
        max-height: 80vh;
        background: #fff;
        transform: translateY(100%);
        transition: transform 0.28s ease-in-out;
        z-index: 1040; /* 高于常规内容 */
        box-shadow: 0 -8px 24px rgba(0,0,0,0.15);
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        display: flex;
    }

    /* 抽屉打开状态 */
    .chat-panel.open {
        transform: translateY(0);
    }

    /* 小屏时直播容器填满可用空间（聊天面板未打开时即全宽） */
    .live-container {
        width: 100%;
    }

    .chat-close-btn {
        display: inline-flex;
    }
}

/* 大屏（≥768px）规则 */
@media (min-width: 768px) {
    /* 大屏隐藏评论按钮 */
    .comment-btn {
        display: none !important;
    }

    /* 大屏正常显示右侧面板，取消抽屉定位 */
    .chat-panel {
        position: static;
        transform: none;
        height: auto;
        max-height: none;
        box-shadow: none;
        border-radius: 0;
        display: block;
    }
}

/* 等待中的跳动省略号动画 */
.typing-dots {
    display: inline-flex;
    align-items: center;
    gap: 2px;
}

.typing-dots span {
    font-size: 24px;
    line-height: 1;
    animation: typingDot 1.4s infinite;
}

.typing-dots span:nth-child(1) {
    animation-delay: 0s;
}

.typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typingDot {
    0%, 60%, 100% {
        opacity: 0.3;
        transform: translateY(0);
    }
    30% {
        opacity: 1;
        transform: translateY(-8px);
    }
}
</style>
    <!--中间live聊天-->
<div class="total-chat" >
    <div class="live-container">
    <div class="streamer-info">
        <div class="streamer-left">
            <div class="streamer-details d-flex align-items-center">
                <!-- 主播头像 -->
                <div class="position-relative me-3">
                    <img src="{% static 'svg/person-circle.svg' %}" alt="主播头像"
                        class="rounded-circle border border-3 border-primary">
                </div>

                <div style='overflow: hidden;max-width: 800px;'>
                    <span id="streamerName">loading...</span>
                    <!-- 房间标题 -->
                    <div class="streamer-title mt-2 d-none">
                        <span class="badge text-truncate d-inline-block" style="max-width: 100%"></span>
                    </div>
                    <!-- 房间描述 -->
                    <div class="streamer-describe mt-2 d-none">
                        <span class="badge text-truncate desc" style="max-width: 100%"></span>
                    </div>
                    <!-- <p class="mb-0 text-muted">
                        <i class="bi bi-people-fill me-2"></i>
                        <span id="viewerCount">0</span>人观看
                    </p> -->
                </div>
            </div>

        </div>

        <div class="streamer-actions">
            <div style="position:absolute;top:0;left:0;">
            <!-- <button class="btn btn-primary follow-btn follow2-btn">favourite</button>
            <button class="btn btn-primary follow-btn subscription-btn">subscription</button>
            <button class="btn btn-primary follow-btn reward-btn">tip</button> -->
            <span class="action-icon branch-btn" data-tooltip="Branch">
                <svg viewBox="0 0 384 512" class="branch-icon">
                    <path fill="#ffffff" d="M384 144c0-44.2-35.8-80-80-80s-80 35.8-80 80c0 36.4 24.3 67.1 57.5 76.8-.6 16.1-4.2 28.5-11 36.9-15.4 19.2-49.3 22.4-85.2 25.7-28.2 2.6-57.4 5.4-81.3 16.9v-144c32.5-10.2 56-40.5 56-76.3 0-44.2-35.8-80-80-80S0 35.8 0 80c0 35.8 23.5 66.1 56 76.3v199.3C23.5 365.9 0 396.2 0 432c0 44.2 35.8 80 80 80s80-35.8 80-80c0-34-21.2-63.1-51.2-74.6 3.1-5.2 7.8-9.8 14.9-13.4 16.2-8.2 40.4-10.4 66.1-12.8 42.2-3.9 90-8.4 118.2-43.4 14-17.4 21.1-39.8 21.6-67.9 31.6-10.8 54.4-40.7 54.4-75.9zM80 64c8.8 0 16 7.2 16 16s-7.2 16-16 16-16-7.2-16-16 7.2-16 16-16zm0 384c-8.8 0-16-7.2-16-16s7.2-16 16-16 16 7.2 16 16-7.2 16-16 16zm224-320c8.8 0 16 7.2 16 16s-7.2 16-16 16-16-7.2-16-16 7.2-16 16-16z"/>
                </svg>
            </span>
            <span class="action-icon follow2-btn" data-tooltip="Favourite">
                <svg viewBox="0 0 24 24" class="star-icon">
                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
                </svg>
            </span>
            <span class="action-icon subscription-btn" data-tooltip="Subscription">
                <svg viewBox="0 0 24 24" class="heart-icon">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                </svg>
            </span>
            <span class="action-icon reward-btn" data-tooltip="Reward">
                <svg viewBox="0 0 24 24" class="gift-icon">
                    <path d="M19 8h-2.3c.2-.6.3-1.3.3-2 0-2.8-2.2-5-5-5S7 3.2 7 6c0 .7.1 1.4.3 2H5c-1.1 0-2 .9-2 2v2h18V10c0-1.1-.9-2-2-2zm-7-5c1.7 0 3 1.3 3 3 0-1.7-1.3-3-3-3zm0 3c-1.7 0-3-1.3-3-3 0 1.7 1.3 3 3 3zm-9 6v8c0 1.1.9 2 2 2h7v-10H3zm18 10h-7v-10h7c1.1 0 2 .9 2 2v8z" />
                </svg>
            </span>
            <span class="action-icon comment-btn" style="display: none;" data-tooltip="Comment">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M416 208C416 305.2 330 384 224 384C197.3 384 171.9 379 148.8 370L67.2 413.2C57.9 418.1 46.5 416.4 39 409C31.5 401.6 29.8 390.1 34.8 380.8L70.4 313.6C46.3 284.2 32 247.6 32 208C32 110.8 118 32 224 32C330 32 416 110.8 416 208zM416 576C321.9 576 243.6 513.9 227.2 432C347.2 430.5 451.5 345.1 463 229.3C546.3 248.5 608 317.6 608 400C608 439.6 593.7 476.2 569.6 505.6L605.2 572.8C610.1 582.1 608.4 593.5 601 601C593.6 608.5 582.1 610.2 572.8 605.2L491.2 562C468.1 571 442.7 576 416 576z"></path></svg>
            </span>
            <span class="action-icon share-btn" data-tooltip="Share">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M371.8 82.4C359.8 87.4 352 99 352 112L352 192L240 192C142.8 192 64 270.8 64 368C64 481.3 145.5 531.9 164.2 542.1C166.7 543.5 169.5 544 172.3 544C183.2 544 192 535.1 192 524.3C192 516.8 187.7 509.9 182.2 504.8C172.8 496 160 478.4 160 448.1C160 395.1 203 352.1 256 352.1L352 352.1L352 432.1C352 445 359.8 456.7 371.8 461.7C383.8 466.7 397.5 463.9 406.7 454.8L566.7 294.8C579.2 282.3 579.2 262 566.7 249.5L406.7 89.5C397.5 80.3 383.8 77.6 371.8 82.6z"/></svg>
            </span>
        </div>
        </div>
        </div>
            <!-- 动态聊天区域 -->
            <div class="chat-area" id="chatArea">
                <!-- 这里会被JavaScript动态填充 -->
                <div class="text-center py-4 text-muted loading">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    <span>loading...</span>
                </div>
            </div>
            <div id="anchorForkBox" style="display:none; margin-top:8px;">
                <div class="input-group">
                    <input type="text" class="form-control" id="forkChatInput" placeholder="Type something..." />
                    <button class="btn btn-success" id="forkChatSend" type="button">send</button>
                </div>
            </div>
        </div>

    <!--右侧聊天-->
    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <div class="live-user-header">
                <img src="{% static 'svg/person-circle.svg' %}" alt="">
                <span id="streamerName1">黑猫警长</span>
            </div>
            <!-- 钻石收益区域 -->
            <div class="diamond-display" style="display: flex; align-items: center; background: rgba(255,215,0,0.1); padding: 5px 10px; border-radius: 16px; margin-left: 15px;">
                <!-- 钻石图标 -->
                <svg width="16" height="16" viewBox="0 0 24 24" fill="#FFD700" style="margin-right: 6px;">
                    <path d="M12 1.5L6 9H18L12 1.5ZM6 9L1 15H23L18 9H6ZM1 15L6 21H18L23 15H1ZM12 15L9 9H15L12 15Z"/>
                </svg>
                <!-- 钻石数量 -->
                <span id="diamond" class="diamond-count" style="font-weight: bold; color: #FFD700;">0</span>
                <!-- “+”按钮 -->
                <button id="open-pay-modal" style="margin-left: 8px; background: none; border: none; color: #FFD700; font-size: 16px; cursor: pointer;">+</button>
            </div>
        {% include 'pay.html' %}

        </div>
        <button type="button" class="chat-close-btn" aria-label="关闭">
            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                <path d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.9a1 1 0 0 0 1.41-1.41L13.41 12l4.9-4.89a1 1 0 0 0-.01-1.4z"/>
            </svg>
        </button>
        <div class="chat-content">
            <!-- <button class="chat-close-btn" title="关闭聊天">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button> -->
            <div class="text-center py-4 loading-container">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">loading...</span>
                </div>
                <div class="mt-2 text-muted">loading...</div>
            </div>
        </div>
        <div class="input-group">
            <label for="chatMessageInput"></label><input type="text" class="form-control" id="chatMessageInput" placeholder="Type something..." />
            <div class="input-group-append">
                <button class="btn btn-success" id="chatMessageSend" type="button">send</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        const commentBtn = document.querySelector('.comment-btn');
        const chatPanel = document.getElementById('chatPanel');
        const chatCloseBtn = document.querySelector('.chat-close-btn');
        if (commentBtn && chatPanel) {
            commentBtn.addEventListener('click', function () {
                // 小屏下切换抽屉
                if (window.matchMedia('(max-width: 768px)').matches) {
                    chatPanel.classList.toggle('open');
                }
            });

            // 视口变化时，确保状态一致
            const mq = window.matchMedia('(min-width: 768px)');
            const syncState = () => {
                if (mq.matches) {
                    chatPanel.classList.remove('open'); // 大屏使用常规右侧面板
                }
            };
            mq.addEventListener ? mq.addEventListener('change', syncState) : mq.addListener(syncState);
        }

        if (chatCloseBtn && chatPanel) {
            chatCloseBtn.addEventListener('click', function () {
                chatPanel.classList.remove('open');
            });
        }
    })();
    </script>

<script>
    (function () {
        const shareBtn = document.querySelector('.share-btn');
        if (shareBtn) {
            shareBtn.addEventListener('click', async function () {
                try {
                    // 获取当前URL
                    const currentUrl = new URL(window.location.href);

                    // 添加或更新ref参数
                    const userId = window.GLOBAL_USER_ID;
                    if (userId) {
                        currentUrl.searchParams.set('ref', userId);
                    }

                    // 构建分享链接
                    const shareUrl = currentUrl.toString();

                    // 复制到剪贴板
                    if (navigator.clipboard && navigator.clipboard.writeText) {
                        await navigator.clipboard.writeText(shareUrl);
                    } else {
                        // 降级方案：使用传统的复制方法
                        const textArea = document.createElement('textarea');
                        textArea.value = shareUrl;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                    }

                    // 显示提示信息
                    alert('Share link copied to clipboard!');
                } catch (error) {
                    console.error('Failed to copy link:', error);
                    alert('Failed to copy share link. Please copy it manually.');
                }
            });
        }
    })();
</script>

<script>
    (function () {
        const branchBtn = document.querySelector('.branch-btn');
        if (branchBtn) {
            branchBtn.addEventListener('click', function (e) {
                e.preventDefault();
                // 调用 StreamerInfoManager 的方法，直接创建分支而不显示模态框
                if (window.StreamerInfoManager) {
                    window.StreamerInfoManager.createBranchDirect(1);
                } else {
                    console.error('StreamerInfoManager not available');
                }
            });
        }
    })();
</script>

<!-- Fork Dialog Modal -->
<!-- <div class="modal fade" id="forkModal" tabindex="-1" aria-labelledby="forkModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="color:#333">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="forkModalLabel">New Branch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="forkForm">
                    <div class="mb-3">
                        <label for="forkTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="forkTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="forkDescribe" class="form-label">Description</label>
                        <textarea class="form-control" id="forkDescribe" name="describe" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="submitFork">Submit</button>
            </div>
        </div>
    </div>
</div> -->

<script>
(function(){
    function initForkChatInline(){
        try{
            const box = document.getElementById('anchorForkBox');
            if(!box) return;
            // 仅当当前用户为主播本人时显示
            if(String(window.GLOBAL_USER_ID) === String(window.GLOBAL_ANCHOR_ID)){
                box.style.display = 'block';
            } else {
                box.style.display = 'none';
                return;
            }

            const input = document.getElementById('forkChatInput');
            const sendBtn = document.getElementById('forkChatSend');
            const chatArea = document.querySelector('.chat-area');
            let isSending = false; // 防重复发送标志

            // HTML 转义函数，防止 XSS
            const escapeHtml = (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };

            const send = async () => {
                // 防止重复发送
                if (isSending) {
                    return;
                }

                const message = (input.value || '').trim();
                if(!message) return;

                // 立即标记正在发送
                isSending = true;

                // 立即清空输入框
                input.value = '';

                // 保存按钮原始文本
                const originalButtonText = sendBtn.textContent;

                // 禁用输入框和按钮
                if (input) {
                    input.disabled = true;
                    input.style.opacity = '0.6';
                }
                if (sendBtn) {
                    sendBtn.disabled = true;
                    sendBtn.textContent = 'Sending...';
                    sendBtn.style.opacity = '0.6';
                    sendBtn.style.cursor = 'not-allowed';
                }

                // 1. 立即显示用户发送的消息（成功时保留，失败时删除）
                const userMsgId = 'user-msg-' + Date.now();

                // 获取当前 lastFloor 并计算新楼层号
                const currentLastFloor = window.wsManager ? window.wsManager.lastFloor : 0;
                const newFloor = currentLastFloor + 1;

                if (chatArea) {
                    const currentTime = new Date().toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    }).replace(',', '');

                    const userMessageHTML = `
                        <div id="${userMsgId}" class="chat-message user-message">
                            <div class="message-content">
                                <div class="message-header">
                                    <div><span class="sender-name">${escapeHtml(window.GLOBAL_USER_NAME || 'You')}</span><span>#${newFloor}</span>
                                        <span class="message-branch-btn" data-floor="${newFloor}" data-tooltip="Branch" style="margin-left: 8px; cursor: pointer; display: inline-flex; align-items: center;">
                                            <svg viewBox="0 0 384 512" style="width: 14px; height: 14px; fill: currentColor;">
                                                <path d="M384 144c0-44.2-35.8-80-80-80s-80 35.8-80 80c0 36.4 24.3 67.1 57.5 76.8-.6 16.1-4.2 28.5-11 36.9-15.4 19.2-49.3 22.4-85.2 25.7-28.2 2.6-57.4 5.4-81.3 16.9v-144c32.5-10.2 56-40.5 56-76.3 0-44.2-35.8-80-80-80S0 35.8 0 80c0 35.8 23.5 66.1 56 76.3v199.3C23.5 365.9 0 396.2 0 432c0 44.2 35.8 80 80 80s80-35.8 80-80c0-34-21.2-63.1-51.2-74.6 3.1-5.2 7.8-9.8 14.9-13.4 16.2-8.2 40.4-10.4 66.1-12.8 42.2-3.9 90-8.4 118.2-43.4 14-17.4 21.1-39.8 21.6-67.9 31.6-10.8 54.4-40.7 54.4-75.9zM80 64c8.8 0 16 7.2 16 16s-7.2 16-16 16-16-7.2-16-16 7.2-16 16-16zm0 384c-8.8 0-16-7.2-16-16s7.2-16 16-16 16 7.2 16 16-7.2 16-16 16zm224-320c8.8 0 16 7.2 16 16s-7.2 16-16 16-16-7.2-16-16 7.2-16 16-16z"/>
                                            </svg>
                                        </span>
                                        <span class="message-copy-btn" data-tooltip="Copy" title="Copy" style="margin-left: 8px; cursor: pointer; display: inline-flex; align-items: center;">
                                            <svg viewBox="0 0 640 640" style="width: 14px; height: 14px; fill: currentColor;">
                                                <path d="M288 64C252.7 64 224 92.7 224 128L224 384C224 419.3 252.7 448 288 448L480 448C515.3 448 544 419.3 544 384L544 183.4C544 166 536.9 149.3 524.3 137.2L466.6 81.8C454.7 70.4 438.8 64 422.3 64L288 64zM160 192C124.7 192 96 220.7 96 256L96 512C96 547.3 124.7 576 160 576L352 576C387.3 576 416 547.3 416 512L416 496L352 496L352 512L160 512L160 256L176 256L176 192L160 192z"/>
                                            </svg>
                                        </span>
                                    </div>
                                    <span class="message-time">${currentTime}</span>
                                </div>
                                <div class="mes_text">${escapeHtml(message)}</div>
                            </div>
                        </div>
                    `;
                    chatArea.insertAdjacentHTML('beforeend', userMessageHTML);
                    chatArea.scrollTop = chatArea.scrollHeight;

                    // 绑定消息的 branch 和 copy 事件
                    if (window.wsManager && window.wsManager.attachMessageBranchEvents) {
                        window.wsManager.attachMessageBranchEvents();
                    }
                }

                // 2. 然后显示等待中的 AI 回复占位符
                const loadingId = 'ai-loading-' + Date.now();
                if (chatArea) {
                    const loadingHTML = `
                        <div id="${loadingId}" class="chat-message ai-message">
                            <div class="message-content">
                                <div class="message-header">
                                    <div><span class="sender-name"></span><span></span></div>
                                    <span class="message-time"></span>
                                </div>
                                <div class="mes_text">
                                    <span class="typing-dots">
                                        <span>.</span><span>.</span><span>.</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                    chatArea.insertAdjacentHTML('beforeend', loadingHTML);
                    chatArea.scrollTop = chatArea.scrollHeight;
                }

                // 发送消息到服务器
                try{
                    await fetch('/api/fork/fork_chat/',{
                        method:'POST',
                        headers:{'Content-Type':'application/json','X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]')?.value || '')},
                        body: JSON.stringify({ room_id: window.GLOBAL_ROOM_ID, message })
                    });

                    // 成功后只移除AI等待动画
                    // 用户消息保留不删除（已直接显示在界面上）
                    const loadingElement = document.getElementById(loadingId);
                    if (loadingElement) {
                        loadingElement.remove();
                    }

                    // 更新 WebSocketManager 的 lastFloor
                    if (window.wsManager) {
                        window.wsManager.lastFloor = newFloor;
                        window.wsManager.shouldForceScroll = true;
                    }

                    // 多次尝试滚动，确保能看到新消息和AI回复
                    const scrollAttempts = [300, 800, 1500, 3000];
                    scrollAttempts.forEach(delay => {
                        setTimeout(() => {
                            if (chatArea) {
                                chatArea.scrollTop = chatArea.scrollHeight;
                            }
                        }, delay);
                    });

                } catch(e) {
                    console.error('fork_chat 发送失败', e);

                    // 移除等待动画
                    const loadingElement = document.getElementById(loadingId);
                    if (loadingElement) {
                        loadingElement.remove();
                    }

                    // 移除已显示的用户消息（因为发送失败）
                    const userMsgElement = document.getElementById(userMsgId);
                    if (userMsgElement) {
                        userMsgElement.remove();
                    }

                    // 发送失败时恢复消息到输入框
                    if (input) {
                        input.value = message;
                    }
                    alert('发送消息失败，请重试');
                } finally {
                    // 重新启用输入框和按钮
                    isSending = false;

                    if (input) {
                        input.disabled = false;
                        input.style.opacity = '1';
                        input.focus();
                    }
                    if (sendBtn) {
                        sendBtn.disabled = false;
                        sendBtn.textContent = originalButtonText;
                        sendBtn.style.opacity = '1';
                        sendBtn.style.cursor = 'pointer';
                    }
                }
            };

            sendBtn?.addEventListener('click', send);
            input?.addEventListener('keypress', (e)=>{
                if(e.key==='Enter') {
                    e.preventDefault();
                    send();
                }
            });
        }catch(err){ console.error(err); }
    }

    // 将 initForkChatInline 函数暴露到全局作用域，以便在 StreamerInfoManager.init 完成后调用
    window.initForkChatInline = initForkChatInline;
})();
</script>

{% endblock %}
