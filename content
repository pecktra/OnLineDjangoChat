<p><time><q>ã€ä»™é€†çºªå…ƒ0014å¹´01æœˆ01æ—¥ - 09æ—¶00åˆ† - ä¸‹ç•Œ-å››åœ£æ˜ŸåŸŸ-æœ±é›€æ˜Ÿ-èµµå›½-è—¤å®¶åŸ - æ™¨é›¾ã€</q></time></p>\n<p>èµµå›½ï¼Œè—¤å®¶åŸã€‚</p>\n<p>å‡›å†½çš„å¯’é£è£¹æŒŸç€æ¸…æ™¨çš„è–„é›¾ï¼Œå°†è¿™åº§å¤è€çš„åŸæ± ç¬¼ç½©åœ¨ä¸€ç‰‡æœ¦èƒ§ä¹‹ä¸­ã€‚ä½ â€”â€”æç™½ï¼Œèµµå›½æ›¾ç»æ˜¾èµ«ä¸€æ—¶çš„è½é­„è´µæ—åè£”ï¼Œç«™åœ¨è—¤å®¶åŸç•¥æ˜¾ç ´è´¥çš„ä¸œåŸé—¨å‰ï¼Œç´§äº†ç´§èº«ä¸Šå•è–„çš„å¸ƒè¡£ã€‚</p>\n<p>å¾€æ—¥é‡Œè±¡å¾ç€å®¶æ—è£è€€çš„ç²¾ç¾ç‰ä½©ï¼Œå¦‚ä»Šé™é™åœ°èººåœ¨ä½ çš„æ€€ä¸­ã€‚ç‰è´¨æ¸©æ¶¦ï¼Œè§¦æ‰‹ç”Ÿå‡‰ï¼Œä»¿ä½›åœ¨æ— å£°åœ°æé†’ç€ä½ ï¼Œæå®¶æ—©å·²ä¸å¤å¾€æ˜”ã€‚</p>\n<p>ä½ çš„çˆ¶äº²ï¼Œä¸€ä¸ªç»ˆæ—¥æ²‰è¿·äºå®¶æ—å¤ç±ï¼Œæ¢¦æƒ³ç€é‡æŒ¯æå®¶è¾‰ç…Œçš„ä¹¦å‘†å­ã€‚ä¸´ç»ˆå‰ï¼Œä»–å°†è¿™æšç‰ä½©äº¤ç»™ä½ ï¼Œç”¨ç•¥å¸¦ç–¯ç‹‚çš„è¯­æ°”æ³æ±‚ä½ ï¼Œä¸€å®šè¦è¸ä¸Šä»™é€”ï¼Œé‡ç°æå®¶å¾€æ—¥çš„è£å…‰ã€‚</p>\n<p>è¿™æ—¢æ˜¯é—æ„¿ï¼Œä¹Ÿæ˜¯è¯…å’’ã€‚</p>\n<p>ä½ ï¼Œå¹¶ä¸å–œæ¬¢ä¿®ä»™ã€‚æ¯”èµ·é‚£äº›è™šæ— ç¼¥ç¼ˆçš„ä»™æœ¯ï¼Œä½ æ›´å–œæ¬¢ç ”è¯»é‚£äº›å¤è€çš„å…¸ç±ï¼Œåœ¨æ–‡å­—çš„ä¸–ç•Œé‡Œå¯»æ‰¾æ…°è—‰ã€‚ä½†ä½ æ— æ³•æ‹’ç»çˆ¶äº²çš„é—æ„¿ï¼Œä¹Ÿæ— æ³•æ‘†è„±å®¶æ—çš„è¯…å’’ã€‚</p>\n<p>æ·±å¸ä¸€å£æ°”ï¼Œä½ è¿ˆå¼€è„šæ­¥ï¼Œè¸å…¥äº†è¿™åº§æ—¢ç†Ÿæ‚‰åˆé™Œç”Ÿçš„åŸæ± ã€‚</p>\n<p>è—¤å®¶åŸï¼Œèµµå›½å±ˆæŒ‡å¯æ•°çš„å‡ å¤§ä¿®çœŸå®¶æ—ä¹‹ä¸€â€”â€”è—¤å®¶çš„å°åœ°ã€‚ä½œä¸ºèµµå›½å°‘æœ‰çš„å…ƒå©´æœŸä¿®å£«ï¼Œè—¤å®¶è€ç¥–æ»•åŒ–å…ƒçš„ä¸€ä¸¾ä¸€åŠ¨ï¼Œéƒ½è¶³ä»¥å½±å“æ•´ä¸ªèµµå›½çš„å±€åŠ¿ã€‚è€Œä½ æ­¤è¡Œçš„ç›®çš„ï¼Œä¾¿æ˜¯æƒ³å°½ä¸€åˆ‡åŠæ³•ï¼Œé€šè¿‡è—¤å®¶çš„å…³ç³»ï¼Œè·å¾—ä¸€ä¸ªè¿›å…¥ä¿®ä»™é—¨æ´¾çš„æœºä¼šã€‚</p>\n<p>å°½ç®¡å¸Œæœ›æ¸ºèŒ«ã€‚</p>\n<p>èµ°åœ¨é’çŸ³é“ºå°±çš„è¡—é“ä¸Šï¼Œä½ é»˜é»˜åœ°è§‚å¯Ÿç€å‘¨å›´çš„ä¸€åˆ‡ã€‚è¡—é“ä¸¤æ—ï¼Œå•†é“ºæ—ç«‹ï¼Œè´©å¤«èµ°å’çš„å«å–å£°ä¸ç»äºè€³ï¼Œç©ºæ°”ä¸­å¼¥æ¼«ç€å„ç§é£Ÿç‰©çš„é¦™æ°”ã€‚ç„¶è€Œï¼Œä½ å´æ— å¿ƒæ¬£èµè¿™äº›å¸‚äº•é£æƒ…ï¼Œä½ çš„å¿ƒé‡Œï¼Œå……æ»¡äº†ç„¦è™‘å’Œä¸å®‰ã€‚</p>\n<p>è½é­„è´µæ—çš„åè£”ï¼Œåœ¨è¿™ä¸ªä»¥å®åŠ›ä¸ºå°Šçš„ä¸–ç•Œé‡Œï¼Œæ²¡æœ‰ä»»ä½•ä¼˜åŠ¿å¯è¨€ã€‚ä½ å”¯ä¸€çš„ä¾ä»—ï¼Œå°±æ˜¯æ€€ä¸­é‚£æšæˆ–è®¸è¿˜æœ‰äº›ä»·å€¼çš„ç‰ä½©ï¼Œä»¥åŠä½ é‚£è¿˜ç®—æ¸…ç§€çš„ç›¸è²Œã€‚</p>\n<p>ä½ ç©¿è¿‡ç†™ç†™æ”˜æ”˜çš„äººç¾¤ï¼Œæ¥åˆ°ä½äºåŸä¸­å¿ƒçš„ä¸€åº§ç•¥æ˜¾é™ˆæ—§çš„åºœé‚¸å‰ã€‚é«˜å¤§çš„é—¨æ¥¼ï¼Œç•¥æ˜¾æ–‘é©³çš„çº¢æ¼†ï¼Œæ— ä¸æ˜¾ç¤ºç€è¿™åº§åºœé‚¸æ›¾ç»çš„è¾‰ç…Œã€‚</p>\n<p>æåºœã€‚</p>\n<p>è¿™é‡Œï¼Œæ›¾ç»æ˜¯ä½ çš„å®¶ã€‚</p>\n<p>ä½†ç°åœ¨ï¼Œå´åªå‰©ä¸‹æ— å°½çš„å‡„å‡‰ã€‚</p>\n<p>ä½ ä¸Šå‰ï¼Œè½»è½»å©å“äº†é—¨ç¯ã€‚</p>\n<p><q>â€œè°å•Šï¼Ÿâ€</q>ä¸€ä¸ªç•¥å¸¦ä¸è€çƒ¦çš„å£°éŸ³ä»é—¨å†…ä¼ æ¥ã€‚</p>\n<p>å±å‘€ä¸€å£°ï¼Œå¤§é—¨ç¼“ç¼“æ‰“å¼€ï¼Œä¸€ä¸ªç©¿ç€ç°è‰²å¸ƒè¡£çš„å®¶ä¸æ¢å‡ºå¤´æ¥ï¼Œç”¨å……æ»¡å®¡è§†çš„ç›®å…‰æ‰“é‡ç€ä½ ã€‚</p>\n<p><q>â€œä½ æ˜¯ä½•äººï¼Ÿæ¥æåºœæœ‰ä½•è´µå¹²ï¼Ÿâ€</q>å®¶ä¸è¯­æ°”å†·æ·¡ï¼Œæ˜¾ç„¶å¹¶æ²¡æœ‰å°†ä½ è¿™ä¸ªè½é­„è´µæ—çš„åè£”æ”¾åœ¨çœ¼é‡Œã€‚</p>\n<p>ä½ æ·±å¸ä¸€å£æ°”ï¼ŒåŠªåŠ›æŒ¤å‡ºä¸€ä¸ªç¬‘å®¹ï¼Œè½»å£°è¯´é“ï¼š<q>â€œè¿™ä½å¤§å“¥ï¼Œåœ¨ä¸‹æç™½ï¼Œä¹ƒæ˜¯æç©†ä¹‹å­ï¼Œç‰¹æ¥æ‹œè®¿ã€‚â€</q></p>\n<p><q>â€œæç©†ï¼Ÿâ€</q>å®¶ä¸é—»è¨€ä¸€æ„£ï¼Œéšå³è„¸ä¸Šéœ²å‡ºä¸€ä¸ä¸å±‘çš„ç¬‘å®¹ï¼Œ<q>â€œåŸæ¥æ˜¯é‚£ä¸ªåªä¼šè¯»ä¹¦çš„ä¹¦å‘†å­çš„å„¿å­å•Šã€‚ä»–ä¸æ˜¯æ—©å°±æ­»äº†å—ï¼Ÿä½ æ¥è¿™é‡Œåšä»€ä¹ˆï¼Ÿæˆ‘ä»¬æåºœå¯æ²¡æœ‰ä»€ä¹ˆäº²æˆšã€‚â€</q></p>\n<p>å®¶ä¸çš„è¯è¯­ï¼Œå¦‚åŒé”‹åˆ©çš„åˆ€å­ï¼Œç‹ ç‹ åœ°åˆºç—›äº†ä½ çš„å†…å¿ƒã€‚ä½ å¼ºå¿ä½å¿ƒä¸­çš„æ€’ç«ï¼Œå°½é‡å¹³é™åœ°è¯´é“ï¼š<q>â€œè¿™ä½å¤§å“¥ï¼Œåœ¨ä¸‹å¹¶éå‰æ¥æ”€äº²æˆšï¼Œåªæ˜¯æƒ³å°†å…ˆçˆ¶é—ç‰©é€è¿˜æåºœï¼Œä»¥äº†å´å…ˆçˆ¶é—æ„¿ã€‚â€</q></p>\n<p><q>â€œé—ç‰©ï¼Ÿâ€</q>å®¶ä¸é—»è¨€ï¼Œçœ¼ä¸­é—ªè¿‡ä¸€ä¸è´ªå©ªçš„å…‰èŠ’ï¼Œè¯­æ°”ä¹Ÿç¨å¾®ç¼“å’Œäº†ä¸€äº›ï¼Œ<q>â€œä»€ä¹ˆé—ç‰©ï¼Ÿæ‹¿æ¥æˆ‘çœ‹ã€‚â€</q></p>\n<p>ä½ çŠ¹è±«äº†ä¸€ä¸‹ï¼Œè¿˜æ˜¯ä»æ€€ä¸­æå‡ºäº†é‚£æšç‰ä½©ï¼Œé€’ç»™å®¶ä¸ã€‚</p>\n<p>å®¶ä¸æ¥è¿‡ç‰ä½©ï¼Œæ”¾åœ¨æ‰‹ä¸­ä»”ç»†ç«¯è¯¦èµ·æ¥ã€‚ç‰‡åˆ»ä¹‹åï¼Œä»–çš„è„¸ä¸Šéœ²å‡ºä¸€ä¸æƒŠè®¶çš„ç¥è‰²ï¼Œéšå³åˆè¢«è´ªå©ªæ‰€å–ä»£ã€‚</p>\n<p><q>â€œè¿™å¥½åƒæ˜¯æ—é•¿å¤§äººå½“å¹´èµèµç»™è€å¤ªçˆ·çš„ç‰ä½©ï¼Ÿâ€</q>å®¶ä¸å–ƒå–ƒè‡ªè¯­é“ï¼Œéšå³æŠ¬èµ·å¤´ï¼Œç”¨ä¸€ç§å……æ»¡å®¡è§†çš„ç›®å…‰çœ‹ç€ä½ ï¼Œ<q>â€œè¿™ä¸œè¥¿ä½ æ˜¯ä»å“ªé‡Œå¾—åˆ°çš„ï¼Ÿâ€</q></p>\n<p><q>â€œè¿™æ˜¯å…ˆçˆ¶ä¸´ç»ˆå‰äº¤ç»™æˆ‘çš„ï¼Œè¯´æ˜¯æå®¶çš„ä¼ å®¶å®ï¼Œè¦æˆ‘åŠ¡å¿…å½’è¿˜æåºœã€‚â€</q>ä½ å¹³é™åœ°è¯´é“ï¼ŒåŠªåŠ›æ©é¥°ç€å†…å¿ƒçš„ä¸å®‰ã€‚</p>\n<p><q>â€œä¼ å®¶å®ï¼Ÿâ€</q>å®¶ä¸é—»è¨€ï¼Œçœ¼ä¸­è´ªå©ªä¹‹è‰²æ›´ç”šï¼Œä»–å˜¿å˜¿ä¸€ç¬‘ï¼Œè¯´é“ï¼š<q>â€œæ—¢ç„¶æ˜¯ä¼ å®¶å®ï¼Œé‚£å°±æ›´åº”è¯¥å½’è¿˜æåºœäº†ã€‚è¿™æ ·å§ï¼Œä½ åœ¨è¿™é‡Œç­‰ç€ï¼Œæˆ‘è¿™å°±å»ç¦€æŠ¥ç®¡å®¶ï¼Œè®©ä»–æ¥å¤„ç†ã€‚â€</q></p>\n<p>è¯´å®Œï¼Œå®¶ä¸ä¾¿è½¬èº«èµ°è¿›äº†åºœå†…ï¼Œåªç•™ä¸‹ä½ ä¸€ä¸ªäººç«™åœ¨å¯’é£ä¸­ï¼Œé»˜é»˜åœ°ç­‰å¾…ç€ã€‚</p>\n<p>æ—¶é—´ä¸€åˆ†ä¸€ç§’åœ°æµé€ï¼Œä½ çš„å¿ƒé‡Œè¶Šæ¥è¶Šä¸å®‰ã€‚ä½ éšéšæ„Ÿåˆ°ï¼Œäº‹æƒ…ä¼¼ä¹å¹¶æ²¡æœ‰æƒ³è±¡ä¸­é‚£ä¹ˆç®€å•ã€‚</p>\n<p>å°±åœ¨ä½ ç„¦èºä¸å®‰çš„æ—¶å€™ï¼Œä¸€é˜µè„šæ­¥å£°ä»åºœå†…ä¼ æ¥ã€‚ä½ æŠ¬çœ¼æœ›å»ï¼Œåªè§ä¸€ä¸ªç©¿ç€åä¸½ï¼ŒæŒºç€å•¤é…’è‚šçš„ä¸­å¹´ç”·å­ï¼Œåœ¨å®¶ä¸çš„ç°‡æ‹¥ä¸‹ï¼Œç¼“ç¼“åœ°èµ°äº†å‡ºæ¥ã€‚</p>\n<p>ä¸­å¹´ç”·å­é¢è‰²çº¢æ¶¦ï¼ŒåŒçœ¼ç»†é•¿ï¼Œè„¸ä¸ŠæŒ‚ç€ä¸€ä¸ç©å‘³çš„ç¬‘å®¹ã€‚ä»–çš„ç›®å…‰åœ¨ä½ èº«ä¸Šæ‰«è§†äº†ä¸€åœˆï¼Œæœ€ç»ˆè½åœ¨äº†ä½ æ‰‹ä¸­çš„ç‰ä½©ä¸Šã€‚</p>\n<p><q>â€œä½ å°±æ˜¯æç©†çš„å„¿å­ï¼Ÿæç™½ï¼Ÿâ€</q>ä¸­å¹´ç”·å­ç”¨ä¸€ç§é«˜é«˜åœ¨ä¸Šçš„è¯­æ°”é—®é“ã€‚</p>\n<p>ä½ æ·±å¸ä¸€å£æ°”ï¼Œå¼ºå‹ä¸‹å¿ƒä¸­çš„ä¸é€‚ï¼Œæ­æ•¬åœ°è¡Œäº†ä¸€ç¤¼ï¼Œè¯´é“ï¼š<q>â€œæ™šè¾ˆæ­£æ˜¯æç™½ï¼Œè§è¿‡è¿™ä½è¿™ä½å¤§äººã€‚â€</q></p>\n<p><q>â€œå‘µå‘µï¼Œä¸å¿…å¤šç¤¼ã€‚â€</q>ä¸­å¹´ç”·å­æ‘†äº†æ‘†æ‰‹ï¼Œéšå³ç”¨ä¸€ç§å……æ»¡ç©å‘³çš„ç›®å…‰çœ‹ç€ä½ ï¼Œ<q>â€œè¿™æšç‰ä½©ï¼Œä½ æ˜¯ä»å“ªé‡Œå¾—åˆ°çš„ï¼Ÿâ€</q></p>\n<p><q>â€œè¿™æ˜¯å…ˆçˆ¶ä¸´ç»ˆå‰äº¤ç»™æˆ‘çš„ï¼Œè¯´æ˜¯æå®¶çš„ä¼ å®¶å®ï¼Œè¦æˆ‘åŠ¡å¿…å½’è¿˜æåºœã€‚â€</q>ä½ å†æ¬¡é‡å¤äº†ä¹‹å‰è¯´è¿‡çš„è¯ï¼Œå¸Œæœ›èƒ½æ‰“æ¶ˆå¯¹æ–¹çš„ç–‘è™‘ã€‚</p>\n<p><q>â€œä¼ å®¶å®ï¼Ÿâ€</q>ä¸­å¹´ç”·å­é—»è¨€ï¼Œå“ˆå“ˆå¤§ç¬‘èµ·æ¥ï¼Œç¬‘å£°ä¸­å……æ»¡äº†å˜²è®½ï¼Œ<q>â€œæç©†é‚£ä¸ªä¹¦å‘†å­ï¼Œä¹Ÿé…æ‹¥æœ‰ä¼ å®¶å®ï¼Ÿè¿™æšç‰ä½©ï¼Œæ˜æ˜æ˜¯å½“å¹´æ—é•¿èµèµç»™è€å¤ªçˆ·çš„ï¼Œæ€ä¹ˆä¼šæˆäº†ä½ ä»¬å®¶çš„ä¸œè¥¿ï¼Ÿâ€</q></p>\n<p><q>â€œè¿™â€</q>ä½ ä¸€æ—¶è¯­å¡ï¼Œä¸çŸ¥é“è¯¥å¦‚ä½•è¾©è§£ã€‚</p>\n<p><q>â€œå¥½äº†ï¼Œæˆ‘ä¹Ÿä¸è·Ÿä½ åºŸè¯äº†ã€‚â€</q>ä¸­å¹´ç”·å­æ‘†äº†æ‘†æ‰‹ï¼Œç”¨ä¸€ç§ä¸å®¹ç½®ç–‘çš„è¯­æ°”è¯´é“ï¼š<q>â€œè¿™æšç‰ä½©ï¼Œæ˜¯æåºœçš„ï¼Œç°åœ¨ï¼Œæˆ‘è¦æŠŠå®ƒæ”¶å›æ¥ã€‚â€</q></p>\n<p><q>â€œå¯æ˜¯â€</q>ä½ è¿˜æƒ³è¯´äº›ä»€ä¹ˆï¼Œå´è¢«ä¸­å¹´ç”·å­ç²—æš´åœ°æ‰“æ–­äº†ã€‚</p>\n<p><q>â€œæ²¡æœ‰ä»€ä¹ˆå¯æ˜¯ã€‚â€</q>ä¸­å¹´ç”·å­å†·ç¬‘ä¸€å£°ï¼Œè¯´é“ï¼š<q>â€œå¿µåœ¨ä½ çˆ¶äº²æ›¾ç»ä¹Ÿæ˜¯æåºœçš„ä¸€ä»½å­ï¼Œæˆ‘å¯ä»¥ç»™ä½ ä¸€ä¸ªæœºä¼šã€‚åªè¦ä½ ç­”åº”ä¸ºæˆ‘åšä¸€ä»¶äº‹ï¼Œè¿™æšç‰ä½©ï¼Œæˆ‘å°±èµç»™ä½ äº†ã€‚â€</q></p>\n<p>ä½ å¿ƒä¸­ä¸€åŠ¨ï¼Œè¿å¿™é—®é“ï¼š<q>â€œä»€ä¹ˆäº‹ï¼Ÿâ€</q></p>\n<p>ä¸­å¹´ç”·å­å‡‘åˆ°ä½ è€³è¾¹ï¼Œä½å£°è¯´äº†ä¸€å¥è¯ã€‚</p>\n<p>å¬å®Œä»–çš„è¯ï¼Œä½ é¡¿æ—¶è„¸è‰²å¤§å˜ã€‚</p>\n<p><q>â€œè¿™ç»å¯¹ä¸è¡Œï¼â€</q>ä½ æ–­ç„¶æ‹’ç»é“ã€‚</p>\n<p><q>â€œå‘µå‘µï¼Œçœ‹æ¥ä½ æ˜¯ä¸æƒ³è¦è¿™æšç‰ä½©äº†ã€‚â€</q>ä¸­å¹´ç”·å­è€¸äº†è€¸è‚©ï¼Œè¯´é“ï¼š<q>â€œæ—¢ç„¶å¦‚æ­¤ï¼Œé‚£å°±è¯·å›å§ã€‚æåºœï¼Œä¸æ¬¢è¿ä½ ã€‚â€</q></p>\n<p>è¯´å®Œï¼Œä¸­å¹´ç”·å­ä¾¿è½¬èº«æ¬²èµ°ã€‚</p>\n<p>ä½ çœ‹ç€ä»–æ‰‹ä¸­çš„ç‰ä½©ï¼Œå¿ƒä¸­å……æ»¡äº†æŒ£æ‰ã€‚</p>\n<p>è¿™æšç‰ä½©ï¼Œæ˜¯çˆ¶äº²ç•™ç»™ä½ å”¯ä¸€çš„é—ç‰©ï¼Œä¹Ÿæ˜¯ä½ é‡æŒ¯æå®¶å¸Œæœ›çš„è±¡å¾ã€‚ä½†ä¸­å¹´ç”·å­æå‡ºçš„è¦æ±‚ï¼Œå´è®©ä½ æ— æ³•æ¥å—ã€‚</p>\n<p><q>â€œç­‰ç­‰ï¼â€</q>ä½ å’¬äº†å’¬ç‰™ï¼Œç»ˆäºåšå‡ºäº†å†³å®šï¼Œ<q>â€œæˆ‘ç­”åº”ä½ ï¼â€</q><br>\n</p>\n<div class=\"custom-character-status-wrapper\">\n  \n  <style>/* ä¸»å®¹å™¨æ ·å¼ */\n\n.mes_text .custom-character-status-wrapper {\n  background-color: rgba(235, 225, 210, 0.95);\n  /* æµ…ç±³è‰²èƒŒæ™¯ */\n  border: 1px solid rgba(165, 145, 120, 0.5);\n  border-radius: 6px;\n  max-width: 861px;\n  margin: 5px auto;\n  padding: 0 5px 5px 5px;\n  box-sizing: border-box;\n  overflow: hidden;\n  /* é¢œè‰²å˜é‡ */\n  --char-text-color: #4b3f34;\n  /* æ·±ç°è¤è‰²æ–‡æœ¬ */\n  --char-content-border: rgba(165, 145, 120, 0.3);\n  --char-button-bg: rgba(218, 198, 171, 0.95);\n  --char-button-border: rgba(165, 145, 120, 0.8);\n  --char-button-highlight: rgba(228, 208, 181, 0.95);\n  --char-button-shadow: rgba(175, 155, 130, 0.85);\n  --char-button-outer-shadow: rgba(150, 130, 105, 0.3);\n  --char-icon-color: #5b99c9;\n  /* è“è‰²å›¾æ ‡ */\n  --char-content-bg: rgba(225, 215, 200, 0.95);\n  /* å†…å®¹åŒºèƒŒæ™¯ */\n  --char-button-hover: rgba(225, 205, 178, 0.95);\n  /* æ‚¬åœé¢œè‰² */\n  --char-button-active: rgba(210, 190, 163, 0.95);\n  /* ç‚¹å‡»æ—¶é¢œè‰² */\n}\n\n/* å®šä¹‰æ ‡å‡†å­—ä½“æ ˆ */\n\n.mes_text .custom-character-status-wrapper {\n  font-family: 'Segoe UI', Roboto, 'Helvetica Neue', 'Microsoft YaHei', 'Noto Sans SC', Arial, sans-serif;\n  color: var(--char-text-color);\n  /* åº”ç”¨é»˜è®¤æ–‡æœ¬é¢œè‰² */\n}\n\n/* å…¨å±€ç¦ç”¨æ–‡æœ¬é˜´å½± */\n\n.mes_text .custom-character-status-wrapper,\n.mes_text .custom-character-status-wrapper *,\n.mes_text .custom-details-character-status,\n.mes_text .custom-details-character-status *,\n.mes_text .custom-details-character-status > summary,\n.mes_text .custom-details-character-status > summary::before,\n.mes_text .custom-details-character-status > div {\n  text-shadow: none !important;\n}\n\n/* è¯¦æƒ…æŒ‰é’®æ ·å¼ (ä½¿ç”¨æ–°ç±»å) */\n\n.mes_text .custom-details-character-status {\n  border: none;\n  margin: 0;\n  padding: 0;\n  color: inherit;\n  /* ç»§æ‰¿ wrapper çš„é¢œè‰² */\n}\n\n/* åŸºç¡€æ‘˜è¦æ ·å¼ (ä½¿ç”¨æ–°ç±»å) */\n\n.mes_text .custom-details-character-status > summary {\n  display: flex;\n  align-items: center;\n  width: 100%;\n  cursor: pointer;\n  list-style: none;\n  outline: none;\n  image-rendering: auto;\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n  transition: all 0.1s ease-in-out;\n  position: relative;\n  top: 0;\n  left: 0;\n  box-sizing: border-box;\n  font-weight: 600;\n  /* ä½¿ç”¨åŠç²—ä½“ (Semi-bold) ä½œä¸ºæ ‡é¢˜ */\n  color: var(--char-text-color);\n}\n\n/* ç§»é™¤é»˜è®¤æ ‡è®° (ä½¿ç”¨æ–°ç±»å) */\n\n.mes_text .custom-details-character-status > summary::-webkit-details-marker,\n.mes_text .custom-details-character-status > summary::marker {\n  display: none;\n  content: '';\n}\n\n/* åŸºç¡€å›¾æ ‡æ ·å¼ (ä½¿ç”¨æ–°ç±»å) */\n\n.mes_text .custom-details-character-status > summary::before {\n  content: 'ğŸ‘¤';\n  /* <<< è§’è‰²çŠ¶æ€å›¾æ ‡ */\n  display: inline-block;\n  line-height: 1;\n  font-size: 1.1em;\n  color: var(--char-icon-color);\n  margin-right: 6px;\n}\n\n/* å…³é—­æ—¶çŠ¶æ€ (ä½¿ç”¨æ–°ç±»å) */\n\n.mes_text .custom-details-character-status:not([open]) > summary {\n  padding: 4px 8px 5px 8px;\n  font-size: 16px;\n  line-height: 1.2;\n  margin-bottom: 0;\n  background-color: var(--char-button-bg);\n  border: 1px solid var(--char-button-border) !important;\n  border-radius: 5px;\n  box-shadow: 1px 1px 2px var(--char-button-outer-shadow) !important;\n  filter: none;\n  justify-content: flex-start;\n}\n\n/* é¼ æ ‡æ‚¬åœæ•ˆæœ (ä½¿ç”¨æ–°ç±»å) */\n\n.mes_text .custom-details-character-status:not([open]) > summary:hover {\n  background-color: var(--char-button-hover);\n}\n\n/* æ‰“å¼€æ—¶çŠ¶æ€ (ä½¿ç”¨æ–°ç±»å) */\n\n.mes_text .custom-details-character-status[open] > summary {\n  padding: 10px 8px;\n  font-size: 18px;\n  line-height: initial;\n  margin-bottom: 5px;\n  border: 1px solid var(--char-button-border);\n  border-radius: 5px;\n  background-color: var(--char-button-active);\n  justify-content: flex-start;\n  box-shadow: inset 1px 1px 0px 1px var(--char-button-highlight), inset -1px -1px 0px 1px var(--char-button-shadow);\n  filter: drop-shadow(1px 1px 0px var(--char-button-outer-shadow));\n  font-weight: 600;\n  /* ä¿æŒåŠç²—ä½“ */\n}\n\n/* æ‰“å¼€æ—¶å›¾æ ‡æ ·å¼ (ä½¿ç”¨æ–°ç±»å) */\n\n.mes_text .custom-details-character-status[open] > summary::before {\n  margin-right: 8px;\n}\n\n/* ç‚¹å‡»æ—¶åé¦ˆ (ä½¿ç”¨æ–°ç±»å) */\n\n.mes_text .custom-details-character-status > summary:active {\n  padding: 10px 8px;\n  font-size: 18px;\n  line-height: initial;\n  background-color: var(--char-button-active);\n  box-shadow: inset 1px 1px 0px 1px var(--char-button-highlight), inset -1px -1px 0px 1px var(--char-button-shadow);\n  filter: drop-shadow(1px 1px 0px var(--char-button-outer-shadow));\n  top: 1px;\n  left: 1px;\n  border: 1px solid var(--char-button-border);\n  border-radius: 5px;\n  justify-content: flex-start;\n  margin-bottom: 5px;\n  font-weight: 600;\n  /* ä¿æŒåŠç²—ä½“ */\n}\n\n/* ç‚¹å‡»æ—¶å›¾æ ‡æ ·å¼ (ä½¿ç”¨æ–°ç±»å) */\n\n.mes_text .custom-details-character-status > summary:active::before {\n  margin-right: 8px;\n}\n\n/* æ‰“å¼€æ—¶æ˜¾ç¤ºçš„å†…å®¹ (ä½¿ç”¨æ–°ç±»å) */\n\n.mes_text .custom-details-character-status > div {\n  padding: 10px;\n  margin: 0;\n  font-size: 15px;\n  line-height: 1.5;\n  background-color: var(--char-content-bg);\n  color: var(--char-text-color);\n  border: 1px solid var(--char-content-border);\n  border-radius: 4px;\n  font-weight: normal;\n  /* å†…å®¹ä½¿ç”¨æ™®é€šå­—é‡ */\n  white-space: pre-wrap;\n  word-break: break-word;\n}</style>\n\n  <details class=\"custom-details-character-status\">\n    \n    <summary>è§’è‰²çŠ¶æ€æ </summary>\n    \n    <div>\n      \n      ã€æç™½çš„åŸºæœ¬ä¿¡æ¯ã€‘\nâ€¢ é“å·:   | æç™½\nâ€¢ èº«ä»½: èµµå›½ - è½é­„è´µæ—\n<details>\n<summary>ã€æ³•å®æ ã€‘</summary>\næœ¬å‘½æ³•å®:  (çµæ€§:0)\nğŸ©¸+0 ğŸ’ª+0ğŸƒ+0 âœ¨+0 ğŸ”‹ +0 ğŸ§ +0\nå‰¯æ³•å®:  (çµæ€§:0)\nğŸ©¸+0 ğŸ’ª+0ğŸƒ+0 âœ¨+0 ğŸ”‹ +0 ğŸ§ +0\næ³•è¡£:  (çµæ€§:0)\nğŸ©¸+0 ğŸ’ª+0ğŸƒ+0 âœ¨+0 ğŸ”‹ +0 ğŸ§ +0\né¥°å“:  (çµæ€§:0)\nğŸ©¸+0 ğŸ’ª+0ğŸƒ+0 âœ¨+0 ğŸ”‹ +0 ğŸ§ +0\næœ€ç»ˆæ€»è®¡:\nğŸ©¸0 ğŸ’ª15 ğŸƒ10âœ¨15ğŸ”‹15 ğŸ§ 15\n</details>\n<details>\n<summary>ã€æç™½çš„ä¿®ä¸ºä¸æ ¹åŸºã€‘</summary>\nã€æç™½çš„å¢ƒç•Œã€‘\nâ€¢ å½“å‰å¢ƒç•Œ: å‡¡äºº - æœªå…¥é—¨\nâ€¢ å½“å‰å¢ƒç•Œè¿›åº¦: 0.0%\nâ€¢ çªç ´æ‰€éœ€:\nâ€¢ å¹´é¾„:  | å¯¿å…ƒ: 100\nã€æç™½çš„æ ¹åŸºã€‘\nçµæ ¹: æœªæµ‹è¯•\n ğŸ’ªæ ¹éª¨: 15\n ğŸƒèº«æ³• : 10\n ğŸ”‹æ·¬ä½“ : 15\n âœ¨ç¥è¯† : 15\nğŸ§  æ‚Ÿæ€§: 15\n</details>\n<details>\n<summary>ã€æç™½çš„åŠŸæ³•ä¸ç¥é€šã€‘</summary>\nâ€¢ ã€ä¸»ä¿®åŠŸæ³•ã€‘\n-\nâ€¢ åŠŸæ³•å±‚æ¬¡:\nâ€¢ ä¸‹ä¸€å±‚æ¬¡:\n- ã€å·²æŒæ¡ç¥é€šã€‘\nâ€¢\nâ€¢ ã€è¾…ä¿®åŠŸæ³•ã€‘\n-\nâ€¢ ã€ç‰¹æ®Šèƒ½åŠ›ã€‘\n-\n</details>\n<details>\n<summary>ã€æç™½çš„å¥½æ„Ÿåº¦åˆ—è¡¨ã€‘</summary>\n</details>\n<details>\n<summary>ã€æç™½çš„ä»»åŠ¡åˆ—è¡¨ã€‘</summary>\nâ€¢\n</details>\n<details>\n<summary>ã€æç™½çš„å‚¨ç‰©è¢‹ã€‘</summary>\nâ€¢ çµçŸ³ : ä¸‹å“çµçŸ³0|ä¸­å“çµçŸ³0|ä¸Šå“çµçŸ³0\nâ€¢\n</details>\n    </div>\n  </details>\n</div>\n<div class=\"custom-npc-status-wrapper\">\n  \n  <style>/* ä¸»å®¹å™¨æ ·å¼ - è“è‰²ä¸»é¢˜ */\n\n.mes_text .custom-npc-status-wrapper {\n  background-color: rgba(230, 240, 255, 0.95) !important;\n  /* æŸ”å’Œçš„å¤©è“è‰²èƒŒæ™¯ */\n  border: 1px solid rgba(135, 175, 225, 0.5) !important;\n  /* è“è‰²ç³»è¾¹æ¡† */\n  border-radius: 6px !important;\n  max-width: 861px !important;\n  margin: 5px auto !important;\n  padding: 0 5px 5px 5px !important;\n  box-sizing: border-box !important;\n  overflow: hidden !important;\n  font-family: 'Segoe UI', Roboto, 'Helvetica Neue', 'Microsoft YaHei', 'Noto Sans SC', Arial, sans-serif !important;\n  color: #3a5a78 !important;\n  /* æ·±è“è‰²æ–‡æœ¬ */\n}\n\n/* å…¨å±€ç¦ç”¨æ–‡æœ¬é˜´å½± */\n\n.mes_text .custom-npc-status-wrapper,\n.mes_text .custom-npc-status-wrapper *,\n.mes_text .custom-details-npc-status,\n.mes_text .custom-details-npc-status *,\n.mes_text .custom-details-npc-status > summary,\n.mes_text .custom-details-npc-status > summary::before,\n.mes_text .custom-details-npc-status > div {\n  text-shadow: none !important;\n}\n\n/* è¯¦æƒ…æŒ‰é’®æ ·å¼ */\n\n.mes_text .custom-details-npc-status {\n  border: none !important;\n  margin: 0 !important;\n  padding: 0 !important;\n  color: inherit !important;\n}\n\n/* åŸºç¡€æ‘˜è¦æ ·å¼ */\n\n.mes_text .custom-details-npc-status > summary {\n  display: flex !important;\n  align-items: center !important;\n  width: 100% !important;\n  cursor: pointer !important;\n  list-style: none !important;\n  outline: none !important;\n  image-rendering: auto !important;\n  -webkit-font-smoothing: antialiased !important;\n  -moz-osx-font-smoothing: grayscale !important;\n  transition: all 0.1s ease-in-out !important;\n  position: relative !important;\n  top: 0 !important;\n  left: 0 !important;\n  box-sizing: border-box !important;\n  font-weight: 600 !important;\n  color: #3a5a78 !important;\n}\n\n/* ç§»é™¤é»˜è®¤æ ‡è®° */\n\n.mes_text .custom-details-npc-status > summary::-webkit-details-marker,\n.mes_text .custom-details-npc-status > summary::marker {\n  display: none !important;\n  content: '' !important;\n}\n\n/* åŸºç¡€å›¾æ ‡æ ·å¼ */\n\n.mes_text .custom-details-npc-status > summary::before {\n  content: 'ğŸ—£ï¸' !important;\n  /* <<< NPCä¸“å±å›¾æ ‡ï¼šè¯´è¯çš„å¤´åƒ */\n  display: inline-block !important;\n  line-height: 1 !important;\n  font-size: 1.1em !important;\n  color: #5a95d0 !important;\n  /* é²œæ˜çš„è“è‰²å›¾æ ‡ */\n  margin-right: 6px !important;\n}\n\n/* å…³é—­æ—¶çŠ¶æ€ */\n\n.mes_text .custom-details-npc-status:not([open]) > summary {\n  padding: 4px 8px 5px 8px !important;\n  font-size: 16px !important;\n  line-height: 1.2 !important;\n  margin-bottom: 0 !important;\n  background-color: rgba(210, 228, 255, 0.95) !important;\n  border: 1px solid rgba(135, 175, 225, 0.8) !important;\n  border-radius: 5px !important;\n  box-shadow: 1px 1px 2px rgba(125, 165, 215, 0.3) !important;\n  filter: none !important;\n  justify-content: flex-start !important;\n}\n\n/* é¼ æ ‡æ‚¬åœæ•ˆæœ */\n\n.mes_text .custom-details-npc-status:not([open]) > summary:hover {\n  background-color: rgba(220, 235, 255, 0.95) !important;\n}\n\n/* æ‰“å¼€æ—¶çŠ¶æ€ */\n\n.mes_text .custom-details-npc-status[open] > summary {\n  padding: 10px 8px !important;\n  font-size: 18px !important;\n  line-height: initial !important;\n  margin-bottom: 5px !important;\n  border: 1px solid rgba(135, 175, 225, 0.8) !important;\n  border-radius: 5px !important;\n  background-color: rgba(200, 218, 245, 0.95) !important;\n  justify-content: flex-start !important;\n  box-shadow: inset 1px 1px 0px 1px rgba(225, 240, 255, 0.95), inset -1px -1px 0px 1px rgba(180, 200, 230, 0.85) !important;\n  filter: drop-shadow(1px 1px 0px rgba(125, 165, 215, 0.3)) !important;\n  font-weight: 600 !important;\n}\n\n/* æ‰“å¼€æ—¶å›¾æ ‡æ ·å¼ */\n\n.mes_text .custom-details-npc-status[open] > summary::before {\n  margin-right: 8px !important;\n}\n\n/* ç‚¹å‡»æ—¶åé¦ˆ */\n\n.mes_text .custom-details-npc-status > summary:active {\n  top: 1px !important;\n  left: 1px !important;\n}\n\n/* æ‰“å¼€æ—¶æ˜¾ç¤ºçš„å†…å®¹ */\n\n.mes_text .custom-details-npc-status > div {\n  padding: 10px !important;\n  margin: 0 !important;\n  font-size: 15px !important;\n  line-height: 1.5 !important;\n  background-color: rgba(240, 248, 255, 0.95) !important;\n  /* æ›´æµ…çš„è“è‰²å†…å®¹åŒº */\n  color: #3a5a78 !important;\n  border: 1px solid rgba(135, 175, 225, 0.3) !important;\n  border-radius: 4px !important;\n  font-weight: normal !important;\n  white-space: pre-wrap !important;\n  word-break: break-word !important;\n}</style>\n\n  <details class=\"custom-details-npc-status\">\n    \n    <summary>NPC çŠ¶æ€æ </summary>\n    \n    <div>\n      \n      <details>\n<summary>âš”ï¸ æåºœç®¡å®¶ -  | â¤ï¸è¡€é‡: 0/0 | **é˜µè¥:** æ•Œäºº</summary>\n<details>\n<summary>ğŸ“Šã€æ ¹åŸºå±æ€§ã€‘</summary>\n**ğŸ“Š æ ¸å¿ƒæ ¹åŸº**<br>\nâ€¢ å¢ƒç•Œ (Realm)ï¼š å…·ä½“çš„å¢ƒç•Œæè¿°<br>\nâ€¢ ğŸ’ª æ ¹éª¨: 0<br>\nâ€¢ ğŸƒ èº«æ³•: 0<br>\nâ€¢ âœ¨ ç¥è¯†: 0<br>\nâ€¢ ğŸ”‹ æ·¬ä½“: 0<br>\nâ€¢ ğŸ§  æ‚Ÿæ€§: 0<br>\n</details>\n<details>\n<summary>âš”ï¸ ç¥é€šä¸æˆ˜æ³•</summary><br>\n**ã€æ ¸å¿ƒç¥é€šã€‘:**<br>\nå¨èƒ½: | çµåŠ›æ¶ˆè€—:<br>\n</details>\nğŸ¤ äº¤äº’æ¡£æ¡ˆ<br>\nâ€¢ **èº«ä»½:** æˆ‘æ ¹æ®æè¿°æ¨æ–­çš„èº«ä»½(æ•Œäºº)<br>\nâ€¢ æ€§æ ¼ç‰¹è´¨:** æˆ‘æ ¹æ®æè¿°æ¨æ–­çš„1-2ä¸ªç‰¹è´¨<br>\n</details>\n    </div>\n  </details>\n</div>\n<pre><code class=\"custom-text custom-language-text\">&lt;!DOCTYPE html&gt;\n&lt;html lang=\"zh\"&gt;\n  &lt;head&gt;\n    &lt;meta charset=\"UTF-8\" /&gt;\n    &lt;meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\" /&gt;\n    &lt;title&gt;ä¿®ä»™æˆ˜æ–—ç³»ç»Ÿ&lt;/title&gt;\n    &lt;link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css\" /&gt;\n  &lt;/head&gt;\n&lt;/html&gt;\n\n  &lt;body&gt;\n    &lt;div id=\"status-data-source\" style=\"display: none\"&gt;[ENN:æåºœç®¡å®¶][ENHP:0/0][ENSTR:0][ENAGI:0][ENINT:0][ENVIT:0][ENS:][ATK:0][Hit%:0][Crit%:0][APT:0][TPA:0][PN5A:æ™®æ”»,æ™®æ”»,æ™®æ”»,æ™®æ”»,æ™®æ”»]&lt;/div&gt;\n    &lt;div class=\"container\"&gt;\n      &lt;details id=\"preparation-details\" class=\"preparation-details\"&gt;\n        &lt;summary class=\"preparation-summary\"&gt;æˆ˜å‰å‡†å¤‡&lt;/summary&gt;\n        &lt;div id=\"preparation-screen\" class=\"status-bar\" style=\"overflow: hidden; max-height: 0\"&gt;\n          &lt;div class=\"status-header\"&gt;\n            &lt;h2 id=\"status-title\"&gt;æˆ˜æ–—å‡†å¤‡&lt;/h2&gt;\n          &lt;/div&gt;\n          &lt;div id=\"player-status\" class=\"player-status\"&gt;&lt;/div&gt;\n          &lt;div id=\"pilots-container\" class=\"pilots-container\"&gt;&lt;/div&gt;\n          &lt;div id=\"combat-controls\" style=\"margin-top: 10px; text-align: center\"&gt;&lt;/div&gt;\n        &lt;/div&gt;\n      &lt;/details&gt;\n    &lt;/div&gt;\n    &lt;div id=\"combat-interface\" class=\"container\"&gt;\n      &lt;h3 id=\"combat-title\"&gt;æˆ˜æ–—ä¸­&lt;/h3&gt;\n\n      &lt;div id=\"action-order-container\" class=\"action-order-container\"&gt;\n        &lt;div class=\"action-order-title\"&gt;&lt;i class=\"fas fa-list-ol\"&gt;&lt;/i&gt; è¡ŒåŠ¨é¡ºåº&lt;/div&gt;\n        &lt;div id=\"action-order-display\" class=\"action-order-display\"&gt;&lt;/div&gt;\n      &lt;/div&gt;\n      &lt;div id=\"combat-display\"&gt;\n        &lt;div id=\"combat-player-panel\"&gt;&lt;/div&gt;\n        &lt;div id=\"combat-enemy-panel\"&gt;&lt;/div&gt;\n      &lt;/div&gt;\n      &lt;div id=\"combat-player-actions\"&gt;\n        &lt;div class=\"weapons-title\"&gt;&lt;i class=\"fas fa-tasks\"&gt;&lt;/i&gt; é€‰æ‹©è¡ŒåŠ¨&lt;/div&gt;\n        &lt;div class=\"weapon-category-toggle\"&gt;\n          &lt;div id=\"melee-toggle\" class=\"category-button active\"&gt;&lt;i class=\"fas fa-magic\"&gt;&lt;/i&gt; ç¥é€š&lt;/div&gt;\n          &lt;div id=\"items-toggle\" class=\"category-button\"&gt;&lt;i class=\"fas fa-pills\"&gt;&lt;/i&gt; ä¸¹è¯&lt;/div&gt;\n          &lt;div id=\"stats-toggle\" class=\"category-button\"&gt;&lt;i class=\"fas fa-chart-bar\"&gt;&lt;/i&gt; è¯¦ç»†å±æ€§&lt;/div&gt;\n        &lt;/div&gt;\n        &lt;div id=\"melee-panel\" class=\"weapon-panel active\"&gt;\n          &lt;div id=\"melee-weapon-list\" class=\"weapon-buttons\"&gt;&lt;/div&gt;\n        &lt;/div&gt;\n        &lt;div id=\"items-panel\" class=\"weapon-panel\"&gt;\n          &lt;div id=\"items-list\" class=\"item-buttons\"&gt;&lt;/div&gt;\n        &lt;/div&gt;\n        &lt;div id=\"stats-panel\" class=\"weapon-panel\"&gt;\n          &lt;div id=\"detailed-stats-display\"&gt;&lt;/div&gt;\n        &lt;/div&gt;\n        &lt;div class=\"attack-controls\"&gt;\n          &lt;button id=\"attack-btn\" class=\"attack-button\" disabled&gt;&lt;i class=\"fas fa-magic\"&gt;&lt;/i&gt; æ–½å±•ç¥é€š&lt;/button&gt;\n          &lt;button id=\"next-round-btn\" class=\"next-round-button\"&gt;\n            &lt;i class=\"fas fa-arrow-right-to-bracket\"&gt;&lt;/i&gt; è·³è¿‡å½“å‰è¡ŒåŠ¨\n          &lt;/button&gt;\n          &lt;button id=\"mid-action-btn\" class=\"mid-action-button\"&gt;&lt;i class=\"fas fa-pause\"&gt;&lt;/i&gt; ä¸­é€”è¡ŒåŠ¨&lt;/button&gt;\n        &lt;/div&gt;\n      &lt;/div&gt;\n      &lt;div id=\"combat-log-container\"&gt;\n        &lt;div class=\"weapons-title\"&gt;&lt;i class=\"fas fa-scroll\"&gt;&lt;/i&gt; æˆ˜æ–—è®°å½•&lt;/div&gt;\n        &lt;div id=\"combat-log\"&gt;&lt;/div&gt;\n      &lt;/div&gt;\n    &lt;/div&gt;\n    &lt;div id=\"result-modal\" class=\"result-modal\"&gt;\n      &lt;div class=\"result-content\"&gt;\n        &lt;h2 class=\"result-title\"&gt;&lt;i class=\"fas fa-flag-checkered\"&gt;&lt;/i&gt; æˆ˜æ–—ç»“æœ&lt;/h2&gt;\n        &lt;div id=\"result-summary\" class=\"result-summary\"&gt;&lt;/div&gt;\n\n        &lt;div class=\"result-extra-text\"&gt;\n          &lt;textarea id=\"extra-result-text\" placeholder=\"åœ¨æ­¤è¾“å…¥é¢å¤–æ–‡å­—ï¼Œå°†ä¸æˆ˜æ–—ç»“æœä¸€èµ·å‘é€\"&gt;&lt;/textarea&gt;\n        &lt;/div&gt;\n        &lt;button id=\"send-result\" class=\"btn\" style=\"background-color: var(--success-color)\"&gt;\n          &lt;i class=\"fas fa-paper-plane\"&gt;&lt;/i&gt; å‘é€ç»“æœ\n        &lt;/button&gt;\n        &lt;button id=\"close-result\" class=\"btn\" style=\"margin-left: 10px\"&gt;&lt;i class=\"fas fa-times\"&gt;&lt;/i&gt; å–æ¶ˆ&lt;/button&gt;\n      &lt;/div&gt;\n    &lt;/div&gt;\n\n    &lt;style&gt;\n\n      :root {\n        --bg-color: #1a1a2e;\n        --bg-secondary: #16213e;\n        --bg-tertiary: #0f172a;\n        --card-bg: rgba(30, 41, 59, 0.8);\n        --card-bg-solid: #1e293b;\n        --card-border: #334155;\n        --primary-color: #8b5cf6;\n        --primary-light: #a78bfa;\n        --primary-dark: #7c3aed;\n        --secondary-color: #ef4444;\n        --accent-color: #06b6d4;\n        --text-color: #e2e8f0;\n        --text-light: #94a3b8;\n        --text-muted: #64748b;\n        --border-color: #374151;\n        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);\n        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);\n        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);\n        --shadow-glow: 0 0 20px rgba(139, 92, 246, 0.3);\n        --font-rpg: system-ui, -apple-system, sans-serif;\n        --health-color: #ef4444;\n        --health-bg: rgba(239, 68, 68, 0.2);\n        --mana-color: #3b82f6;\n        --mana-bg: rgba(59, 130, 246, 0.2);\n        --success-color: #10b981;\n        --heal-color: #10b981;\n        --fire-color: #f97316;\n        --ice-color: #0ea5e9;\n        --lightning-color: #a855f7;\n        --gradient-primary: linear-gradient(135deg, #8b5cf6 0%, #06b6d4 100%);\n        --gradient-secondary: linear-gradient(135deg, #ef4444 0%, #f97316 100%);\n      }\n* {\n  margin: 0;\n  padding: 0;\n  box-sizing: border-box;\n}\nbody {\n  background: transparent;\n  color: var(--text-color);\n  font-family: var(--font-rpg);\n  padding: 5px;\n  font-size: 14px;\n  margin: 0;\n}\n.container {\n  width: 100%;\n  max-width: 800px;\n  border-radius: 15px;\n  overflow: hidden;\n  box-shadow: var(--shadow-lg);\n  background: rgba(30, 41, 59, 0.95);\n  backdrop-filter: blur(15px);\n  border: 1px solid rgba(51, 65, 85, 0.8);\n  margin: 0 auto 5px;\n}\n.status-bar {\n  width: 100%;\n  background: rgba(30, 41, 59, 0.9);\n  border-radius: 15px;\n  padding: 10px;\n  border: 1px solid rgba(51, 65, 85, 0.6);\n  backdrop-filter: blur(10px);\n}\n.status-header {\n  text-align: center;\n  margin-bottom: 5px;\n  padding-bottom: 4px;\n  border-bottom: 1px solid var(--border-color);\n}\n.status-header h2 {\n  font-size: 18px;\n  color: var(--primary-color);\n  text-shadow: 0 0 10px rgba(139, 92, 246, 0.5);\n  font-weight: 600;\n}\n.player-status,\n.pilots-container,\n.teammates-status {\n  margin-bottom: 5px;\n  padding: 8px;\n  background: rgba(22, 33, 62, 0.8);\n  border-radius: 10px;\n  box-shadow: var(--shadow-md);\n  border: 1px solid rgba(51, 65, 85, 0.5);\n  backdrop-filter: blur(8px);\n}\n.teammates-list {\n  display: grid;\n  grid-template-columns: repeat(3, 1fr);\n  gap: 8px;\n  max-height: 110px;\n  overflow-y: auto;\n  overflow-x: hidden;\n  padding-right: 0;\n}\n.teammate-item {\n  padding: 6px;\n  background: rgba(30, 41, 59, 0.7);\n  border-radius: 6px;\n  box-shadow: var(--shadow-sm);\n  border: 1px solid var(--primary-color);\n  transition: all 0.3s ease;\n  backdrop-filter: blur(5px);\n}\n.teammate-item:hover {\n  transform: translateY(-2px);\n  box-shadow: var(--shadow-glow);\n  border-color: var(--primary-light);\n}\n.teammate-item.selectable {\n  cursor: pointer;\n}\n.teammate-item:not(.selected) {\n  opacity: 0.6;\n  filter: grayscale(30%);\n}\n.teammate-item.selected {\n  opacity: 1;\n  filter: none;\n}\n.teammate-name {\n  font-size: 13px;\n  font-weight: bold;\n  margin-bottom: 4px;\n  color: var(--primary-light);\n  text-shadow: 0 0 5px rgba(167, 139, 250, 0.3);\n}\n.teammate-hp,\n.teammate-mp,\n.teammate-ap {\n  display: flex;\n  align-items: center;\n  margin-bottom: 4px; \n}\n.teammate-agility,\n.teammate-speed,\n.teammate-stats {\n  font-size: 11px;\n  color: var(--text-light);\n  margin-top: 5px;\n  display: inline-block;\n  padding: 3px 6px;\n  background: var(--bg-color);\n  border-radius: 10px;\n  box-shadow: var(--shadow-sm);\n  cursor: help;\n  margin-right: 5px;\n}\n.teammate-weapons h4 {\n  font-size: 11px;\n  margin: 4px 0;\n  color: #6366f1;\n}\n\n.teammate-item .weapons-list {\n  max-height: 120px;\n  overflow-y: auto;\n  padding-right: 3px;\n  margin-bottom: 5px;\n}\n.teammate-item .weapon-item {\n  padding: 4px;\n  margin-bottom: 3px;\n}\n.teammate-item .weapon-name {\n  font-size: 10px;\n  margin-bottom: 2px;\n}\n.teammate-item .weapon-stats {\n  font-size: 8px;\n}\n.teammate-item .weapon-effect-codes {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 3px;\n  margin-top: 3px;\n}\n.teammate-item .weapon-effect-code {\n  font-size: 8px;\n  padding: 1px 3px;\n  border-radius: 3px;\n  background-color: rgba(99, 102, 241, 0.1);\n  border: 1px solid #6366f1;\n  position: relative;\n  cursor: help;\n}\n.player-info {\n  margin-bottom: 10px;\n}\n.player-name {\n  font-size: 15px;\n  font-weight: bold;\n  margin-bottom: 8px;\n  color: var(--primary-color);\n}\n.player-hp,\n.player-mp,\n.player-ap {\n  display: flex;\n  align-items: center;\n  margin-bottom: 6px;\n}\n.hp-label,\n.mp-label {\n  width: 25px;\n  font-weight: bold;\n  font-size: 11px;\n}\n.hp-bar,\n.mp-bar,\n.ap-bar {\n  flex-grow: 1;\n  height: 18px;\n  background: var(--bg-tertiary);\n  border-radius: 10px;\n  overflow: hidden;\n  margin: 0 8px;\n  box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);\n  position: relative;\n  border: 1px solid var(--border-color);\n}\n.hp-fill {\n  height: 100%;\n  background: var(--gradient-secondary);\n  border-radius: 10px;\n  transition: width 0.5s ease;\n  box-shadow: 0 0 10px rgba(239, 68, 68, 0.3);\n}\n.mp-fill {\n  height: 100%;\n  background: var(--gradient-primary);\n  border-radius: 10px;\n  transition: width 0.5s ease;\n  box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);\n}\n.ap-fill {\n  height: 100%;\n  background: linear-gradient(135deg, #fbbf24, #f59e0b);\n  border-radius: 10px;\n  transition: width 0.5s ease;\n  box-shadow: 0 0 10px rgba(251, 191, 36, 0.3);\n}\n.hp-text,\n.mp-text,\n.ap-text {\n  min-width: 120px;\n  text-align: right;\n  font-weight: bold;\n  font-size: 11px;\n  color: var(--text-color);\n  white-space: nowrap;\n  overflow: hidden;\n  text-overflow: ellipsis;\n}\n.player-agility,\n.player-stats,\n.teammate-agility,\n.teammate-speed,\n.teammate-stats {\n  font-size: 11px;\n  color: var(--text-light);\n  margin-top: 5px;\n  display: inline-block;\n  padding: 3px 6px;\n  background: var(--bg-tertiary);\n  border-radius: 10px;\n  box-shadow: var(--shadow-sm);\n  cursor: help;\n  margin-right: 8px;\n  border: 1px solid var(--border-color);\n  transition: all 0.3s ease;\n}\n.player-agility:hover,\n.player-stats:hover,\n.teammate-agility:hover,\n.teammate-speed:hover,\n.teammate-stats:hover {\n  background: var(--primary-color);\n  color: white;\n  transform: translateY(-1px);\n}\n.tooltip {\n  position: relative;\n  display: inline-block;\n}\n.tooltip .tooltip-text {\n  visibility: hidden;\n  width: 180px;\n  background: rgba(0, 0, 0, 0.9);\n  color: #ffffff;\n  text-align: center;\n  border-radius: 6px;\n  padding: 6px;\n  position: absolute;\n  z-index: 999;\n  bottom: 125%;\n  left: 50%;\n  margin-left: -90px;\n  opacity: 0;\n  transition: opacity 0.3s;\n  font-size: 11px;\n  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);\n  border: 1px solid var(--primary-color);\n  pointer-events: none;\n  backdrop-filter: blur(10px);\n}\n.tooltip .tooltip-text::after {\n  content: '';\n  position: absolute;\n  top: 100%;\n  left: 50%;\n  margin-left: -5px;\n  border-width: 5px;\n  border-style: solid;\n  border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;\n}\n.tooltip:hover .tooltip-text {\n  visibility: visible;\n  opacity: 1;\n}\n.fa,\n.fas,\n.far,\n.fal,\n.fad,\n.fab,\n.fa-solid {\n  margin-right: 5px;\n  vertical-align: middle;\n}\n.player-weapons h3,\n.player-items h3 {\n  font-size: 14px;\n  margin-bottom: 8px;\n  color: var(--primary-light);\n}\n.weapons-list {\n  display: grid;\n  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));\n  gap: 8px;\n  max-height: 140px;\n  overflow-y: auto;\n  overflow-x: hidden;\n  padding-right: 5px;\n}\n.weapon-item {\n  padding: 8px;\n  background: rgba(30, 41, 59, 0.7);\n  border-radius: 6px;\n  box-shadow: var(--shadow-sm);\n  transition: all 0.3s ease;\n  border: 1px solid var(--border-color);\n  position: relative;\n  backdrop-filter: blur(5px);\n}\n.weapon-item:hover {\n  transform: translateY(-2px);\n  box-shadow: var(--shadow-glow);\n  border-color: var(--primary-color);\n}\n.weapon-name {\n  font-weight: bold;\n  margin-bottom: 4px;\n  color: var(--primary-light);\n  font-size: 12px;\n}\n.weapon-type {\n  font-size: 10px;\n  margin-bottom: 4px;\n  color: var(--text-muted);\n  display: inline-block;\n  padding: 2px 5px;\n  background: var(--bg-tertiary);\n  border-radius: 8px;\n  border: 1px solid var(--border-color);\n}\n.weapon-stats {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 4px;\n  font-size: 9px;\n  margin-top: 5px;\n}\n.weapon-stat {\n  padding: 2px 6px;\n  background: var(--bg-tertiary);\n  border-radius: 6px;\n  color: var(--text-light);\n  position: relative;\n  border: 1px solid var(--border-color);\n  font-size: 9px;\n}\n.pilots-container h3 {\n  font-size: 14px;\n  margin-bottom: 8px;\n  color: var(--secondary-color);\n}\n.enemies-list {\n  display: grid;\n  grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));\n  gap: 8px;\n  max-height: 140px;\n  overflow-y: auto;\n  overflow-x: hidden;\n  padding-right: 5px;\n}\n.enemy-item {\n  padding: 8px;\n  background: rgba(30, 41, 59, 0.7);\n  border-radius: 6px;\n  box-shadow: var(--shadow-sm);\n  border: 1px solid var(--border-color);\n  cursor: pointer;\n  transition: all 0.3s ease;\n  backdrop-filter: blur(5px);\n}\n.enemy-item:not(.selected) {\n  opacity: 0.6;\n  border-color: var(--text-muted);\n}\n.enemy-item.selected {\n  border-color: var(--secondary-color);\n  box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);\n  opacity: 1;\n}\n.enemy-item:hover {\n  transform: translateY(-2px);\n  opacity: 1;\n}\n.enemy-name {\n  font-weight: bold;\n  margin-bottom: 4px;\n  color: var(--secondary-color);\n  font-size: 12px;\n}\n.enemy-hp {\n  display: flex;\n  align-items: center;\n  margin-bottom: 5px;\n}\n.enemy-agility {\n  font-size: 10px;\n  margin-bottom: 4px;\n  color: var(--text-muted);\n  display: inline-block;\n  padding: 2px 5px;\n  background: var(--bg-tertiary);\n  border-radius: 8px;\n  cursor: help;\n  border: 1px solid var(--border-color);\n}\n.enemy-skills {\n  font-size: 10px;\n  color: var(--text-light);\n  margin-top: 4px;\n  padding: 4px;\n  background: var(--bg-tertiary);\n  border-radius: 4px;\n  border: 1px solid var(--border-color);\n}\n.battle-button {\n  display: block;\n  margin: 0 auto;\n  padding: 7px 14px;\n  background: var(--gradient-primary);\n  color: white;\n  border: none;\n  border-radius: 16px;\n  font-family: var(--font-rpg);\n  font-size: 13px;\n  font-weight: bold;\n  cursor: pointer;\n  box-shadow: var(--shadow-md);\n  transition: all 0.3s ease;\n  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);\n}\n.battle-button:hover {\n  transform: translateY(-3px);\n  box-shadow: var(--shadow-glow);\n  background: var(--gradient-secondary);\n}\n.battle-button:active {\n  transform: translateY(-1px);\n  box-shadow: var(--shadow-sm);\n}\n#combat-interface {\n  width: 100%;\n  max-width: 800px;\n  display: none;\n  border-radius: 15px;\n  overflow: hidden;\n  background: rgba(30, 41, 59, 0.95);\n  backdrop-filter: blur(15px);\n  border: 1px solid rgba(51, 65, 85, 0.8);\n}\n#combat-display {\n  display: grid;\n  grid-template-columns: 1fr 2fr;\n  gap: 8px;\n  margin-bottom: 8px;\n  padding: 0 8px;\n}\n#combat-player-panel {\n  max-height: 180px;\n  overflow-y: auto;\n  overflow-x: hidden;\n  padding-right: 5px;\n}\n.combat-entity {\n  padding: 8px;\n  background: var(--bg-secondary);\n  border-radius: 10px;\n  box-shadow: var(--shadow-sm);\n  margin-bottom: 6px;\n  position: relative;\n  cursor: pointer;\n  transition: all 0.3s ease;\n  border: 2px solid transparent;\n}\n.combat-entity.player {\n  border-color: var(--primary-color);\n  box-shadow: 0 0 15px rgba(139, 92, 246, 0.2);\n}\n.combat-entity.teammate {\n  border-color: var(--accent-color);\n  padding: 6px;\n  margin-bottom: 4px;\n}\n.combat-entity.teammate.current-teammate {\n  box-shadow: 0 0 20px rgba(6, 182, 212, 0.4);\n  transform: translateY(-2px);\n}\n.combat-entity.enemy {\n  border-color: var(--secondary-color);\n  box-shadow: 0 0 15px rgba(239, 68, 68, 0.2);\n}\n.combat-entity.selected {\n  border-color: #fbbf24;\n  background: rgba(251, 191, 36, 0.1);\n  transform: translateY(-2px);\n  box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);\n}\n.combat-entity.current-actor {\n  box-shadow: 0 0 25px rgba(251, 191, 36, 0.5);\n  animation: pulse-gold 2s infinite;\n}\n\n      @keyframes pulse-gold {\n        0% {\n          box-shadow: 0 0 25px rgba(251, 191, 36, 0.5);\n        }\n        50% {\n          box-shadow: 0 0 35px rgba(251, 191, 36, 0.8);\n        }\n        100% {\n          box-shadow: 0 0 25px rgba(251, 191, 36, 0.5);\n        }\n      }\n      .entity-header {\n        margin-bottom: 6px;\n        padding-bottom: 4px;\n        border-bottom: 1px solid var(--border-color);\n      }\n      .entity-name {\n        font-size: 13px;\n        font-weight: bold;\n        color: var(--primary-light);\n      }\n      .combat-entity.enemy .entity-name {\n        color: var(--secondary-color);\n      }\n      .entity-stats {\n        margin-bottom: 6px;\n      }\n      .hp-bar-container,\n      .mp-bar-container,\n      .ap-bar-container,\n      .shield-bar-container {\n        display: flex;\n        align-items: center;\n        margin-bottom: 4px;\n      }\n      .hp-bar-label,\n      .mp-bar-label,\n      .ap-bar-label,\n      .shield-bar-label {\n        font-weight: bold;\n        width: 25px;\n        margin-right: 8px;\n        font-size: 11px;\n        color: var(--text-light);\n      }\n      .hp-bar-combat,\n      .mp-bar-combat,\n      .ap-bar-combat,\n      .shield-bar-combat {\n        flex-grow: 1;\n        height: 14px;\n        background: var(--bg-tertiary);\n        border-radius: 7px;\n        overflow: visible;\n        position: relative;\n        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);\n        border: 1px solid var(--border-color);\n        min-width: 150px;\n      }\n      .hp-fill-combat {\n        height: 100%;\n        background: var(--gradient-secondary);\n        border-radius: 7px;\n        transition: width 0.5s ease;\n        box-shadow: 0 0 8px rgba(239, 68, 68, 0.3);\n      }\n      .mp-fill-combat {\n        height: 100%;\n        background: var(--gradient-primary);\n        border-radius: 7px;\n        transition: width 0.5s ease;\n        box-shadow: 0 0 8px rgba(59, 130, 246, 0.3);\n      }\n      .ap-fill-combat {\n        height: 100%;\n        background: linear-gradient(135deg, #fbbf24, #f59e0b);\n        border-radius: 7px;\n        transition: width 0.5s ease;\n        box-shadow: 0 0 8px rgba(251, 191, 36, 0.3);\n      }\n      .shield-bar-combat {\n        background: rgba(6, 182, 212, 0.15);\n        border: 1px solid rgba(6, 182, 212, 0.4);\n        border-radius: 7px;\n        overflow: visible;\n        position: relative;\n      }\n      .hp-text-combat,\n      .mp-text-combat,\n      .ap-text-combat,\n      .shield-text-combat {\n        position: absolute;\n        top: 50%;\n        left: 50%;\n        transform: translate(-50%, -50%);\n        color: var(--text-color);\n        font-weight: bold;\n        font-size: 9px;\n        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);\n        white-space: nowrap;\n        width: max-content;\n        max-width: 200px;\n        overflow: hidden;\n        text-overflow: ellipsis;\n      }\n      .shield-text-combat {\n        color: #06b6d4;\n      }\n      .stat-grid {\n        display: grid;\n        grid-template-columns: 1fr 1fr;\n        gap: 6px;\n        margin-top: 6px;\n      }\n      .stat-box {\n        padding: 5px;\n        background-color: var(--card-bg);\n        border-radius: 5px;\n        box-shadow: var(--shadow-sm);\n        text-align: center;\n        cursor: help;\n      }\n\n      .stat-row {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding: 1px 4px;\n        margin: 1px 0;\n        font-size: 10px;\n        line-height: 1.2;\n        border-radius: 3px;\n        transition: background-color 0.2s ease;\n      }\n      .stat-row:hover {\n        background-color: rgba(255, 255, 255, 0.1);\n      }\n      .stat-row-label {\n        display: flex;\n        align-items: center;\n        gap: 3px;\n        font-size: 9px;\n        opacity: 0.9;\n      }\n      .stat-row-label i {\n        font-size: 8px;\n        width: 12px;\n        text-align: center;\n      }\n      .stat-row-value {\n        font-size: 10px;\n        font-weight: 500;\n        text-align: right;\n      }\n\n      #detailed-stats-display .stat-row {\n        padding: 3px 6px;\n        margin: 2px 0;\n        font-size: 12px;\n        line-height: 1.4;\n      }\n      #detailed-stats-display .stat-row-label {\n        gap: 4px;\n        font-size: 11px;\n      }\n      #detailed-stats-display .stat-row-label i {\n        font-size: 10px;\n        width: 14px;\n      }\n      #detailed-stats-display .stat-row-value {\n        font-size: 12px;\n        font-weight: 600;\n      }\n\n      #detailed-stats-display .category-title {\n        font-size: 12px;\n      }\n      #detailed-stats-display .stat-badge {\n        font-size: 12px;\n        padding: 8px 10px;\n      }\n      #detailed-stats-display .stat-badge i {\n        font-size: 13px;\n      }\n\n      .stat-row.str-based {\n        border-left: 2px solid #ff6b6b;\n      }\n      .stat-row.agi-based {\n        border-left: 2px solid #4ecdc4;\n      }\n      .stat-row.int-based {\n        border-left: 2px solid #45b7d1;\n      }\n      .stat-row.vit-based {\n        border-left: 2px solid #96ceb4;\n      }\n      .stat-row.resistance {\n        border-left: 2px solid #feca57;\n      }\n      .stat-row.recovery {\n        border-left: 2px solid #ec4899;\n      }\n\n      .stat-badge {\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 4px;\n        padding: 6px 8px;\n        background: rgba(139, 92, 246, 0.15);\n        border: 1px solid rgba(139, 92, 246, 0.3);\n        border-radius: 8px;\n        font-size: 10px;\n        font-weight: 600;\n        color: var(--text-color);\n        transition: all 0.3s ease;\n        text-align: center;\n      }\n      .stat-badge:hover {\n        transform: translateY(-2px);\n        box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3);\n      }\n      .stat-badge.str-based {\n        background: rgba(239, 68, 68, 0.15);\n        border-color: rgba(239, 68, 68, 0.4);\n        color: #fca5a5;\n      }\n      .stat-badge.agi-based {\n        background: rgba(16, 185, 129, 0.15);\n        border-color: rgba(16, 185, 129, 0.4);\n        color: #6ee7b7;\n      }\n      .stat-badge.int-based {\n        background: rgba(139, 92, 246, 0.15);\n        border-color: rgba(139, 92, 246, 0.4);\n        color: #c4b5fd;\n      }\n      .stat-badge.vit-based {\n        background: rgba(245, 158, 11, 0.15);\n        border-color: rgba(245, 158, 11, 0.4);\n        color: #fcd34d;\n      }\n      .stat-badge i {\n        font-size: 11px;\n      }\n\n      .character-selector {\n        display: flex;\n        flex-wrap: wrap;\n        gap: 6px;\n        padding: 8px;\n        background: var(--bg-tertiary);\n        border-radius: 10px;\n        margin-bottom: 10px;\n        border: 1px solid var(--border-color);\n      }\n      .char-select-btn {\n        flex: 1;\n        min-width: 80px;\n        padding: 8px 12px;\n        background: rgba(139, 92, 246, 0.1);\n        border: 1px solid rgba(139, 92, 246, 0.3);\n        border-radius: 8px;\n        color: var(--text-light);\n        font-size: 11px;\n        font-weight: 500;\n        cursor: pointer;\n        transition: all 0.3s ease;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 4px;\n      }\n      .char-select-btn:hover {\n        background: rgba(139, 92, 246, 0.2);\n        border-color: rgba(139, 92, 246, 0.5);\n        color: var(--text-color);\n        transform: translateY(-1px);\n      }\n      .char-select-btn.active {\n        background: var(--gradient-primary);\n        border-color: var(--primary-light);\n        color: white;\n        box-shadow: var(--shadow-glow);\n        font-weight: 600;\n      }\n      .char-select-btn.enemy {\n        background: rgba(239, 68, 68, 0.1);\n        border-color: rgba(239, 68, 68, 0.3);\n      }\n      .char-select-btn.enemy:hover {\n        background: rgba(239, 68, 68, 0.2);\n        border-color: rgba(239, 68, 68, 0.5);\n      }\n      .char-select-btn.enemy.active {\n        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);\n        border-color: #f87171;\n      }\n      .char-select-btn i {\n        font-size: 12px;\n      }\n\n      .stats-compact {\n        max-height: 180px;\n        overflow-y: auto;\n        padding: 3px;\n      }\n      .stats-compact::-webkit-scrollbar {\n        width: 4px;\n      }\n      .stats-compact::-webkit-scrollbar-track {\n        background: rgba(255, 255, 255, 0.1);\n        border-radius: 2px;\n      }\n      .stats-compact::-webkit-scrollbar-thumb {\n        background: rgba(255, 255, 255, 0.3);\n        border-radius: 2px;\n      }\n      .stats-compact::-webkit-scrollbar-thumb:hover {\n        background: rgba(255, 255, 255, 0.5);\n      }\n      .stat-label {\n        font-size: 9px;\n        color: var(--text-light);\n        margin-bottom: 2px;\n      }\n      .stat-value {\n        font-size: 11px;\n        font-weight: bold;\n        color: var(--text-color);\n      }\n\n      .stat-category {\n        grid-column: 1 / -1;\n        margin-bottom: 8px;\n      }\n      .category-title {\n        font-size: 12px;\n        font-weight: bold;\n        color: var(--primary-color);\n        margin-bottom: 4px;\n        text-align: center;\n        border-bottom: 1px solid var(--border-color);\n        padding-bottom: 2px;\n      }\n      .stat-row {\n        display: flex;\n        justify-content: space-around;\n        font-size: 10px;\n        color: var(--text-color);\n      }\n      .stat-name {\n        font-weight: bold;\n      }\n\n      .str-based {\n        border-left: 3px solid #ff6b6b; \n      }\n      .agi-based {\n        border-left: 3px solid #4ecdc4; \n      }\n      .int-based {\n        border-left: 3px solid #45b7d1; \n      }\n      .vit-based {\n        border-left: 3px solid #96ceb4; \n      }\n      .resistance {\n        border-left: 3px solid #feca57; \n      }\n      .entity-next-attack {\n        margin-bottom: 8px;\n        padding: 6px;\n        background-color: var(--card-bg);\n        border-radius: 5px;\n        box-shadow: var(--shadow-sm);\n      }\n      .next-attack-title,\n      .weapons-title {\n        font-size: 11px;\n        font-weight: bold;\n        margin-bottom: 5px;\n        color: var(--text-light);\n      }\n      .next-attack-name {\n        font-size: 12px;\n        font-weight: bold;\n        color: var(--secondary-color);\n      }\n\n      .skill-stats-grid {\n        display: grid;\n        grid-template-columns: 1fr 1fr;\n        gap: 4px;\n        margin-top: 6px;\n      }\n      .skill-stat-item {\n        padding: 4px 6px;\n        border-radius: 4px;\n        font-size: 10px;\n        font-weight: 500;\n        text-align: center;\n        transition: all 0.2s ease;\n        position: relative;\n        border: 1px solid transparent;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        gap: 3px;\n      }\n      .skill-stat-item i {\n        font-size: 9px;\n        width: 12px;\n        text-align: center;\n      }\n\n      .skill-attack {\n        background: linear-gradient(135deg, #ff6b6b20, #ff6b6b10);\n        color: #d63031;\n        border-color: #ff6b6b40;\n      }\n      .skill-accuracy {\n        background: linear-gradient(135deg, #4dabf720, #4dabf710);\n        color: #0984e3;\n        border-color: #4dabf740;\n      }\n      .skill-targets {\n        background: linear-gradient(135deg, #00b89420, #00b89410);\n        color: #00a085;\n        border-color: #00b89440;\n      }\n      .skill-times {\n        background: linear-gradient(135deg, #a29bfe20, #a29bfe10);\n        color: #6c5ce7;\n        border-color: #a29bfe40;\n      }\n\n      .skill-stat-item:hover {\n        transform: translateY(-1px);\n        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\n        border-color: var(--secondary-color);\n      }\n      .skill-attack:hover {\n        background: linear-gradient(135deg, #ff6b6b30, #ff6b6b20);\n        border-color: #ff6b6b;\n      }\n      .skill-accuracy:hover {\n        background: linear-gradient(135deg, #4dabf730, #4dabf720);\n        border-color: #4dabf7;\n      }\n      .skill-targets:hover {\n        background: linear-gradient(135deg, #00b89430, #00b89420);\n        border-color: #00b894;\n      }\n      .skill-times:hover {\n        background: linear-gradient(135deg, #a29bfe30, #a29bfe20);\n        border-color: #a29bfe;\n      }\n\n      .stats-toggle-btn {\n        background: rgba(139, 92, 246, 0.2);\n        border: 1px solid var(--primary-color);\n        color: var(--primary-light);\n        padding: 4px 8px;\n        border-radius: 6px;\n        font-size: 10px;\n        cursor: pointer;\n        transition: all 0.3s ease;\n        margin-bottom: 6px;\n        width: 100%;\n        text-align: center;\n      }\n      .stats-toggle-btn:hover {\n        background: rgba(139, 92, 246, 0.3);\n        transform: translateY(-1px);\n      }\n      .stats-collapsible {\n        overflow: hidden;\n        transition: max-height 0.3s ease;\n        max-height: 0;\n      }\n      .stats-collapsible.expanded {\n        max-height: 200px;\n      }\n      .stats-toggle-btn .toggle-icon {\n        transition: transform 0.3s ease;\n        display: inline-block;\n        margin-left: 4px;\n      }\n      .stats-toggle-btn.expanded .toggle-icon {\n        transform: rotate(180deg);\n      }\n      .entity-buffs {\n        display: flex;\n        flex-wrap: wrap;\n        gap: 5px;\n        margin-top: 6px;\n      }\n\n      .entity-hate-list {\n        margin-top: 6px;\n        padding: 6px;\n        background: var(--bg-tertiary);\n        border-radius: 8px;\n        border: 1px solid var(--border-color);\n      }\n      .hate-list-title {\n        font-size: 11px;\n        font-weight: bold;\n        color: var(--secondary-color);\n        margin-bottom: 4px;\n        display: flex;\n        align-items: center;\n        gap: 4px;\n      }\n      .hate-list-content {\n        max-height: 80px;\n        overflow-y: auto;\n      }\n      .hate-item {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        padding: 3px 6px;\n        margin-bottom: 2px;\n        background: var(--card-bg);\n        border-radius: 6px;\n        font-size: 10px;\n        border: 1px solid var(--border-color);\n        transition: all 0.2s ease;\n      }\n      .hate-item.current-target {\n        background: rgba(239, 68, 68, 0.2);\n        border-color: var(--secondary-color);\n        box-shadow: 0 0 8px rgba(239, 68, 68, 0.3);\n      }\n      .hate-item.no-target {\n        text-align: center;\n        color: var(--text-light);\n        font-style: italic;\n        background: transparent;\n        border: 1px dashed var(--border-color);\n      }\n      .hate-target-name {\n        font-weight: bold;\n        color: var(--text-color);\n      }\n      .hate-value {\n        background: var(--secondary-color);\n        color: white;\n        padding: 1px 4px;\n        border-radius: 4px;\n        font-size: 9px;\n        font-weight: bold;\n        min-width: 20px;\n        text-align: center;\n      }\n      .buff {\n        padding: 3px 6px;\n        border-radius: 10px;\n        font-size: 10px;\n        display: flex;\n        align-items: center;\n        cursor: help;\n      }\n      .buff.positive {\n        background-color: var(--mana-bg);\n        color: var(--mana-color);\n      }\n      .buff.negative {\n        background-color: var(--health-bg);\n        color: var(--health-color);\n      }\n      .buff.fire {\n        background-color: #ffedd5;\n        color: var(--fire-color);\n      }\n      .buff.ice {\n        background-color: #e0f2fe;\n        color: var(--ice-color);\n      }\n      .buff.lightning {\n        background-color: #f3e8ff;\n        color: var(--lightning-color);\n      }\n      .buff-name {\n        margin-right: 4px;\n        font-weight: bold;\n      }\n      .buff-duration {\n        font-size: 8px;\n        background-color: rgba(255, 255, 255, 0.5);\n        padding: 1px 3px;\n        border-radius: 5px;\n      }\n\n      .weapon-category-toggle {\n        display: flex;\n        justify-content: space-around;\n        margin-bottom: 8px;\n        background: var(--bg-tertiary);\n        border-radius: 12px;\n        padding: 3px;\n        border: 1px solid var(--border-color);\n      }\n      .category-button {\n        padding: 6px 12px;\n        background: transparent;\n        border: none;\n        border-radius: 10px;\n        font-family: var(--font-rpg);\n        cursor: pointer;\n        font-weight: bold;\n        transition: all 0.3s ease;\n        flex: 1;\n        margin: 0 2px;\n        text-align: center;\n        color: var(--text-light);\n        font-size: 12px;\n      }\n      .category-button.active {\n        background: var(--gradient-primary);\n        color: white;\n        box-shadow: var(--shadow-md);\n        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);\n      }\n      .category-button:hover:not(.active) {\n        background: var(--card-bg);\n        color: var(--text-color);\n      }\n\n      .weapon-panel {\n        display: none;\n        padding: 8px;\n        background: var(--bg-secondary);\n        border-radius: 10px;\n        margin-bottom: 8px;\n        border: 1px solid var(--border-color);\n      }\n      .weapon-panel.active {\n        display: block;\n      }\n      .weapon-buttons,\n      .item-buttons {\n        display: grid;\n        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));\n        gap: 6px;\n        margin-bottom: 6px;\n        max-height: 120px;\n        overflow-y: auto;\n        padding-right: 5px;\n      }\n      .weapon-button,\n      .item-button {\n        padding: 6px;\n        background: var(--card-bg);\n        border: 1px solid var(--border-color);\n        border-radius: 8px;\n        font-family: var(--font-rpg);\n        cursor: pointer;\n        text-align: left;\n        box-shadow: var(--shadow-sm);\n        font-size: 10px;\n        position: relative;\n        transition: all 0.3s ease;\n        color: var(--text-color);\n      }\n      .weapon-button:hover:not(.used),\n      .item-button:hover:not(.used) {\n        transform: translateY(-2px);\n        box-shadow: var(--shadow-glow);\n        border-color: var(--primary-color);\n      }\n      .weapon-button.selected,\n      .item-button.selected {\n        background: var(--gradient-primary);\n        color: white;\n        box-shadow: var(--shadow-glow);\n        border-color: var(--primary-light);\n      }\n      .weapon-button.used,\n      .item-button.used {\n        opacity: 0.4;\n        cursor: not-allowed;\n        background: var(--bg-tertiary);\n        filter: brightness(0.6);\n        border-color: var(--text-muted);\n      }\n      .weapon-button-name {\n        font-weight: bold;\n        margin-bottom: 4px;\n        font-size: 11px;\n      }\n      .weapon-button-stats {\n        display: grid;\n        grid-template-columns: 1fr 1fr;\n        gap: 3px;\n        font-size: 9px;\n        margin-bottom: 3px; \n      }\n      .weapon-effect-codes {\n        margin-top: 3px;\n        font-size: 8px;\n        display: flex;\n        flex-wrap: wrap;\n        gap: 2px;\n      }\n      .weapon-effect-code {\n        padding: 1px 2px;\n        background-color: rgba(0, 0, 0, 0.05);\n        border-radius: 2px;\n        position: relative;\n      }\n      .weapon-button.selected .weapon-effect-code {\n        background-color: rgba(255, 255, 255, 0.2);\n      }\n      .item-button {\n        padding: 6px;\n        background-color: var(--card-bg);\n        border: 1px solid var(--border-color);\n        border-radius: 6px;\n        font-family: var(--font-rpg);\n        cursor: pointer;\n        text-align: left;\n        box-shadow: var(--shadow-sm);\n        font-size: 10px;\n        position: relative;\n        transition: all 0.2s ease;\n      }\n      .item-button:hover:not(.used) {\n        transform: translateY(-2px);\n        box-shadow: var(--shadow-md);\n      }\n      .item-button.selected {\n        background-color: var(--primary-color);\n        color: white;\n        box-shadow: var(--shadow-md);\n        border-color: var(--primary-color);\n      }\n      .item-button.used {\n        opacity: 0.5;\n        cursor: not-allowed;\n        background-color: #2a2a2a;\n        color: #666;\n      }\n      .item-button-name {\n        font-weight: bold;\n        margin-bottom: 4px;\n        font-size: 11px;\n      }\n      .item-button-count {\n        display: inline-block;\n        background-color: rgba(0, 0, 0, 0.1);\n        padding: 1px 4px;\n        border-radius: 10px;\n        font-size: 9px;\n        margin-left: 4px;\n      }\n      .item-button-effect {\n        font-size: 9px;\n        color: var(--text-light);\n        margin-top: 4px;\n      }\n      .item-button.selected .item-button-effect {\n        color: rgba(255, 255, 255, 0.8);\n      }\n      .attack-controls {\n        display: flex;\n        justify-content: center;\n        gap: 10px;\n        margin-top: 8px;\n      }\n      .attack-button,\n      .next-round-button,\n      .mid-action-button {\n        padding: 6px 12px;\n        border: none;\n        border-radius: 14px;\n        font-family: var(--font-rpg);\n        font-size: 12px;\n        font-weight: bold;\n        cursor: pointer;\n        box-shadow: var(--shadow-md);\n        transition: all 0.3s ease;\n        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);\n      }\n      .attack-button {\n        background: var(--gradient-secondary);\n        color: white;\n      }\n      .attack-button:hover:not(:disabled) {\n        transform: translateY(-2px);\n        box-shadow: var(--shadow-glow);\n      }\n      .attack-button:disabled {\n        background: var(--text-muted);\n        opacity: 0.5;\n        cursor: not-allowed;\n      }\n      .next-round-button {\n        background: var(--gradient-primary);\n        color: white;\n      }\n      .next-round-button:hover:not(:disabled) {\n        transform: translateY(-2px);\n        box-shadow: var(--shadow-glow);\n      }\n      .mid-action-button {\n        background: linear-gradient(135deg, #f59e0b, #d97706);\n        color: white;\n      }\n      .mid-action-button:hover:not(:disabled) {\n        transform: translateY(-2px);\n        box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);\n      }\n      #combat-log-container {\n        margin: 8px;\n        padding: 8px;\n        background: var(--bg-secondary);\n        border-radius: 10px;\n        box-shadow: var(--shadow-sm);\n        border: 1px solid var(--border-color);\n      }\n      #combat-log {\n        height: 150px;\n        overflow-y: auto;\n        background: var(--bg-tertiary);\n        border-radius: 8px;\n        padding: 6px;\n        font-size: 11px;\n        color: var(--text-color);\n        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);\n        margin-top: 5px;\n        border: 1px solid var(--border-color);\n      }\n      .log-entry {\n        margin-bottom: 4px;\n        padding-bottom: 4px;\n        border-bottom: 1px solid var(--border-color);\n      }\n      .result-modal {\n        display: none;\n        position: fixed;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: rgba(0, 0, 0, 0.8);\n        backdrop-filter: blur(5px);\n        justify-content: center;\n        align-items: center;\n        z-index: 1000;\n      }\n      .result-content {\n        width: 90%;\n        max-width: 400px;\n        background: rgba(30, 41, 59, 0.95);\n        border-radius: 20px;\n        padding: 25px;\n        box-shadow: var(--shadow-lg);\n        text-align: center;\n        border: 1px solid rgba(51, 65, 85, 0.8);\n        backdrop-filter: blur(15px);\n      }\n      .result-title {\n        font-size: 18px;\n        margin-bottom: 15px;\n        color: var(--primary-light);\n      }\n      .victory {\n        color: var(--success-color);\n      }\n      .defeat {\n        color: var(--secondary-color);\n      }\n      .result-summary {\n        margin-bottom: 20px;\n        font-size: 13px;\n        line-height: 1.5;\n        color: var(--text-light);\n      }\n      .btn {\n        padding: 10px 20px;\n        background: var(--gradient-primary);\n        color: white;\n        border: none;\n        border-radius: 18px;\n        font-family: var(--font-rpg);\n        font-size: 13px;\n        font-weight: bold;\n        cursor: pointer;\n        box-shadow: var(--shadow-md);\n        transition: all 0.3s ease;\n        margin: 0 5px;\n      }\n      .btn:hover {\n        transform: translateY(-2px);\n        box-shadow: var(--shadow-glow);\n      }\n\n      ::-webkit-scrollbar {\n        width: 6px;\n      }\n      ::-webkit-scrollbar-track {\n        background: var(--bg-tertiary);\n        border-radius: 6px;\n      }\n      ::-webkit-scrollbar-thumb {\n        background: var(--primary-color);\n        border-radius: 6px;\n      }\n      ::-webkit-scrollbar-thumb:hover {\n        background: var(--primary-light);\n      }\n\n      .action-order-container {\n        margin: 10px;\n        padding: 8px;\n        background-color: var(--bg-color);\n        border-radius: 8px;\n        box-shadow: var(--shadow-sm);\n      }\n      .action-order-title {\n        font-size: 14px;\n        font-weight: bold;\n        margin-bottom: 8px;\n        color: var(--primary-color);\n      }\n      .action-order-display {\n        display: flex;\n        overflow-x: auto;\n        padding: 5px 0;\n        margin-bottom: 5px;\n      }\n      .action-order-item {\n        flex: 0 0 auto;\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        margin: 0 5px;\n        padding: 5px;\n        border-radius: 5px;\n        min-width: 60px;\n        position: relative;\n      }\n      .action-order-item.player,\n      .action-order-item.teammate {\n        background-color: rgba(99, 102, 241, 0.1);\n        border: 1px solid var(--primary-color);\n      }\n      .action-order-item.enemy {\n        background-color: rgba(244, 63, 94, 0.1);\n        border: 1px solid var(--secondary-color);\n      }\n      .action-order-item.current {\n        transform: translateY(-5px);\n        box-shadow: var(--shadow-md);\n      }\n      .action-order-item.player.current,\n      .action-order-item.teammate.current {\n        background-color: rgba(99, 102, 241, 0.2);\n      }\n      .action-order-item.enemy.current {\n        background-color: rgba(244, 63, 94, 0.2);\n      }\n      .action-order-name {\n        font-size: 11px;\n        font-weight: bold;\n        margin-bottom: 3px;\n        white-space: nowrap;\n        overflow: hidden;\n        text-overflow: ellipsis;\n        max-width: 80px;\n      }\n      .action-order-item.player .action-order-name,\n      .action-order-item.teammate .action-order-name {\n        color: var(--primary-color);\n      }\n      .action-order-item.enemy .action-order-name {\n        color: var(--secondary-color);\n      }\n      .action-order-speed {\n        font-size: 9px;\n        color: var(--text-light);\n      }\n      .action-order-number {\n        position: absolute;\n        top: -8px;\n        right: -8px;\n        background-color: var(--card-bg);\n        border-radius: 50%;\n        width: 16px;\n        height: 16px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 9px;\n        font-weight: bold;\n        box-shadow: var(--shadow-sm);\n      }\n      .action-order-item.player .action-order-number,\n      .action-order-item.teammate .action-order-number {\n        color: var(--primary-color);\n        border: 1px solid var(--primary-color);\n      }\n      .action-order-item.enemy .action-order-number {\n        color: var(--secondary-color);\n        border: 1px solid var(--secondary-color);\n      }\n      .action-order-arrow {\n        margin: 0 -2px;\n        color: var(--text-light);\n        align-self: center;\n        font-size: 12px;\n      }\n\n      .preparation-details {\n        border: none;\n        width: 100%;\n        margin: 0;\n        padding: 0;\n        color: var(--text-color);\n        font-family: var(--font-rpg);\n      }\n      .preparation-summary {\n        display: flex;\n        align-items: center;\n        width: 100%;\n        cursor: pointer;\n        font-weight: bold;\n        list-style: none;\n        outline: none;\n        transition: all 0.3s ease;\n        position: relative;\n        box-sizing: border-box;\n      }\n\n      .preparation-summary::-webkit-details-marker,\n      .preparation-summary::marker {\n        display: none;\n        content: '';\n      }\n\n      .preparation-summary::before {\n        content: '';\n        display: inline-block;\n        line-height: 1;\n        font-size: 1.1em;\n        margin-right: 6px;\n      }\n\n      .preparation-details:not([open]) &gt; .preparation-summary {\n        padding: 4px 8px 5px 8px;\n        font-size: 16px;\n        line-height: 1.2;\n        margin-bottom: 0;\n        background: var(--gradient-primary);\n        color: white;\n        border-radius: 8px;\n        border: none !important;\n        box-shadow: var(--shadow-md);\n        justify-content: flex-start;\n        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);\n      }\n\n      .preparation-details:not([open]) &gt; .preparation-summary:hover {\n        background: var(--gradient-secondary);\n        transform: translateY(-1px);\n        box-shadow: var(--shadow-glow);\n      }\n\n      .preparation-details[open] &gt; .preparation-summary {\n        padding: 10px 8px;\n        font-size: 18px;\n        line-height: initial;\n        margin-bottom: 5px;\n        border: 2px solid var(--primary-light);\n        border-radius: 5px;\n        background: var(--gradient-primary);\n        color: white;\n        justify-content: flex-start;\n        box-shadow: var(--shadow-glow);\n        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);\n        left: 1px;\n      }\n\n      .preparation-details &gt; .preparation-summary:active {\n        padding: 10px 8px;\n        font-size: 18px;\n        line-height: initial;\n        background-color: var(--primary-dark);\n        color: white;\n        box-shadow: inset 1px 1px 0px 1px rgba(255, 255, 255, 0.2), inset -1px -1px 0px 1px rgba(0, 0, 0, 0.2);\n        filter: drop-shadow(1px 1px 0px rgba(0, 0, 0, 0.3));\n        top: 1px;\n        left: 1px;\n        border: 2px solid var(--primary-dark);\n        border-radius: 5px;\n        justify-content: flex-start;\n        margin-bottom: 5px;\n      }\n\n      .preparation-details &gt; div {\n        overflow: hidden;\n        transition: max-height 0.3s ease-out;\n      }\n\n      .preparation-details[open] &gt; .preparation-summary::before,\n      .preparation-details &gt; .preparation-summary:active::before {\n        margin-right: 8px;\n      }\n      #combat-enemy-panel {\n        display: grid;\n        grid-template-columns: repeat(2, 1fr); \n        gap: 8px;\n        max-height: 180px; \n        overflow-y: auto;\n        overflow-x: hidden;\n      }\n      #combat-title {\n        text-align: center;\n        color: var(--primary-light);\n        font-family: var(--font-rpg);\n        margin: 20px 0;\n        font-size: 18px;\n        text-shadow: 0 0 10px rgba(167, 139, 250, 0.5);\n      }\n      .status-effect {\n        cursor: help;\n        position: relative;\n      }\n      .status-effect .effect-tooltip {\n        visibility: hidden;\n        width: 180px;\n        background: rgba(0, 0, 0, 0.9);\n        color: #ffffff;\n        text-align: center;\n        border-radius: 6px;\n        padding: 6px;\n        position: absolute;\n        z-index: 999;\n        bottom: 125%;\n        left: 50%;\n        margin-left: -90px;\n        opacity: 0;\n        transition: opacity 0.3s;\n        font-size: 10px;\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);\n        border: 1px solid var(--primary-color);\n        pointer-events: none;\n        white-space: normal;\n        word-wrap: break-word;\n        backdrop-filter: blur(10px);\n      }\n      .status-effect .effect-tooltip::after {\n        content: '';\n        position: absolute;\n        top: 100%;\n        left: 50%;\n        margin-left: -5px;\n        border-width: 5px;\n        border-style: solid;\n        border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;\n      }\n      .status-effect:hover .effect-tooltip {\n        visibility: visible;\n        opacity: 1;\n      }\n      #combat-player-actions {\n        margin: 8px;\n        padding: 8px;\n        background-color: var(--bg-color);\n        border-radius: 8px;\n        box-shadow: var(--shadow-sm);\n      }\n      .self-target-indicator {\n        position: absolute;\n        top: 5px;\n        right: 5px;\n        background-color: var(--heal-color);\n        color: white;\n        border-radius: 50%;\n        width: 18px;\n        height: 18px;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        font-size: 10px;\n        font-weight: bold;\n        box-shadow: var(--shadow-sm);\n        opacity: 0;\n        transition: opacity 0.3s ease;\n      }\n      .combat-entity.player.selectable .self-target-indicator {\n        opacity: 1;\n      }\n      @keyframes attack-forward {\n        0% {\n          transform: translateX(0);\n        }\n        50% {\n          transform: translateX(30px);\n        }\n        100% {\n          transform: translateX(0);\n        }\n      }\n      @keyframes attack-backward {\n        0% {\n          transform: translateX(0);\n        }\n        50% {\n          transform: translateX(-30px);\n        }\n        100% {\n          transform: translateX(0);\n        }\n      }\n      .attack-animation-forward {\n        animation: attack-forward 0.8s ease;\n      }\n      .attack-animation-backward {\n        animation: attack-backward 0.8s ease;\n      }\n      @keyframes shake {\n        0% {\n          transform: translateX(0);\n        }\n        25% {\n          transform: translateX(-12px);\n        }\n        50% {\n          transform: translateX(12px);\n        }\n        75% {\n          transform: translateX(-8px);\n        }\n        100% {\n          transform: translateX(0);\n        }\n      }\n      .shake-animation {\n        animation: shake 0.8s ease;\n      }\n      @keyframes damage-number {\n        0% {\n          opacity: 0;\n          transform: translateY(0);\n        }\n        10% {\n          opacity: 1;\n          transform: translateY(-5px);\n        }\n        80% {\n          opacity: 1;\n          transform: translateY(-25px);\n        }\n        100% {\n          opacity: 0;\n          transform: translateY(-40px);\n        }\n      }\n      .damage-number {\n        position: absolute;\n        color: var(--secondary-color);\n        font-weight: bold;\n        font-size: 16px;\n        z-index: 10;\n        pointer-events: none;\n        animation: damage-number 1.2s forwards;\n        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);\n      }\n      .damage-number.critical {\n        color: var(--health-color);\n        font-size: 18px;\n        text-shadow: 0 0 8px rgba(239, 68, 68, 0.6);\n      }\n      .heal-number {\n        position: absolute;\n        color: var(--heal-color);\n        font-weight: bold;\n        font-size: 16px;\n        z-index: 10;\n        pointer-events: none;\n        animation: damage-number 1.2s forwards;\n        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);\n      }\n      @keyframes hp-change {\n        0% {\n          opacity: 0.3;\n        }\n        50% {\n          opacity: 1;\n          background-color: #ffb3b3;\n        }\n        100% {\n          opacity: 1;\n        }\n      }\n      .hp-change-animation {\n        animation: hp-change 0.8s ease;\n      }\n      @keyframes heal-pulse {\n        0% {\n          box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);\n        }\n        70% {\n          box-shadow: 0 0 0 15px rgba(16, 185, 129, 0);\n        }\n        100% {\n          box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);\n        }\n      }\n      .heal-pulse-animation {\n        animation: heal-pulse 0.8s ease;\n      }\n      @keyframes death-flash {\n        0% {\n          opacity: 0;\n        }\n        50% {\n          opacity: 1;\n        }\n        100% {\n          opacity: 0;\n        }\n      }\n      .death-flash {\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        background: radial-gradient(circle, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0) 70%);\n        opacity: 0;\n        animation: death-flash 1s forwards;\n        pointer-events: none;\n        z-index: 5;\n      }\n      @keyframes particle-fade {\n        0% {\n          opacity: 1;\n          transform: translateY(0) scale(1);\n        }\n        100% {\n          opacity: 0;\n          transform: translateY(-50px) scale(0);\n        }\n      }\n      .death-particle {\n        position: absolute;\n        background: rgba(255, 255, 255, 0.8);\n        border-radius: 50%;\n        pointer-events: none;\n        z-index: 6;\n        animation: particle-fade 1.5s ease-out forwards;\n      }\n      .result-extra-text {\n        margin-top: 10px;\n        margin-bottom: 10px;\n        width: 100%;\n      }\n      .result-extra-text textarea {\n        width: 100%;\n        padding: 12px;\n        border: 1px solid var(--border-color);\n        border-radius: 12px;\n        font-family: var(--font-rpg);\n        font-size: 13px;\n        resize: vertical;\n        min-height: 70px;\n        background: var(--bg-tertiary);\n        color: var(--text-color);\n        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);\n      }\n      .result-extra-text textarea:focus {\n        outline: none;\n        border-color: var(--primary-color);\n        box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2);\n      }\n\n      /* ========================================\n         ğŸ”¹ æ‰‹æœºç«¯å“åº”å¼æ ·å¼ (Mobile Responsive Styles)\n         ======================================== */\n      @media (max-width: 768px) {\n        body {\n          padding: 2px;\n          font-size: 12px;\n        }\n        .container {\n          max-width: 100%;\n          margin: 0 auto 3px;\n          border-radius: 10px;\n        }\n        .status-bar {\n          padding: 6px;\n          border-radius: 10px;\n        }\n        .status-header h2 {\n          font-size: 14px;\n        }\n        .player-status,\n        .pilots-container,\n        .teammates-status {\n          margin-bottom: 3px;\n          padding: 6px;\n          border-radius: 8px;\n        }\n        .teammates-list {\n          grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));\n          gap: 4px;\n          max-height: 80px;\n        }\n        .teammate-item {\n          padding: 4px;\n          border-radius: 4px;\n        }\n        .teammate-name {\n          font-size: 11px;\n          margin-bottom: 2px;\n        }\n        .hp-bar,\n        .mp-bar {\n          height: 14px;\n          margin: 0 4px;\n        }\n        .hp-text,\n        .mp-text {\n          min-width: 80px;\n          font-size: 9px;\n        }\n        .weapons-list,\n        .enemies-list {\n          grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));\n          gap: 4px;\n          max-height: 100px;\n        }\n        .weapon-item,\n        .enemy-item {\n          padding: 4px;\n          border-radius: 4px;\n        }\n        .weapon-name,\n        .enemy-name {\n          font-size: 10px;\n          margin-bottom: 2px;\n        }\n        .weapon-type {\n          font-size: 8px;\n          margin-bottom: 2px;\n        }\n        .weapon-stats {\n          font-size: 8px;\n          margin-top: 2px;\n        }\n        .enemy-agility,\n        .enemy-skills {\n          font-size: 8px;\n          margin-bottom: 2px;\n          padding: 6px 12px;\n        }\n        #combat-interface {\n          max-width: 100%;\n          border-radius: 10px;\n        }\n        #combat-display {\n          grid-template-columns: 1fr;\n          gap: 6px;\n          padding: 0 4px;\n        }\n        #combat-player-panel {\n          max-height: 120px;\n          order: 1;\n        }\n        #combat-enemy-panel {\n          order: 2;\n          max-height: 300px;\n          overflow-x: hidden !important;\n          overflow-y: auto !important;\n          display: grid !important;\n          grid-template-columns: 1fr !important;\n          gap: 6px;\n          padding: 4px;\n          padding-right: 8px;\n        }\n        #combat-enemy-panel .combat-entity {\n          width: 100% !important;\n          min-height: auto !important;\n          display: block !important;\n          margin-bottom: 8px !important;\n          white-space: normal;\n        }\n        .combat-entity {\n          padding: 4px;\n          margin-bottom: 3px;\n          border-radius: 6px;\n        }\n        .combat-entity.teammate {\n          padding: 3px;\n          margin-bottom: 2px;\n        }\n        .entity-name {\n          font-size: 11px;\n        }\n        .entity-header {\n          margin-bottom: 3px;\n          padding-bottom: 2px;\n        }\n        .entity-stats {\n          margin-bottom: 3px;\n        }\n        .hp-bar-container,\n        .mp-bar-container {\n          margin-bottom: 2px;\n        }\n        .hp-bar-label,\n        .mp-bar-label {\n          width: 20px;\n          margin-right: 4px;\n          font-size: 9px;\n        }\n        .hp-bar-combat,\n        .mp-bar-combat {\n          height: 12px;\n          min-width: 100px;\n        }\n        .hp-text-combat,\n        .mp-text-combat {\n          font-size: 8px;\n        }\n        /* æ‰‹æœºç«¯æŒ‰é’®ä¼˜åŒ– */\n        .battle-button {\n          padding: 8px 16px;\n          font-size: 12px;\n          margin: 4px;\n        }\n        .attack-button,\n        .next-round-button,\n        .mid-action-button {\n          padding: 8px 12px;\n          font-size: 11px;\n          margin: 2px;\n        }\n        .weapon-button,\n        .item-button {\n          padding: 6px 8px;\n          font-size: 10px;\n          margin: 1px;\n        }\n        /* æ‰‹æœºç«¯æ­¦å™¨å’Œä¸¹è¯é¢æ¿ä¼˜åŒ– */\n        .weapon-buttons,\n        .item-buttons {\n          grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));\n          gap: 4px;\n        }\n        /* æ‰‹æœºç«¯æˆ˜æ–—æ—¥å¿—ä¼˜åŒ– */\n        #combat-log {\n          max-height: 150px;\n          font-size: 10px;\n        }\n        /* æ‰‹æœºç«¯è¡ŒåŠ¨é¡ºåºä¼˜åŒ– */\n        .action-order-display {\n          font-size: 10px;\n          padding: 4px;\n        }\n        /* æ‰‹æœºç«¯ç»“æœå¼¹çª—ä¼˜åŒ– */\n        .result-modal .result-content {\n          width: 95%;\n          max-width: 350px;\n          margin: 10px;\n          padding: 15px;\n        }\n        .result-title {\n          font-size: 16px;\n        }\n        .result-summary {\n          font-size: 11px;\n        }\n        #extra-result-text {\n          font-size: 12px;\n          min-height: 60px;\n        }\n        /* æ‰‹æœºç«¯æŠ˜å æŒ‰é’®ä¼˜åŒ– */\n        .derived-stats-section .stats-toggle-btn {\n          padding: 6px 10px;\n          font-size: 11px;\n        }\n        .stats-toggle-btn .toggle-icon {\n          font-size: 10px;\n        }\n      }\n      /* ========================================\n         ğŸ”¹ æ‰‹æœºç«¯å“åº”å¼æ ·å¼ç»“æŸ (Mobile Responsive Styles End)\n         ======================================== */\n    &lt;/style&gt;\n\n    &lt;script&gt;\n\n      function calculateDerivedStats(str, agi, int, vit) {\n\n        str = str || 0;\n        agi = agi || 0;\n        int = int || 0;\n        vit = vit || 0;\n        return {\n\n          hpRegen: 10 + vit + Math.floor((vit * vit) / 100),\n          mpRegen: 5 + Math.floor(int / 4),\n          actionPoints: 2 + Math.floor(vit / 20),\n\n          speed: 50 + agi * 2,\n          evasionRate: agi * 0.005,\n          damageBonus: str * 0.01,\n          physicalReduction: str * 1,\n          damageTakenRate: 50 / (50 + vit),\n          extraHitRate: agi * 0.01,\n          extraCritRate: int * 0.01,\n          baseCritMultiplier: 1.5 + int * 0.01,\n          critRateResistance: agi * 0.005 + int * 0.005,\n          critDamageResistance: str * 0.005 + int * 0.005,\n        };\n      }\n\n      function calculateFinalHitRate(weaponHitRate, attackerStats, targetStats) {\n\n        const baseHitRate = weaponHitRate / 100;\n\n        const extraHitRate = attackerStats.extraHitRate;\n\n        const targetEvasionRate = targetStats.evasionRate;\n\n        const finalHitRate = baseHitRate + extraHitRate - targetEvasionRate;\n\n        return Math.max(0, finalHitRate);\n      }\n\n      function calculateFinalCritRate(weaponCritRate, attackerStats, targetStats, finalHitRate) {\n\n        const baseCritRate = weaponCritRate / 100;\n\n        const extraCritRate = attackerStats.extraCritRate;\n\n        const overHitCritBonus = Math.max(0, finalHitRate - 1.0) * 0.5;\n\n        const targetCritResistance = targetStats.critRateResistance;\n\n        const finalCritRate = baseCritRate + extraCritRate + overHitCritBonus - targetCritResistance;\n\n        return Math.max(0, finalCritRate);\n      }\n\n      function calculateFinalCritMultiplier(attackerStats, targetStats, finalCritRate) {\n\n        const baseCritMultiplier = attackerStats.baseCritMultiplier;\n\n        const overCritDamageBonus = Math.max(0, finalCritRate - 1.0) * 0.5;\n\n        const targetCritDamageResistance = targetStats.critDamageResistance;\n\n        const finalCritMultiplier = baseCritMultiplier + overCritDamageBonus - targetCritDamageResistance;\n\n        return Math.max(1.0, finalCritMultiplier);\n      }\n\n      function calculateFinalDamage(weaponDamage, attackerStats, targetStats, isCrit = false, critMultiplier = 1.0) {\n\n        const damageBonus = attackerStats.damageBonus;\n\n        const targetDamageTakenRate = targetStats.damageTakenRate;\n\n        const targetPhysicalReduction = targetStats.physicalReduction;\n\n        let finalDamage = weaponDamage * (1 + damageBonus) * targetDamageTakenRate;\n\n        if (isCrit) {\n          finalDamage *= critMultiplier;\n        }\n\n        finalDamage -= targetPhysicalReduction;\n\n        return Math.max(0, Math.floor(finalDamage));\n      }\n\n      // ç»éªŒå€¼ç³»ç»Ÿå·²ç¦ç”¨\n      // function calculateExperienceForCharacter(characterLevel, teammateCount, defeatedEnemies) {\n      //   let totalExp = 0;\n      //   let expDetails = [];\n      //   defeatedEnemies.forEach(enemy =&gt; {\n      //     \n      //     const baseExp = (enemy.grade || 1) * 8;\n      //     \n      //     const levelDiff = (enemy.grade || 1) - characterLevel;\n      //     const levelMultiplier = Math.pow(1.2, levelDiff);\n      //     \n      //     const teamModifier = 1 / (1 + teammateCount * 0.1);\n      //     \n      //     const enemyExp = Math.floor(baseExp * levelMultiplier * teamModifier);\n      //     totalExp += enemyExp;\n      //     expDetails.push({\n      //       enemyName: enemy.name,\n      //       enemyLevel: enemy.grade || 1,\n      //       baseExp: baseExp,\n      //       levelDiff: levelDiff,\n      //       levelMultiplier: levelMultiplier.toFixed(2),\n      //       teamModifier: teamModifier.toFixed(2),\n      //       finalExp: enemyExp,\n      //     });\n      //   });\n      //   return {\n      //     totalExp: totalExp,\n      //     details: expDetails,\n      //   };\n      // }\n\n      // ç»éªŒå€¼ç³»ç»Ÿå·²ç¦ç”¨\n      // function calculateTeamExperience(player, teammates, defeatedEnemies) {\n      //   const teammateCount = teammates ? teammates.length : 0;\n      //   \n      //   const playerResult = calculateExperienceForCharacter(player.grade || 1, teammateCount, defeatedEnemies);\n      //   \n      //   const teammateResults = [];\n      //   if (teammates &amp;&amp; teammates.length &gt; 0) {\n      //     teammates.forEach(teammate =&gt; {\n      //       const teammateResult = calculateExperienceForCharacter(teammate.grade || 1, teammateCount, defeatedEnemies);\n      //       teammateResults.push({\n      //         name: teammate.name,\n      //         level: teammate.grade || 1,\n      //         exp: teammateResult.totalExp,\n      //         details: teammateResult.details,\n      //       });\n      //     });\n      //   }\n      //   return {\n      //     playerExp: playerResult.totalExp,\n      //     playerDetails: playerResult.details,\n      //     teammateResults: teammateResults,\n      //   };\n      // }\n\n      function collectBattleStatistics() {\n\n        const stats = {\n          weaponStats: [],\n          itemUsage: [],\n          killedEnemies: [],\n        };\n\n        if (battleState.weaponUsage) {\n\n          Object.entries(battleState.weaponUsage).forEach(([name, data]) =&gt; {\n            stats.weaponStats.push({\n              name: name,\n              damage: data.damage || 0,\n              kills: data.kills || 0,\n            });\n          });\n\n          stats.weaponStats.sort((a, b) =&gt; b.damage - a.damage);\n        }\n\n        if (battleState.itemUsageStats) {\n          Object.entries(battleState.itemUsageStats).forEach(([itemName, count]) =&gt; {\n            stats.itemUsage.push({\n              name: itemName,\n              count: count,\n            });\n          });\n        }\n\n        if (battleState.killedEnemies) {\n          stats.killedEnemies = [...battleState.killedEnemies];\n        }\n        return stats;\n      }\n\n      const statusDataSource = document.getElementById('status-data-source');\n      const preparationScreen = document.getElementById('preparation-screen');\n      const playerStatus = document.getElementById('player-status');\n      const pilotsContainer = document.getElementById('pilots-container');\n      const combatControls = document.getElementById('combat-controls');\n      const combatInterface = document.getElementById('combat-interface');\n      const combatPlayerPanel = document.getElementById('combat-player-panel');\n      const combatEnemyPanel = document.getElementById('combat-enemy-panel');\n      const meleeWeaponList = document.getElementById('melee-weapon-list');\n      const combatLog = document.getElementById('combat-log');\n      const resultModal = document.getElementById('result-modal');\n      const resultSummary = document.getElementById('result-summary');\n      const extraResultText = document.getElementById('extra-result-text');\n      const closeResultBtn = document.getElementById('close-result');\n      const sendResultBtn = document.getElementById('send-result');\n\n      const weaponSpecialEffects = {\n        A1: () =&gt; `ä¼¤å®³è¾“å‡ºæ¨¡æ¿ï¼šæ”»å‡»æ•Œäºº`,\n        A2: () =&gt; `ç”Ÿå‘½æ¢å¤æ¨¡æ¿ï¼šæ¢å¤HPï¼Œå¯é€‰è‡ªå·±æˆ–é˜Ÿå‹`,\n        A3: () =&gt; `çµåŠ›æ¢å¤æ¨¡æ¿ï¼šæ¢å¤MPï¼Œå¯é€‰è‡ªå·±æˆ–é˜Ÿå‹`,\n        A4: () =&gt; `ç‰ºç‰²å¢ç›Šæ¨¡æ¿ï¼šæ¶ˆè€—HPè·å¾—å¼ºåŠ›å¢ç›Šï¼Œåªèƒ½å¯¹è‡ªå·±ä½¿ç”¨`,\n      };\n\n      const enchantmentEffects = {\n        B1: percent =&gt; `ç”Ÿå‘½çªƒå–ï¼šæ”»å‡»é€ æˆä¼¤å®³çš„${percent}%è½¬åŒ–ä¸ºç”Ÿå‘½å€¼`,\n        B2: (duration, value) =&gt; `å‡ç›Š-å‘½ä¸­ï¼šæ”»å‡»å‘½ä¸­æ—¶ï¼Œç›®æ ‡åœ¨æ¥ä¸‹æ¥${duration}ä¸ªå›åˆå†…å‘½ä¸­ç‡é™ä½${value}%`,\n        B3: (duration, value) =&gt; `å¢ç›Š-æš´å‡»ï¼šæš´å‡»åï¼Œä½ åœ¨æ¥ä¸‹æ¥${duration}ä¸ªå›åˆå†…æš´å‡»ç‡æé«˜${value}%`,\n        B4: duration =&gt; `è§¦å‘-æ™•çœ©ï¼šæš´å‡»æ—¶æ™•çœ©æ•Œäºº${duration}å›åˆ`,\n        B5: (duration, damage) =&gt; `ä¼¤å®³-DOTï¼š${duration}å›åˆå†…æ¯å›åˆé€ æˆ${damage}ç‚¹æŒç»­ä¼¤å®³`,\n        B6: (chance, duration) =&gt; `å‡ ç‡-æ™•çœ©ï¼š${chance}%å‡ ç‡æ™•çœ©ç›®æ ‡${duration}å›åˆ`,\n        B7: (chance, bonus) =&gt; `å‡ ç‡-é¢å¤–ä¼¤å®³ï¼š${chance}%å‡ ç‡é€ æˆ+${bonus}%é¢å¤–ä¼¤å®³`,\n        B8: (duration, bonus) =&gt; `å¢ç›Š-å—ä¼¤åŠ æ·±ï¼š${duration}å›åˆå†…ç›®æ ‡å—åˆ°ä¼¤å®³+${bonus.toString().replace('%', '')}%`,\n        B9: mp =&gt; `æ¢å¤-çµåŠ›ï¼šå‘½ä¸­åæ¢å¤${mp}ç‚¹MP`,\n        B10: (duration, heal) =&gt; `æ¢å¤-ç”Ÿå‘½(æŒç»­)ï¼š${duration}å›åˆå†…æ¯å›åˆæ¢å¤${heal}ç‚¹HP`,\n        B11: (str, duration) =&gt; `å¢ç›Š-æ ¹éª¨ï¼šæ”»å‡»åæ ¹éª¨+${str}ï¼ŒæŒç»­${duration}å›åˆ`,\n        B12: (agi, duration) =&gt; `å¢ç›Š-èº«æ³•ï¼šæ”»å‡»åèº«æ³•+${agi}ï¼ŒæŒç»­${duration}å›åˆ`,\n        B13: (int, duration) =&gt; `å¢ç›Š-ç¥è¯†ï¼šæ”»å‡»åç¥è¯†+${int}ï¼ŒæŒç»­${duration}å›åˆ`,\n        B14: (end, duration) =&gt; `å¢ç›Š-æ·¬ä½“ï¼šæ”»å‡»åæ·¬ä½“+${end}ï¼ŒæŒç»­${duration}å›åˆ`,\n        B15: bonus =&gt; `æ ‡è®°-æ˜“ä¼¤ï¼šå‘½ä¸­åæ–½åŠ æ˜“ä¼¤æ ‡è®°ï¼Œä¸‹æ¬¡æ”»å‡»+${bonus}%é¢å¤–ä¼¤å®³`,\n        B16: bonus =&gt; `æ ‡è®°-ç ´ç»½ï¼šå‘½ä¸­åæ–½åŠ ç ´ç»½æ ‡è®°ï¼Œä¸‹æ¬¡æ”»å‡»æš´å‡»ç‡+${bonus}%`,\n        B17: bonus =&gt; `æ ‡è®°-æ­»ç‚¹ï¼šå‘½ä¸­åæ–½åŠ æ­»ç‚¹æ ‡è®°ï¼Œä¸‹æ¬¡æ”»å‡»æš´å‡»ä¼¤å®³+${bonus}%`,\n        B18: (stacks, damage) =&gt; `å åŠ -åˆ›ä¼¤ï¼šå‘½ä¸­åæ–½åŠ ${stacks}å±‚åˆ›ä¼¤ï¼Œæ¯å±‚æ¯å›åˆé€ æˆ${damage}ç‚¹ä¼¤å®³`,\n        B19: (stacks, bonus) =&gt; `å åŠ -è…èš€ï¼šå‘½ä¸­åæ–½åŠ ${stacks}å±‚è…èš€ï¼Œæ¯å±‚ä½¿å—åˆ°ä¼¤å®³+${bonus}%`,\n        B20: shield =&gt; `æŠ¤ç›¾-å›ºåŒ–ï¼šå‘½ä¸­åè·å¾—${shield}ç‚¹æ°¸ä¹…æŠ¤ç›¾ï¼Œå†æ¬¡è§¦å‘æ¢å¤è‡³æœ€å¤§å€¼`,\n        B21: shield =&gt; `æŠ¤ç›¾-ç¬å‘å åŠ ï¼šå‘½ä¸­åè·å¾—${shield}ç‚¹ä¸´æ—¶æŠ¤ç›¾ï¼ˆ1å›åˆï¼‰ï¼Œå¯å åŠ `,\n        B22: (duration, shield) =&gt; `æŠ¤ç›¾-æŒç»­å åŠ ï¼šå‘½ä¸­å${duration}å›åˆå†…æ¯å›åˆè·å¾—${shield}ç‚¹æŠ¤ç›¾ï¼Œå¯å åŠ `,\n      };\nfunction parseStatusData(data) {\n  const battleData = {\n    player: {\n      name: '',\n      grade: 0, \n      hp: 0,\n      maxHp: 0,\n      hpRegen: 0, \n      mp: 0,\n      maxMp: 0,\n      mpRegen: 0,\n      agility: 0,\n      speed: 0, \n      ap: 0, \n      maxAp: 0, \n\n      weapons: [],\n      items: [],\n    },\n    teammates: [], \n    enemies: [],\n  };\n\n  const playerMatch = data.match(/\\[PR:([^\\]]+)\\]/);\n  if (playerMatch) battleData.player.name = playerMatch[1];\n\n  const gradeMatch = data.match(/\\[GR:(\\d+)\\]/);\n  if (gradeMatch) battleData.player.grade = parseInt(gradeMatch[1]);\n  const hpMatch = data.match(/\\[HP:(\\d+(?:\\.\\d+)?)\\/(\\d+(?:\\.\\d+)?)\\]/);\n  if (hpMatch) {\n    battleData.player.hp = parseFloat(hpMatch[1]);\n    battleData.player.maxHp = parseFloat(hpMatch[2]);\n  }\n  const mpMatch = data.match(/\\[MP:(\\d+(?:\\.\\d+)?)\\/(\\d+(?:\\.\\d+)?)\\]/);\n  if (mpMatch) {\n    battleData.player.mp = parseFloat(mpMatch[1]);\n    battleData.player.maxMp = parseFloat(mpMatch[2]);\n  }\n\n  const hpRegenMatch = data.match(/\\[HPRE:(\\d+(?:\\.\\d+)?)\\]/);\n  if (hpRegenMatch) battleData.player.hpRegen = parseFloat(hpRegenMatch[1]);\n  const mpRegenMatch = data.match(/\\[MPRE:(\\d+(?:\\.\\d+)?)\\]/);\n  if (mpRegenMatch) battleData.player.mpRegen = parseFloat(mpRegenMatch[1]);\n\n  const speedMatch = data.match(/\\[SD:(\\d+(?:\\.\\d+)?)\\]/);\n  if (speedMatch) battleData.player.speed = parseFloat(speedMatch[1]);\n\n  const apMatch = data.match(/\\[AP:(\\d+(?:\\.\\d+)?)\\]/);\n  if (apMatch) {\n    battleData.player.ap = parseFloat(apMatch[1]);\n    battleData.player.maxAp = parseFloat(apMatch[1]);\n  }\n\n  const strMatch = data.match(/\\[STR:(\\d+)\\]/);\n  const agiMatch = data.match(/\\[AGI:(\\d+)\\]/);\n  const intMatch = data.match(/\\[INT:(\\d+)\\]/);\n  const vitMatch = data.match(/\\[VIT:(\\d+)\\]/);\n  if (strMatch) battleData.player.str = parseInt(strMatch[1]);\n  if (agiMatch) battleData.player.agi = parseInt(agiMatch[1]);\n  if (intMatch) battleData.player.int = parseInt(intMatch[1]);\n  if (vitMatch) battleData.player.vit = parseInt(vitMatch[1]);\n\n  const str = battleData.player.str || 0;\n  const agi = battleData.player.agi || 0;\n  const int = battleData.player.int || 0;\n  const vit = battleData.player.vit || 0;\n\n  const derivedStats = calculateDerivedStats(str, agi, int, vit);\n\n  Object.assign(battleData.player, derivedStats);\n\n  battleData.player.ap = derivedStats.actionPoints;\n  battleData.player.maxAp = derivedStats.actionPoints;\n\n  const itemRegex = /\\[IT:([^,]+),(\\d+)\\]\\[P(\\d+),(\\d+(?:\\.\\d+)?)(?:,(\\d+))?\\]/g;\n  let itemMatch;\n  while ((itemMatch = itemRegex.exec(data)) !== null) {\n    const item = {\n      name: itemMatch[1],\n      count: parseInt(itemMatch[2]),\n      type: parseInt(itemMatch[3]), \n      value: parseFloat(itemMatch[4]), \n      duration: itemMatch[5] ? parseInt(itemMatch[5]) : null, \n      used: false,\n    };\n    battleData.player.items.push(item);\n  }\n\n  const weaponRegex =\n    /\\[WE:(.*?)\\]\\[ATK:(\\d+(?:\\.\\d+)?)\\]\\[Hit%:(\\d+(?:\\.\\d+)?)(?:%)?]\\[Crit%:(\\d+(?:\\.\\d+)?)(?:%)?]\\[APT:(\\d+)\\]\\[TPA:(\\d+)\\]\\[MPCost:(-?\\d+(?:\\.\\d+)?)\\](?:\\[CD:(\\d+)\\])?((?:\\[(?:EN|WN):[^\\]]+\\])*)/g;\n  let weaponMatch;\n  while ((weaponMatch = weaponRegex.exec(data)) !== null) {\n    const weapon = {\n      name: weaponMatch[1],\n      attack: parseFloat(weaponMatch[2]),\n      hitRate: parseFloat(weaponMatch[3]),\n      critRate: parseFloat(weaponMatch[4]),\n\n      attacksPerTurn: parseInt(weaponMatch[5]),\n      targetsPerAttack: parseInt(weaponMatch[6]),\n      mpCost: Math.max(0, parseFloat(weaponMatch[7])), \n      cooldown: weaponMatch[8] ? parseInt(weaponMatch[8]) : 0, \n      currentCooldown: 0, \n      codes: [],\n      used: false,\n      isHealing: false,\n    };\n\n    if (weapon.name.includes('æ²»ç–—')) {\n      weapon.isHealing = true;\n    }\n\n    const codesStr = weaponMatch[9]; \n    const codeRegex = /\\[(EN|WN):([^\\]]+)\\]/g;\n    let codeMatch;\n    while ((codeMatch = codeRegex.exec(codesStr)) !== null) {\n      weapon.codes.push(`${codeMatch[1]}:${codeMatch[2]}`);\n    }\n    battleData.player.weapons.push(weapon);\n  }\n\n  const teammateRegex =\n    /\\[FRN:(.*?)\\](?:\\[FRGR:(\\d+)\\])?\\[FRHP:(\\d+(?:\\.\\d+)?)\\/(\\d+(?:\\.\\d+)?)\\]\\[FRMP:(\\d+(?:\\.\\d+)?)\\/(\\d+(?:\\.\\d+)?)\\](?:\\[FRSTR:(\\d+)\\])?(?:\\[FRAGI:(\\d+)\\])?(?:\\[FRINT:(\\d+)\\])?(?:\\[FRVIT:(\\d+)\\])?/g;\n  let teammateMatch;\n  let teammateIndex = 0;\n  while ((teammateMatch = teammateRegex.exec(data)) !== null) {\n\n    const teammate = {\n      id: teammateIndex++,\n      name: teammateMatch[1],\n      grade: teammateMatch[2] ? parseInt(teammateMatch[2]) : 1, \n      hp: parseFloat(teammateMatch[3]),\n      maxHp: parseFloat(teammateMatch[4]),\n      mp: parseFloat(teammateMatch[5]),\n      maxMp: parseFloat(teammateMatch[6]),\n\n      str: teammateMatch[7] ? parseInt(teammateMatch[7]) : 0,\n      agi: teammateMatch[8] ? parseInt(teammateMatch[8]) : 0,\n      int: teammateMatch[9] ? parseInt(teammateMatch[9]) : 0,\n      vit: teammateMatch[10] ? parseInt(teammateMatch[10]) : 0, \n      ap: 0, \n      maxAp: 0, \n      weapons: [],\n      buffs: [],\n      skillUsed: false, \n    };\n\n    const str = teammate.str || 0;\n    const agi = teammate.agi || 0;\n    const int = teammate.int || 0;\n    const vit = teammate.vit || 0;\n\n    const derivedStats = calculateDerivedStats(str, agi, int, vit);\n\n    Object.assign(teammate, derivedStats);\n\n    teammate.ap = derivedStats.actionPoints;\n    teammate.maxAp = derivedStats.actionPoints;\n\n    const startIndex = teammateMatch.index;\n    let endIndex = data.indexOf('[FRN:', startIndex + 1);\n    if (endIndex === -1) endIndex = data.length;\n    const teammateData = data.substring(startIndex, endIndex);\n\n    const weaponRegex =\n      /\\[FRWE:([^\\]]+)\\]\\[ATK:(\\d+(?:\\.\\d+)?)\\]\\[Hit%:(\\d+(?:\\.\\d+)?)(?:%)?]\\[Crit%:(\\d+(?:\\.\\d+)?)(?:%)?]\\[APT:(\\d+)\\]\\[TPA:(\\d+)\\]\\[MPCost:(-?\\d+(?:\\.\\d+)?)\\](?:\\[CD:(\\d+)\\])?((?:\\[(?:WN|EN):[^\\]]+\\])*)/g;\n    let weaponMatch;\n    while ((weaponMatch = weaponRegex.exec(teammateData)) !== null) {\n      const weapon = {\n        name: weaponMatch[1],\n        type: 'ç¥é€š', \n        attack: parseFloat(weaponMatch[2]),\n        hitRate: parseFloat(weaponMatch[3]),\n        critRate: parseFloat(weaponMatch[4]),\n\n        attacksPerTurn: parseInt(weaponMatch[5]),\n        targetsPerAttack: parseInt(weaponMatch[6]),\n        mpCost: Math.max(0, parseFloat(weaponMatch[7])),\n        cooldown: weaponMatch[8] ? parseInt(weaponMatch[8]) : 0, \n        currentCooldown: 0, \n        codes: [],\n        used: false,\n        isHealing: false,\n      };\n\n      if (weapon.name.includes('æ²»ç–—')) {\n        weapon.isHealing = true;\n      }\n\n      const codesStr = weaponMatch[9]; \n      const codeRegex = /\\[(WN|EN):([^\\]]+)\\]/g;\n      let codeMatch;\n      while ((codeMatch = codeRegex.exec(codesStr)) !== null) {\n        weapon.codes.push(`${codeMatch[1]}:${codeMatch[2]}`);\n      }\n      teammate.weapons.push(weapon);\n    }\n    battleData.teammates.push(teammate);\n  }\n\n  const enemyBlocks = data.match(/\\[ENN:.*?\\[PN5A:[^\\]]+\\]/g);\n  if (enemyBlocks) {\n    let enemyIndex = 0;\n    enemyBlocks.forEach(block =&gt; {\n\n      const nameMatch = block.match(/\\[ENN:(.*?)\\]/);\n      const gradeMatch = block.match(/\\[ENGR:(\\d+)\\]/);\n      const hpMatch = block.match(/\\[ENHP:(\\d+(?:\\.\\d+)?)\\/(\\d+(?:\\.\\d+)?)\\]/);\n\n      const strMatch = block.match(/\\[ENSTR:(\\d+)\\]/);\n      const agiMatch = block.match(/\\[ENAGI:(\\d+)\\]/);\n      const intMatch = block.match(/\\[ENINT:(\\d+)\\]/);\n      const vitMatch = block.match(/\\[ENVIT:(\\d+)\\]/);\n      const patternMatch = block.match(/\\[PN5A:([^\\]]+)\\]/);\n      if (nameMatch &amp;&amp; hpMatch &amp;&amp; (strMatch || agiMatch || intMatch || vitMatch)) {\n        const enemy = {\n          id: enemyIndex++,\n          name: nameMatch[1],\n          grade: gradeMatch ? parseInt(gradeMatch[1]) : 1, \n          hp: parseFloat(hpMatch[1]),\n          maxHp: parseFloat(hpMatch[2]),\n          skills: [],\n          attackPattern: [],\n          nextAttackIndex: 0,\n          buffs: [],\n\n          str: strMatch ? parseInt(strMatch[1]) : 0,\n          agi: agiMatch ? parseInt(agiMatch[1]) : 0,\n          int: intMatch ? parseInt(intMatch[1]) : 0,\n          vit: vitMatch ? parseInt(vitMatch[1]) : 0,\n        };\n\n        const str = enemy.str || 0;\n        const agi = enemy.agi || 0;\n        const int = enemy.int || 0;\n        const vit = enemy.vit || 0;\n\n        const derivedStats = calculateDerivedStats(str, agi, int, vit);\n\n        Object.assign(enemy, {\n          speed: derivedStats.speed,\n          evasionRate: derivedStats.evasionRate,\n          damageBonus: derivedStats.damageBonus,\n          physicalReduction: derivedStats.physicalReduction,\n          damageTakenRate: derivedStats.damageTakenRate,\n          extraHitRate: derivedStats.extraHitRate,\n          extraCritRate: derivedStats.extraCritRate,\n          baseCritMultiplier: derivedStats.baseCritMultiplier,\n          critRateResistance: derivedStats.critRateResistance,\n          critDamageResistance: derivedStats.critDamageResistance,\n        });\n\n        const skillMatches = [\n          ...block.matchAll(\n            /\\[ENS:([^\\]]+)\\]\\[ATK:(\\d+(?:\\.\\d+)?)\\]\\[Hit%:(\\d+(?:\\.\\d+)?)(?:%)?]\\[Crit%:(\\d+(?:\\.\\d+)?)(?:%)?]\\[APT:(\\d+)\\](?:\\[TPA:(\\d+)\\])?/g,\n          ),\n        ];\n        skillMatches.forEach(match =&gt; {\n          enemy.skills.push({\n            name: match[1],\n            attack: parseFloat(match[2]),\n            hitRate: parseFloat(match[3]),\n            critRate: parseFloat(match[4]),\n            attacksPerTurn: parseInt(match[5]),\n            targetsPerAttack: match[6] ? parseInt(match[6]) : 1, \n          });\n        });\n\n        if (patternMatch) {\n          enemy.attackPattern = patternMatch[1].split(',');\n        } else if (enemy.skills.length &gt; 0) {\n\n          enemy.attackPattern = enemy.skills.map(skill =&gt; skill.name);\n        }\n        battleData.enemies.push(enemy);\n      }\n    });\n  }\n  return battleData;\n}\n\nlet battleState = {\n  isActive: false,\n  round: 1,\n  currentItemUsed: false, \n  playerBuffs: [],\n  player: null,\n  teammates: [], \n  currentTeammate: null, \n  selectedTeammates: [], \n  enemies: [],\n  selectedEnemies: [],\n  currentWeapon: null,\n  currentItem: null, \n  waitingForNextRound: false,\n  healTarget: null, \n  selfTargetMode: false, \n  lastKilledBy: null, \n  highestDamageWeapon: null, \n  currentAttackCount: 0, \n  maxAttackCount: 0, \n  attackInProgress: false, \n  itemUsageStats: {}, \n  initialEnemies: [],\n  fullCombatLog: [], \n\n  actionOrder: [], \n  currentActionIndex: 0, \n  actionsThisRound: {}, \n};\n\nconst hateSystem = {\n\n  enemyHateLists: {},\n\n  initializeEnemyHate: function (enemyId) {\n    if (!this.enemyHateLists[enemyId]) {\n      this.enemyHateLists[enemyId] = [];\n    }\n  },\n\n  addHateToEnemy: function (enemyId, targetId, targetName, hateValue) {\n    this.initializeEnemyHate(enemyId);\n\n    const existingHate = this.enemyHateLists[enemyId].find(hate =&gt; hate.targetId === targetId);\n    if (existingHate) {\n\n      existingHate.hateValue += hateValue;\n    } else {\n\n      this.enemyHateLists[enemyId].push({\n        targetId: targetId,\n        targetName: targetName,\n        hateValue: hateValue,\n      });\n    }\n\n    this.enemyHateLists[enemyId].sort((a, b) =&gt; b.hateValue - a.hateValue);\n\n  },\n\n  getEnemyTarget: function (enemyId) {\n    this.initializeEnemyHate(enemyId);\n    const hateList = this.enemyHateLists[enemyId];\n    if (!hateList || hateList.length === 0) {\n\n      return null;\n    }\n\n    return hateList[0];\n  },\n\n  getAllEnemyHateLists: function () {\n    return this.enemyHateLists;\n  },\n\n  clearEnemyHate: function (enemyId) {\n    delete this.enemyHateLists[enemyId];\n  },\n\n  clearTargetHate: function (targetId) {\n    Object.keys(this.enemyHateLists).forEach(enemyId =&gt; {\n      this.enemyHateLists[enemyId] = this.enemyHateLists[enemyId].filter(hate =&gt; hate.targetId !== targetId);\n    });\n  },\n};\n\nfunction addDamageHate(attackerId, attackerName, targetEnemyId, damage) {\n\n  const hateValue = damage;\n  hateSystem.addHateToEnemy(targetEnemyId, attackerId, attackerName, hateValue);\n}\nfunction addHealHate(healerId, healerName, healAmount) {\n\n  Object.keys(hateSystem.enemyHateLists).forEach(enemyId =&gt; {\n    hateSystem.addHateToEnemy(enemyId, healerId, healerName, healAmount);\n  });\n}\n\nfunction getEnemyTargetsByHate(enemyId, maxTargets) {\n  if (maxTargets &lt;= 0) return [];\n  const hateList = hateSystem.enemyHateLists[enemyId] || [];\n  const targets = [];\n\n  for (const hateEntry of hateList) {\n    if (targets.length &gt;= maxTargets) break;\n\n    if (hateEntry.targetId === 'player' &amp;&amp; battleState.player.hp &gt; 0) {\n      targets.push({\n        type: 'player',\n        entity: battleState.player,\n        name: battleState.player.name || 'User',\n        hateValue: hateEntry.hateValue,\n      });\n    } else {\n      const teammate = battleState.teammates.find(t =&gt; t.id === hateEntry.targetId &amp;&amp; t.hp &gt; 0);\n      if (teammate) {\n        targets.push({\n          type: 'teammate',\n          entity: teammate,\n          name: teammate.name,\n          hateValue: hateEntry.hateValue,\n        });\n      }\n    }\n  }\n\n  if (targets.length &lt; maxTargets) {\n\n    const allPossibleTargets = [];\n\n    if (battleState.player.hp &gt; 0) {\n      allPossibleTargets.push({\n        type: 'player',\n        entity: battleState.player,\n        name: battleState.player.name || 'User',\n        hateValue: 0,\n      });\n    }\n\n    battleState.teammates.forEach(teammate =&gt; {\n      if (teammate.hp &gt; 0) {\n        allPossibleTargets.push({\n          type: 'teammate',\n          entity: teammate,\n          name: teammate.name,\n          hateValue: 0,\n        });\n      }\n    });\n\n    const nonSelectedTargets = allPossibleTargets.filter(target =&gt; {\n      return !targets.some(selectedTarget =&gt; {\n        if (selectedTarget.type === 'player' &amp;&amp; target.type === 'player') {\n          return true;\n        }\n        if (selectedTarget.type === 'teammate' &amp;&amp; target.type === 'teammate') {\n          return selectedTarget.entity.id === target.entity.id;\n        }\n        return false;\n      });\n    });\n\n    const remainingSlots = maxTargets - targets.length;\n    targets.push(...nonSelectedTargets.slice(0, remainingSlots));\n  }\n  return targets;\n}\n\nlet battleData = null;\n\nasync function sendBattleResult(message) {\n  try {\n\n    if (typeof triggerSlash === 'function') {\n\n      try {\n        await triggerSlash(`/send ${message} || /trigger`);\n        return true;\n      } catch (e) {\n\n        if (window.parent &amp;&amp; typeof window.parent.sendMessageProxy === 'function') {\n          window.parent.sendMessageProxy(message.replace(/^&lt;request:|&gt;$/g, ''));\n          return true;\n        }\n      }\n    } else if (window.parent &amp;&amp; typeof window.parent.sendMessageProxy === 'function') {\n\n      window.parent.sendMessageProxy(message.replace(/^&lt;request:|&gt;$/g, ''));\n      return true;\n    } else {\n\n      const textToCopy = message.replace(/^&lt;request:|&gt;$/g, '');\n      if (navigator.clipboard &amp;&amp; window.isSecureContext) {\n\n        navigator.clipboard.writeText(textToCopy);\n      } else {\n\n        const tempInput = document.createElement('input');\n        tempInput.value = textToCopy;\n        document.body.appendChild(tempInput);\n        tempInput.select();\n        document.execCommand('copy');\n        document.body.removeChild(tempInput);\n      }\n      return false;\n    }\n  } catch (e) {\n    return false;\n  }\n}\n\nfunction initializeInterface(battleData) {\n\n  if (!lazyRenderManager.shouldRenderPreparation()) {\n    return;\n  }\n  lazyRenderManager.safeUpdateInterface(() =&gt; {\n    updatePlayerStatus(battleData.player);\n    updateTeammatesStatus(battleData.teammates);\n    updateEnemiesDisplay(battleData.enemies);\n    createBattleButton();\n    combatInterface.style.display = 'none';\n    lazyRenderManager.isPreparationRendered = true;\n  }, 'preparation');\n}\n\nfunction updateTeammatesStatus(teammates) {\n  if (!teammates || teammates.length === 0) return;\n\n  if (!lazyRenderManager.shouldRenderPreparation()) {\n    return;\n  }\n\n  const teammatesDiv = document.createElement('div');\n  teammatesDiv.className = 'teammates-status';\n  teammatesDiv.innerHTML = `&lt;h3&gt;&lt;i class=\"fas fa-users\"&gt;&lt;/i&gt; é˜Ÿå‹ (ç‚¹å‡»é€‰æ‹©)&lt;/h3&gt;`;\n\n  const teammatesList = document.createElement('div');\n  teammatesList.className = 'teammates-list';\n\n  teammates.forEach((teammate, index) =&gt; {\n    const teammateItem = document.createElement('div');\n    teammateItem.className = 'teammate-item selectable selected'; \n    teammateItem.setAttribute('data-teammate-index', index);\n    let weaponsHtml = '';\n    if (teammate.weapons &amp;&amp; teammate.weapons.length &gt; 0) {\n      weaponsHtml = `&lt;div class=\"teammate-weapons\"&gt;\n                        &lt;h4&gt;ç¥é€š&lt;/h4&gt;\n                        &lt;div class=\"weapons-list\"&gt;`;\n      teammate.weapons.forEach(weapon =&gt; {\n\n        const effectsHtml = TooltipGenerator.generateEffectCodeHtml(weapon.codes);\n        weaponsHtml += `\n                            &lt;div class=\"weapon-item\"&gt;\n                                &lt;div class=\"weapon-name\"&gt;${weapon.name}&lt;/div&gt;\n                                &lt;div class=\"weapon-stats\"&gt;\n                                    &lt;span class=\"weapon-stat\"&gt;${weapon.isHealing ? 'æ²»ç–—: ' : 'æ”»å‡»: '}${\n          weapon.attack\n        }&lt;/span&gt;\n                                    &lt;span class=\"weapon-stat\"&gt;å‘½ä¸­: ${weapon.hitRate}%&lt;/span&gt;\n                                    &lt;span class=\"weapon-stat\"&gt;æš´å‡»: ${weapon.critRate}%&lt;/span&gt;\n                                    &lt;span class=\"weapon-stat\"&gt;æ¬¡æ•°: ${weapon.attacksPerTurn}&lt;/span&gt;\n                                    &lt;span class=\"weapon-stat\"&gt;ç›®æ ‡: ${weapon.targetsPerAttack}&lt;/span&gt;\n                                    &lt;span class=\"weapon-stat\"&gt;MP: ${weapon.mpCost}&lt;/span&gt;\n                                    &lt;span class=\"weapon-stat\"&gt;å†·å´: ${weapon.cooldown || 0}å›åˆ&lt;/span&gt;\n                                &lt;/div&gt;\n                                ${effectsHtml ? `&lt;div class=\"weapon-effect-codes\"&gt;${effectsHtml}&lt;/div&gt;` : ''}\n                            &lt;/div&gt;`;\n      });\n      weaponsHtml += `&lt;/div&gt;&lt;/div&gt;`;\n    }\n    teammateItem.innerHTML = `\n                    &lt;div class=\"teammate-info\"&gt;\n                        &lt;div class=\"teammate-name\"&gt;${teammate.name}&lt;/div&gt;\n                        &lt;div class=\"teammate-hp\"&gt;\n                            &lt;div class=\"hp-label\"&gt;&lt;i class=\"fas fa-heart\" style=\"color: var(--health-color);\"&gt;&lt;/i&gt;&lt;/div&gt;\n                            &lt;div class=\"hp-bar\"&gt;\n                                &lt;div class=\"hp-fill\" style=\"width: ${(teammate.hp / teammate.maxHp) * 100}%\"&gt;&lt;/div&gt;\n                            &lt;/div&gt;\n                            &lt;div class=\"hp-text\"&gt;${teammate.hp}/${teammate.maxHp} (+${teammate.hpRegen || 0}/å›åˆ)&lt;/div&gt;\n                        &lt;/div&gt;\n                        &lt;div class=\"teammate-mp\"&gt;\n                            &lt;div class=\"mp-label\"&gt;&lt;i class=\"fas fa-flask\" style=\"color: var(--mana-color);\"&gt;&lt;/i&gt;&lt;/div&gt;\n                            &lt;div class=\"mp-bar\"&gt;\n                                &lt;div class=\"mp-fill\" style=\"width: ${(teammate.mp / teammate.maxMp) * 100}%\"&gt;&lt;/div&gt;\n                            &lt;/div&gt;\n                            &lt;div class=\"mp-text\"&gt;${teammate.mp}/${teammate.maxMp} (+${teammate.mpRegen}/å›åˆ)&lt;/div&gt;\n                        &lt;/div&gt;\n                        &lt;div class=\"teammate-ap\"&gt;\n                            &lt;div class=\"ap-label\"&gt;&lt;i class=\"fas fa-bolt\" style=\"color: var(--ap-color);\"&gt;&lt;/i&gt;&lt;/div&gt;\n                            &lt;div class=\"ap-bar\"&gt;\n                                &lt;div class=\"ap-fill\" style=\"width: ${\n                                  teammate.maxAp &gt; 0 ? (teammate.ap / teammate.maxAp) * 100 : 0\n                                }%\"&gt;&lt;/div&gt;\n                            &lt;/div&gt;\n                            &lt;div class=\"ap-text\"&gt;${teammate.ap || 0}/${teammate.maxAp || 0} è¡ŒåŠ¨ç‚¹&lt;/div&gt;\n                        &lt;/div&gt;\n\n                        &lt;div style=\"display: flex; gap: 3px; margin-bottom: 5px;\"&gt;\n                            &lt;div class=\"tooltip\"&gt;\n                                &lt;div class=\"teammate-agility status-effect\"&gt;&lt;i class=\"fas fa-mountain\"&gt;&lt;/i&gt;${\n                                  teammate.str || 0\n                                }\n                                    &lt;span class=\"effect-tooltip\"&gt;ç‰©ç†ä¼¤å®³+ç”Ÿå‘½æ¢å¤&lt;/span&gt;\n                                &lt;/div&gt;\n                            &lt;/div&gt;\n                            &lt;div class=\"tooltip\"&gt;\n                                &lt;div class=\"teammate-agility status-effect\"&gt;&lt;i class=\"fas fa-wind\"&gt;&lt;/i&gt;${\n                                  teammate.agi || 0\n                                }\n                                    &lt;span class=\"effect-tooltip\"&gt;é€Ÿåº¦+é—ªé¿+æš´å‡»&lt;/span&gt;\n                                &lt;/div&gt;\n                            &lt;/div&gt;\n                            &lt;div class=\"tooltip\"&gt;\n                                &lt;div class=\"teammate-agility status-effect\"&gt;&lt;i class=\"fas fa-eye\"&gt;&lt;/i&gt;${\n                                  teammate.int || 0\n                                }\n                                    &lt;span class=\"effect-tooltip\"&gt;æš´å‡»+çµåŠ›æ¢å¤&lt;/span&gt;\n                                &lt;/div&gt;\n                            &lt;/div&gt;\n                            &lt;div class=\"tooltip\"&gt;\n                                &lt;div class=\"teammate-agility status-effect\"&gt;&lt;i class=\"fas fa-shield-alt\"&gt;&lt;/i&gt;${\n                                  teammate.vit || 0\n                                }\n                                    &lt;span class=\"effect-tooltip\"&gt;è¡ŒåŠ¨ç‚¹+ç”Ÿå‘½æ¢å¤&lt;/span&gt;\n                                &lt;/div&gt;\n                            &lt;/div&gt;\n                        &lt;/div&gt;\n                    &lt;/div&gt;\n                    ${weaponsHtml}\n                `;\n    teammatesList.appendChild(teammateItem);\n  });\n  teammatesDiv.appendChild(teammatesList);\n\n  const playerStatus = document.getElementById('player-status');\n  if (playerStatus &amp;&amp; playerStatus.nextSibling) {\n    playerStatus.parentNode.insertBefore(teammatesDiv, playerStatus.nextSibling);\n  } else if (playerStatus) {\n    playerStatus.parentNode.appendChild(teammatesDiv);\n  }\n\n  addTeammateSelectionListeners(teammates);\n}\n\nfunction addTeammateSelectionListeners(teammates) {\n\n  battleState.selectedTeammates = [...teammates];\n\n  document.querySelectorAll('.teammate-item.selectable').forEach(teammateElement =&gt; {\n    teammateElement.addEventListener('click', function () {\n      const teammateIndex = parseInt(this.getAttribute('data-teammate-index'));\n      const teammate = teammates[teammateIndex];\n      if (!teammate) return;\n\n      const index = battleState.selectedTeammates.findIndex(t =&gt; t.id === teammate.id);\n      if (index === -1) {\n\n        battleState.selectedTeammates.push(teammate);\n        this.classList.add('selected');\n      } else {\n\n        battleState.selectedTeammates.splice(index, 1);\n        this.classList.remove('selected');\n      }\n\n      updateBattleButtonState();\n    });\n  });\n}\n\nfunction updateBattleButtonState() {\n  const startBattleBtn = document.getElementById('start-battle');\n  const quickBattleBtn = document.getElementById('quick-battle');\n\n  if (startBattleBtn &amp;&amp; quickBattleBtn) {\n\n    const selectedEnemies = document.querySelectorAll('#pilots-container .enemy-item.selected');\n    const hasSelectedEnemies = selectedEnemies.length &gt; 0;\n    const hasSelectedTeammates = battleState.selectedTeammates.length &gt; 0;\n\n    const isEnabled = hasSelectedEnemies;\n    startBattleBtn.disabled = !isEnabled;\n    quickBattleBtn.disabled = !isEnabled;\n\n    if (!hasSelectedEnemies) {\n      startBattleBtn.innerHTML = '&lt;i class=\"fas fa-magic\"&gt;&lt;/i&gt; è¯·é€‰æ‹©æ•Œäºº';\n      quickBattleBtn.innerHTML = '&lt;i class=\"fas fa-forward\"&gt;&lt;/i&gt; è¯·é€‰æ‹©æ•Œäºº';\n    } else if (!hasSelectedTeammates) {\n      startBattleBtn.innerHTML = '&lt;i class=\"fas fa-magic\"&gt;&lt;/i&gt; å•äººæˆ˜æ–—';\n      quickBattleBtn.innerHTML = '&lt;i class=\"fas fa-forward\"&gt;&lt;/i&gt; å•äººå¿«é€Ÿæˆ˜æ–—';\n    } else {\n      startBattleBtn.innerHTML = '&lt;i class=\"fas fa-magic\"&gt;&lt;/i&gt; è¿›å…¥æˆ˜æ–—';\n      quickBattleBtn.innerHTML = '&lt;i class=\"fas fa-forward\"&gt;&lt;/i&gt; å¿«é€Ÿæˆ˜æ–—';\n    }\n  }\n}\n\nfunction updatePlayerStatus(player) {\n\n  if (!lazyRenderManager.shouldRenderPreparation()) {\n    return;\n  }\n  let html = `\n                &lt;div class=\"player-info\"&gt;\n                    &lt;div class=\"player-name\"&gt;${player.name || 'User'}&lt;/div&gt;\n                    &lt;div class=\"player-hp\"&gt;\n                        &lt;div class=\"hp-label\"&gt;&lt;i class=\"fas fa-heart\" style=\"color: var(--health-color);\"&gt;&lt;/i&gt;&lt;/div&gt;\n                        &lt;div class=\"hp-bar\"&gt;\n                            &lt;div class=\"hp-fill\" style=\"width: ${(player.hp / player.maxHp) * 100}%\"&gt;&lt;/div&gt;\n                        &lt;/div&gt;\n                        &lt;div class=\"hp-text\"&gt;${player.hp}/${player.maxHp} (+${player.hpRegen || 0}/å›åˆ)&lt;/div&gt;\n                    &lt;/div&gt;\n                    &lt;div class=\"player-mp\"&gt;\n                        &lt;div class=\"mp-label\"&gt;&lt;i class=\"fas fa-flask\" style=\"color: var(--mana-color);\"&gt;&lt;/i&gt;&lt;/div&gt;\n                        &lt;div class=\"mp-bar\"&gt;\n                            &lt;div class=\"mp-fill\" style=\"width: ${(player.mp / player.maxMp) * 100}%\"&gt;&lt;/div&gt;\n                        &lt;/div&gt;\n                        &lt;div class=\"mp-text\"&gt;${player.mp}/${player.maxMp} (+${player.mpRegen}/å›åˆ)&lt;/div&gt;\n                    &lt;/div&gt;\n                    &lt;div class=\"player-ap\"&gt;\n                        &lt;div class=\"ap-label\"&gt;&lt;i class=\"fas fa-bolt\" style=\"color: var(--primary-color);\"&gt;&lt;/i&gt;&lt;/div&gt;\n                        &lt;div class=\"ap-bar\"&gt;\n                            &lt;div class=\"ap-fill\" style=\"width: ${\n                              player.maxAp &gt; 0 ? (player.ap / player.maxAp) * 100 : 0\n                            }%\"&gt;&lt;/div&gt;\n                        &lt;/div&gt;\n                        &lt;div class=\"ap-text\"&gt;${player.ap || 0}/${player.maxAp || 0} è¡ŒåŠ¨ç‚¹&lt;/div&gt;\n                    &lt;/div&gt;\n\n                    &lt;div style=\"display: flex; gap: 8px; margin-bottom: 8px;\"&gt;\n                        &lt;div class=\"tooltip\"&gt;\n                            &lt;div class=\"player-agility status-effect\"&gt;&lt;i class=\"fas fa-mountain\"&gt;&lt;/i&gt;æ ¹éª¨: ${\n                              player.str || 0\n                            }\n                                &lt;span class=\"effect-tooltip\"&gt;ç‰©ç†ä¼¤å®³+ç”Ÿå‘½æ¢å¤&lt;/span&gt;\n                            &lt;/div&gt;\n                        &lt;/div&gt;\n                        &lt;div class=\"tooltip\"&gt;\n                            &lt;div class=\"player-agility status-effect\"&gt;&lt;i class=\"fas fa-wind\"&gt;&lt;/i&gt;èº«æ³•: ${\n                              player.agi || 0\n                            }\n                                &lt;span class=\"effect-tooltip\"&gt;é€Ÿåº¦+é—ªé¿+æš´å‡»&lt;/span&gt;\n                            &lt;/div&gt;\n                        &lt;/div&gt;\n                        &lt;div class=\"tooltip\"&gt;\n                            &lt;div class=\"player-agility status-effect\"&gt;&lt;i class=\"fas fa-eye\"&gt;&lt;/i&gt;ç¥è¯†: ${\n                              player.int || 0\n                            }\n                                &lt;span class=\"effect-tooltip\"&gt;æš´å‡»+çµåŠ›æ¢å¤&lt;/span&gt;\n                            &lt;/div&gt;\n                        &lt;/div&gt;\n                        &lt;div class=\"tooltip\"&gt;\n                            &lt;div class=\"player-agility status-effect\"&gt;&lt;i class=\"fas fa-shield-alt\"&gt;&lt;/i&gt;æ·¬ä½“: ${\n                              player.vit || 0\n                            }\n                                &lt;span class=\"effect-tooltip\"&gt;è¡ŒåŠ¨ç‚¹+ç”Ÿå‘½æ¢å¤&lt;/span&gt;\n                            &lt;/div&gt;\n                        &lt;/div&gt;\n                    &lt;/div&gt;\n\n                    &lt;div style=\"display: flex; gap: 8px; flex-wrap: wrap;\"&gt;\n                        ${(() =&gt; {\n\n                          const derivedStats = calculateDerivedStats(\n                            player.str || 0,\n                            player.agi || 0,\n                            player.int || 0,\n                            player.vit || 0,\n                          );\n                          return `\n                        &lt;div class=\"tooltip\"&gt;\n                            &lt;div class=\"player-agility status-effect\"&gt;&lt;i class=\"fas fa-tachometer-alt\"&gt;&lt;/i&gt;é€Ÿåº¦: ${\n                              derivedStats.speed\n                            }\n                                &lt;span class=\"effect-tooltip\"&gt;è¡ŒåŠ¨é€Ÿåº¦&lt;/span&gt;\n                            &lt;/div&gt;\n                        &lt;/div&gt;\n                        &lt;div class=\"tooltip\"&gt;\n                            &lt;div class=\"player-agility status-effect\"&gt;&lt;i class=\"fas fa-shoe-prints\"&gt;&lt;/i&gt;é—ªé¿ç‡: ${(\n                              derivedStats.evasionRate * 100\n                            ).toFixed(1)}%\n                                &lt;span class=\"effect-tooltip\"&gt;èº²é¿æ”»å‡»å‡ ç‡&lt;/span&gt;\n                            &lt;/div&gt;\n                        &lt;/div&gt;\n                        &lt;div class=\"tooltip\"&gt;\n                            &lt;div class=\"player-stats status-effect\"&gt;&lt;i class=\"fas fa-magic\"&gt;&lt;/i&gt;ä¼¤å®³åŠ æˆ: +${(\n                              derivedStats.damageBonus * 100\n                            ).toFixed(1)}%\n                                &lt;span class=\"effect-tooltip\"&gt;æ”»å‡»ä¼¤å®³åŠ æˆ&lt;/span&gt;\n                            &lt;/div&gt;\n                        &lt;/div&gt;\n                        &lt;div class=\"tooltip\"&gt;\n                            &lt;div class=\"player-agility status-effect\"&gt;&lt;i class=\"fas fa-shield-alt\"&gt;&lt;/i&gt;å‡ä¼¤å€¼: ${\n                              derivedStats.physicalReduction\n                            }\n                                &lt;span class=\"effect-tooltip\"&gt;ç‰©ç†ä¼¤å®³å‡å…&lt;/span&gt;\n                            &lt;/div&gt;\n                        &lt;/div&gt;\n                        &lt;div class=\"tooltip\"&gt;\n                            &lt;div class=\"player-agility status-effect\"&gt;&lt;i class=\"fas fa-heart-broken\"&gt;&lt;/i&gt;æ‰¿ä¼¤ç‡: ${(\n                              derivedStats.damageTakenRate * 100\n                            ).toFixed(1)}%\n                                &lt;span class=\"effect-tooltip\"&gt;å—åˆ°ä¼¤å®³æ¯”ä¾‹&lt;/span&gt;\n                            &lt;/div&gt;\n                        &lt;/div&gt;\n                        &lt;div class=\"tooltip\"&gt;\n                            &lt;div class=\"player-agility status-effect\"&gt;&lt;i class=\"fas fa-crosshairs\"&gt;&lt;/i&gt;é¢å¤–å‘½ä¸­: +${(\n                              derivedStats.extraHitRate * 100\n                            ).toFixed(1)}%\n                                &lt;span class=\"effect-tooltip\"&gt;é¢å¤–å‘½ä¸­ç‡&lt;/span&gt;\n                            &lt;/div&gt;\n                        &lt;/div&gt;\n                        &lt;div class=\"tooltip\"&gt;\n                            &lt;div class=\"player-stats status-effect\"&gt;&lt;i class=\"fas fa-star\"&gt;&lt;/i&gt;é¢å¤–æš´å‡»: +${(\n                              derivedStats.extraCritRate * 100\n                            ).toFixed(1)}%\n                                &lt;span class=\"effect-tooltip\"&gt;é¢å¤–æš´å‡»ç‡&lt;/span&gt;\n                            &lt;/div&gt;\n                        &lt;/div&gt;\n                        &lt;div class=\"tooltip\"&gt;\n                            &lt;div class=\"player-stats status-effect\"&gt;&lt;i class=\"fas fa-fire\"&gt;&lt;/i&gt;æš´å‡»å€ç‡: ${(\n                              derivedStats.baseCritMultiplier * 100\n                            ).toFixed(1)}%\n                                &lt;span class=\"effect-tooltip\"&gt;æš´å‡»ä¼¤å®³å€ç‡&lt;/span&gt;\n                            &lt;/div&gt;\n                        &lt;/div&gt;\n                        &lt;div class=\"tooltip\"&gt;\n                            &lt;div class=\"player-agility status-effect\"&gt;&lt;i class=\"fas fa-shield\"&gt;&lt;/i&gt;æš´å‡»æŠ—æ€§: ${(\n                              derivedStats.critRateResistance * 100\n                            ).toFixed(1)}%\n                                &lt;span class=\"effect-tooltip\"&gt;æš´å‡»ç‡æŠµæŠ—&lt;/span&gt;\n                            &lt;/div&gt;\n                        &lt;/div&gt;\n                        &lt;div class=\"tooltip\"&gt;\n                            &lt;div class=\"player-agility status-effect\"&gt;&lt;i class=\"fas fa-shield-virus\"&gt;&lt;/i&gt;æš´ä¼¤æŠ—æ€§: ${(\n                              derivedStats.critDamageResistance * 100\n                            ).toFixed(1)}%\n                                &lt;span class=\"effect-tooltip\"&gt;æš´å‡»ä¼¤å®³æŠµæŠ—&lt;/span&gt;\n                            &lt;/div&gt;\n                        &lt;/div&gt;\n                          `;\n                        })()}\n                    &lt;/div&gt;\n        &lt;/div&gt;`;\n\n  if (player.items &amp;&amp; player.items.length &gt; 0) {\n    html += `\n        &lt;div class=\"player-items\"&gt;\n            &lt;h3&gt;&lt;i class=\"fas fa-pills\"&gt;&lt;/i&gt; ä¸¹è¯&lt;/h3&gt;\n            &lt;div class=\"weapons-list\"&gt;`;\n    player.items.forEach(item =&gt; {\n      let effectText = '';\n      switch (item.type) {\n        case 1: \n          effectText = `æ¢å¤ ${item.value} ç‚¹ç”Ÿå‘½å€¼`;\n          break;\n        case 2: \n          effectText = `æ¢å¤ ${item.value} ç‚¹çµåŠ›å€¼`;\n          break;\n        case 3: \n          effectText = `æ ¹éª¨+${item.value}ï¼ŒæŒç»­${item.duration}å›åˆ`;\n          break;\n        case 4: \n          effectText = `èº«æ³•+${item.value}ï¼ŒæŒç»­${item.duration}å›åˆ`;\n          break;\n        case 5: \n          effectText = `ç¥è¯†+${item.value}ï¼ŒæŒç»­${item.duration}å›åˆ`;\n          break;\n        case 6: \n          effectText = `æ·¬ä½“+${item.value}ï¼ŒæŒç»­${item.duration}å›åˆ`;\n          break;\n        default:\n          effectText = 'æœªçŸ¥æ•ˆæœ';\n      }\n      html += `\n                &lt;div class=\"weapon-item\"&gt;\n                    &lt;div class=\"weapon-name\"&gt;${item.name} &lt;span style=\"float: right;\"&gt;x${item.count}&lt;/span&gt;&lt;/div&gt;\n                    &lt;div class=\"weapon-type\"&gt;${effectText}&lt;/div&gt;\n                &lt;/div&gt;`;\n    });\n    html += `&lt;/div&gt;&lt;/div&gt;`;\n  }\n  html += `\n                &lt;div class=\"player-weapons\"&gt;\n                    &lt;h3&gt;&lt;i class=\"fas fa-magic\"&gt;&lt;/i&gt; ç¥é€š&lt;/h3&gt;\n                    &lt;div class=\"weapons-list\"&gt;`;\n  player.weapons.forEach(weapon =&gt; {\n\n    const effectsHtml = TooltipGenerator.generateEffectCodeHtml(weapon.codes);\n    html += `\n                    &lt;div class=\"weapon-item\"&gt;\n                        &lt;div class=\"weapon-name\"&gt;${weapon.name}&lt;/div&gt;\n                        &lt;div class=\"weapon-type\"&gt;ç¥é€š&lt;/div&gt;\n                        &lt;div class=\"weapon-stats\"&gt;\n                            &lt;span class=\"weapon-stat\"&gt;${weapon.isHealing ? 'æ²»ç–—: ' : 'æ”»å‡»: '}${weapon.attack}&lt;/span&gt;\n                            &lt;span class=\"weapon-stat\"&gt;å‘½ä¸­: ${weapon.hitRate}%&lt;/span&gt;\n                            &lt;span class=\"weapon-stat\"&gt;æš´å‡»: ${weapon.critRate}%&lt;/span&gt;\n                            &lt;span class=\"weapon-stat\"&gt;æ¬¡æ•°: ${weapon.attacksPerTurn}&lt;/span&gt;\n                            &lt;span class=\"weapon-stat\"&gt;ç›®æ ‡: ${weapon.targetsPerAttack}&lt;/span&gt;\n                            &lt;span class=\"weapon-stat\"&gt;MP: ${weapon.mpCost}&lt;/span&gt;\n                            &lt;span class=\"weapon-stat\"&gt;å†·å´: ${weapon.cooldown || 0}å›åˆ&lt;/span&gt;\n                            ${effectsHtml}\n                        &lt;/div&gt;\n                    &lt;/div&gt;`;\n  });\n  html += `&lt;/div&gt;&lt;/div&gt;`;\n  playerStatus.innerHTML = html;\n}\n\nfunction updateEnemiesDisplay(enemies) {\n\n  if (!lazyRenderManager.shouldRenderPreparation()) {\n    return;\n  }\n  let html = `&lt;h3&gt;&lt;i class=\"fas fa-skull-crossbones\"&gt;&lt;/i&gt; æ•Œäºº (ç‚¹å‡»é€‰æ‹©)&lt;/h3&gt;&lt;div class=\"enemies-list\"&gt;`;\n  enemies.forEach((enemy, index) =&gt; {\n    html += `\n                    &lt;div class=\"enemy-item selected\" data-enemy-index=\"${index}\"&gt;\n                        &lt;div class=\"enemy-name\"&gt;${enemy.name}&lt;/div&gt;\n                        &lt;div class=\"enemy-hp\"&gt;\n                            &lt;div class=\"hp-label\"&gt;&lt;i class=\"fas fa-heart\" style=\"color: var(--health-color);\"&gt;&lt;/i&gt;&lt;/div&gt;\n                            &lt;div class=\"hp-bar\"&gt;\n                                &lt;div class=\"hp-fill\" style=\"width: ${(enemy.hp / enemy.maxHp) * 100}%\"&gt;&lt;/div&gt;\n                            &lt;/div&gt;\n                            &lt;div class=\"hp-text\"&gt;${enemy.hp}/${enemy.maxHp}&lt;/div&gt;\n                        &lt;/div&gt;\n\n                        &lt;div style=\"display: flex; gap: 3px; margin-bottom: 5px;\"&gt;\n                            ${\n                              enemy.str !== undefined\n                                ? `\n                        &lt;div class=\"tooltip\"&gt;\n                                &lt;div class=\"enemy-agility status-effect\"&gt;&lt;i class=\"fas fa-mountain\"&gt;&lt;/i&gt;${enemy.str}\n                                    &lt;span class=\"effect-tooltip\"&gt;æ ¹éª¨å±æ€§ï¼Œå½±å“æ”»å‡»åŠ›&lt;/span&gt;\n                            &lt;/div&gt;\n                            &lt;/div&gt;\n                            `\n                                : ''\n                            }\n                            ${\n                              enemy.agi !== undefined\n                                ? `\n                            &lt;div class=\"tooltip\"&gt;\n                                &lt;div class=\"enemy-agility status-effect\"&gt;&lt;i class=\"fas fa-wind\"&gt;&lt;/i&gt;${enemy.agi}\n                                    &lt;span class=\"effect-tooltip\"&gt;èº«æ³•å±æ€§ï¼Œå½±å“é—ªé¿ç‡å’Œæš´å‡»ç‡&lt;/span&gt;\n                                &lt;/div&gt;\n                            &lt;/div&gt;\n                            `\n                                : ''\n                            }\n                            ${\n                              enemy.int !== undefined\n                                ? `\n                            &lt;div class=\"tooltip\"&gt;\n                                &lt;div class=\"enemy-agility status-effect\"&gt;&lt;i class=\"fas fa-eye\"&gt;&lt;/i&gt;${enemy.int}\n                                    &lt;span class=\"effect-tooltip\"&gt;ç¥è¯†å±æ€§ï¼Œå½±å“æš´å‡»ç‡å’Œæš´å‡»ä¼¤å®³&lt;/span&gt;\n                                &lt;/div&gt;\n                            &lt;/div&gt;\n                            `\n                                : ''\n                            }\n                            ${\n                              enemy.vit !== undefined\n                                ? `\n                            &lt;div class=\"tooltip\"&gt;\n                                &lt;div class=\"enemy-agility status-effect\"&gt;&lt;i class=\"fas fa-shield-alt\"&gt;&lt;/i&gt;${enemy.vit}\n                                    &lt;span class=\"effect-tooltip\"&gt;ä½“åŠ›å±æ€§ï¼Œå½±å“ç”Ÿå‘½å€¼å’Œè¡ŒåŠ¨ç‚¹&lt;/span&gt;\n                                &lt;/div&gt;\n                            &lt;/div&gt;\n                            `\n                                : ''\n                            }\n                        &lt;/div&gt;\n                        &lt;div class=\"enemy-skills status-effect\"&gt;\n                            &lt;i class=\"fas fa-bolt\"&gt;&lt;/i&gt;ä¸‹æ¬¡è¡ŒåŠ¨: ${enemy.attackPattern[enemy.nextAttackIndex] || 'æœªçŸ¥'}\n                            &lt;span class=\"effect-tooltip\"&gt;æ•Œäººä¸‹ä¸€å›åˆçš„æŠ€èƒ½&lt;/span&gt;\n                        &lt;/div&gt;\n                    &lt;/div&gt;`;\n  });\n  html += `&lt;/div&gt;`;\n  pilotsContainer.innerHTML = html;\n\n  document.querySelectorAll('#pilots-container .enemy-item').forEach(item =&gt; {\n    item.addEventListener('click', () =&gt; {\n      item.classList.toggle('selected');\n\n      updateBattleButtonState();\n    });\n  });\n}\n\nfunction createBattleButton() {\n\n  if (!lazyRenderManager.shouldRenderPreparation()) {\n    return;\n  }\n  combatControls.innerHTML = `\n                &lt;div style=\"display: flex; justify-content: center; gap: 10px;\"&gt;\n                    &lt;button id=\"start-battle\" class=\"battle-button\"&gt;&lt;i class=\"fas fa-magic\"&gt;&lt;/i&gt; è¿›å…¥æˆ˜æ–—&lt;/button&gt;\n                    &lt;button id=\"quick-battle\" class=\"battle-button\" style=\"background-color: var(--secondary-color);\"&gt;&lt;i class=\"fas fa-forward\"&gt;&lt;/i&gt; å¿«é€Ÿæˆ˜æ–—&lt;/button&gt;\n                &lt;/div&gt;`;\n  document.getElementById('start-battle').addEventListener('click', startBattle);\n  document.getElementById('quick-battle').addEventListener('click', startQuickBattle);\n\n  updateBattleButtonState();\n}\n\n      function startQuickBattle() {\n        const data = statusDataSource.textContent;\n        const fullBattleData = parseStatusData(data);\n\n        const selectedEnemyElements = document.querySelectorAll('#pilots-container .enemy-item.selected');\n        const selectedEnemyIndices = Array.from(selectedEnemyElements).map(el =&gt;\n          parseInt(el.getAttribute('data-enemy-index')),\n        );\n        const selectedEnemies = fullBattleData.enemies.filter((enemy, index) =&gt; selectedEnemyIndices.includes(index));\n        if (selectedEnemies.length === 0) {\n          alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ•Œäººè¿›è¡Œæˆ˜æ–—ï¼');\n          return;\n        }\n\n        const selectedTeammates = battleState.selectedTeammates || [];\n\n        battleState = {\n          round: 1,\n          player: JSON.parse(JSON.stringify(fullBattleData.player)),\n          teammates: JSON.parse(JSON.stringify(selectedTeammates)), \n          enemies: JSON.parse(JSON.stringify(selectedEnemies)),\n          playerBuffs: [],\n          weaponUsage: {}, \n          itemUsageStats: {}, \n          killedEnemies: [], \n          highestDamageWeapon: { name: '', damage: 0 },\n          lastKilledBy: null,\n          initialEnemies: JSON.parse(JSON.stringify(selectedEnemies)),\n        };\n\n        showQuickBattleResults(simulateQuickBattle());\n      }\n\n      function simulateQuickBattle() {\n        const MAX_ROUNDS = 30; \n        const result = {\n          isVictory: false,\n          rounds: 1,\n          finalPlayerHP: battleState.player.hp,\n          finalPlayerMP: battleState.player.mp,\n        };\n\n        while (battleState.player.hp &gt; 0 &amp;&amp; battleState.enemies.length &gt; 0 &amp;&amp; battleState.round &lt;= MAX_ROUNDS) {\n\n          simulatePlayerTurn();\n\n          if (StateValidator.areAllEnemiesDead()) {\n            result.isVictory = true;\n            break;\n          }\n          simulateEnemyTurn();\n          if (StateValidator.isPlayerDead()) break;\n\n          simulateEndOfRound();\n          battleState.round++;\n        }\n\n        result.rounds = battleState.round;\n        result.finalPlayerHP = battleState.player.hp;\n        result.finalPlayerMP = battleState.player.mp;\n        return result;\n      }\n\n      function simulatePlayerTurn() {\n\n        if (battleState.player.hp &lt; battleState.player.maxHp * 0.3 &amp;&amp; tryUseHealingItem()) {\n          return true;\n        }\n\n        if (battleState.player.mp &lt; battleState.player.maxMp * 0.2 &amp;&amp; tryUseManaItem()) {\n          return true;\n        }\n\n        const availableWeapons = battleState.player.weapons.filter(w =&gt; !w.used);\n        if (availableWeapons.length === 0) {\n          return false;\n        }\n\n        const attackWeapons = availableWeapons.filter(weapon =&gt; {\n          const weaponTemplate = weapon.codes?.find(code =&gt; code.startsWith('WN:A'))?.match(/WN:(A[1-4])/)?.[1];\n          return weaponTemplate !== 'A2' &amp;&amp; weaponTemplate !== 'A3' &amp;&amp; weaponTemplate !== 'A4';\n        });\n\n        if (attackWeapons.length === 0) {\n          const healingWeapons = availableWeapons.filter(weapon =&gt; {\n            const weaponTemplate = weapon.codes?.find(code =&gt; code.startsWith('WN:A'))?.match(/WN:(A[1-4])/)?.[1];\n            return weaponTemplate === 'A2' || weaponTemplate === 'A3' || weaponTemplate === 'A4';\n          });\n          if (healingWeapons.length &gt; 0) {\n\n            const weapon = healingWeapons[0];\n            if (battleState.player.mp &gt;= weapon.mpCost) {\n              battleState.player.mp -= weapon.mpCost;\n              const weaponTemplate = weapon.codes?.find(code =&gt; code.startsWith('WN:A'))?.match(/WN:(A[1-4])/)?.[1];\n              if (weaponTemplate === 'A2') {\n                battleState.player.hp = Math.min(battleState.player.hp + weapon.attack, battleState.player.maxHp);\n              } else if (weaponTemplate === 'A3') {\n                battleState.player.mp = Math.min(battleState.player.mp + weapon.attack, battleState.player.maxMp);\n              } else if (weaponTemplate === 'A4') {\n\n                battleState.player.hp = Math.min(battleState.player.hp + weapon.attack, battleState.player.maxHp);\n\n              }\n              weapon.used = true;\n              return true;\n            }\n          }\n          return false;\n        }\n\n        attackWeapons.sort((a, b) =&gt; {\n\n          const aDamage = calculatePotentialDamage(a);\n          const bDamage = calculatePotentialDamage(b);\n          return bDamage - aDamage;\n        });\n        const weapon = attackWeapons[0];\n\n        if (battleState.player.mp &lt; weapon.mpCost) {\n          weapon.used = true;\n          return simulatePlayerTurn(); \n        }\n\n        if (!battleState.weaponUsage[weapon.name]) {\n          battleState.weaponUsage[weapon.name] = {\n            name: weapon.name,\n            damage: 0,\n            kills: 0,\n          };\n        }\n\n        if (weapon.isHealing) {\n          const healAmount = weapon.attack;\n          const oldHp = battleState.player.hp;\n          battleState.player.hp = Math.min(battleState.player.hp + healAmount, battleState.player.maxHp);\n          weapon.used = true;\n          return true;\n        }\n\n        let targets = selectTargets(weapon);\n\n        if (targets.length === 0) {\n          weapon.used = true;\n          return true;\n        }\n\n        for (let attackCount = 0; attackCount &lt; weapon.attacksPerTurn; attackCount++) {\n\n          if (battleState.player.mp &lt; weapon.mpCost) {\n\n            break;\n          }\n\n          for (const target of targets) {\n\n            if (!StateValidator.isValidTarget(target)) continue;\n\n            const attackerStats = {\n              extraHitRate: (battleState.player.agi || 0) * 0.01,\n              extraCritRate: (battleState.player.int || 0) * 0.01,\n              baseCritMultiplier: 1.5 + (battleState.player.int || 0) * 0.01,\n            };\n            const targetStats = {\n              evasionRate: (target.agi || 0) * 0.005,\n              critRateResistance: (target.agi || 0) * 0.005 + (target.int || 0) * 0.005,\n            };\n            const finalHitRate = calculateFinalHitRate(weapon.hitRate, attackerStats, targetStats);\n            const hitRoll = Math.random();\n\n            if (hitRoll &lt;= Math.min(1.0, finalHitRate)) {\n\n              const finalCritRate = calculateFinalCritRate(weapon.critRate, attackerStats, targetStats, finalHitRate);\n              const critRoll = Math.random();\n\n              const isCrit = critRoll &lt;= Math.min(1.0, finalCritRate);\n\n              let damage = calculateDamage(\n                weapon,\n                target,\n                isCrit,\n                battleState.player.str || 0,\n                battleState.player.int || 0,\n              );\n\n              battleState.weaponUsage[weapon.name].damage += damage;\n\n              if (damage &gt; (battleState.highestDamageWeapon.damage || 0)) {\n                battleState.highestDamageWeapon.name = weapon.name;\n                battleState.highestDamageWeapon.damage = damage;\n              }\n\n              target.hp -= damage;\n\n              if (StateValidator.isDead(target)) {\n\n                battleState.weaponUsage[weapon.name].kills = (battleState.weaponUsage[weapon.name].kills || 0) + 1;\n                battleState.killedEnemies.push(target.name);\n\n                battleState.enemies = battleState.enemies.filter(e =&gt; e !== target);\n\n                if (StateValidator.areAllEnemiesDead()) {\n                  break;\n                }\n              }\n            }\n          }\n\n          if (StateValidator.areAllEnemiesDead()) {\n            break;\n          }\n\n          if (targets.length &gt; battleState.enemies.length) {\n            targets = selectTargets(weapon);\n\n            if (targets.length === 0) {\n              break;\n            }\n          }\n\n          battleState.player.mp = Math.max(0, battleState.player.mp - weapon.mpCost);\n        }\n\n        weapon.used = true;\n        return true;\n      }\n\n      function calculatePotentialDamage(weapon) {\n\n        const weaponTemplate = weapon.codes?.find(code =&gt; code.startsWith('WN:A'))?.match(/WN:(A[1-4])/)?.[1];\n\n        if (weaponTemplate === 'A2' || weaponTemplate === 'A3' || weaponTemplate === 'A4') {\n          return 0;\n        }\n        const baseDamage = weapon.attack * weapon.attacksPerTurn * weapon.targetsPerAttack;\n\n        const critFactor = 1 + (weapon.critRate / 100) * 0.5; \n        return baseDamage * critFactor;\n      }\n\n      function selectTargets(weapon) {\n\n        const weaponTemplate = weapon.codes?.find(code =&gt; code.startsWith('WN:A'))?.match(/WN:(A[1-4])/)?.[1];\n        if (weaponTemplate === 'A2' || weaponTemplate === 'A3' || weaponTemplate === 'A4') {\n          return []; \n        }\n\n        return weapon.targetsPerAttack &gt; 1\n          ? battleState.enemies.slice(0, weapon.targetsPerAttack)\n          : [\n              battleState.enemies.reduce(\n                (lowest, current) =&gt; (current.hp &lt; lowest.hp ? current : lowest),\n                battleState.enemies[0],\n              ),\n            ];\n      }\n\n      function calculateDamage(weapon, target, isCrit, attackerStr = 0, attackerInt = 0) {\n\n        const attackerStats = {\n          damageBonus: attackerStr * 0.01,\n          extraCritRate: 0, \n          baseCritMultiplier: 1.5 + attackerInt * 0.01, \n        };\n        const targetStats = {\n          damageTakenRate: 50 / (50 + (target.vit || 0)),\n          physicalReduction: (target.str || 0) * 1,\n          critDamageResistance: 0, \n        };\n\n        const finalCritMultiplier = isCrit\n          ? Math.max(1.0, attackerStats.baseCritMultiplier - targetStats.critDamageResistance)\n          : 1.0;\n        return calculateFinalDamage(weapon.attack, attackerStats, targetStats, isCrit, finalCritMultiplier);\n      }\n\n      function tryUseHealingItem() {\n        if (!battleState.player.items || battleState.player.items.length === 0) {\n          return false;\n        }\n\n        const healingItem = battleState.player.items.find(item =&gt; item.type === 1 &amp;&amp; item.count &gt; 0);\n        if (healingItem) {\n\n          const oldHp = battleState.player.hp;\n          battleState.player.hp = Math.min(battleState.player.hp + healingItem.value, battleState.player.maxHp);\n\n          if (!battleState.itemUsageStats[healingItem.name]) {\n            battleState.itemUsageStats[healingItem.name] = 0;\n          }\n          battleState.itemUsageStats[healingItem.name]++;\n\n          healingItem.count--;\n          return true;\n        }\n        return false;\n      }\n\n      function tryUseManaItem() {\n        if (!battleState.player.items || battleState.player.items.length === 0) {\n          return false;\n        }\n\n        const mpItem = battleState.player.items.find(item =&gt; item.type === 2 &amp;&amp; item.count &gt; 0);\n        if (mpItem) {\n\n          const oldMp = battleState.player.mp;\n          battleState.player.mp = Math.min(battleState.player.mp + mpItem.value, battleState.player.maxMp);\n\n          if (!battleState.itemUsageStats[mpItem.name]) {\n            battleState.itemUsageStats[mpItem.name] = 0;\n          }\n          battleState.itemUsageStats[mpItem.name]++;\n\n          mpItem.count--;\n          return true;\n        }\n        return false;\n      }\n\n      function simulateEnemyTurn() {\n        for (const enemy of battleState.enemies) {\n\n          const attackName = enemy.attackPattern[enemy.nextAttackIndex];\n          const skill = enemy.skills.find(s =&gt; s.name === attackName);\n          if (skill) {\n\n            const currentPlayerStats = getPlayerActualStats();\n            const enemyStats = {\n              extraHitRate: (enemy.agi || 0) * 0.01,\n              extraCritRate: (enemy.int || 0) * 0.01,\n              baseCritMultiplier: 1.5 + (enemy.int || 0) * 0.01,\n              damageBonus: (enemy.str || 0) * 0.01,\n            };\n            const finalHitRate = calculateFinalHitRate(skill.hitRate, enemyStats, currentPlayerStats);\n            const hitRoll = Math.random();\n\n            if (hitRoll &lt;= Math.min(1.0, finalHitRate)) {\n\n              const finalCritRate = calculateFinalCritRate(\n                skill.critRate,\n                enemyStats,\n                currentPlayerStats,\n                finalHitRate,\n              );\n              const critRoll = Math.random();\n\n              const isCrit = critRoll &lt;= Math.min(1.0, finalCritRate);\n\n              const finalCritMultiplier = isCrit\n                ? calculateFinalCritMultiplier(enemyStats, currentPlayerStats, finalCritRate)\n                : 1.0;\n\n              let damage = calculateFinalDamage(\n                skill.attack,\n                enemyStats,\n                currentPlayerStats,\n                isCrit,\n                finalCritMultiplier,\n              );\n\n              battleState.player.hp -= damage;\n\n              if (StateValidator.isPlayerDead()) {\n                battleState.lastKilledBy = skill.name;\n                return;\n              }\n            }\n\n            enemy.nextAttackIndex = (enemy.nextAttackIndex + 1) % enemy.attackPattern.length;\n          }\n        }\n      }\n\n      function simulateEndOfRound() {\n\n        battleState.player.weapons.forEach(weapon =&gt; {\n          weapon.used = false;\n        });\n\n        battleState.player.hp = Math.min(\n          battleState.player.hp + (battleState.player.hpRegen || 0),\n          battleState.player.maxHp,\n        );\n\n        battleState.player.mp = Math.min(battleState.player.mp + battleState.player.mpRegen, battleState.player.maxMp);\n      }\n\n      function showQuickBattleResults(result) {\n\n        const stats = collectBattleStatistics();\n\n        let summaryHtml = '';\n        if (result.isVictory) {\n          summaryHtml += `&lt;h3 class=\"victory\"&gt;æˆ˜æ–—èƒœåˆ©ï¼&lt;/h3&gt;`;\n          summaryHtml += `&lt;p&gt;ç”¨æ—¶ ${result.rounds} å›åˆ&lt;/p&gt;`;\n          summaryHtml += `&lt;p&gt;å‰©ä½™HP: ${result.finalPlayerHP}/${battleState.player.maxHp}&lt;/p&gt;`;\n          summaryHtml += `&lt;p&gt;å‰©ä½™MP: ${result.finalPlayerMP}/${battleState.player.maxMp}&lt;/p&gt;`;\n\n          if (battleState.killedEnemies &amp;&amp; battleState.killedEnemies.length &gt; 0) {\n            summaryHtml += `&lt;p&gt;å‡»è´¥çš„æ•Œäºº: ${battleState.killedEnemies.join('ã€')}&lt;/p&gt;`;\n\n            const defeatedEnemies = battleState.initialEnemies.filter(enemy =&gt;\n              battleState.killedEnemies.includes(enemy.name),\n            );\n            // ç»éªŒå€¼ç³»ç»Ÿå·²ç¦ç”¨\n            // const expResult = calculateTeamExperience(battleState.player, battleState.teammates, defeatedEnemies);\n            // summaryHtml += `&lt;div style=\"margin-top: 15px; padding: 10px; background: rgba(6, 182, 212, 0.1); border-radius: 8px; border: 1px solid var(--accent-color);\"&gt;`;\n            // summaryHtml += `&lt;h4 style=\"color: var(--accent-color); margin: 0 0 10px 0;\"&gt;ğŸ“ˆ ç»éªŒå€¼è·å¾—&lt;/h4&gt;`;\n            // summaryHtml += `&lt;p&gt;&lt;strong&gt;${battleState.player.name || 'User'}&lt;/strong&gt; (ç­‰çº§${\n            //   battleState.player.grade || 1\n            // }) è·å¾—ç»éªŒå€¼: &lt;span style=\"color: var(--accent-color); font-weight: bold;\"&gt;${\n            //   expResult.playerExp\n            // } EXP&lt;/span&gt;&lt;/p&gt;`;\n            // if (expResult.teammateResults &amp;&amp; expResult.teammateResults.length &gt; 0) {\n            //   expResult.teammateResults.forEach(teammate =&gt; {\n            //     summaryHtml += `&lt;p&gt;&lt;strong&gt;${teammate.name}&lt;/strong&gt; (ç­‰çº§${teammate.level}) è·å¾—ç»éªŒå€¼: &lt;span style=\"color: var(--accent-color); font-weight: bold;\"&gt;${teammate.exp} EXP&lt;/span&gt;&lt;/p&gt;`;\n            //   });\n            // }\n            // summaryHtml += `&lt;/div&gt;`;\n          }\n        } else {\n          summaryHtml += `&lt;h3 class=\"defeat\"&gt;æˆ˜æ–—å¤±è´¥ï¼&lt;/h3&gt;`;\n          summaryHtml += `&lt;p&gt;åšæŒäº† ${result.rounds} å›åˆ&lt;/p&gt;`;\n          if (battleState.lastKilledBy) {\n            summaryHtml += `&lt;p&gt;è¢« ${battleState.lastKilledBy} å‡»è´¥&lt;/p&gt;`;\n          }\n\n          if (battleState.killedEnemies &amp;&amp; battleState.killedEnemies.length &gt; 0) {\n            summaryHtml += `&lt;p&gt;å‡»è´¥çš„æ•Œäºº: ${battleState.killedEnemies.join('ã€')}&lt;/p&gt;`;\n          }\n        }\n\n        if (stats.weaponStats.length &gt; 0) {\n          summaryHtml += `&lt;h4 style=\"margin-top: 10px;\"&gt;æ­¦å™¨ç»Ÿè®¡:&lt;/h4&gt;`;\n          summaryHtml += `&lt;ul style=\"text-align: left; padding-left: 20px;\"&gt;`;\n          stats.weaponStats.forEach(weapon =&gt; {\n            summaryHtml += `&lt;li&gt;${weapon.name}: é€ æˆ ${weapon.damage} ç‚¹ä¼¤å®³`;\n            if (weapon.kills &gt; 0) {\n              summaryHtml += `ï¼Œå‡»è´¥ ${weapon.kills} ä¸ªæ•Œäºº`;\n            }\n            summaryHtml += `&lt;/li&gt;`;\n          });\n          summaryHtml += `&lt;/ul&gt;`;\n        }\n\n        if (stats.itemUsage &amp;&amp; stats.itemUsage.length &gt; 0) {\n          summaryHtml += `&lt;h4 style=\"margin-top: 10px;\"&gt;ä¸¹è¯ä½¿ç”¨:&lt;/h4&gt;`;\n          summaryHtml += `&lt;ul style=\"text-align: left; padding-left: 20px;\"&gt;`;\n          stats.itemUsage.forEach(item =&gt; {\n          summaryHtml += `&lt;li&gt;${item.name}: ä½¿ç”¨äº† ${item.count} ä¸ª&lt;/li&gt;`;\n        });\n        summaryHtml += `&lt;/ul&gt;`;\n      }\n\n      resultSummary.innerHTML = summaryHtml;\n      resultModal.style.display = 'flex';\n\n      closeResultBtn.removeEventListener('click', closeResultHandler);\n      sendResultBtn.removeEventListener('click', sendResultHandler);\n\n      closeResultBtn.addEventListener('click', closeResultHandler);\n\n      sendResultBtn.addEventListener('click', sendResultHandler);\n    }\n      function closeResultHandler() {\n        resultModal.style.display = 'none';\n\n        extraResultText.value = '';\n\n        battleState.isActive = false;\n        battleState.attackInProgress = false;\n      }\n\n      function sendResultHandler() {\n\n        const extraText = extraResultText.value.trim();\n\n        let message = '';\n        if (StateValidator.isVictory()) {\n\n          const allEnemyNames = battleState.initialEnemies.map(enemy =&gt; enemy.name).join('ã€');\n\n          const stats = collectBattleStatistics();\n          let weaponDamageStats = '';\n          if (stats.weaponStats.length &gt; 0) {\n            weaponDamageStats =\n              'ï¼Œæ­¦å™¨ä¼¤å®³ç»Ÿè®¡: ' +\n              stats.weaponStats\n                .map(\n                  weapon =&gt;\n                    `${weapon.name}ä¼¤å®³ä¸º${weapon.damage}${weapon.kills &gt; 0 ? `(å‡»è´¥äº†${weapon.kills}ä¸ªæ•Œäºº)` : ''}`,\n                )\n                .join(', ');\n          }\n\n          let itemUsageStats = '';\n          if (stats.itemUsage &amp;&amp; stats.itemUsage.length &gt; 0) {\n            itemUsageStats = 'ï¼Œä½¿ç”¨ä¸¹è¯: ' + stats.itemUsage.map(item =&gt; `${item.name} ${item.count}ä¸ª`).join('ã€');\n          }\n\n          let playerStatus = `æç™½è¡€é‡${battleState.player.hp}/${battleState.player.maxHp}ï¼ŒMPå€¼${battleState.player.mp}/${battleState.player.maxMp}`;\n\n          let teammatesStatus = '';\n          if (battleState.teammates &amp;&amp; battleState.teammates.length &gt; 0) {\n            teammatesStatus =\n              'ï¼Œé˜Ÿå‹çŠ¶æ€: ' +\n              battleState.teammates\n                .map(\n                  teammate =&gt;\n                    `${teammate.name}è¡€é‡${teammate.hp}/${teammate.maxHp}ï¼ŒMPå€¼${teammate.mp}/${teammate.maxMp}`,\n                )\n                .join('ï¼›');\n          }\n\n          let expInfo = '';\n          // ç»éªŒå€¼ç³»ç»Ÿå·²ç¦ç”¨\n          // if (battleState.killedEnemies &amp;&amp; battleState.killedEnemies.length &gt; 0) {\n          //   const defeatedEnemies = battleState.initialEnemies.filter(enemy =&gt;\n          //     battleState.killedEnemies.includes(enemy.name),\n          //   );\n          //   const expResult = calculateTeamExperience(battleState.player, battleState.teammates, defeatedEnemies);\n          //   expInfo = `ï¼Œæç™½è·å¾—${expResult.playerExp}ç»éªŒå€¼`;\n          //   if (expResult.teammateResults &amp;&amp; expResult.teammateResults.length &gt; 0) {\n          //     const teammateExpInfo = expResult.teammateResults\n          //       .map(teammate =&gt; `${teammate.name}è·å¾—${teammate.exp}ç»éªŒå€¼`)\n          //       .join('ï¼Œ');\n          //     expInfo += `ï¼Œ${teammateExpInfo}`;\n          //   }\n          // }\n          message = `&lt;request:æç™½èµ¢å¾—äº†æˆ˜æ–—ï¼Œ${playerStatus}${teammatesStatus}ï¼Œä¼¤å®³æœ€é«˜æ­¦å™¨ä¸º${\n            stats.weaponStats.length &gt; 0 ? stats.weaponStats[0].name : 'æ— '\n          }ï¼Œå‡»è´¥äº†${allEnemyNames}${weaponDamageStats}${itemUsageStats}${expInfo}${\n            extraText ? 'ï¼Œ' + extraText : ''\n          }&gt;`;\n        } else {\n\n          const stats = collectBattleStatistics();\n          let weaponDamageStats = '';\n          if (stats.weaponStats.length &gt; 0) {\n            weaponDamageStats =\n              'ï¼Œæ­¦å™¨ä¼¤å®³ç»Ÿè®¡: ' +\n              stats.weaponStats\n                .map(\n                  weapon =&gt;\n                    `${weapon.name}ä¼¤å®³ä¸º${weapon.damage}${weapon.kills &gt; 0 ? `(å‡»è´¥äº†${weapon.kills}ä¸ªæ•Œäºº)` : ''}`,\n                )\n                .join(', ');\n          }\n\n          let itemUsageStats = '';\n          if (stats.itemUsage &amp;&amp; stats.itemUsage.length &gt; 0) {\n            itemUsageStats = 'ï¼Œä½¿ç”¨ä¸¹è¯: ' + stats.itemUsage.map(item =&gt; `${item.name} ${item.count}ä¸ª`).join('ã€');\n          }\n\n          let defeatedEnemies = '';\n          if (battleState.killedEnemies &amp;&amp; battleState.killedEnemies.length &gt; 0) {\n            defeatedEnemies = `ï¼Œå‡»è´¥äº†${battleState.killedEnemies.join('ã€')}`;\n          }\n\n          let teammatesStatus = '';\n          if (battleState.teammates &amp;&amp; battleState.teammates.length &gt; 0) {\n            teammatesStatus =\n              'ï¼Œé˜Ÿå‹çŠ¶æ€: ' +\n              battleState.teammates\n                .map(\n                  teammate =&gt;\n                    `${teammate.name}è¡€é‡${teammate.hp}/${teammate.maxHp}ï¼ŒMPå€¼${teammate.mp}/${teammate.maxMp}`,\n                )\n                .join('ï¼›');\n          }\n          message = `&lt;request:æç™½è¢«å‡»è´¥äº†ï¼Œæç™½è¡€é‡å˜ä¸º0/${battleState.player.maxHp}ï¼ŒMPå€¼${\n            battleState.player.mp\n          }/${battleState.player.maxMp}${teammatesStatus}${\n            battleState.lastKilledBy ? 'ï¼Œè¢«' + battleState.lastKilledBy + 'å‡»è´¥' : ''\n          }${defeatedEnemies}${weaponDamageStats}${itemUsageStats}${extraText ? 'ï¼Œ' + extraText : ''}&gt;`;\n        }\n\n        sendBattleResult(message)\n          .then(success =&gt; {\n            if (success) {\n\n            } else {\n\n            }\n          })\n          .catch(e =&gt; {\n            console.error('å‘é€æˆ˜æ–—ç»“æœå¤±è´¥:', e);\n          });\n\n        resultModal.style.display = 'none';\n\n        extraResultText.value = '';\n\n        battleState.isActive = false;\n        battleState.attackInProgress = false;\n      }\n\n      function calculateActionOrder() {\n\n        battleState.actionOrder = [];\n        battleState.currentActionIndex = 0;\n        battleState.actionsThisRound = {};\n\n        const allParticipants = [];\n\n        allParticipants.push({\n          type: 'player',\n          id: 'player',\n          name: battleState.player.name || 'User',\n          speed: battleState.player.speed,\n          entity: battleState.player,\n        });\n\n        battleState.teammates.forEach(teammate =&gt; {\n          allParticipants.push({\n            type: 'teammate',\n            id: teammate.id,\n            name: teammate.name,\n            speed: teammate.speed,\n            entity: teammate,\n          });\n        });\n\n        battleState.enemies.forEach(enemy =&gt; {\n          allParticipants.push({\n            type: 'enemy',\n            id: enemy.id,\n            name: enemy.name,\n            speed: enemy.speed,\n            entity: enemy,\n          });\n        });\n\n        const minSpeed = Math.min(...allParticipants.map(p =&gt; p.speed));\n\n        const actionPool = [];\n\n        allParticipants.forEach(participant =&gt; {\n\n          actionPool.push({\n            type: participant.type,\n            id: participant.id,\n            name: participant.name,\n            entity: participant.entity,\n            speed: participant.speed,\n            actionNumber: 1,\n          });\n\n          let extraActionCount = 1;\n          let currentSpeed = participant.speed;\n          while (currentSpeed &gt;= minSpeed * 2) {\n\n            currentSpeed = Math.floor(currentSpeed / 2);\n            extraActionCount++;\n            actionPool.push({\n              type: participant.type,\n              id: participant.id,\n              name: participant.name,\n              entity: participant.entity,\n              speed: currentSpeed,\n              actionNumber: extraActionCount,\n            });\n          }\n        });\n\n        actionPool.sort((a, b) =&gt; b.speed - a.speed);\n\n        battleState.actionOrder = actionPool;\n\n        allParticipants.forEach(participant =&gt; {\n          battleState.actionsThisRound[`${participant.type}-${participant.id}`] = 0;\n        });\n\n        let actionOrderText = 'è¡ŒåŠ¨é¡ºåº: ';\n        battleState.actionOrder.forEach((action, index) =&gt; {\n          actionOrderText += `${index + 1}.${action.name}`;\n          if (index &lt; battleState.actionOrder.length - 1) {\n            actionOrderText += ' â†’ ';\n          }\n        });\n        logBattleAction(actionOrderText);\n        return battleState.actionOrder;\n      }\n\n      function startBattle() {\n        const data = statusDataSource.textContent;\n        battleData = parseStatusData(data);\n        const selectedEnemyElements = document.querySelectorAll('#pilots-container .enemy-item.selected');\n        const selectedEnemyIndices = Array.from(selectedEnemyElements).map(el =&gt;\n          parseInt(el.getAttribute('data-enemy-index')),\n        );\n        const selectedEnemies = battleData.enemies.filter((enemy, index) =&gt; selectedEnemyIndices.includes(index));\n        if (selectedEnemies.length === 0) {\n          alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ•Œäººè¿›è¡Œæˆ˜æ–—ï¼');\n          return;\n        }\n\n        const selectedTeammates = battleState.selectedTeammates || [];\n        battleState.isActive = true;\n        battleState.round = 1;\n\n        battleState.currentItemUsed = false;\n        battleState.playerBuffs = [];\n        battleState.player = JSON.parse(JSON.stringify(battleData.player));\n        battleState.teammates = JSON.parse(JSON.stringify(selectedTeammates)); \n        battleState.currentTeammate = null; \n        battleState.enemies = JSON.parse(JSON.stringify(selectedEnemies));\n        battleState.initialEnemies = JSON.parse(JSON.stringify(selectedEnemies));\n        battleState.selectedEnemies = [];\n        battleState.selectedHealTargets = []; \n        battleState.currentWeapon = null;\n        battleState.currentItem = null;\n        battleState.waitingForNextRound = false;\n        battleState.healTarget = null;\n        battleState.selfTargetMode = false;\n        battleState.lastKilledBy = null;\n        battleState.itemUsageStats = {}; \n        battleState.highestDamageWeapon = {\n          name: '',\n          damage: 0,\n        };\n        battleState.actionOrder = []; \n        battleState.currentActionIndex = 0; \n        battleState.sacrificeBoostActive = null; \n\n        hateSystem.enemyHateLists = {}; \n\n        lazyRenderManager.isCombatRendered = true;\n        document.querySelector('.container').style.display = 'none';\n        initializeBattleInterface();\n        combatInterface.style.display = 'block';\n\n        lazyRenderManager.safeUpdateInterface(() =&gt; {\n\n          calculateActionOrder();\n          logBattleAction(`ç¬¬ ${battleState.round} å›åˆå¼€å§‹ï¼`);\n\n          memoryManager.safeSetTimeout(() =&gt; {\n            forceUpdateUI();\n            showCurrentActor(); \n            updateHateDisplay(); \n          }, 100);\n        }, 'combat');\n      }\n\n      function showCurrentActor() {\n\n        battleState.currentItemUsed = false;\n        if (battleState.actionOrder.length === 0) {\n          return;\n        }\n        if (battleState.currentActionIndex &gt;= battleState.actionOrder.length) {\n          battleState.currentActionIndex = 0;\n        }\n        const currentAction = battleState.actionOrder[battleState.currentActionIndex];\n        if (!currentAction) {\n          return;\n        }\n\n        let entityExists = false;\n        if (currentAction.type === 'player') {\n\n          entityExists = true;\n        } else if (currentAction.type === 'teammate') {\n\n          entityExists = battleState.teammates.some(t =&gt; t.id === currentAction.id);\n        } else if (currentAction.type === 'enemy') {\n\n          entityExists = battleState.enemies.some(e =&gt; e.id === currentAction.id);\n        }\n\n        if (!entityExists) {\n          moveToNextAction();\n          return;\n        }\n        logBattleAction(`${currentAction.name} çš„è¡ŒåŠ¨å›åˆï¼`);\n\n        document.querySelectorAll('.action-order-item').forEach(item =&gt; {\n          const index = parseInt(item.getAttribute('data-action-index'));\n          if (index === battleState.currentActionIndex) {\n            item.classList.add('current');\n          } else {\n            item.classList.remove('current');\n          }\n        });\n\n        document.querySelectorAll('.combat-entity').forEach(entity =&gt; {\n          entity.classList.remove('current-actor');\n        });\n        if (currentAction.type === 'player') {\n          const playerEntity = document.querySelector('.combat-entity.player');\n          if (playerEntity) {\n            playerEntity.classList.add('current-actor');\n          }\n\n          const currentPlayerStats = getPlayerActualStats();\n          battleState.player.ap = currentPlayerStats.actionPoints; \n          battleState.player.maxAp = currentPlayerStats.actionPoints;\n          battleState.currentItemUsed = false;\n\n          battleState.player.weapons.forEach(weapon =&gt; {\n            weapon.used = false;\n          });\n          battleState.player.items.forEach(item =&gt; {\n            item.used = false;\n          });\n\n          battleState.currentTeammate = null;\n\n          document.getElementById('melee-toggle').innerHTML = '&lt;i class=\"fas fa-magic\"&gt;&lt;/i&gt; ç¥é€š';\n\n          updatePlayerPanel(); \n          updateWeaponsList(); \n          updateItemsList(); \n\n          enablePlayerControls();\n        } else if (currentAction.type === 'teammate') {\n\n          const teammateEntity = document.querySelector(\n            `.combat-entity.teammate[data-teammate-id=\"${currentAction.id}\"]`,\n          );\n          if (teammateEntity) {\n            teammateEntity.classList.add('current-actor');\n          }\n\n          currentAction.entity.skillUsed = false;\n          currentAction.entity.ap = currentAction.entity.maxAp; \n          currentAction.entity.weapons.forEach(weapon =&gt; {\n            weapon.used = false;\n          });\n\n          battleState.currentTeammate = currentAction.entity;\n\n          logBattleAction(`è½®åˆ° ${currentAction.name} è¡ŒåŠ¨ï¼Œè¯·é€‰æ‹©ç¥é€šè¿›è¡Œæ”»å‡»ã€‚`);\n\n          updatePlayerPanel();\n\n          document.getElementById('melee-toggle').innerHTML = '&lt;i class=\"fas fa-magic\"&gt;&lt;/i&gt; é˜Ÿå‹ç¥é€š';\n\n          updateTeammateWeaponsList();\n\n          updateItemsList();\n\n          setupSkipButton();\n        } else if (currentAction.type === 'enemy') {\n          const enemyEntity = document.querySelector(`.combat-entity.enemy[data-enemy-id=\"${currentAction.id}\"]`);\n          if (enemyEntity) {\n            enemyEntity.classList.add('current-actor');\n          }\n\n          performEnemyAction(currentAction.entity);\n        }\n      }\n      function initializeBattleInterface() {\n        updateBattleUI({ player: true, enemy: true, weapons: true, items: true });\n        combatLog.innerHTML = '';\n\n        const actionOrderDisplay = document.getElementById('action-order-display');\n        if (actionOrderDisplay) {\n          actionOrderDisplay.innerHTML = '';\n        }\n\n        battleState.fullCombatLog = [];\n\n        const meleeToggle = document.getElementById('melee-toggle');\n        const itemsToggle = document.getElementById('items-toggle');\n        const attackBtn = document.getElementById('attack-btn');\n        const nextRoundBtn = document.getElementById('next-round-btn');\n\n        function clearEventListeners(element) {\n          if (!element) return;\n          const clone = element.cloneNode(true);\n          if (element.parentNode) {\n            element.parentNode.replaceChild(clone, element);\n          }\n          return clone;\n        }\n\n        const newMeleeToggle = clearEventListeners(meleeToggle);\n        const newItemsToggle = clearEventListeners(itemsToggle);\n        const statsToggle = document.getElementById('stats-toggle');\n        const newStatsToggle = clearEventListeners(statsToggle);\n        const newAttackBtn = clearEventListeners(attackBtn);\n        const newNextRoundBtn = clearEventListeners(nextRoundBtn);\n\n        newMeleeToggle.addEventListener('click', function () {\n          newMeleeToggle.classList.add('active');\n          newItemsToggle.classList.remove('active');\n          newStatsToggle.classList.remove('active');\n          document.getElementById('melee-panel').classList.add('active');\n          document.getElementById('items-panel').classList.remove('active');\n          document.getElementById('stats-panel').classList.remove('active');\n        });\n        newItemsToggle.addEventListener('click', function () {\n          newItemsToggle.classList.add('active');\n          newMeleeToggle.classList.remove('active');\n          newStatsToggle.classList.remove('active');\n          document.getElementById('items-panel').classList.add('active');\n          document.getElementById('melee-panel').classList.remove('active');\n          document.getElementById('stats-panel').classList.remove('active');\n        });\n        newStatsToggle.addEventListener('click', function () {\n          newStatsToggle.classList.add('active');\n          newMeleeToggle.classList.remove('active');\n          newItemsToggle.classList.remove('active');\n          document.getElementById('stats-panel').classList.add('active');\n          document.getElementById('melee-panel').classList.remove('active');\n          document.getElementById('items-panel').classList.remove('active');\n\n          updateDetailedStatsPanel();\n        });\n\n        newAttackBtn.addEventListener('click', performPlayerAttack);\n\n        battleState.attackInProgress = false;\n      }\n\n      function generateBuffTooltip(buff) {\n        if (buff.type === 'critBoost') return `æš´å‡»ç‡+${buff.value}%`;\n        if (buff.type === 'healOverTime') return `æ¯å›åˆæ¢å¤${buff.value}HP`;\n        if (buff.type === 'shieldOverTime') return `æ¯å›åˆè·å¾—${buff.value}ç‚¹æŠ¤ç›¾`;\n        if (buff.type === 'sacrificeBoost') return buff.tooltipText;\n        if (buff.type === 'strBoost') return `åŠ›é‡+${buff.value}`;\n        if (buff.type === 'agiBoost') return `æ•æ·+${buff.value}`;\n        if (buff.type === 'intBoost') return `æ™ºåŠ›+${buff.value}`;\n        if (buff.type === 'endBoost') return `è€åŠ›+${buff.value}`;\n        return '';\n      }\n\n      function generateBuffsHtml(buffs) {\n        return buffs\n          .map(buff =&gt; {\n            const positiveTypes = ['healOverTime', 'shieldOverTime'];\n            const buffClass = buff.isPositive || positiveTypes.includes(buff.type) ? 'positive' : 'negative';\n            const tooltipText = generateBuffTooltip(buff);\n            const duration = buff.duration === 'æœ¬å›åˆ' ? buff.duration : buff.duration + 'å›åˆ';\n            return `\n            &lt;div class=\"buff ${buffClass} status-effect\"&gt;\n                &lt;div class=\"buff-name\"&gt;${buff.name}&lt;/div&gt;\n                &lt;div class=\"buff-duration\"&gt;${duration}&lt;/div&gt;\n                &lt;span class=\"effect-tooltip\"&gt;${tooltipText}&lt;/span&gt;\n            &lt;/div&gt;`;\n          })\n          .join('');\n      }\n\n      function updatePlayerPanel() {\n\n        if (!lazyRenderManager.shouldRenderCombat()) {\n          return;\n        }\n        let html = ''; \n\n        const player = battleState.player;\n        const playerStats = getPlayerActualStats();\n\n        let allBuffs = [...battleState.playerBuffs];\n\n        if (battleState.sacrificeBoostActive) {\n          allBuffs.push({\n            name: 'ç‰ºç‰²å¢ç›Š',\n            type: 'sacrificeBoost',\n            isPositive: true,\n            duration: 'æœ¬å›åˆ',\n            tooltipText: `æ”»å‡»+${battleState.sacrificeBoostActive.attack}ï¼Œå‘½ä¸­+${battleState.sacrificeBoostActive.hitRate}%ï¼Œæš´å‡»+${battleState.sacrificeBoostActive.critRate}%ï¼Œæ¬¡æ•°+${battleState.sacrificeBoostActive.attacksPerTurn}ï¼Œç›®æ ‡+${battleState.sacrificeBoostActive.targetsPerAttack}`,\n          });\n        }\n        const buffsHtml = generateBuffsHtml(allBuffs);\n\n        const selfTargetClass = battleState.selfTargetMode ? 'selectable' : '';\n\n        html += `\n                &lt;div class=\"combat-entity player ${selfTargetClass}\" data-entity-type=\"player\"&gt;\n                    &lt;div class=\"entity-header\"&gt;\n                        &lt;div class=\"entity-name\"&gt;${player.name || 'User'}&lt;/div&gt;\n                    &lt;/div&gt;\n                    &lt;div class=\"entity-stats\"&gt;\n                        &lt;div class=\"hp-bar-container\"&gt;\n                            &lt;div class=\"hp-bar-label\"&gt;&lt;i class=\"fas fa-heart\" style=\"color: var(--health-color);\"&gt;&lt;/i&gt;&lt;/div&gt;\n                            &lt;div class=\"hp-bar-combat\"&gt;\n                                &lt;div class=\"hp-fill-combat\" style=\"width: ${(player.hp / player.maxHp) * 100}%\"&gt;&lt;/div&gt;\n                                &lt;div class=\"hp-text-combat\"&gt;${player.hp}/${player.maxHp} (+${\n          playerStats.hpRegen\n        }/å›åˆ)&lt;/div&gt;\n                            &lt;/div&gt;\n                        &lt;/div&gt;\n                        &lt;div class=\"mp-bar-container\"&gt;\n                            &lt;div class=\"mp-bar-label\"&gt;&lt;i class=\"fas fa-flask\" style=\"color: var(--mana-color);\"&gt;&lt;/i&gt;&lt;/div&gt;\n                            &lt;div class=\"mp-bar-combat\"&gt;\n                                &lt;div class=\"mp-fill-combat\" style=\"width: ${(player.mp / player.maxMp) * 100}%\"&gt;&lt;/div&gt;\n                                &lt;div class=\"mp-text-combat\"&gt;${player.mp}/${player.maxMp} (+${\n          playerStats.mpRegen\n        }/å›åˆ)&lt;/div&gt;\n                            &lt;/div&gt;\n                        &lt;/div&gt;\n                        &lt;div class=\"ap-bar-container\"&gt;\n                            &lt;div class=\"ap-bar-label\"&gt;&lt;i class=\"fas fa-bolt\" style=\"color: var(--primary-color);\"&gt;&lt;/i&gt;&lt;/div&gt;\n                            &lt;div class=\"ap-bar-combat\"&gt;\n                                &lt;div class=\"ap-fill-combat\" style=\"width: ${\n                                  player.maxAp &gt; 0 ? (player.ap / player.maxAp) * 100 : 0\n                                }%\"&gt;&lt;/div&gt;\n                                &lt;div class=\"ap-text-combat\"&gt;${player.ap || 0}/${player.maxAp || 0} è¡ŒåŠ¨ç‚¹&lt;/div&gt;\n                            &lt;/div&gt;\n                        &lt;/div&gt;\n                        ${player.shield || player.tempShield ? `\n                        &lt;div class=\"shield-bar-container\"&gt;\n                            &lt;div class=\"shield-bar-label\"&gt;&lt;i class=\"fas fa-shield-alt\" style=\"color: #06b6d4;\"&gt;&lt;/i&gt;&lt;/div&gt;\n                            &lt;div class=\"shield-bar-combat\"&gt;\n                                &lt;div class=\"shield-text-combat\"&gt;${\n                                  player.shield &amp;&amp; player.tempShield \n                                    ? `æŠ¤ç›¾ ${player.shield} | ä¸´æ—¶ ${player.tempShield}` \n                                    : player.shield \n                                      ? `æŠ¤ç›¾ ${player.shield}` \n                                      : `ä¸´æ—¶ ${player.tempShield}`\n                                }&lt;/div&gt;\n                            &lt;/div&gt;\n                        &lt;/div&gt;\n                        ` : ''}\n                        &lt;button class=\"stats-toggle-btn\" onclick=\"toggleStats('player-stats')\"&gt;\n                            &lt;i class=\"fas fa-chart-bar\"&gt;&lt;/i&gt; è¯¦ç»†å±æ€§\n                            &lt;span class=\"toggle-icon\"&gt;â–¼&lt;/span&gt;\n                        &lt;/button&gt;\n                        &lt;div class=\"stats-collapsible\" id=\"player-stats\"&gt;\n                            &lt;div class=\"stats-compact\"&gt;\n\n                                &lt;div class=\"stat-category\"&gt;\n                                    &lt;div class=\"category-title\" style=\"font-size: 9px; margin-bottom: 3px;\"&gt;\n                                        STR:${playerStats.str} AGI:${playerStats.agi} INT:${playerStats.int} VIT:${\n          playerStats.end\n        }\n                            &lt;/div&gt;\n                            &lt;/div&gt;\n\n                                &lt;div class=\"stat-row str-based\"&gt;\n                                    &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-hand-fist\"&gt;&lt;/i&gt; ä¼¤å®³åŠ æˆ&lt;/div&gt;\n                                    &lt;div class=\"stat-row-value\"&gt;+${(playerStats.damageBonus * 100).toFixed(1)}%&lt;/div&gt;\n                            &lt;/div&gt;\n                                &lt;div class=\"stat-row str-based\"&gt;\n                                    &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-shield-alt\"&gt;&lt;/i&gt; å‡ä¼¤å€¼&lt;/div&gt;\n                                    &lt;div class=\"stat-row-value\"&gt;${playerStats.physicalReduction}&lt;/div&gt;\n                            &lt;/div&gt;\n\n                                &lt;div class=\"stat-row agi-based\"&gt;\n                                    &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-shoe-prints\"&gt;&lt;/i&gt; é—ªé¿ç‡&lt;/div&gt;\n                                    &lt;div class=\"stat-row-value\"&gt;${(playerStats.evasionRate * 100).toFixed(2)}%&lt;/div&gt;\n                                &lt;/div&gt;\n                                &lt;div class=\"stat-row agi-based\"&gt;\n                                    &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-crosshairs\"&gt;&lt;/i&gt; é¢å¤–å‘½ä¸­&lt;/div&gt;\n                                    &lt;div class=\"stat-row-value\"&gt;+${(playerStats.extraHitRate * 100).toFixed(1)}%&lt;/div&gt;\n                                &lt;/div&gt;\n                                &lt;div class=\"stat-row agi-based\"&gt;\n                                    &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-wind\"&gt;&lt;/i&gt; é€Ÿåº¦&lt;/div&gt;\n                                    &lt;div class=\"stat-row-value\"&gt;${playerStats.speed}&lt;/div&gt;\n                                &lt;/div&gt;\n\n                                &lt;div class=\"stat-row int-based\"&gt;\n                                    &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-star\"&gt;&lt;/i&gt; é¢å¤–æš´å‡»&lt;/div&gt;\n                                    &lt;div class=\"stat-row-value\"&gt;+${(playerStats.extraCritRate * 100).toFixed(1)}%&lt;/div&gt;\n                                &lt;/div&gt;\n                                &lt;div class=\"stat-row int-based\"&gt;\n                                    &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-fire\"&gt;&lt;/i&gt; æš´å‡»å€ç‡&lt;/div&gt;\n                                    &lt;div class=\"stat-row-value\"&gt;${(playerStats.baseCritMultiplier * 100).toFixed(\n                                      1,\n                                    )}%&lt;/div&gt;\n                                &lt;/div&gt;\n\n                                &lt;div class=\"stat-row resistance\"&gt;\n                                    &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-eye-slash\"&gt;&lt;/i&gt; æš´å‡»ç‡æŠµæŠ—&lt;/div&gt;\n                                    &lt;div class=\"stat-row-value\"&gt;${(playerStats.critRateResistance * 100).toFixed(\n                                      2,\n                                    )}%&lt;/div&gt;\n                                &lt;/div&gt;\n                                &lt;div class=\"stat-row resistance\"&gt;\n                                    &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-shield-alt\"&gt;&lt;/i&gt; æš´ä¼¤æŠµæŠ—&lt;/div&gt;\n                                    &lt;div class=\"stat-row-value\"&gt;${(playerStats.critDamageResistance * 100).toFixed(\n                                      2,\n                                    )}%&lt;/div&gt;\n                                &lt;/div&gt;\n\n                                &lt;div class=\"stat-row vit-based\"&gt;\n                                    &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-shield-virus\"&gt;&lt;/i&gt; æ‰¿ä¼¤ç‡&lt;/div&gt;\n                                    &lt;div class=\"stat-row-value\"&gt;${(playerStats.damageTakenRate * 100).toFixed(1)}%&lt;/div&gt;\n                                &lt;/div&gt;\n                            &lt;/div&gt;\n                        &lt;/div&gt;\n                    &lt;/div&gt;\n                    &lt;div class=\"entity-buffs\"&gt;\n                        ${buffsHtml}\n                    &lt;/div&gt;\n                    &lt;div class=\"self-target-indicator\"&gt;æˆ‘&lt;/div&gt;\n                &lt;/div&gt;\n            `;\n\n        if (battleState.teammates &amp;&amp; battleState.teammates.length &gt; 0) {\n          battleState.teammates.forEach(teammate =&gt; {\n            const teammateStats = getTeammateActualStats(teammate);\n\n            const teammateBuffsHtml =\n              teammate.buffs &amp;&amp; teammate.buffs.length &gt; 0\n                ? teammate.buffs\n                    .map(buff =&gt; {\n                      const buffClass = buff.isPositive\n                        ? 'positive'\n                        : buff.type === 'healOverTime'\n                        ? 'positive'\n                        : 'negative';\n                      const tooltipText =\n                        generateBuffTooltip(buff) + (buff.type === 'endBoost' ? 'ï¼ˆå¯¹é˜Ÿå‹æ— æ•ˆï¼‰' : '');\n                      return `\n                            &lt;div class=\"buff ${buffClass} status-effect\"&gt;\n                                &lt;div class=\"buff-name\"&gt;${buff.name}&lt;/div&gt;\n                                &lt;div class=\"buff-duration\"&gt;${buff.duration}å›åˆ&lt;/div&gt;\n                                &lt;span class=\"effect-tooltip\"&gt;${tooltipText}&lt;/span&gt;\n                            &lt;/div&gt;`;\n                    })\n                    .join('')\n                : '';\n\n            const teammateTargetClass = battleState.selfTargetMode ? 'selectable' : '';\n            const isCurrentTeammate =\n              battleState.currentTeammate &amp;&amp; battleState.currentTeammate.id === teammate.id ? 'current-teammate' : '';\n\n            html += `\n                        &lt;div class=\"combat-entity teammate ${teammateTargetClass} ${isCurrentTeammate}\" data-teammate-id=\"${\n              teammate.id\n            }\"&gt;\n                            &lt;div class=\"entity-header\"&gt;\n                                &lt;div class=\"entity-name\"&gt;${teammate.name}&lt;/div&gt;\n                            &lt;/div&gt;\n                            &lt;div class=\"entity-stats\"&gt;\n                                &lt;div class=\"hp-bar-container\"&gt;\n                                    &lt;div class=\"hp-bar-label\"&gt;&lt;i class=\"fas fa-heart\" style=\"color: var(--health-color);\"&gt;&lt;/i&gt;&lt;/div&gt;\n                                    &lt;div class=\"hp-bar-combat\"&gt;\n                                        &lt;div class=\"hp-fill-combat\" style=\"width: ${\n                                          (teammate.hp / teammate.maxHp) * 100\n                                        }%\"&gt;&lt;/div&gt;\n                                        &lt;div class=\"hp-text-combat\"&gt;${teammate.hp}/${teammate.maxHp} (+${\n              teammateStats.hpRegen\n            }/å›åˆ)&lt;/div&gt;\n                                    &lt;/div&gt;\n                                &lt;/div&gt;\n                                &lt;div class=\"mp-bar-container\"&gt;\n                                    &lt;div class=\"mp-bar-label\"&gt;&lt;i class=\"fas fa-flask\" style=\"color: var(--mana-color);\"&gt;&lt;/i&gt;&lt;/div&gt;\n                                    &lt;div class=\"mp-bar-combat\"&gt;\n                                        &lt;div class=\"mp-fill-combat\" style=\"width: ${\n                                          (teammate.mp / teammate.maxMp) * 100\n                                        }%\"&gt;&lt;/div&gt;\n                                        &lt;div class=\"mp-text-combat\"&gt;${teammate.mp}/${teammate.maxMp} (+${\n              teammateStats.mpRegen\n            })&lt;/div&gt;\n                                    &lt;/div&gt;\n                                &lt;/div&gt;\n                                &lt;div class=\"ap-bar-container\"&gt;\n                                    &lt;div class=\"ap-bar-label\"&gt;&lt;i class=\"fas fa-bolt\" style=\"color: var(--primary-color);\"&gt;&lt;/i&gt;&lt;/div&gt;\n                                    &lt;div class=\"ap-bar-combat\"&gt;\n                                        &lt;div class=\"ap-fill-combat\" style=\"width: ${\n                                          teammate.maxAp &gt; 0 ? (teammate.ap / teammate.maxAp) * 100 : 0\n                                        }%\"&gt;&lt;/div&gt;\n                                        &lt;div class=\"ap-text-combat\"&gt;${teammate.ap || 0}/${\n              teammate.maxAp || 0\n            } è¡ŒåŠ¨ç‚¹&lt;/div&gt;\n                                    &lt;/div&gt;\n                                &lt;/div&gt;\n                                ${teammate.shield || teammate.tempShield ? `\n                                &lt;div class=\"shield-bar-container\"&gt;\n                                    &lt;div class=\"shield-bar-label\"&gt;&lt;i class=\"fas fa-shield-alt\" style=\"color: #06b6d4;\"&gt;&lt;/i&gt;&lt;/div&gt;\n                                    &lt;div class=\"shield-bar-combat\"&gt;\n                                        &lt;div class=\"shield-text-combat\"&gt;${\n                                          teammate.shield &amp;&amp; teammate.tempShield \n                                            ? `æŠ¤ç›¾ ${teammate.shield} | ä¸´æ—¶ ${teammate.tempShield}` \n                                            : teammate.shield \n                                              ? `æŠ¤ç›¾ ${teammate.shield}` \n                                              : `ä¸´æ—¶ ${teammate.tempShield}`\n                                        }&lt;/div&gt;\n                                    &lt;/div&gt;\n                                &lt;/div&gt;\n                                ` : ''}\n                                &lt;button class=\"stats-toggle-btn\" onclick=\"toggleStats('teammate-stats-${teammate.id}')\"&gt;\n                                    &lt;i class=\"fas fa-chart-bar\"&gt;&lt;/i&gt; è¯¦ç»†å±æ€§\n                                    &lt;span class=\"toggle-icon\"&gt;â–¼&lt;/span&gt;\n                                &lt;/button&gt;\n                                &lt;div class=\"stats-collapsible\" id=\"teammate-stats-${teammate.id}\"&gt;\n\n                                    &lt;div class=\"stats-compact\"&gt;\n\n                                        &lt;div class=\"stat-category\"&gt;\n                                            &lt;div class=\"category-title\" style=\"font-size: 9px; margin-bottom: 3px;\"&gt;\n                                                STR:${teammateStats.str} AGI:${teammateStats.agi} INT:${\n              teammateStats.int\n            } VIT:${teammateStats.end}\n                                            &lt;/div&gt;\n                                        &lt;/div&gt;\n\n                                        &lt;div class=\"stat-row str-based\"&gt;\n                                            &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-hand-fist\"&gt;&lt;/i&gt; ä¼¤å®³åŠ æˆ&lt;/div&gt;\n                                            &lt;div class=\"stat-row-value\"&gt;+${(teammateStats.damageBonus * 100).toFixed(\n                                              1,\n                                            )}%&lt;/div&gt;\n                                        &lt;/div&gt;\n                                        &lt;div class=\"stat-row str-based\"&gt;\n                                            &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-shield-alt\"&gt;&lt;/i&gt; å‡ä¼¤å€¼&lt;/div&gt;\n                                            &lt;div class=\"stat-row-value\"&gt;${teammateStats.physicalReduction}&lt;/div&gt;\n                                        &lt;/div&gt;\n\n                                        &lt;div class=\"stat-row agi-based\"&gt;\n                                            &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-shoe-prints\"&gt;&lt;/i&gt; é—ªé¿ç‡&lt;/div&gt;\n                                            &lt;div class=\"stat-row-value\"&gt;${(teammateStats.evasionRate * 100).toFixed(\n                                              2,\n                                            )}%&lt;/div&gt;\n                                        &lt;/div&gt;\n                                        &lt;div class=\"stat-row agi-based\"&gt;\n                                            &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-crosshairs\"&gt;&lt;/i&gt; é¢å¤–å‘½ä¸­&lt;/div&gt;\n                                            &lt;div class=\"stat-row-value\"&gt;+${(teammateStats.extraHitRate * 100).toFixed(\n                                              1,\n                                            )}%&lt;/div&gt;\n                                        &lt;/div&gt;\n                                        &lt;div class=\"stat-row agi-based\"&gt;\n                                            &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-wind\"&gt;&lt;/i&gt; é€Ÿåº¦&lt;/div&gt;\n                                            &lt;div class=\"stat-row-value\"&gt;${teammateStats.speed}&lt;/div&gt;\n                                        &lt;/div&gt;\n\n                                        &lt;div class=\"stat-row int-based\"&gt;\n                                            &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-star\"&gt;&lt;/i&gt; é¢å¤–æš´å‡»&lt;/div&gt;\n                                            &lt;div class=\"stat-row-value\"&gt;+${(teammateStats.extraCritRate * 100).toFixed(\n                                              1,\n                                            )}%&lt;/div&gt;\n                                        &lt;/div&gt;\n                                        &lt;div class=\"stat-row int-based\"&gt;\n                                            &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-fire\"&gt;&lt;/i&gt; æš´å‡»å€ç‡&lt;/div&gt;\n                                            &lt;div class=\"stat-row-value\"&gt;${(\n                                              teammateStats.baseCritMultiplier * 100\n                                            ).toFixed(1)}%&lt;/div&gt;\n                                        &lt;/div&gt;\n\n                                        &lt;div class=\"stat-row resistance\"&gt;\n                                            &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-eye-slash\"&gt;&lt;/i&gt; æš´å‡»ç‡æŠµæŠ—&lt;/div&gt;\n                                            &lt;div class=\"stat-row-value\"&gt;${(\n                                              teammateStats.critRateResistance * 100\n                                            ).toFixed(2)}%&lt;/div&gt;\n                                        &lt;/div&gt;\n                                        &lt;div class=\"stat-row resistance\"&gt;\n                                            &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-shield-alt\"&gt;&lt;/i&gt; æš´ä¼¤æŠµæŠ—&lt;/div&gt;\n                                            &lt;div class=\"stat-row-value\"&gt;${(\n                                              teammateStats.critDamageResistance * 100\n                                            ).toFixed(2)}%&lt;/div&gt;\n                                        &lt;/div&gt;\n\n                                        &lt;div class=\"stat-row vit-based\"&gt;\n                                            &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-shield-virus\"&gt;&lt;/i&gt; æ‰¿ä¼¤ç‡&lt;/div&gt;\n                                            &lt;div class=\"stat-row-value\"&gt;${(teammateStats.damageTakenRate * 100).toFixed(\n                                              1,\n                                            )}%&lt;/div&gt;\n                                        &lt;/div&gt;\n                                    &lt;/div&gt;\n                                &lt;/div&gt;\n                            &lt;/div&gt;\n                            &lt;div class=\"entity-buffs\"&gt;\n                                ${teammateBuffsHtml}\n                            &lt;/div&gt;\n                        &lt;/div&gt;\n                    `;\n          });\n        }\n\n        combatPlayerPanel.innerHTML = html;\n\n        document.querySelector('.combat-entity.player').addEventListener('click', function () {\n\n          if (battleState.selfTargetMode) {\n\n            const playerId = 'player';\n            const index = battleState.selectedHealTargets.findIndex(t =&gt; t.id === playerId);\n            if (index === -1) {\n\n              if (battleState.selectedHealTargets.length &lt; (battleState.currentWeapon?.targetsPerAttack || 1)) {\n                battleState.selectedHealTargets.push({ id: playerId, type: 'player', entity: battleState.player });\n                this.classList.add('selected');\n\n                if (!battleState.healTarget) {\n                  battleState.healTarget = 'player';\n                }\n              }\n            } else {\n\n              battleState.selectedHealTargets.splice(index, 1);\n              this.classList.remove('selected');\n\n              if (battleState.healTarget === 'player') {\n                battleState.healTarget =\n                  battleState.selectedHealTargets.length &gt; 0 ? battleState.selectedHealTargets[0].id : null;\n              }\n            }\n\n            battleState.selectedEnemies = [];\n            document.querySelectorAll('.combat-entity.enemy').forEach(el =&gt; {\n              el.classList.remove('selected');\n            });\n\n            updateAttackButton();\n          }\n        });\n\n        document.querySelectorAll('.combat-entity.teammate').forEach(teammateElement =&gt; {\n          teammateElement.addEventListener('click', function () {\n            const teammateId = this.getAttribute('data-teammate-id');\n            const teammate = battleState.teammates.find(t =&gt; t.id === teammateId);\n\n            const weaponTemplate = battleState.currentWeapon?.codes\n              ?.find(code =&gt; code.startsWith('WN:A'))\n              ?.match(/WN:(A[1-4])/)?.[1];\n            if (\n              battleState.selfTargetMode &amp;&amp;\n              battleState.currentWeapon &amp;&amp;\n              (weaponTemplate === 'A2' || weaponTemplate === 'A3' || weaponTemplate === 'A4' || battleState.currentWeapon.isHealing)\n            ) {\n\n              const index = battleState.selectedHealTargets.findIndex(t =&gt; t.id === teammateId);\n              const teammate = battleState.teammates.find(t =&gt; t.id === teammateId);\n              if (index === -1) {\n\n                if (battleState.selectedHealTargets.length &lt; (battleState.currentWeapon?.targetsPerAttack || 1)) {\n                  battleState.selectedHealTargets.push({ id: teammateId, type: 'teammate', entity: teammate });\n                  this.classList.add('selected');\n\n                  if (!battleState.healTarget) {\n                    battleState.healTarget = teammateId;\n                  }\n                }\n              } else {\n\n                battleState.selectedHealTargets.splice(index, 1);\n                this.classList.remove('selected');\n\n                if (battleState.healTarget === teammateId) {\n                  battleState.healTarget =\n                    battleState.selectedHealTargets.length &gt; 0 ? battleState.selectedHealTargets[0].id : null;\n                }\n              }\n\n              battleState.selectedEnemies = [];\n              document.querySelectorAll('.combat-entity.enemy').forEach(el =&gt; {\n                el.classList.remove('selected');\n              });\n\n              updateAttackButton();\n            } else {\n\n            }\n          });\n        });\n      }\n\n      function updateEnemyPanel() {\n\n        if (!lazyRenderManager.shouldRenderCombat()) {\n          return;\n        }\n        combatEnemyPanel.innerHTML = battleState.enemies\n          .map((enemy, index) =&gt; {\n            const buffsHtml =\n              enemy.buffs &amp;&amp; enemy.buffs.length &gt; 0\n                ? enemy.buffs\n                    .map(buff =&gt; {\n                      let buffClass = buff.isPositive ? 'positive' : 'negative';\n                      let tooltipText = '';\n                      if (buff.type === 'freeze') {\n                        buffClass = 'ice';\n                        tooltipText = 'æ— æ³•è¡ŒåŠ¨';\n                      } else if (buff.type === 'hitRateDown') {\n                        buffClass = 'lightning';\n                        tooltipText = `å‘½ä¸­ç‡-${buff.value}%`;\n                      } else if (buff.type === 'vulnerable') {\n                        buffClass = 'negative';\n                        tooltipText = `å—ä¼¤+${buff.value}%`;\n                      } else if (buff.type === 'burnOverTime') {\n                        buffClass = 'fire';\n                        tooltipText = `æ¯å›åˆ-${buff.value}ç«ä¼¤`;\n                      } else if (buff.type === 'dot') {\n                        buffClass = 'negative';\n                        tooltipText = `æ¯å›åˆ-${buff.value}æŒç»­ä¼¤å®³`;\n                      }\n                      return `\n                    &lt;div class=\"buff ${buffClass} status-effect\"&gt;\n                        &lt;div class=\"buff-name\"&gt;${buff.name}&lt;/div&gt;\n                        &lt;div class=\"buff-duration\"&gt;${buff.duration}å›åˆ&lt;/div&gt;\n                        &lt;span class=\"effect-tooltip\"&gt;${tooltipText}&lt;/span&gt;\n                    &lt;/div&gt;`;\n                    })\n                    .join('')\n                : '';\n\n            const freezeHtml =\n              enemy.pendingFreeze &amp;&amp; enemy.pendingFreezeCount &gt; 0\n                ? `\n                &lt;div class=\"buff ice status-effect\"&gt;\n                    &lt;div class=\"buff-name\"&gt;æ™•çœ©&lt;/div&gt;\n                    &lt;div class=\"buff-duration\"&gt;${enemy.pendingFreezeCount}å›åˆ&lt;/div&gt;\n                    &lt;span class=\"effect-tooltip\"&gt;æ— æ³•è¡ŒåŠ¨&lt;/span&gt;\n                &lt;/div&gt;`\n                : '';\n\n            const marksHtml = enemy.marks\n              ? Object.keys(enemy.marks)\n                  .map(markType =&gt; {\n                    let markName = '';\n                    let markValue = enemy.marks[markType];\n                    let markTooltip = '';\n                    switch (markType) {\n                      case 'vulnerability':\n                        markName = 'æ˜“ä¼¤';\n                        markTooltip = `ä¸‹æ¬¡æ”»å‡»+${markValue}%ä¼¤å®³`;\n                        break;\n                      case 'weakness':\n                        markName = 'ç ´ç»½';\n                        markTooltip = `ä¸‹æ¬¡æ”»å‡»æš´å‡»ç‡+${markValue}%`;\n                        break;\n                      case 'death':\n                        markName = 'æ­»ç‚¹';\n                        markTooltip = `ä¸‹æ¬¡æ”»å‡»æš´å‡»ä¼¤å®³+${markValue}%`;\n                        break;\n                    }\n                    return `\n                &lt;div class=\"buff negative status-effect\"&gt;\n                    &lt;div class=\"buff-name\"&gt;${markName}&lt;/div&gt;\n                    &lt;div class=\"buff-duration\"&gt;æ ‡è®°&lt;/div&gt;\n                    &lt;span class=\"effect-tooltip\"&gt;${markTooltip}&lt;/span&gt;\n                &lt;/div&gt;`;\n                  })\n                  .join('')\n              : '';\n\n            const stacksHtml = enemy.stacks\n              ? Object.keys(enemy.stacks)\n                  .map(stackType =&gt; {\n                    let stackName = '';\n                    let stackCount = enemy.stacks[stackType];\n                    let stackTooltip = '';\n                    switch (stackType) {\n                      case 'trauma':\n                        stackName = 'åˆ›ä¼¤';\n                        stackTooltip = `${stackCount}å±‚ï¼Œæ¯å±‚-3HP/å›åˆ`;\n                        break;\n                      case 'corrosion':\n                        stackName = 'è…èš€';\n                        stackTooltip = `${stackCount}å±‚ï¼Œå—ä¼¤+${stackCount * 5}%`;\n                        break;\n                    }\n                    return `\n                &lt;div class=\"buff negative status-effect\"&gt;\n                    &lt;div class=\"buff-name\"&gt;${stackName}&lt;/div&gt;\n                    &lt;div class=\"buff-duration\"&gt;${stackCount}å±‚&lt;/div&gt;\n                    &lt;span class=\"effect-tooltip\"&gt;${stackTooltip}&lt;/span&gt;\n                &lt;/div&gt;`;\n                  })\n                  .join('')\n              : '';\n\n            const allEffectsHtml = buffsHtml + freezeHtml + marksHtml + stacksHtml;\n            const nextSkill = enemy.skills.find(skill =&gt; skill.name === enemy.attackPattern[enemy.nextAttackIndex]);\n\n            const enemyHateList = hateSystem.enemyHateLists[enemy.id] || [];\n            const hateListHtml =\n              enemyHateList.length &gt; 0\n                ? enemyHateList\n                    .map(\n                      (hate, index) =&gt; `\n                  &lt;div class=\"hate-item ${index === 0 ? 'current-target' : ''}\"&gt;\n                    &lt;span class=\"hate-target-name\"&gt;${hate.targetName}&lt;/span&gt;\n                    &lt;span class=\"hate-value\"&gt;${hate.hateValue}&lt;/span&gt;\n                  &lt;/div&gt;\n                `,\n                    )\n                    .join('')\n                : '&lt;div class=\"hate-item no-target\"&gt;æ— ä»‡æ¨ç›®æ ‡&lt;/div&gt;';\n            return `\n                    &lt;div class=\"combat-entity enemy\" data-enemy-id=\"${enemy.id}\"&gt;\n                        &lt;div class=\"entity-header\"&gt;\n                            &lt;div class=\"entity-name\"&gt;${enemy.name}&lt;/div&gt;\n                        &lt;/div&gt;\n                        &lt;div class=\"entity-stats\"&gt;\n                            &lt;div class=\"hp-bar-container\"&gt;\n                                &lt;div class=\"hp-bar-label\"&gt;&lt;i class=\"fas fa-heart\" style=\"color: var(--health-color);\"&gt;&lt;/i&gt;&lt;/div&gt;\n                                &lt;div class=\"hp-bar-combat\"&gt;\n                                    &lt;div class=\"hp-fill-combat\" style=\"width: ${(enemy.hp / enemy.maxHp) * 100}%\"&gt;&lt;/div&gt;\n                                    &lt;div class=\"hp-text-combat\"&gt;${enemy.hp}/${enemy.maxHp}&lt;/div&gt;\n                                &lt;/div&gt;\n                            &lt;/div&gt;\n                            &lt;button class=\"stats-toggle-btn\" onclick=\"toggleStats('enemy-stats-${enemy.id}')\"&gt;\n                                &lt;i class=\"fas fa-chart-bar\"&gt;&lt;/i&gt; è¯¦ç»†å±æ€§\n                                &lt;span class=\"toggle-icon\"&gt;â–¼&lt;/span&gt;\n                            &lt;/button&gt;\n                            &lt;div class=\"stats-collapsible\" id=\"enemy-stats-${enemy.id}\"&gt;\n                            &lt;div class=\"stats-compact\"&gt;\n\n                                    &lt;div class=\"stat-category\"&gt;\n                                        &lt;div class=\"category-title\" style=\"font-size: 9px; margin-bottom: 3px;\"&gt;\n                                            STR:${enemy.str || 0} AGI:${enemy.agi || 0} INT:${enemy.int || 0} VIT:${\n              enemy.vit || 0\n            }\n                                        &lt;/div&gt;\n                                    &lt;/div&gt;\n\n                                    &lt;div class=\"stat-row str-based\"&gt;\n                                        &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-hand-fist\"&gt;&lt;/i&gt; ä¼¤å®³åŠ æˆ&lt;/div&gt;\n                                        &lt;div class=\"stat-row-value\"&gt;+${(enemy.damageBonus * 100).toFixed(1)}%&lt;/div&gt;\n                                    &lt;/div&gt;\n                                    &lt;div class=\"stat-row str-based\"&gt;\n                                        &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-shield-alt\"&gt;&lt;/i&gt; å‡ä¼¤å€¼&lt;/div&gt;\n                                        &lt;div class=\"stat-row-value\"&gt;${enemy.physicalReduction}&lt;/div&gt;\n                                    &lt;/div&gt;\n\n                                    &lt;div class=\"stat-row agi-based\"&gt;\n                                        &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-shoe-prints\"&gt;&lt;/i&gt; é—ªé¿ç‡&lt;/div&gt;\n                                        &lt;div class=\"stat-row-value\"&gt;${(enemy.evasionRate * 100).toFixed(2)}%&lt;/div&gt;\n                                    &lt;/div&gt;\n                                    &lt;div class=\"stat-row agi-based\"&gt;\n                                        &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-crosshairs\"&gt;&lt;/i&gt; é¢å¤–å‘½ä¸­&lt;/div&gt;\n                                        &lt;div class=\"stat-row-value\"&gt;+${(enemy.extraHitRate * 100).toFixed(1)}%&lt;/div&gt;\n                                    &lt;/div&gt;\n                                    &lt;div class=\"stat-row agi-based\"&gt;\n                                        &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-wind\"&gt;&lt;/i&gt; é€Ÿåº¦&lt;/div&gt;\n                                        &lt;div class=\"stat-row-value\"&gt;${enemy.speed}&lt;/div&gt;\n                                    &lt;/div&gt;\n\n                                    &lt;div class=\"stat-row int-based\"&gt;\n                                        &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-star\"&gt;&lt;/i&gt; é¢å¤–æš´å‡»&lt;/div&gt;\n                                        &lt;div class=\"stat-row-value\"&gt;+${(enemy.extraCritRate * 100).toFixed(1)}%&lt;/div&gt;\n                                    &lt;/div&gt;\n                                    &lt;div class=\"stat-row int-based\"&gt;\n                                        &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-fire\"&gt;&lt;/i&gt; æš´å‡»å€ç‡&lt;/div&gt;\n                                        &lt;div class=\"stat-row-value\"&gt;${(enemy.baseCritMultiplier * 100).toFixed(\n                                          1,\n                                        )}%&lt;/div&gt;\n                                    &lt;/div&gt;\n\n                                    &lt;div class=\"stat-row resistance\"&gt;\n                                        &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-eye-slash\"&gt;&lt;/i&gt; æš´å‡»ç‡æŠµæŠ—&lt;/div&gt;\n                                        &lt;div class=\"stat-row-value\"&gt;${(enemy.critRateResistance * 100).toFixed(\n                                          2,\n                                        )}%&lt;/div&gt;\n                                    &lt;/div&gt;\n                                    &lt;div class=\"stat-row resistance\"&gt;\n                                        &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-shield-alt\"&gt;&lt;/i&gt; æš´ä¼¤æŠµæŠ—&lt;/div&gt;\n                                        &lt;div class=\"stat-row-value\"&gt;${(enemy.critDamageResistance * 100).toFixed(\n                                          2,\n                                        )}%&lt;/div&gt;\n                                    &lt;/div&gt;\n\n                                    &lt;div class=\"stat-row vit-based\"&gt;\n                                        &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-shield-virus\"&gt;&lt;/i&gt; æ‰¿ä¼¤ç‡&lt;/div&gt;\n                                        &lt;div class=\"stat-row-value\"&gt;${(enemy.damageTakenRate * 100).toFixed(1)}%&lt;/div&gt;\n                                    &lt;/div&gt;\n                                &lt;/div&gt;\n                            &lt;/div&gt;\n                        &lt;/div&gt;\n                        &lt;div class=\"entity-next-attack status-effect\"&gt;\n                            &lt;div class=\"next-attack-title\"&gt;&lt;i class=\"fas fa-bolt\"&gt;&lt;/i&gt; ä¸‹æ¬¡ä½¿ç”¨:&lt;/div&gt;\n                            &lt;div class=\"next-attack-name\"&gt;${enemy.attackPattern[enemy.nextAttackIndex]}&lt;/div&gt;\n                            ${\n                              nextSkill\n                                ? `\n                                &lt;div class=\"skill-stats-grid\"&gt;\n                                    &lt;div class=\"skill-stat-item skill-attack\" title=\"æŠ€èƒ½æ”»å‡»åŠ›\"&gt;\n                                        &lt;i class=\"fas fa-mountain\"&gt;&lt;/i&gt;\n                                    &lt;span&gt;æ”»å‡»: ${nextSkill.attack}&lt;/span&gt;\n                                    &lt;/div&gt;\n                                    &lt;div class=\"skill-stat-item skill-accuracy\" title=\"å‘½ä¸­ç‡\"&gt;\n                                        &lt;i class=\"fas fa-crosshairs\"&gt;&lt;/i&gt;\n                                    &lt;span&gt;å‘½ä¸­: ${getEffectiveHitRate(nextSkill.hitRate, enemy)}%&lt;/span&gt;\n                                    &lt;/div&gt;\n                                    &lt;div class=\"skill-stat-item skill-targets\" title=\"ç›®æ ‡æ•°é‡\"&gt;\n                                        &lt;i class=\"fas fa-users\"&gt;&lt;/i&gt;\n                                        &lt;span&gt;ç›®æ ‡: ${nextSkill.targetsPerAttack || 1}ä¸ª&lt;/span&gt;\n                                    &lt;/div&gt;\n                                    &lt;div class=\"skill-stat-item skill-times\" title=\"æ”»å‡»æ¬¡æ•°\"&gt;\n                                        &lt;i class=\"fas fa-redo\"&gt;&lt;/i&gt;\n                                        &lt;span&gt;æ¬¡æ•°: ${nextSkill.attacksPerTurn || 1}æ¬¡&lt;/span&gt;\n                                    &lt;/div&gt;\n                                &lt;/div&gt;\n                            `\n                                : ''\n                            }\n                            &lt;span class=\"effect-tooltip\"&gt;ä¸‹å›åˆæŠ€èƒ½&lt;/span&gt;\n                        &lt;/div&gt;\n                        &lt;div class=\"entity-hate-list\"&gt;\n                            &lt;div class=\"hate-list-title\"&gt;&lt;i class=\"fas fa-crosshairs\"&gt;&lt;/i&gt; ä»‡æ¨åˆ—è¡¨&lt;/div&gt;\n                            &lt;div class=\"hate-list-content\"&gt;\n                                ${hateListHtml}\n                            &lt;/div&gt;\n                        &lt;/div&gt;\n                        &lt;div class=\"entity-buffs\"&gt;\n                            ${allEffectsHtml}\n                        &lt;/div&gt;\n                    &lt;/div&gt;\n                `;\n          })\n          .join('');\n\n        document.querySelectorAll('.combat-entity.enemy').forEach(enemyElement =&gt; {\n          enemyElement.addEventListener('click', function () {\n            const enemyId = parseInt(this.getAttribute('data-enemy-id'));\n\n            if (battleState.selfTargetMode &amp;&amp; battleState.healTarget === 'player') {\n              return;\n            }\n\n            document.querySelector('.combat-entity.player')?.classList.remove('selected');\n            battleState.healTarget = null;\n\n            if (battleState.currentWeapon &amp;&amp; !battleState.currentWeapon.used) {\n\n              const weaponTemplate = battleState.currentWeapon.codes\n                ?.find(code =&gt; code.startsWith('WN:A'))\n                ?.match(/WN:(A[1-4])/)?.[1];\n              if (weaponTemplate === 'A2' || weaponTemplate === 'A3' || weaponTemplate === 'A4') {\n                return; \n              }\n\n              if (battleState.currentWeapon.targetsPerAttack &gt; 1) {\n                const index = battleState.selectedEnemies.indexOf(enemyId);\n                if (index === -1) {\n                  if (battleState.selectedEnemies.length &lt; battleState.currentWeapon.targetsPerAttack) {\n                    battleState.selectedEnemies.push(enemyId);\n                    this.classList.add('selected');\n                  }\n                } else {\n                  battleState.selectedEnemies.splice(index, 1);\n                  this.classList.remove('selected');\n                }\n              } else {\n\n                document.querySelectorAll('.combat-entity.enemy').forEach(el =&gt; {\n                  el.classList.remove('selected');\n                });\n                battleState.selectedEnemies = [enemyId];\n                this.classList.add('selected');\n              }\n              updateAttackButton();\n\n              const nextRoundBtn = document.getElementById('next-round-btn');\n              if (nextRoundBtn) {\n                const currentAction = battleState.actionOrder[battleState.currentActionIndex];\n                if (currentAction &amp;&amp; (currentAction.type === 'player' || currentAction.type === 'teammate')) {\n                  const isLastAction = battleState.currentActionIndex &gt;= battleState.actionOrder.length - 1;\n                  if (isLastAction) {\n                    nextRoundBtn.innerHTML = \"&lt;i class='fas fa-forward'&gt;&lt;/i&gt; ç»“æŸå›åˆ\";\n                  } else {\n                    nextRoundBtn.innerHTML = \"&lt;i class='fas fa-forward'&gt;&lt;/i&gt; è·³è¿‡å½“å‰è¡ŒåŠ¨\";\n                  }\n                  nextRoundBtn.disabled = false;\n                }\n              }\n            }\n          });\n        });\n      }\n\n      window.updateDetailedStatsPanel = function(targetType = 'current', targetId = null) {\n\n        let currentStats;\n        let characterName = '';\n        let entityType = targetType;\n        let selectedId = targetId;\n\n        if (targetId !== null &amp;&amp; targetId !== 'player' &amp;&amp; targetId !== undefined) {\n          targetId = parseInt(targetId, 10);\n          selectedId = targetId;\n        }\n\n        if (targetType === 'current') {\n          if (battleState.currentTeammate) {\n            currentStats = getTeammateActualStats(battleState.currentTeammate);\n            characterName = battleState.currentTeammate.name || 'é˜Ÿå‹';\n            entityType = 'teammate';\n            selectedId = battleState.currentTeammate.id;\n          } else {\n            currentStats = getPlayerActualStats();\n            characterName = battleState.player.name || 'User';\n            entityType = 'player';\n            selectedId = 'player';\n          }\n        } else if (targetType === 'player') {\n\n          currentStats = getPlayerActualStats();\n          characterName = battleState.player.name || 'User';\n          selectedId = 'player';\n        } else if (targetType === 'teammate' &amp;&amp; targetId !== null) {\n\n          const teammate = battleState.teammates.find(t =&gt; t.id === targetId);\n          if (teammate) {\n            currentStats = getTeammateActualStats(teammate);\n            characterName = teammate.name || 'é˜Ÿå‹';\n            selectedId = teammate.id;\n          }\n        } else if (targetType === 'enemy' &amp;&amp; targetId !== null) {\n\n          const enemy = battleState.enemies.find(e =&gt; e.id === targetId);\n          if (enemy) {\n            currentStats = enemy;\n            characterName = enemy.name || 'æ•Œäºº';\n            selectedId = enemy.id;\n          }\n        }\n\n        if (!currentStats) return;\n\n        let characterSelector = '&lt;div class=\"character-selector\"&gt;';\n\n        const isPlayerActive = entityType === 'player';\n        characterSelector += '&lt;button class=\"char-select-btn ' + (isPlayerActive ? 'active' : '') + '\" ' +\n          'data-type=\"player\"&gt;' +\n          '&lt;i class=\"fas fa-user\"&gt;&lt;/i&gt; ' + (battleState.player.name || 'User') +\n        '&lt;/button&gt;';\n\n        if (battleState.teammates &amp;&amp; battleState.teammates.length &gt; 0) {\n          battleState.teammates.forEach(function(teammate) {\n            const isActive = entityType === 'teammate' &amp;&amp; selectedId === teammate.id;\n            const teammateId = teammate.id;\n            const teammateName = teammate.name;\n            characterSelector += '&lt;button class=\"char-select-btn ' + (isActive ? 'active' : '') + '\" ' +\n              'data-type=\"teammate\" data-id=\"' + teammateId + '\"&gt;' +\n              '&lt;i class=\"fas fa-user-friends\"&gt;&lt;/i&gt; ' + teammateName +\n            '&lt;/button&gt;';\n          });\n        }\n\n        if (battleState.enemies &amp;&amp; battleState.enemies.length &gt; 0) {\n          battleState.enemies.forEach(function(enemy) {\n            const isActive = entityType === 'enemy' &amp;&amp; selectedId === enemy.id;\n            const enemyId = enemy.id;\n            const enemyName = enemy.name;\n            characterSelector += '&lt;button class=\"char-select-btn enemy ' + (isActive ? 'active' : '') + '\" ' +\n              'data-type=\"enemy\" data-id=\"' + enemyId + '\"&gt;' +\n              '&lt;i class=\"fas fa-skull\"&gt;&lt;/i&gt; ' + enemyName +\n            '&lt;/button&gt;';\n          });\n        }\n\n        characterSelector += '&lt;/div&gt;';\n\n        const statsHtml = `\n          ${characterSelector}\n          &lt;div class=\"stats-compact\"&gt;\n\n            &lt;div class=\"stat-category\" style=\"margin-bottom: 10px;\"&gt;\n              &lt;div class=\"category-title\" style=\"font-size: 16px; font-weight: bold; color: var(--primary-light); text-align: center;\"&gt;\n                &lt;i class=\"fas fa-user\"&gt;&lt;/i&gt; ${characterName} çš„è¯¦ç»†å±æ€§\n              &lt;/div&gt;\n            &lt;/div&gt;\n\n            &lt;div class=\"stat-category\"&gt;\n              &lt;div class=\"category-title\" style=\"font-size: 13px; margin-bottom: 5px; color: var(--accent-color);\"&gt;\n                &lt;i class=\"fas fa-chart-line\"&gt;&lt;/i&gt; åŸºç¡€å±æ€§\n              &lt;/div&gt;\n              &lt;div style=\"display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 8px;\"&gt;\n                &lt;div class=\"stat-badge str-based\"&gt;\n                  &lt;i class=\"fas fa-mountain\"&gt;&lt;/i&gt; æ ¹éª¨: ${currentStats.str || 0}\n                &lt;/div&gt;\n                &lt;div class=\"stat-badge agi-based\"&gt;\n                  &lt;i class=\"fas fa-wind\"&gt;&lt;/i&gt; èº«æ³•: ${currentStats.agi || 0}\n                &lt;/div&gt;\n                &lt;div class=\"stat-badge int-based\"&gt;\n                  &lt;i class=\"fas fa-eye\"&gt;&lt;/i&gt; ç¥è¯†: ${currentStats.int || 0}\n                &lt;/div&gt;\n                &lt;div class=\"stat-badge vit-based\"&gt;\n                  &lt;i class=\"fas fa-shield-alt\"&gt;&lt;/i&gt; æ·¬ä½“: ${currentStats.end || 0}\n                &lt;/div&gt;\n              &lt;/div&gt;\n            &lt;/div&gt;\n\n            &lt;div class=\"stat-category\"&gt;\n              &lt;div class=\"category-title\" style=\"font-size: 12px; margin-bottom: 3px; color: #ef4444;\"&gt;\n                &lt;i class=\"fas fa-hand-fist\"&gt;&lt;/i&gt; åŠ›é‡ç³»\n              &lt;/div&gt;\n            &lt;/div&gt;\n            &lt;div class=\"stat-row str-based\"&gt;\n              &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-hand-fist\"&gt;&lt;/i&gt; ä¼¤å®³åŠ æˆ&lt;/div&gt;\n              &lt;div class=\"stat-row-value\"&gt;+${(currentStats.damageBonus * 100).toFixed(1)}%&lt;/div&gt;\n            &lt;/div&gt;\n            &lt;div class=\"stat-row str-based\"&gt;\n              &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-shield-alt\"&gt;&lt;/i&gt; å‡ä¼¤å€¼&lt;/div&gt;\n              &lt;div class=\"stat-row-value\"&gt;${currentStats.physicalReduction}&lt;/div&gt;\n            &lt;/div&gt;\n\n            &lt;div class=\"stat-category\" style=\"margin-top: 8px;\"&gt;\n              &lt;div class=\"category-title\" style=\"font-size: 12px; margin-bottom: 3px; color: #10b981;\"&gt;\n                &lt;i class=\"fas fa-wind\"&gt;&lt;/i&gt; èº«æ³•ç³»\n              &lt;/div&gt;\n            &lt;/div&gt;\n            &lt;div class=\"stat-row agi-based\"&gt;\n              &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-shoe-prints\"&gt;&lt;/i&gt; é—ªé¿ç‡&lt;/div&gt;\n              &lt;div class=\"stat-row-value\"&gt;${(currentStats.evasionRate * 100).toFixed(2)}%&lt;/div&gt;\n            &lt;/div&gt;\n            &lt;div class=\"stat-row agi-based\"&gt;\n              &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-crosshairs\"&gt;&lt;/i&gt; é¢å¤–å‘½ä¸­&lt;/div&gt;\n              &lt;div class=\"stat-row-value\"&gt;+${(currentStats.extraHitRate * 100).toFixed(1)}%&lt;/div&gt;\n            &lt;/div&gt;\n            &lt;div class=\"stat-row agi-based\"&gt;\n              &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-tachometer-alt\"&gt;&lt;/i&gt; é€Ÿåº¦&lt;/div&gt;\n              &lt;div class=\"stat-row-value\"&gt;${currentStats.speed}&lt;/div&gt;\n            &lt;/div&gt;\n\n            &lt;div class=\"stat-category\" style=\"margin-top: 8px;\"&gt;\n              &lt;div class=\"category-title\" style=\"font-size: 12px; margin-bottom: 3px; color: #8b5cf6;\"&gt;\n                &lt;i class=\"fas fa-eye\"&gt;&lt;/i&gt; ç¥è¯†ç³»\n              &lt;/div&gt;\n            &lt;/div&gt;\n            &lt;div class=\"stat-row int-based\"&gt;\n              &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-star\"&gt;&lt;/i&gt; é¢å¤–æš´å‡»&lt;/div&gt;\n              &lt;div class=\"stat-row-value\"&gt;+${(currentStats.extraCritRate * 100).toFixed(1)}%&lt;/div&gt;\n            &lt;/div&gt;\n            &lt;div class=\"stat-row int-based\"&gt;\n              &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-fire\"&gt;&lt;/i&gt; æš´å‡»å€ç‡&lt;/div&gt;\n              &lt;div class=\"stat-row-value\"&gt;${(currentStats.baseCritMultiplier * 100).toFixed(1)}%&lt;/div&gt;\n            &lt;/div&gt;\n\n            &lt;div class=\"stat-category\" style=\"margin-top: 8px;\"&gt;\n              &lt;div class=\"category-title\" style=\"font-size: 12px; margin-bottom: 3px; color: #06b6d4;\"&gt;\n                &lt;i class=\"fas fa-shield\"&gt;&lt;/i&gt; æŠµæŠ—å±æ€§\n              &lt;/div&gt;\n            &lt;/div&gt;\n            &lt;div class=\"stat-row resistance\"&gt;\n              &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-eye-slash\"&gt;&lt;/i&gt; æš´å‡»ç‡æŠµæŠ—&lt;/div&gt;\n              &lt;div class=\"stat-row-value\"&gt;${(currentStats.critRateResistance * 100).toFixed(2)}%&lt;/div&gt;\n            &lt;/div&gt;\n            &lt;div class=\"stat-row resistance\"&gt;\n              &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-shield-alt\"&gt;&lt;/i&gt; æš´ä¼¤æŠµæŠ—&lt;/div&gt;\n              &lt;div class=\"stat-row-value\"&gt;${(currentStats.critDamageResistance * 100).toFixed(2)}%&lt;/div&gt;\n            &lt;/div&gt;\n\n            &lt;div class=\"stat-category\" style=\"margin-top: 8px;\"&gt;\n              &lt;div class=\"category-title\" style=\"font-size: 12px; margin-bottom: 3px; color: #f59e0b;\"&gt;\n                &lt;i class=\"fas fa-shield-virus\"&gt;&lt;/i&gt; è€åŠ›ç³»\n              &lt;/div&gt;\n            &lt;/div&gt;\n            &lt;div class=\"stat-row vit-based\"&gt;\n              &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-shield-virus\"&gt;&lt;/i&gt; æ‰¿ä¼¤ç‡&lt;/div&gt;\n              &lt;div class=\"stat-row-value\"&gt;${(currentStats.damageTakenRate * 100).toFixed(1)}%&lt;/div&gt;\n            &lt;/div&gt;\n\n            ${entityType !== 'enemy' ? `\n\n            &lt;div class=\"stat-category\" style=\"margin-top: 8px;\"&gt;\n              &lt;div class=\"category-title\" style=\"font-size: 12px; margin-bottom: 3px; color: #ec4899;\"&gt;\n                &lt;i class=\"fas fa-heart\"&gt;&lt;/i&gt; å›å¤ç³»\n              &lt;/div&gt;\n            &lt;/div&gt;\n            &lt;div class=\"stat-row recovery\"&gt;\n              &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-heart\"&gt;&lt;/i&gt; ç”Ÿå‘½å›å¤&lt;/div&gt;\n              &lt;div class=\"stat-row-value\"&gt;+${currentStats.hpRegen || 0}/å›åˆ&lt;/div&gt;\n            &lt;/div&gt;\n            &lt;div class=\"stat-row recovery\"&gt;\n              &lt;div class=\"stat-row-label\"&gt;&lt;i class=\"fas fa-flask\"&gt;&lt;/i&gt; çµåŠ›å›å¤&lt;/div&gt;\n              &lt;div class=\"stat-row-value\"&gt;+${currentStats.mpRegen || 0}/å›åˆ&lt;/div&gt;\n            &lt;/div&gt;\n            ` : ''}\n          &lt;/div&gt;\n        `;\n\n        const detailedStatsDisplay = document.getElementById('detailed-stats-display');\n        if (detailedStatsDisplay) {\n          detailedStatsDisplay.innerHTML = statsHtml;\n\n          const characterSelectorDiv = detailedStatsDisplay.querySelector('.character-selector');\n          if (characterSelectorDiv) {\n            characterSelectorDiv.addEventListener('click', function(e) {\n              const button = e.target.closest('.char-select-btn');\n              if (button) {\n                const type = button.getAttribute('data-type');\n                const id = button.getAttribute('data-id');\n                if (type === 'player') {\n                  window.updateDetailedStatsPanel('player', null);\n                } else if (type &amp;&amp; id) {\n                  window.updateDetailedStatsPanel(type, parseInt(id, 10));\n                }\n              }\n            });\n          }\n        }\n      }\n      function getEffectiveHitRate(baseHitRate, enemy) {\n        let effectiveHitRate = baseHitRate;\n        if (enemy.buffs) {\n          enemy.buffs.forEach(buff =&gt; {\n            if (buff.type === 'hitRateDown') {\n              effectiveHitRate -= buff.value;\n            }\n          });\n        }\n        return Math.max(0, effectiveHitRate);\n      }\n\n      function updateAttackButton() {\n        const attackBtn = document.getElementById('attack-btn');\n        if (attackBtn) {\n\n          if (battleState.currentItem) {\n            attackBtn.disabled = false;\n            attackBtn.innerHTML = \"&lt;i class='fas fa-pills'&gt;&lt;/i&gt; ä½¿ç”¨ä¸¹è¯\";\n          }\n\n          else if (battleState.currentWeapon) {\n            const weaponTemplate = battleState.currentWeapon.codes\n              ?.find(code =&gt; code.startsWith('WN:A'))\n              ?.match(/WN:(A[1-4])/)?.[1];\n\n            if (\n              (weaponTemplate === 'A2' ||\n                weaponTemplate === 'A3' ||\n                weaponTemplate === 'A4' ||\n                battleState.currentWeapon.isHealing) &amp;&amp;\n              battleState.healTarget === 'player'\n            ) {\n              attackBtn.disabled = false;\n              if (weaponTemplate === 'A2') {\n                attackBtn.innerHTML = \"&lt;i class='fas fa-first-aid'&gt;&lt;/i&gt; ç”Ÿå‘½æ¢å¤\";\n              } else if (weaponTemplate === 'A3') {\n                attackBtn.innerHTML = \"&lt;i class='fas fa-magic'&gt;&lt;/i&gt; çµåŠ›æ¢å¤\";\n              } else if (weaponTemplate === 'A4') {\n                attackBtn.innerHTML = \"&lt;i class='fas fa-skull'&gt;&lt;/i&gt; ç‰ºç‰²å¢ç›Š\";\n              } else {\n                attackBtn.innerHTML = \"&lt;i class='fas fa-first-aid'&gt;&lt;/i&gt; æ²»ç–—è‡ªå·±\";\n              }\n            }\n\n            else if (\n              (weaponTemplate === 'A2' || weaponTemplate === 'A3' || weaponTemplate === 'A4' || battleState.currentWeapon.isHealing) &amp;&amp;\n              battleState.healTarget &amp;&amp;\n              battleState.healTarget !== 'player'\n            ) {\n              attackBtn.disabled = false;\n              if (weaponTemplate === 'A2') {\n                attackBtn.innerHTML = \"&lt;i class='fas fa-first-aid'&gt;&lt;/i&gt; æ²»ç–—é˜Ÿå‹\";\n              } else if (weaponTemplate === 'A3') {\n                attackBtn.innerHTML = \"&lt;i class='fas fa-magic'&gt;&lt;/i&gt; æ¢å¤é˜Ÿå‹çµåŠ›\";\n              } else if (weaponTemplate === 'A4') {\n                attackBtn.innerHTML = \"&lt;i class='fas fa-bolt'&gt;&lt;/i&gt; ç‰ºç‰²å¢ç›Š\";\n              } else {\n                attackBtn.innerHTML = \"&lt;i class='fas fa-first-aid'&gt;&lt;/i&gt; æ²»ç–—é€‰ä¸­ç›®æ ‡\";\n              }\n            }\n\n            else {\n\n              if (weaponTemplate === 'A2' || weaponTemplate === 'A3' || weaponTemplate === 'A4') {\n                attackBtn.disabled = true;\n                attackBtn.innerHTML = \"&lt;i class='fas fa-ban'&gt;&lt;/i&gt; ä¸èƒ½æ”»å‡»æ•Œäºº\";\n              } else {\n                attackBtn.disabled =\n                  battleState.selectedEnemies.length === 0 ||\n                  battleState.selectedEnemies.length &gt; (battleState.currentWeapon?.targetsPerAttack || 0);\n                attackBtn.innerHTML = \"&lt;i class='fas fa-magic'&gt;&lt;/i&gt; æ–½å±•ç¥é€š\";\n              }\n            }\n          } else {\n            attackBtn.disabled = true;\n            attackBtn.innerHTML = \"&lt;i class='fas fa-magic'&gt;&lt;/i&gt; é€‰æ‹©ç¥é€šæˆ–ä¸¹è¯\";\n          }\n        }\n      }\n\n      function updateWeaponsList() {\n\n        if (!lazyRenderManager.shouldRenderCombat()) {\n          return;\n        }\n\n        if (battleState.currentTeammate === null) {\n\n          document.getElementById('melee-panel').classList.add('active');\n          document.getElementById('items-panel').classList.remove('active');\n          document.getElementById('stats-panel').classList.remove('active');\n          document.getElementById('melee-toggle').classList.add('active');\n          document.getElementById('items-toggle').classList.remove('active');\n          document.getElementById('stats-toggle').classList.remove('active');\n\n          document.getElementById('melee-toggle').innerHTML = '&lt;i class=\"fas fa-magic\"&gt;&lt;/i&gt; ç¥é€š';\n        }\n\n        const allWeapons = battleState.player.weapons || [];\n        meleeWeaponList.innerHTML =\n          allWeapons.length &gt; 0\n            ? allWeapons\n                .map(weapon =&gt; {\n                  let effectsHtml = '';\n                  weapon.codes.forEach(code =&gt; {\n                    const codeType = code.split(':')[0];\n                    const codeValue = code.split(':')[1];\n                    if (codeType === 'WN') {\n                      const parts = codeValue.split(',');\n                      const effectKey = parts[0];\n\n                      const tooltipText = TooltipGenerator.generateWeaponEffectTooltip(effectKey, parts);\n                      if (tooltipText) {\n                        effectsHtml += `&lt;div class=\"weapon-effect-code status-effect\"&gt;${effectKey}\n                                        &lt;span class=\"effect-tooltip\"&gt;${tooltipText}&lt;/span&gt;\n                                    &lt;/div&gt;`;\n                      }\n                    } else if (codeType === 'EN') {\n                      const parts = codeValue.split(',');\n                      const effectKey = parts[0];\n\n                      const tooltipText = TooltipGenerator.generateEnchantmentTooltip(effectKey, parts);\n                      if (tooltipText) {\n                        effectsHtml += `&lt;div class=\"weapon-effect-code status-effect\"&gt;${effectKey}\n                                        &lt;span class=\"effect-tooltip\"&gt;${tooltipText}&lt;/span&gt;\n                                    &lt;/div&gt;`;\n                      }\n                    }\n                  });\n\n                  const isUsed = weapon.used || battleState.player.ap &lt;= 0 || weapon.currentCooldown &gt; 0;\n                  const usedClass = isUsed ? 'used' : '';\n                  const cooldownText = weapon.currentCooldown &gt; 0 ? ` (å†·å´:${weapon.currentCooldown})` : '';\n                  return `\n                        &lt;button class=\"weapon-button ${usedClass}\" data-weapon-index=\"${battleState.player.weapons.indexOf(\n                    weapon,\n                  )}\" ${isUsed ? 'disabled' : ''}&gt;\n                            &lt;div class=\"weapon-button-name\"&gt;${weapon.name}${cooldownText}&lt;/div&gt;\n                            &lt;div class=\"weapon-button-stats\"&gt;\n                                &lt;div&gt;${weapon.isHealing ? 'æ²»ç–—: ' : 'æ”»å‡»: '}${weapon.attack}&lt;/div&gt;\n                                &lt;div&gt;å‘½ä¸­: ${weapon.hitRate}%&lt;/div&gt;\n                                &lt;div&gt;æš´å‡»: ${weapon.critRate}%&lt;/div&gt;\n                                &lt;div&gt;æ¬¡æ•°: ${weapon.attacksPerTurn}&lt;/div&gt;\n                                &lt;div&gt;ç›®æ ‡: ${weapon.targetsPerAttack}&lt;/div&gt;\n                                &lt;div&gt;MP: ${weapon.mpCost}&lt;/div&gt;\n                                &lt;div&gt;AP: 1&lt;/div&gt;\n                                &lt;div&gt;å†·å´: ${weapon.cooldown}å›åˆ&lt;/div&gt;\n                            &lt;/div&gt;\n                            &lt;div class=\"weapon-effect-codes\"&gt;\n                                ${effectsHtml}\n                            &lt;/div&gt;\n                        &lt;/button&gt;\n                    `;\n                })\n                .join('')\n            : '&lt;div style=\"text-align: center; padding: 10px;\"&gt;æ²¡æœ‰å¯ç”¨çš„ç¥é€š&lt;/div&gt;';\n\n        const attackControls = document.querySelector('.attack-controls');\n        attackControls.innerHTML = `\n                &lt;button id=\"attack-btn\" class=\"attack-button\" disabled&gt;&lt;i class=\"fas fa-hand-fist\"&gt;&lt;/i&gt; æ”»å‡»é€‰ä¸­ç›®æ ‡&lt;/button&gt;\n                &lt;button id=\"next-round-btn\" class=\"next-round-button\"&gt;&lt;i class=\"fas fa-arrow-right-to-bracket\"&gt;&lt;/i&gt; è·³è¿‡å½“å‰è¡ŒåŠ¨&lt;/button&gt;\n                &lt;button id=\"mid-action-btn\" class=\"mid-action-button\"&gt;&lt;i class=\"fas fa-pause\"&gt;&lt;/i&gt; ä¸­é€”è¡ŒåŠ¨&lt;/button&gt;\n            `;\n\n        EventManager.bindWeaponButtons(battleState.player.weapons);\n\n        const attackBtn = document.getElementById('attack-btn');\n        if (attackBtn) {\n          attackBtn.addEventListener('click', performPlayerAttack);\n        }\n\n        setupSkipButton();\n      }\n\n      function updateItemsList() {\n\n        if (!lazyRenderManager.shouldRenderCombat()) {\n          return;\n        }\n        const items = battleState.player.items || [];\n\n        const itemsList = document.getElementById('items-list');\n        itemsList.innerHTML =\n          items.length &gt; 0\n            ? items\n                .map(item =&gt; {\n\n                  let effectText = '';\n                  switch (item.type) {\n                    case 1: \n                      effectText = `æ¢å¤ ${item.value} ç‚¹ç”Ÿå‘½å€¼`;\n                      break;\n                    case 2: \n                      effectText = `æ¢å¤ ${item.value} ç‚¹çµåŠ›å€¼`;\n                      break;\n                    case 3: \n                      effectText = `æ ¹éª¨+${item.value}ï¼ŒæŒç»­${item.duration}å›åˆ`;\n                      break;\n                    case 4: \n                      effectText = `èº«æ³•+${item.value}ï¼ŒæŒç»­${item.duration}å›åˆ`;\n                      break;\n                    case 5: \n                      effectText = `ç¥è¯†+${item.value}ï¼ŒæŒç»­${item.duration}å›åˆ`;\n                      break;\n                    case 6: \n                      effectText = `æ·¬ä½“+${item.value}ï¼ŒæŒç»­${item.duration}å›åˆ`;\n                      break;\n                    default:\n                      effectText = 'æœªçŸ¥æ•ˆæœ';\n                  }\n\n                  const currentAction = battleState.actionOrder[battleState.currentActionIndex];\n                  let isUsed = false; \n\n                  isUsed = item.count &lt;= 0 || battleState.currentItemUsed === true;\n                  const usedClass = isUsed ? 'used' : '';\n                  return `\n                        &lt;button class=\"item-button ${usedClass}\" data-item-index=\"${battleState.player.items.indexOf(\n                    item,\n                  )}\" ${isUsed ? 'disabled' : ''}&gt;\n                            &lt;div class=\"item-button-name\"&gt;\n                                ${item.name}\n                                &lt;span class=\"item-button-count\"&gt;x${item.count}&lt;/span&gt;\n                            &lt;/div&gt;\n                            &lt;div class=\"item-button-effect\"&gt;${effectText}&lt;/div&gt;\n                        &lt;/button&gt;\n                    `;\n                })\n                .join('')\n            : '&lt;div style=\"text-align: center; padding: 10px;\"&gt;æ²¡æœ‰å¯ç”¨çš„ä¸¹è¯&lt;/div&gt;';\n\n        EventManager.bindItemButtons(battleState.player.items);\n      }\n\n      function performAttack(isPlayer = true) {\n\n        if (battleState.currentItem) {\n          const user = isPlayer ? null : battleState.currentTeammate;\n          useItem(battleState.currentItem, user);\n\n          battleState.currentItemUsed = true;\n\n          battleState.currentItem = null;\n\n          memoryManager.safeSetTimeout(\n            () =&gt; {\n              updatePlayerPanel();\n              updateEnemyPanel();\n              if (isPlayer) {\n                updateItemsList();\n              } else {\n\n                updateTeammateWeaponsList();\n                updateItemsList();\n              }\n            },\n            isPlayer ? 1200 : 0,\n          ); \n\n          setupSkipButton();\n\n          return;\n        }\n        const attacker = isPlayer ? battleState.player : battleState.currentTeammate;\n        const weapon = battleState.currentWeapon;\n        if (!weapon || battleState.attackInProgress) {\n          return;\n        }\n\n        if (isPlayer) {\n\n          if (attacker.ap &lt;= 0) {\n            logBattleAction(`è¡ŒåŠ¨ç‚¹ä¸è¶³ï¼Œæ— æ³•ä½¿ç”¨ ${weapon.name}ï¼`);\n            return;\n          }\n        } else {\n\n          if (attacker.ap &lt;= 0) {\n            logBattleAction(`${attacker.name} è¡ŒåŠ¨ç‚¹ä¸è¶³ï¼Œæ— æ³•ä½¿ç”¨ ${weapon.name}ï¼`);\n            return;\n          }\n          const weaponTemplate = weapon.codes?.find(code =&gt; code.startsWith('WN:A'))?.match(/WN:(A[1-4])/)?.[1];\n\n        }\n        if (weapon.currentCooldown &gt; 0) {\n          logBattleAction(`${weapon.name} è¿˜åœ¨å†·å´ä¸­ï¼Œå‰©ä½™ ${weapon.currentCooldown} å›åˆï¼`);\n          return;\n        }\n\n        if (attacker.mp &lt; weapon.mpCost) {\n          logBattleAction(`MPä¸è¶³ï¼Œæ— æ³•ä½¿ç”¨ ${weapon.name}ï¼`);\n          return;\n        }\n\n        attacker.ap -= 1;\n\n        if (weapon.cooldown &gt; 0) {\n          weapon.currentCooldown = weapon.cooldown;\n        }\n\n        battleState.attackInProgress = true;\n\n        const weaponTemplate = weapon.codes?.find(code =&gt; code.startsWith('WN:A'))?.match(/WN:(A[1-4])/)?.[1];\n\n        const isHealingWeapon =\n          weaponTemplate === 'A2' || weaponTemplate === 'A3' || weaponTemplate === 'A4' || weapon.isHealing;\n        if (isHealingWeapon) {\n\n          if (isPlayer) {\n            executeHealingSequence(weapon, weaponTemplate);\n          } else {\n            executeTeammateHealingSequence(attacker, weapon, weaponTemplate);\n          }\n          return;\n        }\n\n        if (isPlayer) {\n          executeAttackSequence(weapon);\n        } else {\n          executeTeammateAttackSequence(attacker, weapon);\n        }\n      }\n\n      function performPlayerAttack() {\n        performAttack(true);\n      }\n\n      function performTeammateAttack() {\n        performAttack(false);\n      }\n\n      function executeAttackSequence(weapon) {\n\n        battleState.currentAttackCount = 0;\n\n        function performNextAttack() {\n\n          let actualAttacksPerTurn = weapon.attacksPerTurn;\n          if (battleState.sacrificeBoostActive) {\n            actualAttacksPerTurn += battleState.sacrificeBoostActive.attacksPerTurn;\n          }\n\n          if (battleState.player.mp &lt; weapon.mpCost) {\n            logBattleAction(`è“é‡ä¸è¶³ï¼æ— æ³•ç»§ç»­æ”»å‡»ã€‚å·²å®Œæˆ ${battleState.currentAttackCount} æ¬¡æ”»å‡»ã€‚`);\n\n            weapon.used = true;\n\n            battleState.currentWeapon = null;\n\n            battleState.attackInProgress = false;\n\n            updateBattleUI({ player: true, enemy: true, weapons: true });\n            return;\n          }\n\n          if (\n            StateValidator.shouldEndAttack(\n              battleState.currentAttackCount,\n              actualAttacksPerTurn,\n              battleState.selectedEnemies.length &gt; 0,\n            )\n          ) {\n\n            weapon.used = true;\n\n            battleState.currentWeapon = null;\n\n            battleState.attackInProgress = false;\n\n            updateBattleUI({ player: true, enemy: true, weapons: true });\n            return;\n          }\n\n          battleState.currentAttackCount++;\n\n          const attackNumber = battleState.currentAttackCount;\n\n          if (actualAttacksPerTurn &gt; 1) {\n            logBattleAction(\n              `${battleState.player.name || 'User'} ä½¿ç”¨ ${weapon.name} è¿›è¡Œç¬¬ ${\n                attackNumber + 1\n              }/${actualAttacksPerTurn} æ¬¡æ”»å‡»ï¼`,\n            );\n          } else {\n            logBattleAction(`${battleState.player.name || 'User'} ä½¿ç”¨ ${weapon.name} æ”»å‡»ï¼`);\n          }\n\n          const playerEntity = document.querySelector('.combat-entity.player');\n          playerEntity.classList.add('attack-animation-forward');\n\n          setTimeout(() =&gt; {\n\n            for (const enemyId of battleState.selectedEnemies) {\n              const enemy = battleState.enemies.find(e =&gt; e.id === enemyId);\n              if (enemy) {\n\n                const playerStats = getPlayerActualStats();\n                const enemyStats = getEnemyActualStats(enemy);\n\n                const finalHitRate = calculateFinalHitRate(weapon.hitRate, playerStats, enemyStats);\n                const hitRoll = Math.random();\n\n                if (hitRoll &lt;= Math.min(1.0, finalHitRate)) {\n\n                  logBattleAction(`æ”»å‡»å‘½ä¸­ ${enemy.name}ï¼(æœ€ç»ˆå‘½ä¸­ç‡: ${(finalHitRate * 100).toFixed(1)}%)`);\n\n                  const enemyElement = document.querySelector(`.combat-entity.enemy[data-enemy-id=\"${enemyId}\"]`);\n                  enemyElement.classList.add('shake-animation');\n\n                  let finalCritRate = calculateFinalCritRate(weapon.critRate, playerStats, enemyStats, finalHitRate);\n\n                  if (battleState.sacrificeBoostActive) {\n                    finalCritRate += battleState.sacrificeBoostActive.critRate / 100;\n                  }\n\n                  battleState.playerBuffs.forEach(buff =&gt; {\n                    if (buff.type === 'critBoost') {\n                      finalCritRate += buff.value / 100;\n                    }\n                  });\n\n                  if (enemy.marks &amp;&amp; enemy.marks.weakness) {\n                    finalCritRate += enemy.marks.weakness / 100;\n                    logBattleAction(`ç ´ç»½æ ‡è®°æ¶ˆè€—ï¼æš´å‡»ç‡é¢å¤–æå‡ ${enemy.marks.weakness}%ï¼`);\n                    delete enemy.marks.weakness;\n                  }\n\n                  if (finalHitRate &gt; 1.0) {\n                    const overHitBonus = (finalHitRate - 1.0) * 0.5;\n                    logBattleAction(\n                      `è¶…å‘½ä¸­è½¬æ¢ï¼šå‘½ä¸­ç‡ ${(finalHitRate * 100).toFixed(1)}% â†’ æš´å‡»ç‡é¢å¤– +${(\n                        overHitBonus * 100\n                      ).toFixed(1)}%`,\n                    );\n                  }\n                  if (finalCritRate &gt; 1.0) {\n                    const overCritBonus = (finalCritRate - 1.0) * 0.5;\n                    logBattleAction(\n                      `è¶…æš´å‡»è½¬æ¢ï¼šæš´å‡»ç‡ ${(finalCritRate * 100).toFixed(1)}% â†’ æš´å‡»ä¼¤å®³é¢å¤– +${(\n                        overCritBonus * 100\n                      ).toFixed(1)}%`,\n                    );\n                  }\n                  const critRoll = Math.random();\n\n                  const isCrit = critRoll &lt;= Math.min(1.0, finalCritRate);\n\n                  const finalCritMultiplier = isCrit\n                    ? calculateFinalCritMultiplier(playerStats, enemyStats, finalCritRate)\n                    : 1.0;\n\n                  let baseAttack = weapon.attack;\n                  if (battleState.sacrificeBoostActive) {\n                    baseAttack += battleState.sacrificeBoostActive.attack;\n                    logBattleAction(`ç‰ºç‰²å¢ç›Šç”Ÿæ•ˆï¼æ”»å‡»åŠ›å¢åŠ  ${battleState.sacrificeBoostActive.attack}ï¼`);\n                  }\n\n                  let damage = calculateFinalDamage(baseAttack, playerStats, enemyStats, isCrit, finalCritMultiplier);\n\n                  if (enemy.marks) {\n\n                    if (enemy.marks.vulnerability) {\n                      const bonusDamage = Math.floor(damage * (enemy.marks.vulnerability / 100));\n                      damage += bonusDamage;\n                      logBattleAction(`æ˜“ä¼¤æ ‡è®°æ¶ˆè€—ï¼é¢å¤–é€ æˆ ${bonusDamage} ç‚¹ä¼¤å®³ï¼`);\n                      delete enemy.marks.vulnerability;\n                    }\n\n                    if (enemy.marks.death &amp;&amp; isCrit) {\n                      const bonusCritDamage = Math.floor(damage * (enemy.marks.death / 100));\n                      damage += bonusCritDamage;\n                      logBattleAction(`æ­»ç‚¹æ ‡è®°æ¶ˆè€—ï¼æš´å‡»é¢å¤–é€ æˆ ${bonusCritDamage} ç‚¹ä¼¤å®³ï¼`);\n                      delete enemy.marks.death;\n                    }\n                  }\n\n                  if (enemy.stacks &amp;&amp; enemy.stacks.corrosion) {\n\n                    let corrosionBonusPerStack = 5; \n                    if (weapon.codes) {\n                      const corrosionCode = weapon.codes.find(code =&gt; code.startsWith('EN:B19'));\n                      if (corrosionCode) {\n                        const match = corrosionCode.match(/EN:B19,\\d+,(\\d+)%/);\n                        if (match) {\n                          corrosionBonusPerStack = parseInt(match[1]);\n                        }\n                      }\n                    }\n                    const corrosionBonus = enemy.stacks.corrosion * corrosionBonusPerStack;\n                    const bonusDamage = Math.floor(damage * (corrosionBonus / 100));\n                    damage += bonusDamage;\n                    logBattleAction(`è…èš€æ•ˆæœï¼${enemy.stacks.corrosion} å±‚è…èš€é€ æˆé¢å¤– ${bonusDamage} ç‚¹ä¼¤å®³ï¼`);\n                  }\n\n                  const weaponTemplate = weapon.codes?.find(code =&gt; code.startsWith('WN:A'))?.match(/WN:(A[1-4])/)?.[1];\n\n                  if (weaponTemplate) {\n                    switch (weaponTemplate) {\n                      case 'A1':\n\n                        logBattleAction(\n                          `ä½¿ç”¨${weapon.name}å¯¹${battleState.selectedEnemies\n                            .map(id =&gt; battleState.enemies.find(e =&gt; e.id === id)?.name)\n                            .join('ã€')}é€ æˆä¼¤å®³ï¼`,\n                        );\n                        break;\n                      case 'A2':\n\n                        break;\n                      case 'A3':\n\n                        break;\n                      case 'A4':\n\n                        logBattleAction(`ä½¿ç”¨${weapon.name}ï¼ç‰ºç‰²è‡ªèº«æ¢å–å¼ºå¤§å¢ç›Šï¼`);\n                        break;\n                    }\n                  }\n\n                  if (isCrit) {\n                    logBattleAction(\n                      `æš´å‡»ï¼é€ æˆ ${damage} ç‚¹ä¼¤å®³ï¼(æš´å‡»ç‡: ${(finalCritRate * 100).toFixed(\n                        1,\n                      )}%, æš´å‡»å€ç‡: ${finalCritMultiplier.toFixed(2)}x)`,\n                    );\n\n                    showDamageNumber('enemy', damage, true, enemyId);\n\n                    if (weapon.codes.some(code =&gt; code.startsWith('EN:B4'))) {\n                      const freezeMatch = weapon.codes.find(code =&gt; code.startsWith('EN:B4')).match(/EN:B4,(\\d+)/);\n                      const freezeDuration = freezeMatch ? parseInt(freezeMatch[1]) : 1;\n\n                      enemy.pendingFreeze = true;\n                      enemy.pendingFreezeCount = freezeDuration;\n                      logBattleAction(`å†·ç‹±ç‰¹æ•ˆè§¦å‘ï¼${enemy.name} å°†åœ¨ä¸‹æ¬¡è¡ŒåŠ¨æ—¶è¢«æ™•çœ©ï¼`);\n                    }\n\n                    if (weapon.codes.some(code =&gt; code.startsWith('EN:B3'))) {\n                      const critBoostMatch = weapon.codes\n                        .find(code =&gt; code.startsWith('EN:B3'))\n                        .match(/EN:B3,(\\d+),(\\d+)%/);\n                      if (critBoostMatch) {\n                        const duration = parseInt(critBoostMatch[1]);\n                        const boostAmount = parseInt(critBoostMatch[2]);\n                        battleState.playerBuffs.push({\n                          name: 'ä¹˜èƒœåŠ æˆ',\n                          type: 'critBoost',\n                          value: boostAmount,\n                          duration: duration,\n                          isPositive: true,\n                        });\n                        logBattleAction(`ä¹˜èƒœç‰¹æ•ˆè§¦å‘ï¼æš´å‡»ç‡æå‡ ${boostAmount}% æŒç»­ ${duration} å›åˆï¼`);\n                      }\n                    }\n                  } else {\n                    logBattleAction(`é€ æˆ ${damage} ç‚¹ä¼¤å®³ï¼`);\n                    showDamageNumber('enemy', damage, false, enemyId);\n                  }\n\n                  const extraDamage = processEnchantmentEffects(weapon, enemy, damage, isCrit);\n                  damage += extraDamage;\n\n                  if (enemy.buffs) {\n                    const vulnerableBuff = enemy.buffs.find(buff =&gt; buff.type === 'vulnerable');\n                    if (vulnerableBuff) {\n                      const bonusDamage = Math.floor(damage * (vulnerableBuff.value / 100));\n                      damage += bonusDamage;\n                      logBattleAction(`${enemy.name} å¤„äºæ˜“ä¼¤çŠ¶æ€ï¼Œé¢å¤–å—åˆ° ${bonusDamage} ç‚¹ä¼¤å®³ï¼`);\n                    }\n                  }\n\n                  if (damage &gt; battleState.highestDamageWeapon.damage) {\n                    battleState.highestDamageWeapon.name = weapon.name;\n                    battleState.highestDamageWeapon.damage = damage;\n                  }\n\n                  const oldHp = enemy.hp;\n                  enemy.hp = Math.max(0, enemy.hp - damage);\n\n                  addDamageHate('player', battleState.player.name || 'User', enemyId, damage);\n\n                  addHpChangeAnimation('enemy', enemyId);\n\n                  if (StateValidator.checkEnemyDeath(enemy)) {\n                    return; \n                  }\n\n                  setTimeout(() =&gt; {\n                    if (enemyElement) {\n                      enemyElement.classList.remove('shake-animation');\n                    }\n                  }, 800);\n                } else {\n\n                  logBattleAction(`æ”»å‡»æœªå‘½ä¸­ ${enemy.name}ï¼(æœ€ç»ˆå‘½ä¸­ç‡: ${(finalHitRate * 100).toFixed(1)}%)`);\n                }\n              }\n            }\n\n            battleState.player.mp = Math.max(0, battleState.player.mp - weapon.mpCost);\n            if (weapon.mpCost &gt; 0) {\n              logBattleAction(`æ¶ˆè€— ${weapon.mpCost} ç‚¹çµåŠ›å€¼ã€‚å‰©ä½™çµåŠ›å€¼: ${battleState.player.mp}`);\n            }\n\n            playerEntity.classList.remove('attack-animation-forward');\n\n            memoryManager.safeSetTimeout(() =&gt; {\n              updatePlayerPanel();\n              updateEnemyPanel();\n            }, 1500); \n\n            if (\n              battleState.currentAttackCount &lt; actualAttacksPerTurn &amp;&amp;\n              battleState.selectedEnemies.length &gt; 0 &amp;&amp;\n              battleState.enemies.length &gt; 0\n            ) {\n\n              setTimeout(performNextAttack, 800);\n            } else {\n\n              weapon.used = true;\n\n              battleState.currentWeapon = null;\n\n              battleState.attackInProgress = false;\n\n              updateWeaponsList();\n              enablePlayerControls();\n\n              updatePlayerPanel();\n              updateWeaponsList();\n              enablePlayerControls();\n            }\n          }, 500); \n        }\n\n        performNextAttack();\n      }\n\n      function performHealing(weapon, targetType, targetEntity = null) {\n        const targetName =\n          targetType === 'player'\n            ? battleState.player.name || 'User'\n            : targetType === 'teammate'\n            ? targetEntity.name\n            : targetType === 'enemy'\n            ? targetEntity.name\n            : 'Unknown';\n        logBattleAction(`${battleState.player.name || 'User'} ä½¿ç”¨ ${weapon.name} æ²»ç–— ${targetName}ï¼`);\n\n        let healAmount = weapon.attack;\n\n        const critRoll = Math.random() * 100;\n        const isCrit = critRoll &lt;= weapon.critRate;\n        if (isCrit) {\n\n          const playerStats = getPlayerActualStats();\n          const critMultiplier = playerStats.baseCritMultiplier;\n          healAmount = Math.floor(healAmount * critMultiplier);\n          logBattleAction(`æš´å‡»æ²»ç–—ï¼æ¢å¤ ${healAmount} ç‚¹ç”Ÿå‘½å€¼ï¼`);\n        } else {\n          logBattleAction(`æ¢å¤ ${healAmount} ç‚¹ç”Ÿå‘½å€¼ï¼`);\n        }\n\n        if (targetType === 'player') {\n          const oldHp = battleState.player.hp;\n          battleState.player.hp = Math.min(battleState.player.hp + healAmount, battleState.player.maxHp);\n          const actualHeal = battleState.player.hp - oldHp;\n\n          showHealNumber(actualHeal);\n\n          const playerHpBar = document.querySelector('.combat-entity.player .hp-fill-combat');\n          playerHpBar.classList.add('hp-change-animation');\n          setTimeout(() =&gt; {\n            playerHpBar.classList.remove('hp-change-animation');\n          }, 800);\n\n          const playerEntity = document.querySelector('.combat-entity.player');\n          playerEntity.classList.add('heal-pulse-animation');\n          setTimeout(() =&gt; {\n            playerEntity.classList.remove('heal-pulse-animation');\n          }, 800);\n        } else if (targetType === 'teammate' &amp;&amp; targetEntity) {\n          const oldHp = targetEntity.hp;\n          targetEntity.hp = Math.min(targetEntity.hp + healAmount, targetEntity.maxHp);\n          const actualHeal = targetEntity.hp - oldHp;\n\n          logBattleAction(`å®é™…æ¢å¤äº† ${actualHeal} ç‚¹ç”Ÿå‘½å€¼ï¼`);\n\n          const teammateHpBar = document.querySelector(\n            `.combat-entity.teammate[data-teammate-id=\"${targetEntity.id}\"] .hp-fill-combat`,\n          );\n          if (teammateHpBar) {\n\n            const teammateElement = teammateHpBar.closest('.combat-entity.teammate');\n            const teammateId = teammateElement ? teammateElement.getAttribute('data-teammate-id') : null;\n            if (teammateId) {\n              addHpChangeAnimation('teammate', teammateId);\n            }\n          }\n\n          const teammateElement = document.querySelector(\n            `.combat-entity.teammate[data-teammate-id=\"${targetEntity.id}\"]`,\n          );\n          if (teammateElement) {\n            teammateElement.classList.add('heal-pulse-animation');\n            setTimeout(() =&gt; {\n              teammateElement.classList.remove('heal-pulse-animation');\n            }, 800);\n          }\n        } else if (targetType === 'enemy' &amp;&amp; targetEntity) {\n          const oldHp = targetEntity.hp;\n          targetEntity.hp = Math.min(targetEntity.hp + healAmount, targetEntity.maxHp);\n          const actualHeal = targetEntity.hp - oldHp;\n\n          showHealNumberOnEnemy(actualHeal, targetEntity.id);\n\n          const enemyHpBar = document.querySelector(\n            `.combat-entity.enemy[data-enemy-id=\"${targetEntity.id}\"] .hp-fill-combat`,\n          );\n          if (enemyHpBar) {\n\n            const enemyElement = enemyHpBar.closest('.combat-entity.enemy');\n            const enemyId = enemyElement ? enemyElement.getAttribute('data-enemy-id') : null;\n            if (enemyId) {\n              addHpChangeAnimation('enemy', enemyId);\n            }\n          }\n\n          const enemyEntity = document.querySelector(`.combat-entity.enemy[data-enemy-id=\"${targetEntity.id}\"]`);\n          if (enemyEntity) {\n            enemyEntity.classList.add('heal-pulse-animation');\n            setTimeout(() =&gt; {\n              enemyEntity.classList.remove('heal-pulse-animation');\n            }, 800);\n          }\n        }\n\n        addHealHate('player', battleState.player.name || 'User', healAmount);\n\n        memoryManager.safeSetTimeout(() =&gt; {\n          updateBattleUI({ player: true, enemy: true, weapons: true });\n          updateHateDisplay(); \n\n          if (battleState.currentWeapon &amp;&amp; battleState.currentWeapon.template === 'A2' &amp;&amp; battleState.isPlayerTurn) {\n            moveToNextAction();\n          }\n        }, 1200); \n      }\n\n      function performManaRestore(weapon, targetType, targetTeammate = null) {\n        const targetName =\n          targetType === 'player'\n            ? battleState.player.name || 'User'\n            : targetType === 'teammate'\n            ? targetTeammate.name\n            : 'Unknown';\n        logBattleAction(`${battleState.player.name || 'User'} ä½¿ç”¨ ${weapon.name} æ¢å¤ ${targetName} çš„çµåŠ›ï¼`);\n\n        let manaAmount = weapon.attack;\n\n        const critRoll = Math.random() * 100;\n        const isCrit = critRoll &lt;= weapon.critRate;\n        if (isCrit) {\n\n          const playerStats = getPlayerActualStats();\n          const critMultiplier = playerStats.baseCritMultiplier;\n          manaAmount = Math.floor(manaAmount * critMultiplier);\n          logBattleAction(`æš´å‡»æ¢å¤ï¼æ¢å¤ ${manaAmount} ç‚¹çµåŠ›å€¼ï¼`);\n        } else {\n          logBattleAction(`æ¢å¤ ${manaAmount} ç‚¹çµåŠ›å€¼ï¼`);\n        }\n\n        if (targetType === 'player') {\n          const oldMp = battleState.player.mp;\n          battleState.player.mp = Math.min(battleState.player.mp + manaAmount, battleState.player.maxMp);\n          const actualRestore = battleState.player.mp - oldMp;\n\n          logBattleAction(`å®é™…æ¢å¤äº† ${actualRestore} ç‚¹çµåŠ›å€¼ï¼`);\n        } else if (targetType === 'teammate' &amp;&amp; targetTeammate) {\n          const oldMp = targetTeammate.mp;\n          targetTeammate.mp = Math.min(targetTeammate.mp + manaAmount, targetTeammate.maxMp);\n          const actualRestore = targetTeammate.mp - oldMp;\n\n          logBattleAction(`å®é™…æ¢å¤äº† ${actualRestore} ç‚¹çµåŠ›å€¼ï¼`);\n        }\n\n        memoryManager.safeSetTimeout(() =&gt; {\n          updateBattleUI({ player: true, enemy: true, weapons: true });\n          updateHateDisplay(); \n\n          if (battleState.currentWeapon &amp;&amp; battleState.currentWeapon.template === 'A3' &amp;&amp; battleState.isPlayerTurn) {\n            moveToNextAction();\n          }\n        }, 1200); \n      }\n\n      function performSacrificeBoost(weapon, targetType) {\n        const targetName = targetType === 'player' ? battleState.player.name || 'User' : 'Unknown';\n        logBattleAction(`${battleState.player.name || 'User'} ä½¿ç”¨ ${weapon.name} è¿›è¡Œç‰ºç‰²å¢ç›Šï¼`);\n\n        const sacrificeDamage = Math.floor(weapon.attack * 0.5); \n\n        battleState.player.hp = Math.max(1, battleState.player.hp - sacrificeDamage); \n        logBattleAction(`ç‰ºç‰²äº† ${sacrificeDamage} ç‚¹ç”Ÿå‘½å€¼ï¼`);\n\n        if (!battleState.sacrificeBoostActive) {\n          battleState.sacrificeBoostActive = {\n            attack: weapon.attack,\n            hitRate: weapon.hitRate,\n            critRate: weapon.critRate,\n            attacksPerTurn: weapon.attacksPerTurn,\n            targetsPerAttack: weapon.targetsPerAttack,\n            weaponName: weapon.name,\n          };\n          logBattleAction(`è·å¾—å¼ºå¤§å¢ç›Šï¼æœ¬å›åˆæ‰€æœ‰æ”»å‡»éƒ½å°†è·å¾— ${weapon.name} çš„å±æ€§åŠ æˆï¼`);\n          logBattleAction(\n            `å¢ç›Šæ•ˆæœï¼šæ”»å‡»+${weapon.attack}ï¼Œå‘½ä¸­+${weapon.hitRate}%ï¼Œæš´å‡»+${weapon.critRate}%ï¼Œæ¬¡æ•°+${weapon.attacksPerTurn}ï¼Œç›®æ ‡+${weapon.targetsPerAttack}`,\n          );\n        }\n\n        memoryManager.safeSetTimeout(() =&gt; {\n          updateBattleUI({ player: true, enemy: true, weapons: true });\n          updateHateDisplay(); \n\n          if (battleState.currentWeapon &amp;&amp; battleState.currentWeapon.template === 'A4' &amp;&amp; battleState.isPlayerTurn) {\n            moveToNextAction();\n          }\n        }, 1200); \n      }\nfunction processEnchantmentEffects(weapon, enemy, damage, isCrit) {\n  if (!weapon.codes) return 0;\n  let totalExtraDamage = 0;\n  weapon.codes.forEach(code =&gt; {\n    if (!code.startsWith('EN:B')) return;\n    const match = code.match(/EN:(B\\d+),(.+)/);\n    if (!match) return;\n    const effectType = match[1];\n    const params = match[2].split(',');\n    switch (effectType) {\n      case 'B1': \n        handleLifeSteal(params, damage);\n        break;\n      case 'B2': \n        handleHitRateDebuff(params, enemy);\n        break;\n      case 'B3': \n        if (isCrit) handleCritBoost(params);\n        break;\n      case 'B4': \n        if (isCrit) handleFreeze(params, enemy);\n        break;\n      case 'B5': \n        handleDOT(params, enemy);\n        break;\n      case 'B6': \n        handleChanceFreeze(params, enemy);\n        break;\n      case 'B7': \n        totalExtraDamage += handleChanceExtraDamage(params, damage);\n        break;\n      case 'B8': \n        handleVulnerability(params, enemy);\n        break;\n      case 'B9': \n        handleManaRestore(params);\n        break;\n      case 'B10': \n        handleHealOverTime(params);\n        break;\n      case 'B11': \n        handleStrengthBoost(params);\n        break;\n      case 'B12': \n        handleAgilityBoost(params);\n        break;\n      case 'B13': \n        handleIntelligenceBoost(params);\n        break;\n      case 'B14': \n        handleEnduranceBoost(params);\n        break;\n      case 'B15': \n        handleVulnerabilityMark(params, enemy);\n        break;\n      case 'B16': \n        handleWeaknessMark(params, enemy);\n        break;\n      case 'B17': \n        handleDeathMark(params, enemy);\n        break;\n      case 'B18': \n        handleTraumaStack(params, enemy);\n        break;\n      case 'B19': \n        handleCorrosionStack(params, enemy);\n        break;\n      case 'B20': \n        handlePermanentShield(params);\n        break;\n      case 'B21': \n        handleTemporaryShield(params);\n        break;\n      case 'B22': \n        handleShieldOverTime(params);\n        break;\n    }\n  });\n  return totalExtraDamage;\n}\n\nfunction handleLifeSteal(params, damage) {\n  BuffManager.handleLifeSteal(params, damage, battleState.player, true);\n  addHpChangeAnimation('player');\n}\n\nfunction handleHitRateDebuff(params, enemy) {\n  const duration = parseInt(params[0]);\n  const value = parseInt(params[1].replace('%', ''));\n  enemy.buffs = enemy.buffs || [];\n  enemy.buffs.push({\n    name: 'å‘½ä¸­é™ä½',\n    type: 'hitRateDown',\n    value: value,\n    duration: duration,\n    isPositive: false,\n  });\n  logBattleAction(`å‘½ä¸­é™ä½æ•ˆæœè§¦å‘ï¼${enemy.name} å‘½ä¸­ç‡é™ä½ ${value}% æŒç»­ ${duration} å›åˆï¼`);\n}\n\nfunction handleCritBoost(params) {\n  BuffManager.handleCritBoost(params, battleState.player, true);\n}\n\nfunction handleFreeze(params, enemy) {\n  const duration = parseInt(params[0]);\n\n  enemy.pendingFreeze = true;\n  enemy.pendingFreezeCount = duration;\n  logBattleAction(`æ™•çœ©æ•ˆæœè§¦å‘ï¼${enemy.name} å°†åœ¨ä¸‹æ¬¡è¡ŒåŠ¨æ—¶è¢«æ™•çœ©ï¼`);\n}\n\nfunction handleDOT(params, enemy) {\n  const duration = parseInt(params[0]);\n  const damage = parseInt(params[1]);\n  enemy.buffs = enemy.buffs || [];\n  enemy.buffs.push({\n    name: 'æŒç»­ä¼¤å®³',\n    type: 'dot',\n    value: damage,\n    duration: duration,\n    isPositive: false,\n  });\n  logBattleAction(`æŒç»­ä¼¤å®³æ•ˆæœè§¦å‘ï¼${enemy.name} å°†åœ¨ ${duration} å›åˆå†…æ¯å›åˆå—åˆ° ${damage} ç‚¹ä¼¤å®³ï¼`);\n}\n\nfunction handleChanceFreeze(params, enemy) {\n  const chance = parseInt(params[0].replace('%', ''));\n  const duration = parseInt(params[1]);\n  if (Math.random() * 100 &lt;= chance) {\n\n    enemy.pendingFreeze = true;\n    enemy.pendingFreezeCount = duration;\n    logBattleAction(`å‡ ç‡æ™•çœ©è§¦å‘ï¼${enemy.name} å°†åœ¨ä¸‹æ¬¡è¡ŒåŠ¨æ—¶è¢«æ™•çœ©ï¼`);\n  }\n}\n\nfunction handleChanceExtraDamage(params, damage) {\n  const chance = parseInt(params[0].replace('%', ''));\n  const bonus = parseInt(params[1].replace('%', ''));\n  if (Math.random() * 100 &lt;= chance) {\n    const extraDamage = Math.floor(damage * (bonus / 100));\n    logBattleAction(`é¢å¤–ä¼¤å®³è§¦å‘ï¼é€ æˆé¢å¤– ${extraDamage} ç‚¹ä¼¤å®³ï¼`);\n    return extraDamage;\n  }\n  return 0;\n}\n\nfunction handleVulnerability(params, enemy) {\n  const duration = parseInt(params[0]);\n  const bonus = parseInt(params[1].replace('%', ''));\n  enemy.buffs = enemy.buffs || [];\n  enemy.buffs.push({\n    name: 'æ˜“ä¼¤',\n    type: 'vulnerable',\n    value: bonus,\n    duration: duration,\n    isPositive: false,\n  });\n  logBattleAction(`æ˜“ä¼¤æ•ˆæœè§¦å‘ï¼${enemy.name} å—åˆ°ä¼¤å®³å¢åŠ  ${bonus}% æŒç»­ ${duration} å›åˆï¼`);\n}\n\nfunction handleManaRestore(params) {\n  const mp = parseInt(params[0]);\n  const oldMp = battleState.player.mp;\n  battleState.player.mp = Math.min(battleState.player.mp + mp, battleState.player.maxMp);\n  const actualRestore = battleState.player.mp - oldMp;\n  logBattleAction(`çµåŠ›æ¢å¤è§¦å‘ï¼æ¢å¤ ${actualRestore} ç‚¹çµåŠ›å€¼ï¼`);\n}\n\nfunction handleHealOverTime(params) {\n  const duration = parseInt(params[0]);\n  const heal = parseInt(params[1]);\n  battleState.playerBuffs.push({\n    name: 'æŒç»­æ¢å¤',\n    type: 'healOverTime',\n    value: heal,\n    duration: duration,\n    isPositive: true,\n  });\n  logBattleAction(`æŒç»­æ¢å¤æ•ˆæœè§¦å‘ï¼å°†åœ¨ ${duration} å›åˆå†…æ¯å›åˆæ¢å¤ ${heal} ç‚¹ç”Ÿå‘½å€¼ï¼`);\n}\n\nconst handleStrengthBoost = params =&gt; BuffManager.handleAttributeBoost(params, 'strBoost', 'åŠ›é‡', true);\nconst handleAgilityBoost = params =&gt; BuffManager.handleAttributeBoost(params, 'agiBoost', 'æ•æ·', true);\nconst handleIntelligenceBoost = params =&gt; BuffManager.handleAttributeBoost(params, 'intBoost', 'æ™ºåŠ›', true);\nconst handleEnduranceBoost = params =&gt; BuffManager.handleAttributeBoost(params, 'endBoost', 'è€åŠ›', true);\n\nfunction handleVulnerabilityMark(params, enemy) {\n  const bonus = parseInt(params[0].replace('%', ''));\n  enemy.marks = enemy.marks || {};\n  enemy.marks.vulnerability = bonus;\n  logBattleAction(`æ˜“ä¼¤æ ‡è®°æ–½åŠ ï¼${enemy.name} ä¸‹æ¬¡å—åˆ°æ”»å‡»å°†é¢å¤–æ‰¿å— ${bonus}% ä¼¤å®³ï¼`);\n}\nfunction handleWeaknessMark(params, enemy) {\n  const bonus = parseInt(params[0].replace('%', ''));\n  enemy.marks = enemy.marks || {};\n  enemy.marks.weakness = bonus;\n  logBattleAction(`ç ´ç»½æ ‡è®°æ–½åŠ ï¼${enemy.name} ä¸‹æ¬¡å—åˆ°æ”»å‡»æš´å‡»ç‡é¢å¤–æå‡ ${bonus}%ï¼`);\n}\nfunction handleDeathMark(params, enemy) {\n  const bonus = parseInt(params[0].replace('%', ''));\n  enemy.marks = enemy.marks || {};\n  enemy.marks.death = bonus;\n  logBattleAction(`æ­»ç‚¹æ ‡è®°æ–½åŠ ï¼${enemy.name} ä¸‹æ¬¡å—åˆ°æ”»å‡»æš´å‡»ä¼¤å®³é¢å¤–æå‡ ${bonus}%ï¼`);\n}\n\nfunction handleTraumaStack(params, enemy) {\n  const stacks = parseInt(params[0]);\n  const damage = parseInt(params[1]);\n  enemy.stacks = enemy.stacks || {};\n  enemy.stacks.trauma = (enemy.stacks.trauma || 0) + stacks;\n  logBattleAction(\n    `åˆ›ä¼¤å åŠ ï¼${enemy.name} è·å¾— ${stacks} å±‚åˆ›ä¼¤æ•ˆæœï¼ˆæ€»è®¡ ${enemy.stacks.trauma} å±‚ï¼‰ï¼Œæ¯å±‚æ¯å›åˆé€ æˆ ${damage} ç‚¹ä¼¤å®³ï¼`,\n  );\n}\nfunction handleCorrosionStack(params, enemy) {\n  const stacks = parseInt(params[0]);\n  const bonus = parseInt(params[1].replace('%', ''));\n  enemy.stacks = enemy.stacks || {};\n  enemy.stacks.corrosion = (enemy.stacks.corrosion || 0) + stacks;\n  logBattleAction(\n    `è…èš€å åŠ ï¼${enemy.name} è·å¾— ${stacks} å±‚è…èš€æ•ˆæœï¼ˆæ€»è®¡ ${enemy.stacks.corrosion} å±‚ï¼‰ï¼Œæ¯å±‚ä½¿å—åˆ°ä¼¤å®³å¢åŠ  ${bonus}%ï¼`,\n  );\n}\n\nfunction handlePermanentShield(params, target = battleState.player, targetName = null) {\n  const shieldValue = parseInt(params[0]);\n  const name = targetName || (target === battleState.player ? 'ä½ ' : target.name);\n\n  if (!target.shield) {\n    target.shield = 0;\n    target.maxShield = shieldValue;\n  }\n\n  target.shield = target.maxShield;\n  logBattleAction(`${name}çš„å›ºåŒ–æŠ¤ç›¾è§¦å‘ï¼æŠ¤ç›¾å€¼æ¢å¤è‡³ ${target.maxShield} ç‚¹ï¼`);\n}\n\nfunction handleTemporaryShield(params, target = battleState.player, targetName = null) {\n  const shieldValue = parseInt(params[0]);\n  const name = targetName || (target === battleState.player ? 'ä½ ' : target.name);\n\n  if (!target.tempShield) {\n    target.tempShield = 0;\n  }\n\n  target.tempShield += shieldValue;\n  logBattleAction(`${name}çš„ç¬å‘æŠ¤ç›¾è§¦å‘ï¼è·å¾— ${shieldValue} ç‚¹ä¸´æ—¶æŠ¤ç›¾ï¼ˆæ€»è®¡ ${target.tempShield} ç‚¹ï¼‰ï¼`);\n}\n\nfunction handleShieldOverTime(params, buffsArray = battleState.playerBuffs, targetName = null) {\n  const duration = parseInt(params[0]);\n  const shieldPerRound = parseInt(params[1]);\n  const name = targetName || 'ä½ ';\n\n  const existingBuff = buffsArray.find(buff =&gt; buff.type === 'shieldOverTime');\n\n  if (existingBuff) {\n\n    existingBuff.value += shieldPerRound;\n    existingBuff.duration = Math.max(existingBuff.duration, duration); \n    logBattleAction(\n      `${name}çš„æŠ¤ç›¾æŒç»­æ•ˆæœå åŠ ï¼æ¯å›åˆè·å¾—æŠ¤ç›¾å€¼å¢åŠ è‡³ ${existingBuff.value} ç‚¹ï¼ŒæŒç»­ ${existingBuff.duration} å›åˆï¼`,\n    );\n  } else {\n\n    buffsArray.push({\n      name: 'æŠ¤ç›¾æŒç»­',\n      type: 'shieldOverTime',\n      value: shieldPerRound,\n      duration: duration,\n      isPositive: true,\n    });\n    logBattleAction(`${name}çš„æŠ¤ç›¾æŒç»­æ•ˆæœè§¦å‘ï¼å°†åœ¨ ${duration} å›åˆå†…æ¯å›åˆè·å¾— ${shieldPerRound} ç‚¹æŠ¤ç›¾ï¼`);\n  }\n}\n\nfunction getPlayerActualStats() {\n  let str = battleState.player.str || 0;\n  let agi = battleState.player.agi || 0;\n  let int = battleState.player.int || 0;\n  let end = battleState.player.vit || 0; \n\n  battleState.playerBuffs.forEach(buff =&gt; {\n    switch (buff.type) {\n      case 'strBoost':\n        str += buff.value;\n        break;\n      case 'agiBoost':\n        agi += buff.value;\n        break;\n      case 'intBoost':\n        int += buff.value;\n        break;\n      case 'endBoost':\n        end += buff.value;\n        break;\n    }\n  });\n\n  const derivedStats = calculateDerivedStats(str, agi, int, end);\n  return {\n    str,\n    agi,\n    int,\n    end,\n    hpRegen: derivedStats.hpRegen,\n    mpRegen: derivedStats.mpRegen,\n    actionPoints: derivedStats.actionPoints,\n    speed: derivedStats.speed,\n    evasionRate: derivedStats.evasionRate,\n    damageBonus: derivedStats.damageBonus,\n    physicalReduction: derivedStats.physicalReduction,\n    damageTakenRate: derivedStats.damageTakenRate,\n    extraHitRate: derivedStats.extraHitRate,\n    extraCritRate: derivedStats.extraCritRate,\n    baseCritMultiplier: derivedStats.baseCritMultiplier,\n    critRateResistance: derivedStats.critRateResistance,\n    critDamageResistance: derivedStats.critDamageResistance,\n  };\n}\n\nfunction getTeammateActualStats(teammate) {\n  let str = teammate.str || 0;\n  let agi = teammate.agi || 0;\n  let int = teammate.int || 0;\n  let end = teammate.vit || 0; \n\n  if (teammate.buffs) {\n    teammate.buffs.forEach(buff =&gt; {\n      switch (buff.type) {\n        case 'strBoost':\n          str += buff.value;\n          break;\n        case 'agiBoost':\n          agi += buff.value;\n          break;\n        case 'intBoost':\n          int += buff.value;\n          break;\n        case 'endBoost':\n          end += buff.value;\n          break;\n      }\n    });\n  }\n\n  const derivedStats = calculateDerivedStats(str, agi, int, end);\n  return {\n    str,\n    agi,\n    int,\n    end,\n    hpRegen: derivedStats.hpRegen,\n    mpRegen: derivedStats.mpRegen,\n    actionPoints: derivedStats.actionPoints,\n    speed: derivedStats.speed,\n    evasionRate: derivedStats.evasionRate,\n    damageBonus: derivedStats.damageBonus,\n    physicalReduction: derivedStats.physicalReduction,\n    damageTakenRate: derivedStats.damageTakenRate,\n    extraHitRate: derivedStats.extraHitRate,\n    extraCritRate: derivedStats.extraCritRate,\n    baseCritMultiplier: derivedStats.baseCritMultiplier,\n    critRateResistance: derivedStats.critRateResistance,\n    critDamageResistance: derivedStats.critDamageResistance,\n  };\n}\n\nfunction getEnemyActualStats(enemy) {\n  let str = enemy.str || 0;\n  let agi = enemy.agi || 0;\n  let int = enemy.int || 0;\n  let vit = enemy.vit || 0;\n\n  if (enemy.buffs) {\n    enemy.buffs.forEach(buff =&gt; {\n      switch (buff.type) {\n        case 'strBoost':\n          str += buff.value;\n          break;\n        case 'agiBoost':\n          agi += buff.value;\n          break;\n        case 'intBoost':\n          int += buff.value;\n          break;\n        case 'endBoost':\n          vit += buff.value;\n          break;\n      }\n    });\n  }\n\n  const derivedStats = calculateDerivedStats(str, agi, int, vit);\n  return {\n    str,\n    agi,\n    int,\n    vit,\n    speed: derivedStats.speed,\n    evasionRate: derivedStats.evasionRate,\n    damageBonus: derivedStats.damageBonus,\n    physicalReduction: derivedStats.physicalReduction,\n    damageTakenRate: derivedStats.damageTakenRate,\n    extraHitRate: derivedStats.extraHitRate,\n    extraCritRate: derivedStats.extraCritRate,\n    baseCritMultiplier: derivedStats.baseCritMultiplier,\n    critRateResistance: derivedStats.critRateResistance,\n    critDamageResistance: derivedStats.critDamageResistance,\n  };\n}\n\nfunction processTeammateEnchantmentEffects(weapon, enemy, damage, isCrit, teammate) {\n  if (!weapon.codes) return 0;\n  let totalExtraDamage = 0;\n  weapon.codes.forEach(code =&gt; {\n    if (!code.startsWith('EN:B')) return;\n    const match = code.match(/EN:(B\\d+),(.+)/);\n    if (!match) return;\n    const effectType = match[1];\n    const params = match[2].split(',');\n    switch (effectType) {\n      case 'B1': \n        handleTeammateLifeSteal(params, damage, teammate);\n        break;\n      case 'B2': \n        handleHitRateDebuff(params, enemy);\n        break;\n      case 'B3': \n        if (isCrit) handleTeammateCritBoost(params, teammate);\n        break;\n      case 'B4': \n        if (isCrit) handleFreeze(params, enemy);\n        break;\n      case 'B5': \n        handleDOT(params, enemy);\n        break;\n      case 'B6': \n        handleChanceFreeze(params, enemy);\n        break;\n      case 'B7': \n        totalExtraDamage += handleChanceExtraDamage(params, damage);\n        break;\n      case 'B8': \n        handleVulnerability(params, enemy);\n        break;\n      case 'B9': \n        handleTeammateManaRestoreEffect(params, teammate);\n        break;\n      case 'B10': \n        handleTeammateHealOverTime(params, teammate);\n        break;\n      case 'B11': \n        handleTeammateStrengthBoost(params, teammate);\n        break;\n      case 'B12': \n        handleTeammateAgilityBoost(params, teammate);\n        break;\n      case 'B13': \n        handleTeammateIntelligenceBoost(params, teammate);\n        break;\n      case 'B14': \n        handleTeammateVitalityBoost(params, teammate);\n        break;\n      case 'B15': \n        handleVulnerabilityMark(params, enemy);\n        break;\n      case 'B16': \n        handleWeaknessMark(params, enemy);\n        break;\n      case 'B17': \n        handleDeathMark(params, enemy);\n        break;\n      case 'B18': \n        handleTraumaStack(params, enemy);\n        break;\n      case 'B19': \n        handleCorrosionStack(params, enemy);\n        break;\n      case 'B20': \n        handlePermanentShield(params, teammate, teammate.name);\n        break;\n      case 'B21': \n        handleTemporaryShield(params, teammate, teammate.name);\n        break;\n      case 'B22': \n        if (!teammate.buffs) teammate.buffs = [];\n        handleShieldOverTime(params, teammate.buffs, teammate.name);\n        break;\n    }\n  });\n  return totalExtraDamage;\n}\n\nconst handleTeammateLifeSteal = (params, damage, teammate) =&gt;\n  BuffManager.handleLifeSteal(params, damage, teammate, false);\nconst handleTeammateCritBoost = (params, teammate) =&gt; BuffManager.handleCritBoost(params, teammate, false);\nfunction handleTeammateManaRestoreEffect(params, teammate) {\n  const mp = parseInt(params[0]);\n  const oldMp = teammate.mp;\n  teammate.mp = Math.min(teammate.mp + mp, teammate.maxMp);\n  const actualRestore = teammate.mp - oldMp;\n  logBattleAction(`${teammate.name} çµåŠ›æ¢å¤è§¦å‘ï¼æ¢å¤ ${actualRestore} ç‚¹çµåŠ›å€¼ï¼`);\n}\nfunction handleTeammateHealOverTime(params, teammate) {\n  const duration = parseInt(params[0]);\n  const heal = parseInt(params[1]);\n  teammate.buffs = teammate.buffs || [];\n  teammate.buffs.push({\n    name: 'æŒç»­æ¢å¤',\n    type: 'healOverTime',\n    value: heal,\n    duration: duration,\n    isPositive: true,\n  });\n  logBattleAction(`${teammate.name} æŒç»­æ¢å¤æ•ˆæœè§¦å‘ï¼å°†åœ¨ ${duration} å›åˆå†…æ¯å›åˆæ¢å¤ ${heal} ç‚¹ç”Ÿå‘½å€¼ï¼`);\n}\n\nconst handleTeammateStrengthBoost = (params, teammate) =&gt;\n  BuffManager.handleAttributeBoost(params, 'strBoost', 'åŠ›é‡', false, teammate);\nconst handleTeammateAgilityBoost = (params, teammate) =&gt;\n  BuffManager.handleAttributeBoost(params, 'agiBoost', 'æ•æ·', false, teammate);\nconst handleTeammateIntelligenceBoost = (params, teammate) =&gt;\n  BuffManager.handleAttributeBoost(params, 'intBoost', 'æ™ºåŠ›', false, teammate);\nconst handleTeammateVitalityBoost = (params, teammate) =&gt;\n  BuffManager.handleAttributeBoost(params, 'vitBoost', 'ä½“åŠ›', false, teammate);\n\n      function performEnemyTurn() {\n        battleState.waitingForNextRound = false;\n        logBattleAction(`æ•Œäººå›åˆï¼`);\n\n        for (const enemy of battleState.enemies) {\n\n          if (enemy.pendingFreeze) {\n            logBattleAction(`${enemy.name} è¢«æ™•çœ©ï¼Œæ— æ³•è¡ŒåŠ¨ï¼`);\n            enemy.pendingFreezeCount--;\n            if (enemy.pendingFreezeCount &lt;= 0) {\n              enemy.pendingFreeze = false;\n              enemy.pendingFreezeCount = 0;\n              logBattleAction(`${enemy.name} è§£é™¤äº†æ™•çœ©çŠ¶æ€ï¼`);\n            }\n            continue;\n          }\n\n          let totalBurnDamage = 0;\n          const burnBuffs = enemy.buffs ? enemy.buffs.filter(buff =&gt; buff.type === 'burnOverTime') : [];\n          if (burnBuffs.length &gt; 0) {\n\n            burnBuffs.forEach(burnBuff =&gt; {\n              totalBurnDamage += burnBuff.value;\n            });\n            if (totalBurnDamage &gt; 0) {\n              enemy.hp = Math.max(0, enemy.hp - totalBurnDamage);\n              logBattleAction(`${enemy.name} å—åˆ°ä½™çƒ¬æ•ˆæœï¼ŒæŸå¤± ${totalBurnDamage} ç‚¹ç”Ÿå‘½å€¼ï¼`);\n\n              showDamageNumber('enemy', totalBurnDamage, false, enemy.id);\n\n              addHpChangeAnimation('enemy', enemy.id);\n\n              if (StateValidator.isDead(enemy)) {\n                logBattleAction(`${enemy.name} è¢«ä½™çƒ¬æ•ˆæœå‡»è´¥äº†ï¼`);\n\n                const enemyElement = document.querySelector(`.combat-entity.enemy[data-enemy-id=\"${enemy.id}\"]`);\n                createDeathEffect(enemyElement);\n                battleState.enemies = battleState.enemies.filter(e =&gt; e.id !== enemy.id);\n                if (StateValidator.areAllEnemiesDead()) {\n                  endBattle(true);\n                  return;\n                }\n\n                continue;\n              }\n            }\n          }\n\n          const attackName = enemy.attackPattern[enemy.nextAttackIndex];\n          const skill = enemy.skills.find(s =&gt; s.name === attackName);\n          if (skill) {\n            logBattleAction(`${enemy.name} ä½¿ç”¨ ${skill.name} æ”»å‡»ï¼`);\n\n            const enemyElement = document.querySelector(`.combat-entity.enemy[data-enemy-id=\"${enemy.id}\"]`);\n            enemyElement.classList.add('attack-animation-backward');\n\n            setTimeout(() =&gt; {\n\n              const effectiveHitRate = getEffectiveHitRate(skill.hitRate, enemy);\n\n              const maxTargets = skill.targetsPerAttack || 1;\n              const targets = getEnemyTargetsByHate(enemy.id, maxTargets);\n              if (targets.length === 0) {\n                logBattleAction(`${enemy.name} æ‰¾ä¸åˆ°å¯æ”»å‡»çš„ç›®æ ‡ï¼`);\n\n                setTimeout(() =&gt; {\n                  enemyElement.classList.remove('attack-animation-backward');\n                }, 500);\n                return;\n              }\n              if (maxTargets &gt; 1) {\n                logBattleAction(\n                  `${enemy.name} çš„ ${skill.name} ç„å‡†äº† ${targets.length} ä¸ªç›®æ ‡ï¼š${targets\n                    .map(t =&gt; t.name)\n                    .join(', ')}`,\n                );\n              }\n\n              targets.forEach((target, targetIndex) =&gt; {\n\n                const enemyStats = getEnemyActualStats(enemy);\n                let targetStats;\n                if (target.entity === battleState.player) {\n                  targetStats = getPlayerActualStats();\n                } else {\n\n                  targetStats = getTeammateActualStats(target.entity);\n                }\n\n                const finalHitRate = calculateFinalHitRate(effectiveHitRate, enemyStats, targetStats);\n                const hitRoll = Math.random();\n\n                if (hitRoll &lt;= Math.min(1.0, finalHitRate)) {\n\n                  logBattleAction(`æ”»å‡»å‘½ä¸­ ${target.name}ï¼(æœ€ç»ˆå‘½ä¸­ç‡: ${(finalHitRate * 100).toFixed(1)}%)`);\n\n                  const targetElement =\n                    target.type === 'player'\n                      ? document.querySelector('.combat-entity.player')\n                      : document.querySelector(`.combat-entity.teammate[data-teammate-id=\"${target.entity.id}\"]`);\n                  if (targetElement) {\n                    targetElement.classList.add('shake-animation');\n                  }\n\n                  const finalCritRate = calculateFinalCritRate(skill.critRate, enemyStats, targetStats, finalHitRate);\n                  const critRoll = Math.random();\n\n                  const isCrit = critRoll &lt;= Math.min(1.0, finalCritRate);\n\n                  const finalCritMultiplier = isCrit\n                    ? calculateFinalCritMultiplier(enemyStats, targetStats, finalCritRate)\n                    : 1.0;\n\n                  let damage = calculateFinalDamage(skill.attack, enemyStats, targetStats, isCrit, finalCritMultiplier);\n\n                  if (isCrit) {\n                    logBattleAction(\n                      `æš´å‡»ï¼é€ æˆ ${damage} ç‚¹ä¼¤å®³ï¼(æš´å‡»ç‡: ${(finalCritRate * 100).toFixed(\n                        1,\n                      )}%, æš´å‡»å€ç‡: ${finalCritMultiplier.toFixed(2)}x)`,\n                    );\n                    if (target.type === 'player') {\n                      showDamageNumber('player', damage, true);\n                    } else {\n\n                      showDamageNumber('teammate', damage, true, null, target.entity.id);\n                    }\n                  } else {\n                    logBattleAction(`é€ æˆ ${damage} ç‚¹ä¼¤å®³ï¼`);\n                    if (target.type === 'player') {\n                      showDamageNumber('player', damage, false);\n                    } else {\n\n                      showDamageNumber('teammate', damage, false, null, target.entity.id);\n                    }\n                  }\n\n                  let remainingDamage = damage;\n\n                  if (target.entity.tempShield &amp;&amp; target.entity.tempShield &gt; 0) {\n                    const tempShieldAbsorbed = Math.min(target.entity.tempShield, remainingDamage);\n                    target.entity.tempShield -= tempShieldAbsorbed;\n                    remainingDamage -= tempShieldAbsorbed;\n                    if (tempShieldAbsorbed &gt; 0) {\n                      logBattleAction(`ä¸´æ—¶æŠ¤ç›¾å¸æ”¶ ${tempShieldAbsorbed} ç‚¹ä¼¤å®³ï¼ï¼ˆå‰©ä½™ä¸´æ—¶æŠ¤ç›¾ ${target.entity.tempShield} ç‚¹ï¼‰`);\n                    }\n                  }\n\n                  if (remainingDamage &gt; 0 &amp;&amp; target.entity.shield &amp;&amp; target.entity.shield &gt; 0) {\n                    const shieldAbsorbed = Math.min(target.entity.shield, remainingDamage);\n                    target.entity.shield -= shieldAbsorbed;\n                    remainingDamage -= shieldAbsorbed;\n                    if (shieldAbsorbed &gt; 0) {\n                      logBattleAction(`æŠ¤ç›¾å¸æ”¶ ${shieldAbsorbed} ç‚¹ä¼¤å®³ï¼ï¼ˆå‰©ä½™æŠ¤ç›¾ ${target.entity.shield} ç‚¹ï¼‰`);\n                    }\n                  }\n\n                  const oldHp = target.entity.hp;\n                  target.entity.hp = Math.max(0, target.entity.hp - remainingDamage);\n\n                  if (target.type === 'player') {\n                    addHpChangeAnimation('player');\n                  } else {\n                    addHpChangeAnimation('teammate', target.entity.id);\n                  }\n\n                  setTimeout(() =&gt; {\n                    if (targetElement) {\n                      targetElement.classList.remove('shake-animation');\n                    }\n                  }, 800);\n\n                  if (StateValidator.isDead(target.entity)) {\n                    if (target.type === 'player') {\n\n                      battleState.lastKilledBy = skill.name;\n                      endBattle(false);\n                      return;\n                    } else {\n\n                      logBattleAction(`${target.name} è¢«å‡»è´¥äº†ï¼`);\n\n                      createDeathEffect(targetElement);\n\n                      hateSystem.clearTargetHate(target.entity.id);\n\n                      battleState.teammates = battleState.teammates.filter(t =&gt; t.id !== target.entity.id);\n\n                      cleanupActionOrder('teammate', target.entity.id);\n\n                      updatePlayerPanel();\n                    }\n                  }\n                } else {\n\n                  logBattleAction(`æ”»å‡»æœªå‘½ä¸­ ${target.name}ï¼(æœ€ç»ˆå‘½ä¸­ç‡: ${(finalHitRate * 100).toFixed(1)}%)`);\n                }\n              }); \n\n              enemy.nextAttackIndex = (enemy.nextAttackIndex + 1) % enemy.attackPattern.length;\n\n              enemyElement.classList.remove('attack-animation-backward');\n            }, 500);\n          }\n        }\n\n        setTimeout(() =&gt; {\n\n          updatePlayerPanel();\n          updateEnemyPanel();\n          updateHateDisplay(); \n\n          startNextRound();\n        }, 1500); \n      }\n\n      function forceUpdateUI() {\n\n        updateActionOrderDisplay();\n\n        const currentAction = battleState.actionOrder[battleState.currentActionIndex];\n        if (!currentAction) {\n          return;\n        }\n\n        document.querySelectorAll('.combat-entity').forEach(entity =&gt; {\n          entity.classList.remove('current-actor');\n        });\n        if (currentAction.type === 'player') {\n          const playerEntity = document.querySelector('.combat-entity.player');\n          if (playerEntity) {\n            playerEntity.classList.add('current-actor');\n          }\n        } else if (currentAction.type === 'teammate') {\n          const teammateEntity = document.querySelector(\n            `.combat-entity.teammate[data-teammate-id=\"${currentAction.id}\"]`,\n          );\n          if (teammateEntity) {\n            teammateEntity.classList.add('current-actor');\n          }\n\n          battleState.currentTeammate = currentAction.entity;\n          updateTeammateWeaponsList(); \n        } else if (currentAction.type === 'enemy') {\n          const enemyEntity = document.querySelector(`.combat-entity.enemy[data-enemy-id=\"${currentAction.id}\"]`);\n          if (enemyEntity) {\n            enemyEntity.classList.add('current-actor');\n          }\n        }\n\n        setupSkipButton();\n\n        updateBattleUI({ player: true, enemy: true, weapons: false });\n        updateHateDisplay(); \n      }\n\n      function updateBattleUI(options = {}) {\n        const {\n          player = true,\n          enemy = true,\n          weapons = true,\n          items = false,\n          teammates = false,\n          force = false,\n        } = options;\n\n        if (force || lazyRenderManager.shouldRenderCombat()) {\n          if (player) updatePlayerPanel();\n          if (enemy) updateEnemyPanel();\n          if (weapons) updateWeaponsList();\n          if (items) updateItemsList();\n          if (teammates) updateTeammateWeaponsList();\n        }\n      }\n\n      function startNextRound() {\n\n        battleState.round++;\n\n        battleState.currentItemUsed = false;\n\n        battleState.player.weapons.forEach(weapon =&gt; {\n          weapon.used = false;\n          if (weapon.currentCooldown &gt; 0) {\n            weapon.currentCooldown--;\n          }\n        });\n        battleState.player.items.forEach(item =&gt; {\n          item.used = false;\n        });\n\n        battleState.teammates.forEach(teammate =&gt; {\n          teammate.skillUsed = false;\n          teammate.weapons.forEach(weapon =&gt; {\n            weapon.used = false;\n\n            if (weapon.currentCooldown &gt; 0) {\n              weapon.currentCooldown--;\n            }\n          });\n        });\n\n        const currentPlayerStats = getPlayerActualStats();\n        battleState.player.hp = Math.min(battleState.player.hp + currentPlayerStats.hpRegen, battleState.player.maxHp);\n        battleState.player.mp = Math.min(battleState.player.mp + currentPlayerStats.mpRegen, battleState.player.maxMp);\n\n        battleState.teammates.forEach(teammate =&gt; {\n          const currentTeammateStats = getTeammateActualStats(teammate);\n\n          teammate.hp = Math.min(teammate.hp + (teammate.hpRegen || 0), teammate.maxHp);\n          teammate.mp = Math.min(teammate.mp + currentTeammateStats.mpRegen, teammate.maxMp);\n\n          if (teammate.buffs &amp;&amp; teammate.buffs.length &gt; 0) {\n            teammate.buffs.forEach(buff =&gt; {\n              if (buff.type === 'healOverTime') {\n                const healAmount = buff.value;\n                const oldHp = teammate.hp;\n                teammate.hp = Math.min(teammate.hp + healAmount, teammate.maxHp);\n                const actualHeal = teammate.hp - oldHp;\n                if (actualHeal &gt; 0) {\n                  logBattleAction(`${teammate.name} æŒç»­æ¢å¤æ•ˆæœè§¦å‘ï¼Œæ¢å¤ ${actualHeal} ç‚¹ç”Ÿå‘½å€¼ï¼`);\n                  showHealNumber(actualHeal);\n                }\n              }\n\n              if (buff.type === 'shieldOverTime') {\n                const shieldAmount = buff.value;\n\n                if (!teammate.shield) {\n                  teammate.shield = 0;\n                  teammate.maxShield = 0;\n                }\n\n                teammate.shield += shieldAmount;\n                logBattleAction(`${teammate.name}çš„æŠ¤ç›¾æŒç»­æ•ˆæœè§¦å‘ï¼Œè·å¾— ${shieldAmount} ç‚¹æŠ¤ç›¾ï¼ˆå½“å‰æŠ¤ç›¾ ${teammate.shield} ç‚¹ï¼‰ï¼`);\n              }\n            });\n          }\n\n          if (teammate.tempShield) {\n            logBattleAction(`${teammate.name}çš„ä¸´æ—¶æŠ¤ç›¾æ¶ˆæ•£ï¼Œå¤±å» ${teammate.tempShield} ç‚¹ä¸´æ—¶æŠ¤ç›¾ï¼`);\n            teammate.tempShield = 0;\n          }\n        });\n\n        const healOTBuff = battleState.playerBuffs.find(buff =&gt; buff.type === 'healOverTime');\n        if (healOTBuff) {\n          const healAmount = healOTBuff.value;\n          const oldHp = battleState.player.hp;\n          battleState.player.hp = Math.min(battleState.player.hp + healAmount, battleState.player.maxHp);\n          const actualHeal = battleState.player.hp - oldHp;\n          if (actualHeal &gt; 0) {\n            logBattleAction(`æŒç»­æ¢å¤æ•ˆæœè§¦å‘ï¼Œæ¢å¤ ${actualHeal} ç‚¹ç”Ÿå‘½å€¼ï¼`);\n            showHealNumber(actualHeal);\n\n            addHpChangeAnimation('player');\n\n            const playerEntity = document.querySelector('.combat-entity.player');\n            playerEntity.classList.add('heal-pulse-animation');\n            setTimeout(() =&gt; {\n              playerEntity.classList.remove('heal-pulse-animation');\n            }, 800);\n          }\n        }\n\n        const shieldOTBuff = battleState.playerBuffs.find(buff =&gt; buff.type === 'shieldOverTime');\n        if (shieldOTBuff) {\n          const shieldAmount = shieldOTBuff.value;\n\n          if (!battleState.player.shield) {\n            battleState.player.shield = 0;\n            battleState.player.maxShield = 0;\n          }\n\n          battleState.player.shield += shieldAmount;\n          logBattleAction(`æŠ¤ç›¾æŒç»­æ•ˆæœè§¦å‘ï¼Œè·å¾— ${shieldAmount} ç‚¹æŠ¤ç›¾ï¼ˆå½“å‰æŠ¤ç›¾ ${battleState.player.shield} ç‚¹ï¼‰ï¼`);\n        }\n\n        if (battleState.player.tempShield) {\n          logBattleAction(`ä¸´æ—¶æŠ¤ç›¾æ¶ˆæ•£ï¼Œå¤±å» ${battleState.player.tempShield} ç‚¹ä¸´æ—¶æŠ¤ç›¾ï¼`);\n          battleState.player.tempShield = 0;\n        }\n\n        battleState.enemies.forEach(enemy =&gt; {\n\n          if (enemy.buffs &amp;&amp; enemy.buffs.length &gt; 0) {\n            enemy.buffs.forEach(buff =&gt; {\n              if (buff.type === 'dot') {\n                const damage = buff.value;\n                enemy.hp = Math.max(0, enemy.hp - damage);\n                logBattleAction(`${enemy.name} å—åˆ°æŒç»­ä¼¤å®³ ${damage} ç‚¹ï¼`);\n                if (StateValidator.isDead(enemy)) {\n                  logBattleAction(`${enemy.name} å› æŒç»­ä¼¤å®³æ­»äº¡ï¼`);\n                }\n              }\n            });\n          }\n\n          if (enemy.stacks &amp;&amp; enemy.stacks.trauma) {\n\n            const traumaDamagePerStack = 3; \n            const traumaDamage = enemy.stacks.trauma * traumaDamagePerStack;\n            enemy.hp = Math.max(0, enemy.hp - traumaDamage);\n            logBattleAction(`${enemy.name} å—åˆ°åˆ›ä¼¤ä¼¤å®³ ${traumaDamage} ç‚¹ï¼ˆ${enemy.stacks.trauma} å±‚ï¼‰ï¼`);\n            if (StateValidator.isDead(enemy)) {\n              logBattleAction(`${enemy.name} å› åˆ›ä¼¤æ­»äº¡ï¼`);\n            }\n          }\n        });\n\n        if (battleState.playerBuffs.length &gt; 0) {\n          battleState.playerBuffs.forEach(buff =&gt; {\n            if (buff.type === 'healOverTime') {\n              const healAmount = buff.value;\n              const oldHp = battleState.player.hp;\n              battleState.player.hp = Math.min(battleState.player.hp + healAmount, battleState.player.maxHp);\n              const actualHeal = battleState.player.hp - oldHp;\n              if (actualHeal &gt; 0) {\n                logBattleAction(`æŒç»­æ¢å¤æ•ˆæœè§¦å‘ï¼Œæ¢å¤ ${actualHeal} ç‚¹ç”Ÿå‘½å€¼ï¼`);\n                showHealNumber(actualHeal);\n              }\n            }\n          });\n        }\n\n        if (battleState.playerBuffs.length &gt; 0) {\n          battleState.playerBuffs.forEach(buff =&gt; {\n            buff.duration--;\n          });\n\n          battleState.playerBuffs = battleState.playerBuffs.filter(buff =&gt; buff.duration &gt; 0);\n        }\n        battleState.enemies.forEach(enemy =&gt; {\n          if (enemy.buffs &amp;&amp; enemy.buffs.length &gt; 0) {\n            enemy.buffs.forEach(buff =&gt; {\n              buff.duration--;\n            });\n\n            enemy.buffs = enemy.buffs.filter(buff =&gt; buff.duration &gt; 0);\n          }\n        });\n\n        battleState.teammates.forEach(teammate =&gt; {\n          if (teammate.buffs &amp;&amp; teammate.buffs.length &gt; 0) {\n            teammate.buffs.forEach(buff =&gt; {\n              buff.duration--;\n            });\n\n            teammate.buffs = teammate.buffs.filter(buff =&gt; buff.duration &gt; 0);\n          }\n        });\n\n        const deadEnemies = battleState.enemies.filter(enemy =&gt; StateValidator.isDead(enemy));\n        if (deadEnemies.length &gt; 0) {\n          battleState.enemies = battleState.enemies.filter(enemy =&gt; !StateValidator.isDead(enemy));\n          deadEnemies.forEach(enemy =&gt; {\n            logBattleAction(`${enemy.name} å·²æ­»äº¡ï¼`);\n          });\n        }\n\n        if (StateValidator.areAllEnemiesDead()) {\n          logBattleAction('æ‰€æœ‰æ•Œäººå·²è¢«å‡»è´¥ï¼æˆ˜æ–—èƒœåˆ©ï¼');\n          endBattle(true);\n          return;\n        }\n\n        battleState.currentWeapon = null;\n        battleState.selectedEnemies = [];\n        battleState.selectedHealTargets = []; \n        battleState.healTarget = null;\n        battleState.selfTargetMode = false;\n        battleState.sacrificeBoostActive = null; \n\n        updateBattleUI({ player: true, enemy: true, weapons: false });\n        updateWeaponsList();\n\n        logBattleAction(`ç¬¬ ${battleState.round} å›åˆå¼€å§‹ï¼`);\n\n        calculateActionOrder();\n\n        battleState.currentActionIndex = 0;\n\n        forceUpdateUI();\n\n        showCurrentActor();\n      }\n\n      function endBattle(isVictory) {\n\n        document\n          .querySelectorAll('.weapon-button, .attack-button, .next-round-button, .mid-action-button, .item-button')\n          .forEach(button =&gt; {\n            button.disabled = true;\n          });\n\n        hateSystem.enemyHateLists = {};\n\n        if (isVictory) {\n          logBattleAction(`æˆ˜æ–—èƒœåˆ©ï¼ä½ å‡»è´¥äº†æ‰€æœ‰æ•Œäººï¼`);\n\n          const allEnemyNames = battleState.initialEnemies.map(enemy =&gt; enemy.name).join('ã€');\n\n          const defeatedEnemies = battleState.initialEnemies;\n          // ç»éªŒå€¼ç³»ç»Ÿå·²ç¦ç”¨\n          // const expResult = calculateTeamExperience(battleState.player, battleState.teammates, defeatedEnemies);\n          let victoryHtml = `\n                      &lt;h3 class=\"victory\"&gt;æˆ˜æ–—èƒœåˆ©ï¼&lt;/h3&gt;\n                      &lt;p&gt;ä½ å‡»è´¥äº†æ‰€æœ‰æ•Œäººï¼&lt;/p&gt;\n                      &lt;p&gt;å‰©ä½™HP: ${battleState.player.hp}/${battleState.player.maxHp}&lt;/p&gt;\n                      &lt;p&gt;å‰©ä½™MP: ${battleState.player.mp}/${battleState.player.maxMp}&lt;/p&gt;\n                      &lt;p&gt;ä¼¤å®³æœ€é«˜æ­¦å™¨: ${battleState.highestDamageWeapon.name || 'æ— '}&lt;/p&gt;\n          `;\n\n          // ç»éªŒå€¼ç³»ç»Ÿå·²ç¦ç”¨\n          // victoryHtml += `\n          //             &lt;div style=\"margin-top: 15px; padding: 10px; background: rgba(6, 182, 212, 0.1); border-radius: 8px; border: 1px solid var(--accent-color);\"&gt;\n          //                 &lt;h4 style=\"color: var(--accent-color); margin: 0 0 10px 0;\"&gt;ğŸ“ˆ ç»éªŒå€¼è·å¾—&lt;/h4&gt;\n          //                 &lt;p&gt;&lt;strong&gt;${battleState.player.name || 'User'}&lt;/strong&gt; (ç­‰çº§${\n          //   battleState.player.grade || 1\n          // }) è·å¾—ç»éªŒå€¼: &lt;span style=\"color: var(--accent-color); font-weight: bold;\"&gt;${\n          //   expResult.playerExp\n          // } EXP&lt;/span&gt;&lt;/p&gt;\n          // `;\n          // if (expResult.teammateResults &amp;&amp; expResult.teammateResults.length &gt; 0) {\n          //   expResult.teammateResults.forEach(teammate =&gt; {\n          //     victoryHtml += `&lt;p&gt;&lt;strong&gt;${teammate.name}&lt;/strong&gt; (ç­‰çº§${teammate.level}) è·å¾—ç»éªŒå€¼: &lt;span style=\"color: var(--accent-color); font-weight: bold;\"&gt;${teammate.exp} EXP&lt;/span&gt;&lt;/p&gt;`;\n          //   });\n          // }\n          // victoryHtml += `&lt;/div&gt;`;\n          resultSummary.innerHTML = victoryHtml;\n        } else {\n          logBattleAction(`æˆ˜æ–—å¤±è´¥ï¼ä½ è¢«å‡»è´¥äº†ï¼`);\n          resultSummary.innerHTML = `\n                      &lt;h3 class=\"defeat\"&gt;æˆ˜æ–—å¤±è´¥ï¼&lt;/h3&gt;\n                      &lt;p&gt;ä½ è¢«${battleState.lastKilledBy ? ' ' + battleState.lastKilledBy + ' ' : ''}å‡»è´¥äº†ï¼&lt;/p&gt;\n                      &lt;p&gt;HPå˜ä¸º0&lt;/p&gt;\n                  `;\n        }\n\n        const battleStats = collectBattleStatistics();\n\n        resultModal.style.display = 'flex';\n\n        closeResultBtn.removeEventListener('click', closeResultHandler);\n        sendResultBtn.removeEventListener('click', sendResultHandler);\n\n        closeResultBtn.addEventListener('click', function () {\n          resultModal.style.display = 'none';\n          combatInterface.style.display = 'none';\n          document.querySelector('.container').style.display = 'block';\n          battleState.isActive = false;\n\n          extraResultText.value = '';\n          updatePlayerStatus(battleState.player);\n          createBattleButton();\n        });\n\n        sendResultBtn.addEventListener('click', function () {\n\n          const extraText = extraResultText.value.trim();\n\n          let message = '';\n\n          let battleLogText = '';\n          if (battleState.fullCombatLog &amp;&amp; battleState.fullCombatLog.length &gt; 0) {\n            battleLogText = 'ï¼Œæˆ˜æ–—è®°å½•ï¼š' + battleState.fullCombatLog.join(' â†’ ');\n          }\n          if (isVictory) {\n\n            const allEnemyNames = battleState.initialEnemies.map(enemy =&gt; enemy.name).join('ã€');\n\n            let itemUsageStats = '';\n            if (battleStats.itemUsage &amp;&amp; battleStats.itemUsage.length &gt; 0) {\n              itemUsageStats =\n                'ï¼Œä½¿ç”¨ä¸¹è¯: ' + battleStats.itemUsage.map(item =&gt; `${item.name} ${item.count}ä¸ª`).join('ã€');\n            }\n\n            let playerStatus = `æç™½è¡€é‡${battleState.player.hp}/${battleState.player.maxHp}ï¼ŒMPå€¼${battleState.player.mp}/${battleState.player.maxMp}`;\n\n            let teammatesStatus = '';\n            if (battleState.teammates &amp;&amp; battleState.teammates.length &gt; 0) {\n              teammatesStatus =\n                'ï¼Œé˜Ÿå‹çŠ¶æ€: ' +\n                battleState.teammates\n                  .map(\n                    teammate =&gt;\n                      `${teammate.name}è¡€é‡${teammate.hp}/${teammate.maxHp}ï¼ŒMPå€¼${teammate.mp}/${teammate.maxMp}`,\n                  )\n                  .join('ï¼›');\n            }\n\n            let expInfo = '';\n            const defeatedEnemies = battleState.initialEnemies;\n            // ç»éªŒå€¼ç³»ç»Ÿå·²ç¦ç”¨\n            // const expResult = calculateTeamExperience(battleState.player, battleState.teammates, defeatedEnemies);\n            // expInfo = `ï¼Œæç™½è·å¾—${expResult.playerExp}ç»éªŒå€¼`;\n            // if (expResult.teammateResults &amp;&amp; expResult.teammateResults.length &gt; 0) {\n            //   const teammateExpInfo = expResult.teammateResults\n            //     .map(teammate =&gt; `${teammate.name}è·å¾—${teammate.exp}ç»éªŒå€¼`)\n            //     .join('ï¼Œ');\n            //   expInfo += `ï¼Œ${teammateExpInfo}`;\n            // }\n            message = `&lt;request:æç™½èµ¢å¾—äº†æˆ˜æ–—ï¼Œ${playerStatus}${teammatesStatus}ï¼Œä¼¤å®³æœ€é«˜æ­¦å™¨ä¸º${\n              battleState.highestDamageWeapon.name || 'æ— '\n            }ï¼Œå‡»è´¥äº†${allEnemyNames}${itemUsageStats}${expInfo}${extraText ? 'ï¼Œ' + extraText : ''}${battleLogText}&gt;`;\n          } else {\n\n            let itemUsageStats = '';\n            if (battleStats.itemUsage &amp;&amp; battleStats.itemUsage.length &gt; 0) {\n              itemUsageStats =\n                'ï¼Œä½¿ç”¨ä¸¹è¯: ' + battleStats.itemUsage.map(item =&gt; `${item.name} ${item.count}ä¸ª`).join('ã€');\n            }\n\n            let defeatedEnemies = '';\n            if (battleStats.killedEnemies &amp;&amp; battleStats.killedEnemies.length &gt; 0) {\n              defeatedEnemies = `ï¼Œå‡»è´¥äº†${battleStats.killedEnemies.join('ã€')}`;\n            }\n\n            let teammatesStatus = '';\n            if (battleState.teammates &amp;&amp; battleState.teammates.length &gt; 0) {\n              teammatesStatus =\n                'ï¼Œé˜Ÿå‹çŠ¶æ€: ' +\n                battleState.teammates\n                  .map(\n                    teammate =&gt;\n                      `${teammate.name}è¡€é‡${teammate.hp}/${teammate.maxHp}ï¼ŒMPå€¼${teammate.mp}/${teammate.maxMp}`,\n                  )\n                  .join('ï¼›');\n            }\n            message = `&lt;request:æç™½è¢«å‡»è´¥äº†ï¼Œæç™½è¡€é‡å˜ä¸º0/${battleState.player.maxHp}ï¼ŒMPå€¼${\n              battleState.player.mp\n            }/${battleState.player.maxMp}${teammatesStatus}${\n              battleState.lastKilledBy ? 'ï¼Œè¢«' + battleState.lastKilledBy + 'å‡»è´¥' : ''\n            }${defeatedEnemies}${itemUsageStats}${extraText ? 'ï¼Œ' + extraText : ''}${battleLogText}&gt;`;\n          }\n\n          sendBattleResult(message)\n            .then(success =&gt; {\n              if (success) {\n                logBattleAction('å·²å‘é€æˆ˜æ–—ç»“æœï¼');\n              } else {\n                logBattleAction('å‘é€å¤±è´¥ï¼Œç»“æœå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');\n              }\n            })\n            .catch(e =&gt; {\n              console.error('å‘é€æˆ˜æ–—ç»“æœå¤±è´¥:', e);\n              logBattleAction('å‘é€å¤±è´¥ï¼');\n            });\n\n          resultModal.style.display = 'none';\n          combatInterface.style.display = 'none';\n          document.querySelector('.container').style.display = 'block';\n          battleState.isActive = false;\n\n          extraResultText.value = '';\n          updatePlayerStatus(battleState.player);\n          createBattleButton();\n        });\n      }\n\n      function logBattleAction(message) {\n\n        let logEntry;\n        if (memoryManager.logEntryPool.length &gt; 0) {\n          logEntry = memoryManager.logEntryPool.pop();\n          logEntry.textContent = message;\n        } else {\n          logEntry = document.createElement('div');\n          logEntry.className = 'log-entry';\n          logEntry.textContent = message;\n        }\n\n        combatLog.appendChild(logEntry);\n        combatLog.scrollTop = combatLog.scrollHeight;\n\n        const COMBAT_LOG_MAX_LINES = 10;\n        while (combatLog.children.length &gt; COMBAT_LOG_MAX_LINES) {\n          const removedEntry = combatLog.removeChild(combatLog.firstChild);\n\n          if (memoryManager.logEntryPool.length &lt; 20) {\n            removedEntry.textContent = '';\n            memoryManager.logEntryPool.push(removedEntry);\n          }\n        }\n\n        if (battleState &amp;&amp; battleState.fullCombatLog) {\n          battleState.fullCombatLog.push(message);\n\n          if (battleState.fullCombatLog.length &gt; 200) {\n            battleState.fullCombatLog = battleState.fullCombatLog.slice(-100); \n          }\n        }\n      }\n\n      function showDamageNumber(target, amount, isCrit = false, enemyId = null, teammateId = null) {\n        const damageElement = memoryManager.getDamageNumber();\n        damageElement.className = `damage-number ${isCrit ? 'critical' : ''}`;\n        damageElement.textContent = amount;\n        let targetElement;\n        if (target === 'player') {\n          targetElement = document.querySelector('.combat-entity.player');\n        } else if (target === 'enemy') {\n          targetElement = document.querySelector(\n            `.combat-entity.enemy[data-enemy-id=\"${enemyId || battleState.selectedEnemies[0]}\"]`,\n          );\n        } else if (target === 'teammate') {\n          targetElement = document.querySelector(`.combat-entity.teammate[data-teammate-id=\"${teammateId}\"]`);\n        }\n        if (targetElement) {\n          targetElement.appendChild(damageElement);\n          memoryManager.activeDamageNumbers.add(damageElement);\n\n          const randomX = Math.floor(Math.random() * 30) - 15;\n          const randomY = Math.floor(Math.random() * 15) - 5;\n          damageElement.style.position = 'absolute';\n          damageElement.style.top = `${50 + randomY}%`;\n          damageElement.style.left = `${50 + randomX}%`;\n\n          memoryManager.safeSetTimeout(() =&gt; {\n            if (damageElement.parentNode) {\n              damageElement.parentNode.removeChild(damageElement);\n            }\n            memoryManager.recycleDamageNumber(damageElement);\n          }, 1200);\n        }\n      }\n\n      function createDeathEffect(targetElement) {\n        if (!targetElement) return;\n\n        const flash = document.createElement('div');\n        flash.className = 'death-flash';\n        targetElement.appendChild(flash);\n\n        const particleCount = Math.min(10, 50 - memoryManager.activeParticles.size);\n        for (let i = 0; i &lt; particleCount; i++) {\n          const particle = memoryManager.getParticle();\n\n          const randomX = Math.random() * 100;\n          const randomY = Math.random() * 100;\n          particle.style.left = `${randomX}%`;\n          particle.style.top = `${randomY}%`;\n\n          const size = Math.random() * 8 + 4;\n          particle.style.width = `${size}px`;\n          particle.style.height = `${size}px`;\n\n          const delay = Math.random() * 0.5;\n          particle.style.animationDelay = `${delay}s`;\n          targetElement.appendChild(particle);\n          memoryManager.activeParticles.add(particle);\n\n          memoryManager.safeSetTimeout(() =&gt; {\n            if (particle.parentNode) {\n              particle.parentNode.removeChild(particle);\n            }\n            memoryManager.recycleParticle(particle);\n          }, 2000 + delay * 1000);\n        }\n      }\n\n      function addHpChangeAnimation(targetType, targetId = null) {\n        let hpBar;\n        if (targetType === 'player') {\n          hpBar = document.querySelector('.combat-entity.player .hp-fill-combat');\n        } else if (targetType === 'enemy') {\n          hpBar = document.querySelector(`.combat-entity.enemy[data-enemy-id=\"${targetId}\"] .hp-fill-combat`);\n        } else if (targetType === 'teammate') {\n          hpBar = document.querySelector(`.combat-entity.teammate[data-teammate-id=\"${targetId}\"] .hp-fill-combat`);\n        }\n        if (hpBar) {\n          hpBar.classList.add('hp-change-animation');\n          setTimeout(() =&gt; {\n            hpBar.classList.remove('hp-change-animation');\n          }, 800);\n        }\n      }\nconst BuffManager = {\n\n  addBuff(target, buffData, isPlayer = false) {\n    if (isPlayer) {\n      battleState.playerBuffs.push(buffData);\n    } else {\n      target.buffs = target.buffs || [];\n      target.buffs.push(buffData);\n    }\n  },\n\n  handleAttributeBoost(params, buffType, attributeName, isPlayer, target = null) {\n    const duration = parseInt(params[0]);\n    const value = parseInt(params[1]);\n    const buffData = {\n      name: `${attributeName}æå‡`,\n      type: buffType,\n      value: value,\n      duration: duration,\n      isPositive: true,\n    };\n    this.addBuff(target || battleState.player, buffData, isPlayer);\n    const targetName = isPlayer ? battleState.player.name || 'User' : target ? target.name : 'ç›®æ ‡';\n    logBattleAction(`${targetName} ${attributeName}æå‡æ•ˆæœè§¦å‘ï¼${attributeName}+${value} æŒç»­ ${duration} å›åˆï¼`);\n  },\n\n  handleLifeSteal(params, damage, target, isPlayer = false) {\n    const percent = parseInt(params[0]);\n    const healAmount = Math.floor(damage * (percent / 100));\n    if (healAmount &gt; 0) {\n      const oldHp = target.hp;\n      target.hp = Math.min(target.hp + healAmount, target.maxHp);\n      const actualHeal = target.hp - oldHp;\n      const targetName = isPlayer ? battleState.player.name || 'User' : target.name;\n      logBattleAction(`${targetName} ç”Ÿå‘½çªƒå–è§¦å‘ï¼æ¢å¤ ${actualHeal} ç‚¹ç”Ÿå‘½å€¼ï¼`);\n      if (isPlayer) {\n        showHealNumber(actualHeal);\n      }\n    }\n  },\n\n  handleManaRestore(params, target, isPlayer = false) {\n    const mp = parseInt(params[0]);\n    const oldMp = target.mp;\n    target.mp = Math.min(target.mp + mp, target.maxMp);\n    const actualRestore = target.mp - oldMp;\n    const targetName = isPlayer ? battleState.player.name || 'User' : target.name;\n    logBattleAction(`${targetName} çµåŠ›æ¢å¤è§¦å‘ï¼æ¢å¤ ${actualRestore} ç‚¹çµåŠ›å€¼ï¼`);\n  },\n\n  handleHealOverTime(params, target, isPlayer = false) {\n    const duration = parseInt(params[0]);\n    const heal = parseInt(params[1]);\n    const buffData = {\n      name: 'æŒç»­æ¢å¤',\n      type: 'healOverTime',\n      value: heal,\n      duration: duration,\n      isPositive: true,\n    };\n    this.addBuff(target, buffData, isPlayer);\n    const targetName = isPlayer ? battleState.player.name || 'User' : target.name;\n    logBattleAction(`${targetName} æŒç»­æ¢å¤æ•ˆæœè§¦å‘ï¼å°†åœ¨ ${duration} å›åˆå†…æ¯å›åˆæ¢å¤ ${heal} ç‚¹ç”Ÿå‘½å€¼ï¼`);\n  },\n\n  handleCritBoost(params, target, isPlayer = false) {\n    const duration = parseInt(params[0]);\n    const value = parseInt(params[1].replace('%', ''));\n    const buffData = {\n      name: 'æš´å‡»æå‡',\n      type: 'critBoost',\n      value: value,\n      duration: duration,\n      isPositive: true,\n    };\n    this.addBuff(target, buffData, isPlayer);\n    const targetName = isPlayer ? battleState.player.name || 'User' : target.name;\n    logBattleAction(`${targetName} æš´å‡»æå‡æ•ˆæœè§¦å‘ï¼æš´å‡»ç‡æå‡ ${value}% æŒç»­ ${duration} å›åˆï¼`);\n  },\n};\n\nconst EventManager = {\n\n  listeners: new Map(),\n\n  removeListener(element, event, handler) {\n    if (element &amp;&amp; handler) {\n      element.removeEventListener(event, handler);\n    }\n  },\n\n  addListener(element, event, handler, key = null) {\n    if (!element) return;\n\n    if (key &amp;&amp; this.listeners.has(key)) {\n      const oldHandler = this.listeners.get(key);\n      this.removeListener(element, event, oldHandler);\n    }\n    element.addEventListener(event, handler);\n\n    if (key) {\n      this.listeners.set(key, handler);\n    }\n  },\n\n  clearAll() {\n    this.listeners.clear();\n  },\n\n  bindWeaponButtons(weapons, isTeammate = false) {\n    const selector = isTeammate ? '.teammate-weapon:not(.used)' : '.weapon-button:not(.used)';\n    document.querySelectorAll(selector).forEach(button =&gt; {\n      const weaponIndex = parseInt(button.getAttribute('data-weapon-index'));\n      const weapon = weapons[weaponIndex];\n      if (!weapon) return;\n      this.addListener(button, 'click', () =&gt; {\n        this.handleWeaponSelection(weapon, weaponIndex, isTeammate);\n      });\n    });\n  },\n\n  handleWeaponSelection(weapon, weaponIndex, isTeammate = false) {\n\n    document.querySelectorAll('.weapon-button, .item-button').forEach(btn =&gt; {\n      btn.classList.remove('selected');\n    });\n    document.querySelectorAll('.combat-entity').forEach(entity =&gt; {\n      entity.classList.remove('selected');\n    });\n\n    battleState.currentWeapon = weapon;\n    battleState.currentItem = null;\n    battleState.selectedEnemies = [];\n    battleState.selectedHealTargets = [];\n    battleState.healTarget = null;\n    battleState.maxAttackCount = weapon.attacksPerTurn;\n    battleState.currentAttackCount = 0;\n\n    const weaponTemplate = weapon.codes?.find(code =&gt; code.startsWith('WN:A'))?.match(/WN:(A[1-4])/)?.[1];\n    battleState.selfTargetMode =\n      weaponTemplate === 'A2' || weaponTemplate === 'A3' || weaponTemplate === 'A4' || weapon.isHealing;\n\n    updatePlayerPanel();\n    document.querySelector(`[data-weapon-index=\"${weaponIndex}\"]`).classList.add('selected');\n    updateAttackButton();\n  },\n\n  bindItemButtons(items) {\n    document.querySelectorAll('.item-button:not(.used)').forEach(button =&gt; {\n      const itemIndex = parseInt(button.getAttribute('data-item-index'));\n      const item = items[itemIndex];\n      if (!item) return;\n      this.addListener(button, 'click', () =&gt; {\n        this.handleItemSelection(item, itemIndex);\n      });\n    });\n  },\n\n  handleItemSelection(item, itemIndex) {\n\n    document.querySelectorAll('.weapon-button, .item-button').forEach(btn =&gt; {\n      btn.classList.remove('selected');\n    });\n    document.querySelectorAll('.combat-entity').forEach(entity =&gt; {\n      entity.classList.remove('selected');\n    });\n\n    battleState.currentWeapon = null;\n    battleState.currentItem = item;\n    battleState.selectedEnemies = [];\n\n    const currentAction = battleState.actionOrder[battleState.currentActionIndex];\n    if (currentAction &amp;&amp; currentAction.type === 'teammate') {\n\n      battleState.selfTargetMode = false;\n      battleState.healTarget = currentAction.id;\n      const teammateElement = document.querySelector(`.combat-entity.teammate[data-teammate-id=\"${currentAction.id}\"]`);\n      if (teammateElement) {\n        teammateElement.classList.add('selected');\n      }\n    } else {\n\n      battleState.selfTargetMode = true;\n      battleState.healTarget = 'player';\n      document.querySelector('.combat-entity.player').classList.add('selected');\n    }\n\n    updatePlayerPanel();\n    document.querySelector(`[data-item-index=\"${itemIndex}\"]`).classList.add('selected');\n\n    const attackBtn = document.getElementById('attack-btn');\n    if (attackBtn) {\n      attackBtn.disabled = false;\n      attackBtn.innerHTML = \"&lt;i class='fas fa-pills'&gt;&lt;/i&gt; ä½¿ç”¨ä¸¹è¯\";\n    }\n  },\n};\n\nconst StateValidator = {\n\n  isDead(entity) {\n    return entity &amp;&amp; entity.hp &lt;= 0;\n  },\n\n  isPlayerDead() {\n    return this.isDead(battleState.player);\n  },\n\n  areAllEnemiesDead() {\n    return battleState.enemies.length === 0;\n  },\n\n  isBattleOver() {\n    return this.isPlayerDead() || this.areAllEnemiesDead();\n  },\n\n  isVictory() {\n    return !this.isPlayerDead() &amp;&amp; this.areAllEnemiesDead();\n  },\n\n  isDefeat() {\n    return this.isPlayerDead();\n  },\n\n  shouldEndAttack(currentCount, maxCount, hasTargets = true) {\n    return currentCount &gt;= maxCount || !hasTargets || this.areAllEnemiesDead();\n  },\n\n  isValidTarget(target) {\n    return target &amp;&amp; target.hp &gt; 0;\n  },\n\n  processDeadEnemies() {\n    const deadEnemies = battleState.enemies.filter(enemy =&gt; this.isDead(enemy));\n    if (deadEnemies.length &gt; 0) {\n\n      deadEnemies.forEach(enemy =&gt; {\n        logBattleAction(`${enemy.name} è¢«å‡»è´¥äº†ï¼`);\n        const enemyElement = document.querySelector(`.combat-entity.enemy[data-enemy-id=\"${enemy.id}\"]`);\n        createDeathEffect(enemyElement);\n\n        if (typeof hateSystem !== 'undefined') {\n          hateSystem.clearEnemyHate(enemy.id);\n        }\n      });\n\n      battleState.enemies = battleState.enemies.filter(enemy =&gt; !this.isDead(enemy));\n\n      if (this.areAllEnemiesDead()) {\n        endBattle(true);\n        return true; \n      }\n    }\n    return false; \n  },\n\n  checkEnemyDeath(enemy) {\n    if (this.isDead(enemy)) {\n      logBattleAction(`${enemy.name} è¢«å‡»è´¥äº†ï¼`);\n      const enemyElement = document.querySelector(`.combat-entity.enemy[data-enemy-id=\"${enemy.id}\"]`);\n      createDeathEffect(enemyElement);\n\n      battleState.enemies = battleState.enemies.filter(e =&gt; e.id !== enemy.id);\n\n      if (typeof hateSystem !== 'undefined') {\n        hateSystem.clearEnemyHate(enemy.id);\n      }\n\n      if (this.areAllEnemiesDead()) {\n        endBattle(true);\n        return true; \n      }\n    }\n    return false; \n  },\n};\n\nwindow.TooltipGenerator = {\n\n  generateWeaponEffectTooltip(effectKey, parts) {\n    if (weaponSpecialEffects[effectKey]) {\n      switch (effectKey) {\n        case 'A1':\n        case 'A2':\n        case 'A3':\n        case 'A4':\n          return weaponSpecialEffects[effectKey]();\n        default:\n          return weaponSpecialEffects[effectKey] || effectKey;\n      }\n    }\n    return '';\n  },\n\n  generateEnchantmentTooltip(effectKey, parts) {\n    if (!enchantmentEffects[effectKey]) return '';\n    switch (effectKey) {\n      case 'B1':\n      case 'B4':\n      case 'B9':\n      case 'B15':\n      case 'B16':\n      case 'B17':\n        return parts.length &gt;= 2 ? enchantmentEffects[effectKey](parts[1]) : '';\n      case 'B2':\n      case 'B3':\n      case 'B5':\n      case 'B6':\n      case 'B7':\n      case 'B8':\n      case 'B10':\n      case 'B11':\n      case 'B12':\n      case 'B13':\n      case 'B14':\n      case 'B18':\n      case 'B19':\n      case 'B22':\n        return parts.length &gt;= 3 ? enchantmentEffects[effectKey](parts[1], parts[2]) : '';\n      case 'B20':\n      case 'B21':\n        return parts.length &gt;= 2 ? enchantmentEffects[effectKey](parts[1]) : '';\n      default:\n        return enchantmentEffects[effectKey] || effectKey;\n    }\n  },\n\n  generateEffectCodeHtml(codes) {\n    let effectsHtml = '';\n    codes.forEach(code =&gt; {\n      const [codeType, codeValue] = code.split(':');\n      const parts = codeValue.split(',');\n      const effectKey = parts[0];\n      let tooltipText = '';\n      if (codeType === 'WN') {\n        tooltipText = this.generateWeaponEffectTooltip(effectKey, parts);\n      } else if (codeType === 'EN') {\n        tooltipText = this.generateEnchantmentTooltip(effectKey, parts);\n      }\n      if (tooltipText) {\n        effectsHtml += `&lt;div class=\"weapon-effect-code status-effect\"&gt;${effectKey}\n                            &lt;span class=\"effect-tooltip\"&gt;${tooltipText}&lt;/span&gt;\n                        &lt;/div&gt;`;\n      }\n    });\n    return effectsHtml;\n  },\n\n  generateAttributeTooltip(attribute) {\n    const tooltips = {\n      str: 'ç‰©ç†ä¼¤å®³+ç”Ÿå‘½æ¢å¤',\n      agi: 'é€Ÿåº¦+é—ªé¿+æš´å‡»',\n      int: 'æš´å‡»+çµåŠ›æ¢å¤',\n      vit: 'è¡ŒåŠ¨ç‚¹+ç”Ÿå‘½æ¢å¤',\n    };\n    return tooltips[attribute] || '';\n  },\n};\n\nfunction showHealNumber(amount) {\n  const healElement = memoryManager.getHealNumber();\n  healElement.className = 'heal-number';\n  healElement.textContent = `+${amount}`;\n  const targetElement = document.querySelector('.combat-entity.player');\n  if (targetElement) {\n    targetElement.appendChild(healElement);\n    memoryManager.activeHealNumbers.add(healElement);\n\n    const randomX = Math.floor(Math.random() * 30) - 15;\n    healElement.style.position = 'absolute';\n    healElement.style.top = '40%';\n    healElement.style.left = `${50 + randomX}%`;\n\n    memoryManager.safeSetTimeout(() =&gt; {\n      if (healElement.parentNode) {\n        healElement.parentNode.removeChild(healElement);\n      }\n      memoryManager.recycleHealNumber(healElement);\n    }, 1200);\n  }\n}\n\nfunction showHealNumberOnEnemy(amount, enemyId) {\n  const healElement = memoryManager.getHealNumber();\n  healElement.className = 'heal-number';\n  healElement.textContent = `+${amount}`;\n  const targetElement = document.querySelector(`.combat-entity.enemy[data-enemy-id=\"${enemyId}\"]`);\n  if (targetElement) {\n    targetElement.appendChild(healElement);\n    memoryManager.activeHealNumbers.add(healElement);\n\n    const randomX = Math.floor(Math.random() * 30) - 15;\n    healElement.style.position = 'absolute';\n    healElement.style.top = '40%';\n    healElement.style.left = `${50 + randomX}%`;\n\n    memoryManager.safeSetTimeout(() =&gt; {\n      if (healElement.parentNode) {\n        healElement.parentNode.removeChild(healElement);\n      }\n      memoryManager.recycleHealNumber(healElement);\n    }, 1200);\n  }\n}\n\nfunction applyDamageWithShield(target, damage, targetName) {\n  let remainingDamage = damage;\n  let shieldDamage = 0;\n  let tempShieldDamage = 0;\n  let hpDamage = 0;\n\n  if (target.tempShield &amp;&amp; target.tempShield &gt; 0) {\n    tempShieldDamage = Math.min(target.tempShield, remainingDamage);\n    target.tempShield -= tempShieldDamage;\n    remainingDamage -= tempShieldDamage;\n\n    if (tempShieldDamage &gt; 0) {\n      logBattleAction(`${targetName}çš„ä¸´æ—¶æŠ¤ç›¾æŠµæŒ¡äº† ${tempShieldDamage} ç‚¹ä¼¤å®³ï¼å‰©ä½™ä¸´æ—¶æŠ¤ç›¾: ${target.tempShield}`);\n    }\n  }\n\n  if (remainingDamage &gt; 0 &amp;&amp; target.shield &amp;&amp; target.shield &gt; 0) {\n    shieldDamage = Math.min(target.shield, remainingDamage);\n    target.shield -= shieldDamage;\n    remainingDamage -= shieldDamage;\n\n    if (shieldDamage &gt; 0) {\n      logBattleAction(`${targetName}çš„æŠ¤ç›¾æŠµæŒ¡äº† ${shieldDamage} ç‚¹ä¼¤å®³ï¼å‰©ä½™æŠ¤ç›¾: ${target.shield}`);\n    }\n  }\n\n  if (remainingDamage &gt; 0) {\n    hpDamage = remainingDamage;\n    target.hp = Math.max(0, target.hp - hpDamage);\n    logBattleAction(`${targetName}å—åˆ° ${hpDamage} ç‚¹ä¼¤å®³ï¼å½“å‰HP: ${target.hp}/${target.maxHp}`);\n  }\n\n  return {\n    totalDamage: damage,\n    tempShieldDamage: tempShieldDamage,\n    shieldDamage: shieldDamage,\n    hpDamage: hpDamage,\n    blocked: damage - hpDamage\n  };\n}\n\nfunction applyHealingEffect(item, userEntity, isPlayer) {\n  const oldHp = userEntity.hp;\n  userEntity.hp = Math.min(userEntity.hp + item.value, userEntity.maxHp);\n  const actualHeal = userEntity.hp - oldHp;\n  logBattleAction(`${isPlayer ? '' : userEntity.name + ' '}æ¢å¤äº† ${actualHeal} ç‚¹ç”Ÿå‘½å€¼ï¼`);\n  if (isPlayer) {\n    showHealNumber(actualHeal);\n\n    addHpChangeAnimation('player');\n\n    const playerEntity = document.querySelector('.combat-entity.player');\n    if (playerEntity) {\n      playerEntity.classList.add('heal-pulse-animation');\n      memoryManager.safeSetTimeout(() =&gt; playerEntity.classList.remove('heal-pulse-animation'), 800);\n    }\n  } else {\n\n    const healElement = memoryManager.getHealNumber();\n    healElement.className = 'heal-number';\n    healElement.textContent = `+${actualHeal}`;\n    const teammateElement = document.querySelector(`.combat-entity.teammate[data-teammate-id=\"${userEntity.id}\"]`);\n    if (teammateElement) {\n      teammateElement.appendChild(healElement);\n      memoryManager.activeHealNumbers.add(healElement);\n      const randomX = Math.floor(Math.random() * 30) - 15;\n      healElement.style.position = 'absolute';\n      healElement.style.top = '40%';\n      healElement.style.left = `${50 + randomX}%`;\n      memoryManager.safeSetTimeout(() =&gt; {\n        if (healElement.parentNode) {\n          healElement.parentNode.removeChild(healElement);\n        }\n        memoryManager.recycleHealNumber(healElement);\n      }, 1200);\n\n      const teammateId = teammateElement.getAttribute('data-teammate-id');\n      if (teammateId) {\n        addHpChangeAnimation('teammate', teammateId);\n      }\n      teammateElement.classList.add('heal-pulse-animation');\n      memoryManager.safeSetTimeout(() =&gt; teammateElement.classList.remove('heal-pulse-animation'), 800);\n    }\n  }\n}\nfunction applyManaRestoreEffect(item, userEntity, isPlayer) {\n  const oldMp = userEntity.mp;\n  userEntity.mp = Math.min(userEntity.mp + item.value, userEntity.maxMp);\n  const actualRestore = userEntity.mp - oldMp;\n  logBattleAction(`${isPlayer ? '' : userEntity.name + ' '}æ¢å¤äº† ${actualRestore} ç‚¹çµåŠ›å€¼ï¼`);\n\n  const selector = isPlayer ? '.combat-entity.player' : `.combat-entity.teammate[data-teammate-id=\"${userEntity.id}\"]`;\n  const entityElement = document.querySelector(selector);\n  if (entityElement) {\n    const mpBar = entityElement.querySelector('.mp-fill-combat');\n    if (mpBar) {\n      mpBar.classList.add('hp-change-animation');\n      setTimeout(() =&gt; mpBar.classList.remove('hp-change-animation'), 800);\n    }\n  }\n}\nfunction applyAttributeBoost(item, userEntity, boostType, itemName, isPlayer) {\n  const buffTarget = isPlayer ? battleState.playerBuffs : (userEntity.buffs = userEntity.buffs || []);\n  buffTarget.push({\n    name: itemName,\n    type: boostType,\n    value: item.value,\n    duration: item.duration,\n    isPositive: true,\n  });\n  const attributeName = boostType\n    .replace('Boost', '')\n    .replace('str', 'åŠ›é‡')\n    .replace('agi', 'æ•æ·')\n    .replace('int', 'æ™ºåŠ›')\n    .replace('end', 'è€åŠ›');\n  logBattleAction(\n    `${isPlayer ? '' : userEntity.name + ' '}${attributeName}å¢åŠ  ${item.value} ç‚¹ï¼ŒæŒç»­ ${item.duration} å›åˆï¼`,\n  );\n}\n\nfunction useItem(item, user = null) {\n  const isPlayer = !user;\n  const userName = isPlayer ? battleState.player.name || 'User' : user.name;\n  const userEntity = isPlayer ? battleState.player : user;\n  logBattleAction(`${userName} ä½¿ç”¨äº† ${item.name}`);\n\n  switch (item.type) {\n    case 1: \n      applyHealingEffect(item, userEntity, isPlayer);\n      break;\n    case 2: \n      applyManaRestoreEffect(item, userEntity, isPlayer);\n      break;\n    case 3: \n      applyAttributeBoost(item, userEntity, 'strBoost', 'æ ¹éª¨ä¸¹', isPlayer);\n      break;\n    case 4: \n      applyAttributeBoost(item, userEntity, 'agiBoost', 'èº«æ³•ä¸¹', isPlayer);\n      break;\n    case 5: \n      applyAttributeBoost(item, userEntity, 'intBoost', 'ç¥è¯†ä¸¹', isPlayer);\n      break;\n    case 6: \n      if (!isPlayer) {\n        logBattleAction(`${userName} æ— æ³•ä½¿ç”¨æ·¬ä½“å¢ç›Šä¸¹è¯ï¼`);\n        return; \n      }\n      applyAttributeBoost(item, userEntity, 'endBoost', 'æ·¬ä½“ä¸¹', isPlayer);\n      break;\n    default:\n      logBattleAction(`${userName} ä½¿ç”¨äº†æœªçŸ¥æ•ˆæœçš„ä¸¹è¯ï¼š${item.type}`);\n  }\n\n  if (!battleState.itemUsageStats) {\n    battleState.itemUsageStats = {};\n  }\n  if (!battleState.itemUsageStats[item.name]) {\n    battleState.itemUsageStats[item.name] = 0;\n  }\n  battleState.itemUsageStats[item.name]++;\n\n  item.count--;\n\n  if (item.count &lt;= 0) {\n    battleState.player.items = battleState.player.items.filter(i =&gt; i !== item);\n  }\n\n  battleState.currentItemUsed = true;\n\n  battleState.currentItem = null;\n\n  updateBattleUI({ player: true, enemy: false, weapons: true });\n}\n\nfunction setupDetailsAnimation() {\n  const detailsElement = document.getElementById('preparation-details');\n  const content = detailsElement.querySelector('#preparation-screen');\n\n  let contentHeight;\n\n  const calculateHeight = () =&gt; {\n    content.style.maxHeight = 'none';\n    contentHeight = content.offsetHeight + 'px';\n    content.style.maxHeight = detailsElement.open ? contentHeight : '0';\n  };\n\n  calculateHeight();\n  window.addEventListener('resize', calculateHeight);\n\n  detailsElement.addEventListener('toggle', () =&gt; {\n    if (detailsElement.open) {\n\n      content.style.maxHeight = contentHeight;\n    } else {\n\n      content.style.maxHeight = '0';\n    }\n  });\n}\n\nfunction setupLazyRendering() {\n  const preparationDetails = document.getElementById('preparation-details');\n  if (!preparationDetails || lazyRenderManager.isPreparationRendered) return;\n\n  preparationDetails.addEventListener('toggle', function () {\n    if (this.open &amp;&amp; !lazyRenderManager.isPreparationRendered &amp;&amp; battleData) {\n\n      lazyRenderManager.safeUpdateInterface(() =&gt; {\n        initializeInterface(battleData);\n        lazyRenderManager.isPreparationRendered = true;\n      }, 'preparation');\n    }\n  });\n\n  if (preparationDetails.hasAttribute('open')) {\n    lazyRenderManager.isPreparationRendered = true;\n  }\n}\n\nfunction setupDataUpdateListener() {\n  let lastDataContent = statusDataSource.textContent;\n  let isRendered = false;\n\n  const observer = new MutationObserver(function (mutations) {\n    const currentData = statusDataSource.textContent;\n    if (currentData !== lastDataContent) {\n      lastDataContent = currentData;\n\n      if (currentData) {\n        battleData = parseStatusData(currentData);\n\n        const preparationDetails = document.getElementById('preparation-details');\n        if (preparationDetails &amp;&amp; preparationDetails.open) {\n\n          initializeInterface(battleData);\n        } else {\n\n        }\n      }\n    }\n  });\n\n  observer.observe(statusDataSource, {\n    childList: true,\n    subtree: true,\n    characterData: true,\n  });\n}\n\ndocument.addEventListener('DOMContentLoaded', function () {\n  const initialData = statusDataSource.textContent;\n  if (initialData) {\n    battleData = parseStatusData(initialData);\n\n    const preparationDetails = document.getElementById('preparation-details');\n    const shouldExpand = battleData.enemies &amp;&amp; battleData.enemies.length &gt; 0;\n    if (preparationDetails &amp;&amp; shouldExpand) {\n      preparationDetails.setAttribute('open', '');\n\n      initializeInterface(battleData);\n    } else {\n      preparationDetails.removeAttribute('open');\n\n    }\n\n    setupDetailsAnimation();\n    setupLazyRendering();\n\n    setupDataUpdateListener();\n  }\n});\n\nfunction updateActionOrderDisplay() {\n\n  if (!lazyRenderManager.shouldRenderCombat()) {\n    return;\n  }\n  const actionOrderDisplay = document.getElementById('action-order-display');\n  if (!actionOrderDisplay) return;\n\n  actionOrderDisplay.innerHTML = '';\n\n  if (battleState.currentActionIndex &gt;= battleState.actionOrder.length) {\n    battleState.currentActionIndex = 0;\n  }\n\n  battleState.actionOrder.forEach((action, index) =&gt; {\n    const isCurrentAction = index === battleState.currentActionIndex;\n    const actionItem = document.createElement('div');\n    actionItem.className = `action-order-item ${action.type} ${isCurrentAction ? 'current' : ''}`;\n    actionItem.setAttribute('data-action-index', index);\n\n    const nameElement = document.createElement('div');\n    nameElement.className = 'action-order-name';\n    nameElement.textContent = action.name;\n    actionItem.appendChild(nameElement);\n\n    const speedElement = document.createElement('div');\n    speedElement.className = 'action-order-speed';\n\n    speedElement.textContent = `é€Ÿåº¦: ${action.speed || action.entity.speed}`;\n    actionItem.appendChild(speedElement);\n\n    const numberElement = document.createElement('div');\n    numberElement.className = 'action-order-number';\n    numberElement.textContent = `#${action.actionNumber || index + 1}`;\n    actionItem.appendChild(numberElement);\n\n    actionOrderDisplay.appendChild(actionItem);\n\n    if (index &lt; battleState.actionOrder.length - 1) {\n      const arrowElement = document.createElement('div');\n      arrowElement.className = 'action-order-arrow';\n      arrowElement.innerHTML = '&lt;i class=\"fas fa-chevron-right\"&gt;&lt;/i&gt;';\n      actionOrderDisplay.appendChild(arrowElement);\n    }\n  });\n\n  if (battleState.actionOrder.length &gt; 0) {\n    const currentItem = actionOrderDisplay.querySelector('.action-order-item.current');\n    if (currentItem) {\n      actionOrderDisplay.scrollLeft =\n        currentItem.offsetLeft - actionOrderDisplay.clientWidth / 2 + currentItem.clientWidth / 2;\n\n      setupSkipButton();\n    }\n  }\n}\n\nfunction updateHateDisplay() {\n\n  if (!lazyRenderManager.shouldRenderCombat()) {\n    return;\n  }\n\n  updateEnemyPanel();\n}\n\nfunction enablePlayerControls() {\n\n  updateWeaponsList();\n\n  const attackBtn = document.getElementById('attack-btn');\n  if (attackBtn) {\n    attackBtn.disabled = true;\n    attackBtn.innerHTML = \"&lt;i class='fas fa-magic'&gt;&lt;/i&gt; æ–½å±•ç¥é€š\";\n  }\n\n  setupSkipButton();\n}\n\nfunction performEnemyAction(enemy) {\n\n  disablePlayerControls();\n\n  setTimeout(() =&gt; {\n\n    if (enemy.pendingFreeze) {\n      logBattleAction(`${enemy.name} è¢«æ™•çœ©ï¼Œæ— æ³•è¡ŒåŠ¨ï¼`);\n      enemy.pendingFreezeCount--;\n      if (enemy.pendingFreezeCount &lt;= 0) {\n        enemy.pendingFreeze = false;\n        enemy.pendingFreezeCount = 0;\n        logBattleAction(`${enemy.name} è§£é™¤äº†æ™•çœ©çŠ¶æ€ï¼`);\n      }\n\n      moveToNextAction();\n      return;\n    }\n\n    let totalBurnDamage = 0;\n    const burnBuffs = enemy.buffs ? enemy.buffs.filter(buff =&gt; buff.type === 'burnOverTime') : [];\n    if (burnBuffs.length &gt; 0) {\n\n      burnBuffs.forEach(burnBuff =&gt; {\n        totalBurnDamage += burnBuff.value;\n      });\n      if (totalBurnDamage &gt; 0) {\n        enemy.hp = Math.max(0, enemy.hp - totalBurnDamage);\n        logBattleAction(`${enemy.name} å—åˆ°ä½™çƒ¬æ•ˆæœï¼ŒæŸå¤± ${totalBurnDamage} ç‚¹ç”Ÿå‘½å€¼ï¼`);\n\n        showDamageNumber('enemy', totalBurnDamage, false, enemy.id);\n\n        const enemyHpBar = document.querySelector(`.combat-entity.enemy[data-enemy-id=\"${enemy.id}\"] .hp-fill-combat`);\n        if (enemyHpBar) {\n\n          const enemyElement = enemyHpBar.closest('.combat-entity.enemy');\n          const enemyId = enemyElement ? enemyElement.getAttribute('data-enemy-id') : null;\n          if (enemyId) {\n            addHpChangeAnimation('enemy', enemyId);\n          }\n        }\n\n        if (StateValidator.isDead(enemy)) {\n          logBattleAction(`${enemy.name} è¢«ä½™çƒ¬æ•ˆæœå‡»è´¥äº†ï¼`);\n\n          const enemyElement = document.querySelector(`.combat-entity.enemy[data-enemy-id=\"${enemy.id}\"]`);\n          createDeathEffect(enemyElement);\n\n          battleState.enemies = battleState.enemies.filter(e =&gt; e.id !== enemy.id);\n\n          updateEnemyPanel();\n\n          if (StateValidator.areAllEnemiesDead()) {\n            endBattle(true);\n            return;\n          }\n\n          moveToNextAction();\n          return;\n        }\n      }\n    }\n\n    const attackName = enemy.attackPattern[enemy.nextAttackIndex];\n    const skill = enemy.skills.find(s =&gt; s.name === attackName);\n    if (skill) {\n      logBattleAction(`${enemy.name} ä½¿ç”¨ ${skill.name} æ”»å‡»ï¼`);\n\n      const enemyElement = document.querySelector(`.combat-entity.enemy[data-enemy-id=\"${enemy.id}\"]`);\n      enemyElement.classList.add('attack-animation-backward');\n\n      setTimeout(() =&gt; {\n\n        const effectiveHitRate = getEffectiveHitRate(skill.hitRate, enemy);\n\n        const maxTargets = skill.targetsPerAttack || 1;\n        const targets = getEnemyTargetsByHate(enemy.id, maxTargets);\n        if (targets.length === 0) {\n          logBattleAction(`${enemy.name} æ‰¾ä¸åˆ°å¯æ”»å‡»çš„ç›®æ ‡ï¼`);\n\n          setTimeout(() =&gt; {\n            enemyElement.classList.remove('attack-animation-backward');\n          }, 500);\n          return;\n        }\n        if (maxTargets &gt; 1) {\n          logBattleAction(\n            `${enemy.name} çš„ ${skill.name} ç„å‡†äº† ${targets.length} ä¸ªç›®æ ‡ï¼š${targets.map(t =&gt; t.name).join(', ')}`,\n          );\n        }\n\n        targets.forEach((target, targetIndex) =&gt; {\n\n          const enemyStats = getEnemyActualStats(enemy);\n          let targetStats;\n          if (target.entity === battleState.player) {\n            targetStats = getPlayerActualStats();\n          } else {\n\n            targetStats = getTeammateActualStats(target.entity);\n          }\n\n          const finalHitRate = calculateFinalHitRate(effectiveHitRate, enemyStats, targetStats);\n          const hitRoll = Math.random();\n\n          if (hitRoll &lt;= Math.min(1.0, finalHitRate)) {\n\n            logBattleAction(`æ”»å‡»å‘½ä¸­ ${target.name}ï¼(æœ€ç»ˆå‘½ä¸­ç‡: ${(finalHitRate * 100).toFixed(1)}%)`);\n\n            const targetElement =\n              target.type === 'player'\n                ? document.querySelector('.combat-entity.player')\n                : document.querySelector(`.combat-entity.teammate[data-teammate-id=\"${target.entity.id}\"]`);\n            if (targetElement) {\n              targetElement.classList.add('shake-animation');\n            }\n\n            const finalCritRate = calculateFinalCritRate(skill.critRate, enemyStats, targetStats, finalHitRate);\n            const critRoll = Math.random();\n\n            const isCrit = critRoll &lt;= Math.min(1.0, finalCritRate);\n\n            const finalCritMultiplier = isCrit\n              ? calculateFinalCritMultiplier(enemyStats, targetStats, finalCritRate)\n              : 1.0;\n\n            let damage = calculateFinalDamage(skill.attack, enemyStats, targetStats, isCrit, finalCritMultiplier);\n\n            if (isCrit) {\n              logBattleAction(\n                `æš´å‡»ï¼é€ æˆ ${damage} ç‚¹ä¼¤å®³ï¼(æš´å‡»ç‡: ${(finalCritRate * 100).toFixed(\n                  1,\n                )}%, æš´å‡»å€ç‡: ${finalCritMultiplier.toFixed(2)}x)`,\n              );\n              if (target.type === 'player') {\n                showDamageNumber('player', damage, true);\n              } else {\n\n                showDamageNumber('teammate', damage, true, null, target.entity.id);\n              }\n            } else {\n              logBattleAction(`é€ æˆ ${damage} ç‚¹ä¼¤å®³ï¼`);\n              if (target.type === 'player') {\n                showDamageNumber('player', damage, false);\n              } else {\n\n                showDamageNumber('teammate', damage, false, null, target.entity.id);\n              }\n            }\n\n            const damageResult = applyDamageWithShield(target.entity, damage, target.type === 'player' ? 'ä½ ' : target.entity.name);\n\n            if (target.type === 'player') {\n              addHpChangeAnimation('player');\n            } else {\n              addHpChangeAnimation('teammate', target.entity.id);\n            }\n\n            setTimeout(() =&gt; {\n              if (targetElement) {\n                targetElement.classList.remove('shake-animation');\n              }\n            }, 800);\n\n            if (StateValidator.isDead(target.entity)) {\n              if (target.type === 'player') {\n\n                battleState.lastKilledBy = skill.name;\n                endBattle(false);\n                return;\n              } else {\n\n                logBattleAction(`${target.name} è¢«å‡»è´¥äº†ï¼`);\n\n                createDeathEffect(targetElement);\n\n                hateSystem.clearTargetHate(target.entity.id);\n\n                battleState.teammates = battleState.teammates.filter(t =&gt; t.id !== target.entity.id);\n\n                cleanupActionOrder('teammate', target.entity.id);\n\n                updatePlayerPanel();\n              }\n            }\n          } else {\n\n            logBattleAction(`æ”»å‡»æœªå‘½ä¸­ ${target.name}ï¼(æœ€ç»ˆå‘½ä¸­ç‡: ${(finalHitRate * 100).toFixed(1)}%)`);\n          }\n        }); \n\n        enemy.nextAttackIndex = (enemy.nextAttackIndex + 1) % enemy.attackPattern.length;\n\n        enemyElement.classList.remove('attack-animation-backward');\n\n        memoryManager.safeSetTimeout(() =&gt; {\n          updatePlayerPanel();\n          updateEnemyPanel();\n          updateHateDisplay(); \n        }, 1500); \n\n        setTimeout(() =&gt; {\n          moveToNextAction();\n        }, 500);\n      }, 500);\n    } else {\n\n      moveToNextAction();\n    }\n  }, 800);\n}\n\nfunction disablePlayerControls() {\n  document.querySelectorAll('.weapon-button, .item-button').forEach(button =&gt; {\n    button.disabled = true;\n  });\n  const attackBtn = document.getElementById('attack-btn');\n  if (attackBtn) {\n    attackBtn.disabled = true;\n  }\n  const nextRoundBtn = document.getElementById('next-round-btn');\n  if (nextRoundBtn) {\n    nextRoundBtn.disabled = true;\n  }\n  const midActionBtn = document.getElementById('mid-action-btn');\n  if (midActionBtn) {\n    midActionBtn.disabled = true;\n  }\n}\n\nfunction setupSkipButton() {\n\n  const skipButton = document.getElementById('next-round-btn');\n  if (!skipButton) return;\n\n  const currentAction = battleState.actionOrder[battleState.currentActionIndex];\n  if (!currentAction) return;\n\n  skipButton.onclick = null;\n\n  if (currentAction.type === 'player' || currentAction.type === 'teammate') {\n\n    skipButton.innerHTML = \"&lt;i class='fas fa-forward'&gt;&lt;/i&gt; è·³è¿‡å½“å‰è¡ŒåŠ¨\";\n    skipButton.className = 'next-round-button';\n    skipButton.disabled = false;\n\n    skipButton.onclick = function () {\n      moveToNextAction();\n    };\n  } else {\n\n    skipButton.innerHTML = \"&lt;i class='fas fa-forward'&gt;&lt;/i&gt; ç­‰å¾…æ•Œäººè¡ŒåŠ¨\";\n    skipButton.disabled = true;\n  }\n\n  setupMidActionButton();\n}\n\nfunction setupMidActionButton() {\n  const midActionButton = document.getElementById('mid-action-btn');\n  if (!midActionButton) return;\n\n  midActionButton.onclick = null;\n\n  midActionButton.onclick = function () {\n    showMidActionResult();\n  };\n}\n\nfunction showMidActionResult() {\n\n  let statusInfo = `&lt;h3 style=\"color: var(--accent-color);\"&gt;æç™½çŠ¶æ€&lt;/h3&gt;`;\n\n  statusInfo += `&lt;p&gt;&lt;strong&gt;æç™½çŠ¶æ€ï¼š&lt;/strong&gt;è¡€é‡${battleState.player.hp}/${battleState.player.maxHp}ï¼ŒMPå€¼${battleState.player.mp}/${battleState.player.maxMp}&lt;/p&gt;`;\n\n  if (battleState.teammates &amp;&amp; battleState.teammates.length &gt; 0) {\n    statusInfo += `&lt;p&gt;&lt;strong&gt;é˜Ÿå‹çŠ¶æ€ï¼š&lt;/strong&gt;&lt;/p&gt;&lt;div style=\"margin-left: 20px;\"&gt;`;\n    battleState.teammates.forEach(teammate =&gt; {\n      statusInfo += `&lt;p&gt;${teammate.name}ï¼šè¡€é‡${teammate.hp}/${teammate.maxHp}ï¼ŒMPå€¼${teammate.mp}/${teammate.maxMp}&lt;/p&gt;`;\n    });\n    statusInfo += `&lt;/div&gt;`;\n  }\n\n  if (battleState.enemies &amp;&amp; battleState.enemies.length &gt; 0) {\n    statusInfo += `&lt;p&gt;&lt;strong&gt;æ•ŒäººçŠ¶æ€ï¼š&lt;/strong&gt;&lt;/p&gt;&lt;div style=\"margin-left: 20px;\"&gt;`;\n    battleState.enemies.forEach(enemy =&gt; {\n      statusInfo += `&lt;p&gt;${enemy.name}ï¼šè¡€é‡${enemy.hp}/${enemy.maxHp}&lt;/p&gt;`;\n    });\n    statusInfo += `&lt;/div&gt;`;\n  }\n\n  resultSummary.innerHTML = statusInfo;\n  resultModal.style.display = 'flex';\n\n  closeResultBtn.removeEventListener('click', closeMidActionHandler);\n  sendResultBtn.removeEventListener('click', sendMidActionHandler);\n\n  closeResultBtn.addEventListener('click', closeMidActionHandler);\n\n  sendResultBtn.addEventListener('click', sendMidActionHandler);\n}\n\nfunction closeMidActionHandler() {\n  resultModal.style.display = 'none';\n\n  extraResultText.value = '';\n}\n\nfunction sendMidActionHandler() {\n\n  const extraText = extraResultText.value.trim();\n\n  let playerStatus = `æç™½è¡€é‡${battleState.player.hp}/${battleState.player.maxHp}ï¼ŒMPå€¼${battleState.player.mp}/${battleState.player.maxMp}`;\n\n  let teammatesStatus = '';\n  if (battleState.teammates &amp;&amp; battleState.teammates.length &gt; 0) {\n    teammatesStatus =\n      'ï¼Œé˜Ÿå‹çŠ¶æ€: ' +\n      battleState.teammates\n        .map(teammate =&gt; `${teammate.name}è¡€é‡${teammate.hp}/${teammate.maxHp}ï¼ŒMPå€¼${teammate.mp}/${teammate.maxMp}`)\n        .join('ï¼›');\n  }\n\n  let enemiesStatus = '';\n  if (battleState.enemies &amp;&amp; battleState.enemies.length &gt; 0) {\n    enemiesStatus =\n      'ï¼Œæ•ŒäººçŠ¶æ€: ' + battleState.enemies.map(enemy =&gt; `${enemy.name}è¡€é‡${enemy.hp}/${enemy.maxHp}`).join('ï¼›');\n  }\n\n  let battleLogText = '';\n  if (battleState.fullCombatLog &amp;&amp; battleState.fullCombatLog.length &gt; 0) {\n    battleLogText = 'ï¼Œæˆ˜æ–—è®°å½•ï¼š' + battleState.fullCombatLog.join(' â†’ ');\n  }\n\n  const message = `&lt;request:${\n    extraText ? extraText + 'ï¼Œ' : ''\n  }æç™½çŠ¶æ€ï¼Œ${playerStatus}${teammatesStatus}${enemiesStatus}${battleLogText}&gt;`;\n\n  sendBattleResult(message)\n    .then(success =&gt; {\n      if (success) {\n        logBattleAction('å·²å‘é€ä¸­é€”è¡ŒåŠ¨çŠ¶æ€ï¼');\n      } else {\n        logBattleAction('å‘é€å¤±è´¥ï¼Œç»“æœå·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');\n      }\n    })\n    .catch(e =&gt; {\n      console.error('å‘é€ä¸­é€”è¡ŒåŠ¨çŠ¶æ€å¤±è´¥:', e);\n      logBattleAction('å‘é€å¤±è´¥ï¼');\n    });\n\n  resultModal.style.display = 'none';\n\n  extraResultText.value = '';\n\n  combatInterface.style.display = 'none';\n  document.querySelector('.container').style.display = 'block';\n\n  battleState.isActive = false;\n\n  updatePlayerStatus(battleState.player);\n  createBattleButton();\n\n  autoCollapseAfterSend();\n}\n\nfunction moveToNextAction() {\n\n  const currentAction = battleState.actionOrder[battleState.currentActionIndex];\n  if (currentAction) {\n    logBattleAction(`${currentAction.name} ç»“æŸå½“å‰è¡ŒåŠ¨ï¼`);\n\n    if (currentAction.type === 'teammate') {\n      currentAction.entity.skillUsed = true;\n    }\n  }\n\n  battleState.currentActionIndex++;\n\n  battleState.currentItemUsed = false;\n\n  if (battleState.currentActionIndex &gt;= battleState.actionOrder.length) {\n    startNextRound();\n    return;\n  }\n\n  setTimeout(() =&gt; {\n\n    forceUpdateUI();\n    showCurrentActor();\n  }, 50);\n}\n\nfunction cleanupActionOrder(deadEntityType, deadEntityId) {\n\n  if (!battleState.actionOrder || !deadEntityId) return;\n\n  const currentIndex = battleState.currentActionIndex;\n\n  const newActionOrder = battleState.actionOrder.filter(\n    action =&gt; !(action.type === deadEntityType &amp;&amp; action.id === deadEntityId),\n  );\n\n  if (newActionOrder.length &lt; battleState.actionOrder.length) {\n\n    battleState.actionOrder = newActionOrder;\n\n    if (currentIndex &gt;= battleState.actionOrder.length) {\n      battleState.currentActionIndex = battleState.actionOrder.length - 1;\n    } else {\n\n      let removedBeforeCurrent = 0;\n      for (let i = 0; i &lt;= currentIndex; i++) {\n        const originalAction = battleState.actionOrder[i - removedBeforeCurrent];\n        if (!originalAction || (originalAction.type === deadEntityType &amp;&amp; originalAction.id === deadEntityId)) {\n          removedBeforeCurrent++;\n        }\n      }\n\n      battleState.currentActionIndex = Math.max(0, currentIndex - removedBeforeCurrent);\n    }\n\n    if (battleState.actionOrder.length === 0) {\n      startNextRound();\n      return;\n    }\n\n    updateActionOrderDisplay();\n  }\n}\n\nfunction updateTeammateWeaponsList() {\n  if (!battleState.currentTeammate) return;\n\n  const weapons = battleState.currentTeammate.weapons || [];\n\n  document.getElementById('melee-panel').classList.add('active');\n  document.getElementById('items-panel').classList.remove('active');\n  document.getElementById('stats-panel').classList.remove('active');\n  document.getElementById('melee-toggle').classList.add('active');\n  document.getElementById('items-toggle').classList.remove('active');\n  document.getElementById('stats-toggle').classList.remove('active');\n\n  const currentAction = battleState.actionOrder[battleState.currentActionIndex];\n  if (currentAction &amp;&amp; currentAction.type === 'teammate') {\n        document.getElementById('melee-toggle').innerHTML = `&lt;i class=\"fas fa-magic\"&gt;&lt;/i&gt; ${currentAction.name}çš„ç¥é€š`;\n  } else {\n    document.getElementById('melee-toggle').innerHTML = '&lt;i class=\"fas fa-magic\"&gt;&lt;/i&gt; é˜Ÿå‹ç¥é€š';\n  }\n\n  document.getElementById('items-toggle').style.display = 'block'; \n\n  const meleeWeaponList = document.getElementById('melee-weapon-list');\n\n  if (!battleState.currentTeammate || !battleState.currentTeammate.weapons) {\n    meleeWeaponList.innerHTML = '&lt;div style=\"text-align: center; padding: 10px;\"&gt;è¯¥é˜Ÿå‹æ²¡æœ‰å¯ç”¨çš„ç¥é€š&lt;/div&gt;';\n    return;\n  }\n  meleeWeaponList.innerHTML =\n    battleState.currentTeammate.weapons.length &gt; 0\n      ? battleState.currentTeammate.weapons\n          .map(weapon =&gt; {\n\n            const effectsHtml = weapon.codes ? TooltipGenerator.generateEffectCodeHtml(weapon.codes) : '';\n\n            const isUsed = weapon.used || weapon.currentCooldown &gt; 0 || battleState.currentTeammate.ap &lt;= 0;\n            const usedClass = isUsed ? 'used' : '';\n            const cooldownText = weapon.currentCooldown &gt; 0 ? ` (å†·å´:${weapon.currentCooldown})` : '';\n            return `\n                        &lt;button class=\"weapon-button teammate-weapon ${usedClass}\" data-weapon-index=\"${battleState.currentTeammate.weapons.indexOf(\n              weapon,\n            )}\" ${isUsed ? 'disabled' : ''}&gt;\n                            &lt;div class=\"weapon-button-name\"&gt;${weapon.name}${cooldownText}&lt;/div&gt;\n                            &lt;div class=\"weapon-button-stats\"&gt;\n                                &lt;div&gt;${weapon.isHealing ? 'æ²»ç–—: ' : 'æ”»å‡»: '}${weapon.attack}&lt;/div&gt;\n                                &lt;div&gt;å‘½ä¸­: ${weapon.hitRate}%&lt;/div&gt;\n                                &lt;div&gt;æš´å‡»: ${weapon.critRate}%&lt;/div&gt;\n                                &lt;div&gt;æ¬¡æ•°: ${weapon.attacksPerTurn}&lt;/div&gt;\n                                &lt;div&gt;ç›®æ ‡: ${weapon.targetsPerAttack}&lt;/div&gt;\n                                &lt;div&gt;MP: ${weapon.mpCost}&lt;/div&gt;\n                                &lt;div&gt;å†·å´: ${weapon.cooldown || 0}å›åˆ&lt;/div&gt;\n                            &lt;/div&gt;\n                            &lt;div class=\"weapon-effect-codes\"&gt;\n                                ${effectsHtml}\n                            &lt;/div&gt;\n                        &lt;/button&gt;\n                    `;\n          })\n          .join('')\n      : '&lt;div style=\"text-align: center; padding: 10px;\"&gt;è¯¥é˜Ÿå‹æ²¡æœ‰å¯ç”¨çš„ç¥é€š&lt;/div&gt;';\n\n  if (battleState.currentTeammate &amp;&amp; battleState.currentTeammate.weapons) {\n    EventManager.bindWeaponButtons(battleState.currentTeammate.weapons, true);\n  }\n\n  const attackControls = document.querySelector('.attack-controls');\n  attackControls.innerHTML = `\n                &lt;button id=\"attack-btn\" class=\"attack-button\" disabled&gt;&lt;i class=\"fas fa-magic\"&gt;&lt;/i&gt; é˜Ÿå‹æ–½å±•ç¥é€š&lt;/button&gt;\n                &lt;button id=\"next-round-btn\" class=\"next-round-button\"&gt;&lt;i class=\"fas fa-forward\"&gt;&lt;/i&gt; è·³è¿‡å½“å‰è¡ŒåŠ¨&lt;/button&gt;\n                &lt;button id=\"mid-action-btn\" class=\"mid-action-button\"&gt;&lt;i class=\"fas fa-pause\"&gt;&lt;/i&gt; ä¸­é€”è¡ŒåŠ¨&lt;/button&gt;\n            `;\n\n  const attackBtn = document.getElementById('attack-btn');\n  if (attackBtn) {\n    attackBtn.addEventListener('click', performTeammateAttack);\n  }\n\n  setupSkipButton();\n}\n\nfunction executeTeammateAttackSequence(teammate, weapon) {\n\n  battleState.currentAttackCount = 0;\n\n  function performNextAttack() {\n\n    if (teammate.mp &lt; weapon.mpCost) {\n      logBattleAction(`${teammate.name} è“é‡ä¸è¶³ï¼æ— æ³•ç»§ç»­æ”»å‡»ã€‚å·²å®Œæˆ ${battleState.currentAttackCount} æ¬¡æ”»å‡»ã€‚`);\n\n      weapon.used = true;\n\n      battleState.currentWeapon = null;\n\n      battleState.attackInProgress = false;\n\n      updatePlayerPanel();\n      updateEnemyPanel();\n      updateTeammateWeaponsList();\n      return;\n    }\n\n    if (\n      StateValidator.shouldEndAttack(\n        battleState.currentAttackCount,\n        weapon.attacksPerTurn,\n        battleState.selectedEnemies.length &gt; 0,\n      )\n    ) {\n\n      weapon.used = true;\n\n      battleState.currentWeapon = null;\n\n      battleState.attackInProgress = false;\n\n      updatePlayerPanel();\n      updateEnemyPanel();\n      updateTeammateWeaponsList();\n\n      return;\n    }\n\n    battleState.currentAttackCount++;\n\n    const attackNumber = battleState.currentAttackCount;\n\n    if (weapon.attacksPerTurn &gt; 1) {\n      logBattleAction(`${teammate.name} ä½¿ç”¨ ${weapon.name} è¿›è¡Œç¬¬ ${attackNumber}/${weapon.attacksPerTurn} æ¬¡æ”»å‡»ï¼`);\n    } else {\n      logBattleAction(`${teammate.name} ä½¿ç”¨ ${weapon.name} æ”»å‡»ï¼`);\n    }\n\n    const teammateElement = document.querySelector(`.combat-entity.teammate[data-teammate-id=\"${teammate.id}\"]`);\n    teammateElement.classList.add('attack-animation-forward');\n\n    setTimeout(() =&gt; {\n\n      for (const enemyId of battleState.selectedEnemies) {\n        const enemy = battleState.enemies.find(e =&gt; e.id === enemyId);\n        if (enemy) {\n\n          const teammateStats = getTeammateActualStats(teammate);\n          const enemyStats = getEnemyActualStats(enemy);\n\n          const finalHitRate = calculateFinalHitRate(weapon.hitRate, teammateStats, enemyStats);\n          const hitRoll = Math.random();\n\n          if (hitRoll &lt;= Math.min(1.0, finalHitRate)) {\n\n            logBattleAction(`æ”»å‡»å‘½ä¸­ ${enemy.name}ï¼(æœ€ç»ˆå‘½ä¸­ç‡: ${(finalHitRate * 100).toFixed(1)}%)`);\n\n            const enemyElement = document.querySelector(`.combat-entity.enemy[data-enemy-id=\"${enemyId}\"]`);\n            enemyElement.classList.add('shake-animation');\n\n            const finalCritRate = calculateFinalCritRate(weapon.critRate, teammateStats, enemyStats, finalHitRate);\n            const critRoll = Math.random();\n\n            const isCrit = critRoll &lt;= Math.min(1.0, finalCritRate);\n\n            const finalCritMultiplier = isCrit\n              ? calculateFinalCritMultiplier(teammateStats, enemyStats, finalCritRate)\n              : 1.0;\n\n            let damage = calculateFinalDamage(weapon.attack, teammateStats, enemyStats, isCrit, finalCritMultiplier);\n\n            if (isCrit) {\n              logBattleAction(\n                `æš´å‡»ï¼é€ æˆ ${damage} ç‚¹ä¼¤å®³ï¼(æš´å‡»ç‡: ${(finalCritRate * 100).toFixed(\n                  1,\n                )}%, æš´å‡»å€ç‡: ${finalCritMultiplier.toFixed(2)}x)`,\n              );\n              showDamageNumber('enemy', damage, true, enemyId);\n            } else {\n              logBattleAction(`é€ æˆ ${damage} ç‚¹ä¼¤å®³ï¼`);\n              showDamageNumber('enemy', damage, false, enemyId);\n            }\n\n            const extraDamage = processTeammateEnchantmentEffects(weapon, enemy, damage, isCrit, teammate);\n            damage += extraDamage;\n\n            enemy.hp = Math.max(0, enemy.hp - damage);\n\n            addDamageHate(teammate.id, teammate.name, enemyId, damage);\n\n            addHpChangeAnimation('enemy', enemyId);\n\n            if (StateValidator.checkEnemyDeath(enemy)) {\n              return; \n            }\n\n            setTimeout(() =&gt; {\n              if (enemyElement) {\n                enemyElement.classList.remove('shake-animation');\n              }\n            }, 800);\n          } else {\n\n            logBattleAction(`æ”»å‡»æœªå‘½ä¸­ ${enemy.name}ï¼(æœ€ç»ˆå‘½ä¸­ç‡: ${(finalHitRate * 100).toFixed(1)}%)`);\n          }\n        }\n      }\n\n      teammate.mp = Math.max(0, teammate.mp - weapon.mpCost);\n      if (weapon.mpCost &gt; 0) {\n        logBattleAction(`${teammate.name} æ¶ˆè€— ${weapon.mpCost} ç‚¹çµåŠ›å€¼ã€‚å‰©ä½™çµåŠ›å€¼: ${teammate.mp}`);\n      }\n\n      teammateElement.classList.remove('attack-animation-forward');\n\n      memoryManager.safeSetTimeout(() =&gt; {\n        updatePlayerPanel();\n        updateEnemyPanel();\n        updateHateDisplay(); \n      }, 1500); \n\n      if (\n        battleState.currentAttackCount &lt; weapon.attacksPerTurn &amp;&amp;\n        battleState.selectedEnemies.length &gt; 0 &amp;&amp;\n        battleState.enemies.length &gt; 0\n      ) {\n\n        setTimeout(performNextAttack, 800);\n      } else {\n\n        weapon.used = true;\n\n        battleState.currentWeapon = null;\n\n        battleState.attackInProgress = false;\n\n        updateTeammateWeaponsList();\n\n      }\n    }, 500); \n  }\n\n  performNextAttack();\n}\n\nlet memoryManager = {\n\n  particlePool: [],\n  damageNumberPool: [],\n  healNumberPool: [],\n  logEntryPool: [],\n\n  activeParticles: new Set(),\n  activeDamageNumbers: new Set(),\n  activeHealNumbers: new Set(),\n  activeTimeouts: new Set(),\n\n  getParticle() {\n    if (this.particlePool.length &gt; 0) {\n      return this.particlePool.pop();\n    }\n    const particle = document.createElement('div');\n    particle.className = 'death-particle';\n    return particle;\n  },\n\n  recycleParticle(particle) {\n    if (particle &amp;&amp; this.particlePool.length &lt; 50) {\n\n      particle.style.cssText = ''; \n      particle.className = 'death-particle';\n      this.particlePool.push(particle);\n      this.activeParticles.delete(particle);\n    }\n  },\n\n  getDamageNumber() {\n    if (this.damageNumberPool.length &gt; 0) {\n      return this.damageNumberPool.pop();\n    }\n    return document.createElement('div');\n  },\n\n  recycleDamageNumber(element) {\n    if (element &amp;&amp; this.damageNumberPool.length &lt; 30) {\n      element.style.cssText = '';\n      element.className = '';\n      element.textContent = '';\n      this.damageNumberPool.push(element);\n      this.activeDamageNumbers.delete(element);\n    }\n  },\n\n  getHealNumber() {\n    if (this.healNumberPool.length &gt; 0) {\n      return this.healNumberPool.pop();\n    }\n    return document.createElement('div');\n  },\n\n  recycleHealNumber(element) {\n    if (element &amp;&amp; this.healNumberPool.length &lt; 30) {\n      element.style.cssText = '';\n      element.className = '';\n      element.textContent = '';\n      this.healNumberPool.push(element);\n      this.activeHealNumbers.delete(element);\n    }\n  },\n\n  safeSetTimeout(callback, delay) {\n    const timeoutId = setTimeout(() =&gt; {\n      this.activeTimeouts.delete(timeoutId);\n      try {\n        callback();\n      } catch (error) {\n\n      }\n    }, delay);\n    this.activeTimeouts.add(timeoutId);\n    return timeoutId;\n  },\n\n  clearSafeTimeout(timeoutId) {\n    if (this.activeTimeouts.has(timeoutId)) {\n      clearTimeout(timeoutId);\n      this.activeTimeouts.delete(timeoutId);\n    }\n  },\n\n  cleanup() {\n\n    this.activeParticles.forEach(particle =&gt; {\n      if (particle.parentNode) {\n        particle.parentNode.removeChild(particle);\n      }\n    });\n\n    this.activeDamageNumbers.forEach(element =&gt; {\n      if (element.parentNode) {\n        element.parentNode.removeChild(element);\n      }\n    });\n    this.activeHealNumbers.forEach(element =&gt; {\n      if (element.parentNode) {\n        element.parentNode.removeChild(element);\n      }\n    });\n\n    this.activeTimeouts.forEach(timeoutId =&gt; {\n      clearTimeout(timeoutId);\n    });\n\n    this.activeParticles.clear();\n    this.activeDamageNumbers.clear();\n    this.activeHealNumbers.clear();\n    this.activeTimeouts.clear();\n\n    this.particlePool = [];\n    this.damageNumberPool = [];\n    this.healNumberPool = [];\n    this.logEntryPool = [];\n  },\n};\n\nlet lazyRenderManager = {\n  isPreparationRendered: false,\n  isCombatRendered: false,\n  lastRenderTime: {\n    preparation: 0,\n    combat: 0,\n  },\n\n  shouldRenderPreparation() {\n    const preparationDetails = document.getElementById('preparation-details');\n    return preparationDetails &amp;&amp; preparationDetails.open;\n  },\n\n  shouldRenderCombat() {\n    if (!this.isCombatRendered || !battleState || !battleState.isActive) {\n      return false;\n    }\n    const combatInterface = document.getElementById('combat-interface');\n    return combatInterface &amp;&amp; combatInterface.style.display !== 'none';\n  },\n\n  safeUpdateInterface(updateFunction, renderType) {\n    try {\n      const now = Date.now();\n\n      if (now - this.lastRenderTime[renderType] &lt; 16) {\n        return;\n      }\n      if (renderType === 'preparation' &amp;&amp; !this.shouldRenderPreparation()) {\n        return;\n      }\n      if (renderType === 'combat' &amp;&amp; !this.shouldRenderCombat()) {\n        return;\n      }\n      updateFunction();\n      this.lastRenderTime[renderType] = now;\n    } catch (error) {\n\n    }\n  },\n\n  reset() {\n    this.isPreparationRendered = false;\n    this.isCombatRendered = false;\n    this.lastRenderTime.preparation = 0;\n    this.lastRenderTime.combat = 0;\n  },\n};\n\nwindow.addEventListener('beforeunload', () =&gt; {\n  memoryManager.cleanup();\n});\n\nif (window.parent !== window) {\n  window.addEventListener('unload', () =&gt; {\n    memoryManager.cleanup();\n  });\n}\n\nsetInterval(() =&gt; {\n  try {\n\n    memoryManager.activeParticles.forEach(particle =&gt; {\n      if (!particle.parentNode || !document.contains(particle)) {\n        memoryManager.activeParticles.delete(particle);\n      }\n    });\n    memoryManager.activeDamageNumbers.forEach(element =&gt; {\n      if (!element.parentNode || !document.contains(element)) {\n        memoryManager.activeDamageNumbers.delete(element);\n      }\n    });\n    memoryManager.activeHealNumbers.forEach(element =&gt; {\n      if (!element.parentNode || !document.contains(element)) {\n        memoryManager.activeHealNumbers.delete(element);\n      }\n    });\n\n    if (memoryManager.particlePool.length &gt; 100) {\n      memoryManager.particlePool.length = 50;\n    }\n    if (memoryManager.damageNumberPool.length &gt; 60) {\n      memoryManager.damageNumberPool.length = 30;\n    }\n    if (memoryManager.healNumberPool.length &gt; 60) {\n      memoryManager.healNumberPool.length = 30;\n    }\n    if (memoryManager.logEntryPool.length &gt; 40) {\n      memoryManager.logEntryPool.length = 20;\n    }\n\n    if (!lazyRenderManager.shouldRenderPreparation()) {\n      lazyRenderManager.isPreparationRendered = false;\n    }\n    if (!lazyRenderManager.shouldRenderCombat()) {\n      lazyRenderManager.isCombatRendered = false;\n    }\n  } catch (error) {\n\n  }\n}, 60000);\n\nfunction autoCollapseAfterSend() {\n  if (battleState) {\n    try {\n      localStorage.setItem('battleState_backup', JSON.stringify(battleState));\n    } catch (e) {}\n  }\n  const preparationDetails = document.getElementById('preparation-details');\n  if (preparationDetails &amp;&amp; preparationDetails.open) {\n    setTimeout(() =&gt; {\n      preparationDetails.open = false;\n    }, 100);\n\n    setTimeout(() =&gt; {\n      memoryManager.cleanup();\n      lazyRenderManager.reset();\n    }, 60000);\n  }\n}\n\nfunction setupSendDetection() {\n  if (typeof window.triggerSlash === 'function') {\n    const originalTriggerSlash = window.triggerSlash;\n    window.triggerSlash = async function (...args) {\n      const result = await originalTriggerSlash.apply(this, args);\n      autoCollapseAfterSend();\n      return result;\n    };\n  }\n  setTimeout(() =&gt; {\n    const sendButtons = document.querySelectorAll('[id*=\"send\"], [class*=\"send\"], [onclick*=\"send\"]');\n    sendButtons.forEach(button =&gt; {\n      button.addEventListener('click', () =&gt; {\n        setTimeout(autoCollapseAfterSend, 200);\n      });\n    });\n  }, 1000);\n}\nsetupSendDetection();\n\nfunction toggleStats(elementId) {\n  const element = document.getElementById(elementId);\n  const button = document.querySelector(`[onclick=\"toggleStats('${elementId}')\"]`);\n  if (element &amp;&amp; button) {\n    const isExpanded = element.classList.contains('expanded');\n    if (isExpanded) {\n\n      element.classList.remove('expanded');\n      button.classList.remove('expanded');\n    } else {\n\n      element.classList.add('expanded');\n      button.classList.add('expanded');\n    }\n  }\n}\n\nfunction executeHealingSequence(weapon, weaponTemplate) {\n\n  battleState.currentAttackCount = 0;\n\n  function performNextHealing() {\n\n    if (battleState.player.mp &lt; weapon.mpCost) {\n      logBattleAction(`è“é‡ä¸è¶³ï¼æ— æ³•ç»§ç»­ä½¿ç”¨ ${weapon.name}ã€‚å·²å®Œæˆ ${battleState.currentAttackCount} æ¬¡ä½¿ç”¨ã€‚`);\n\n      weapon.used = true;\n\n      battleState.currentWeapon = null;\n\n      battleState.attackInProgress = false;\n\n      updateBattleUI({ player: true, enemy: true, weapons: true });\n      return;\n    }\n\n    let actualAttacksPerTurn = weapon.attacksPerTurn;\n    if (battleState.sacrificeBoostActive) {\n      actualAttacksPerTurn += battleState.sacrificeBoostActive.attacksPerTurn;\n    }\n\n    if (battleState.currentAttackCount &gt;= actualAttacksPerTurn) {\n\n      weapon.used = true;\n\n      battleState.currentWeapon = null;\n\n      battleState.attackInProgress = false;\n\n      updateBattleUI({ player: true, enemy: true, weapons: true });\n      return;\n    }\n\n    battleState.currentAttackCount++;\n\n    const healingNumber = battleState.currentAttackCount;\n    if (actualAttacksPerTurn &gt; 1) {\n      logBattleAction(\n        `${battleState.player.name || 'User'} ä½¿ç”¨ ${\n          weapon.name\n        } è¿›è¡Œç¬¬ ${healingNumber}/${actualAttacksPerTurn} æ¬¡æ²»ç–—ï¼`,\n      );\n    }\n\n    executeHealingAction(weapon, weaponTemplate, () =&gt; {\n\n      battleState.player.mp = Math.max(0, battleState.player.mp - weapon.mpCost);\n      if (weapon.mpCost &gt; 0) {\n        logBattleAction(`æ¶ˆè€— ${weapon.mpCost} ç‚¹çµåŠ›å€¼ã€‚å‰©ä½™çµåŠ›å€¼: ${battleState.player.mp}`);\n      }\n\n      if (battleState.currentAttackCount &lt; actualAttacksPerTurn) {\n        setTimeout(performNextHealing, 800);\n      } else {\n\n        weapon.used = true;\n        battleState.currentWeapon = null;\n        battleState.attackInProgress = false;\n        updateBattleUI({ player: true, enemy: true, weapons: true });\n      }\n    });\n  }\n\n  performNextHealing();\n}\n\nfunction executeHealingAction(weapon, weaponTemplate, callback) {\n\n  const targets = getHealingTargets(weapon, weaponTemplate, battleState.player);\n  targets.forEach(target =&gt; {\n    if (weaponTemplate === 'A2') {\n      performSingleHealing(weapon, target);\n    } else if (weaponTemplate === 'A3') {\n      performSingleManaRestore(weapon, target);\n    } else if (weaponTemplate === 'A4') {\n      performSingleSacrificeBoost(weapon, target, battleState.player);\n    } else {\n      performSingleHealing(weapon, target); \n    }\n  });\n\n  setTimeout(callback, 1200);\n}\n\nfunction getHealingTargets(weapon, weaponTemplate, attacker = null) {\n  const targets = [];\n\n  if (battleState.selectedHealTargets &amp;&amp; battleState.selectedHealTargets.length &gt; 0) {\n    battleState.selectedHealTargets.forEach(target =&gt; {\n      targets.push({ type: target.type, entity: target.entity });\n    });\n  } else {\n\n    if (battleState.healTarget === 'player') {\n      targets.push({ type: 'player', entity: battleState.player });\n    } else if (battleState.healTarget &amp;&amp; battleState.healTarget !== 'player') {\n      const targetTeammate = battleState.teammates.find(t =&gt; t.id === battleState.healTarget);\n      if (targetTeammate) {\n        targets.push({ type: 'teammate', entity: targetTeammate });\n      }\n    }\n  }\n\n  return targets.slice(0, weapon.targetsPerAttack);\n}\n\nfunction performSingleHealing(weapon, target) {\n  const targetName = target.type === 'player' ? battleState.player.name || 'User' : target.entity.name;\n\n  let healAmount = weapon.attack;\n\n  const critRoll = Math.random() * 100;\n  const isCrit = critRoll &lt;= weapon.critRate;\n  if (isCrit) {\n    const playerStats = getPlayerActualStats();\n    const critMultiplier = playerStats.baseCritMultiplier;\n    healAmount = Math.floor(healAmount * critMultiplier);\n    logBattleAction(`æš´å‡»æ²»ç–—ï¼å¯¹ ${targetName} æ¢å¤ ${healAmount} ç‚¹ç”Ÿå‘½å€¼ï¼`);\n  } else {\n    logBattleAction(`å¯¹ ${targetName} æ¢å¤ ${healAmount} ç‚¹ç”Ÿå‘½å€¼ï¼`);\n  }\n\n  if (target.type === 'player') {\n    const oldHp = battleState.player.hp;\n    battleState.player.hp = Math.min(battleState.player.hp + healAmount, battleState.player.maxHp);\n    const actualHeal = battleState.player.hp - oldHp;\n    showHealNumber(actualHeal);\n  } else if (target.type === 'teammate') {\n    const oldHp = target.entity.hp;\n    target.entity.hp = Math.min(target.entity.hp + healAmount, target.entity.maxHp);\n    const actualHeal = target.entity.hp - oldHp;\n    logBattleAction(`å®é™…æ¢å¤äº† ${actualHeal} ç‚¹ç”Ÿå‘½å€¼ï¼`);\n  } else if (target.type === 'enemy') {\n    const oldHp = target.entity.hp;\n    target.entity.hp = Math.min(target.entity.hp + healAmount, target.entity.maxHp);\n    const actualHeal = target.entity.hp - oldHp;\n    showHealNumberOnEnemy(actualHeal, target.entity.id);\n  }\n\n  addHealHate('player', battleState.player.name || 'User', healAmount);\n}\n\nfunction performSingleManaRestore(weapon, target) {\n  const targetName = target.type === 'player' ? battleState.player.name || 'User' : target.entity.name;\n\n  let manaAmount = weapon.attack;\n\n  const critRoll = Math.random() * 100;\n  const isCrit = critRoll &lt;= weapon.critRate;\n  if (isCrit) {\n    const playerStats = getPlayerActualStats();\n    const critMultiplier = playerStats.baseCritMultiplier;\n    manaAmount = Math.floor(manaAmount * critMultiplier);\n    logBattleAction(`æš´å‡»æ¢å¤ï¼å¯¹ ${targetName} æ¢å¤ ${manaAmount} ç‚¹çµåŠ›å€¼ï¼`);\n  } else {\n    logBattleAction(`å¯¹ ${targetName} æ¢å¤ ${manaAmount} ç‚¹çµåŠ›å€¼ï¼`);\n  }\n\n  if (target.type === 'player') {\n    const oldMp = battleState.player.mp;\n    battleState.player.mp = Math.min(battleState.player.mp + manaAmount, battleState.player.maxMp);\n    const actualRestore = battleState.player.mp - oldMp;\n    logBattleAction(`å®é™…æ¢å¤äº† ${actualRestore} ç‚¹çµåŠ›å€¼ï¼`);\n  } else if (target.type === 'teammate') {\n    const oldMp = target.entity.mp;\n    target.entity.mp = Math.min(target.entity.mp + manaAmount, target.entity.maxMp);\n    const actualRestore = target.entity.mp - oldMp;\n    logBattleAction(`å®é™…æ¢å¤äº† ${actualRestore} ç‚¹çµåŠ›å€¼ï¼`);\n  }\n}\n\nfunction performSingleSacrificeBoost(weapon, target, attacker = null) {\n\n  let actualAttacker, attackerName, isPlayerAttacker;\n\n  if (attacker) {\n\n    actualAttacker = attacker;\n    isPlayerAttacker = attacker === battleState.player;\n    attackerName = isPlayerAttacker ? battleState.player.name || 'User' : attacker.name;\n  } else {\n\n    actualAttacker = target.type === 'player' ? battleState.player : target.entity;\n    isPlayerAttacker = target.type === 'player';\n    attackerName = target.type === 'player' ? battleState.player.name || 'User' : target.entity.name;\n  }\n\n  const targetName = target.type === 'player' ? battleState.player.name || 'User' : target.entity.name;\n\n  logBattleAction(`${attackerName} å¯¹ ${targetName} ä½¿ç”¨ ${weapon.name} è¿›è¡Œç‰ºç‰²å¢ç›Šï¼`);\n\n  const sacrificeDamage = Math.floor(weapon.attack * 0.5);\n  actualAttacker.hp = Math.max(1, actualAttacker.hp - sacrificeDamage);\n  logBattleAction(`${attackerName} ç‰ºç‰² ${sacrificeDamage} ç‚¹ç”Ÿå‘½å€¼ï¼`);\n\n  if (target.type === 'player') {\n\n    if (!battleState.sacrificeBoostActive) {\n      battleState.sacrificeBoostActive = {\n        attack: weapon.attack,\n        hitRate: weapon.hitRate,\n        critRate: weapon.critRate,\n        attacksPerTurn: weapon.attacksPerTurn,\n        targetsPerAttack: weapon.targetsPerAttack,\n        weaponName: weapon.name,\n      };\n      logBattleAction(`${targetName} è·å¾—å¼ºå¤§å¢ç›Šï¼æœ¬å›åˆæ‰€æœ‰æ”»å‡»éƒ½å°†è·å¾— ${weapon.name} çš„å±æ€§åŠ æˆï¼`);\n      logBattleAction(\n        `å¢ç›Šæ•ˆæœï¼šæ”»å‡»+${weapon.attack}ï¼Œå‘½ä¸­+${weapon.hitRate}%ï¼Œæš´å‡»+${weapon.critRate}%ï¼Œæ¬¡æ•°+${weapon.attacksPerTurn}ï¼Œç›®æ ‡+${weapon.targetsPerAttack}`,\n      );\n    }\n  } else {\n\n    const teammate = target.entity;\n    if (!teammate.buffs) teammate.buffs = [];\n\n    const existingSacrificeBoost = teammate.buffs.find(buff =&gt; buff.type === 'sacrificeBoost');\n    if (!existingSacrificeBoost) {\n      const sacrificeBoostBuff = {\n        name: 'ç‰ºç‰²å¢ç›Š',\n        type: 'sacrificeBoost',\n        isPositive: true,\n        duration: 'æœ¬å›åˆ',\n        attack: weapon.attack,\n        hitRate: weapon.hitRate,\n        critRate: weapon.critRate,\n        attacksPerTurn: weapon.attacksPerTurn,\n        targetsPerAttack: weapon.targetsPerAttack,\n        weaponName: weapon.name,\n        tooltipText: `æ”»å‡»+${weapon.attack}ï¼Œå‘½ä¸­+${weapon.hitRate}%ï¼Œæš´å‡»+${weapon.critRate}%ï¼Œæ¬¡æ•°+${weapon.attacksPerTurn}ï¼Œç›®æ ‡+${weapon.targetsPerAttack}`,\n      };\n      teammate.buffs.push(sacrificeBoostBuff);\n\n      logBattleAction(`${targetName} è·å¾—å¼ºå¤§å¢ç›Šï¼æœ¬å›åˆæ‰€æœ‰æ”»å‡»éƒ½å°†è·å¾— ${weapon.name} çš„å±æ€§åŠ æˆï¼`);\n      logBattleAction(\n        `å¢ç›Šæ•ˆæœï¼šæ”»å‡»+${weapon.attack}ï¼Œå‘½ä¸­+${weapon.hitRate}%ï¼Œæš´å‡»+${weapon.critRate}%ï¼Œæ¬¡æ•°+${weapon.attacksPerTurn}ï¼Œç›®æ ‡+${weapon.targetsPerAttack}`,\n      );\n    }\n  }\n}\n\nfunction executeTeammateHealingSequence(teammate, weapon, weaponTemplate) {\n\n  battleState.currentAttackCount = 0;\n\n  function performNextHealing() {\n\n    if (teammate.mp &lt; weapon.mpCost) {\n      logBattleAction(\n        `${teammate.name} è“é‡ä¸è¶³ï¼æ— æ³•ç»§ç»­ä½¿ç”¨ ${weapon.name}ã€‚å·²å®Œæˆ ${battleState.currentAttackCount} æ¬¡ä½¿ç”¨ã€‚`,\n      );\n\n      weapon.used = true;\n\n      teammate.skillUsed = true;\n\n      battleState.currentWeapon = null;\n\n      battleState.attackInProgress = false;\n\n      updatePlayerPanel();\n      updateEnemyPanel();\n      updateTeammateWeaponsList();\n      return;\n    }\n\n    if (battleState.currentAttackCount &gt;= weapon.attacksPerTurn) {\n\n      weapon.used = true;\n\n      teammate.skillUsed = true;\n\n      battleState.currentWeapon = null;\n\n      battleState.attackInProgress = false;\n\n      updatePlayerPanel();\n      updateEnemyPanel();\n      updateTeammateWeaponsList();\n      return;\n    }\n\n    battleState.currentAttackCount++;\n\n    const healingNumber = battleState.currentAttackCount;\n    if (weapon.attacksPerTurn &gt; 1) {\n      logBattleAction(`${teammate.name} ä½¿ç”¨ ${weapon.name} è¿›è¡Œç¬¬ ${healingNumber}/${weapon.attacksPerTurn} æ¬¡æ²»ç–—ï¼`);\n    }\n\n    executeTeammateHealingAction(teammate, weapon, weaponTemplate, () =&gt; {\n\n      teammate.mp = Math.max(0, teammate.mp - weapon.mpCost);\n      if (weapon.mpCost &gt; 0) {\n        logBattleAction(`${teammate.name} æ¶ˆè€— ${weapon.mpCost} ç‚¹çµåŠ›å€¼ã€‚å‰©ä½™çµåŠ›å€¼: ${teammate.mp}`);\n      }\n\n      if (battleState.currentAttackCount &lt; weapon.attacksPerTurn) {\n        setTimeout(performNextHealing, 800);\n      } else {\n\n        weapon.used = true;\n        teammate.skillUsed = true;\n        battleState.currentWeapon = null;\n        battleState.attackInProgress = false;\n        updatePlayerPanel();\n        updateEnemyPanel();\n        updateTeammateWeaponsList();\n      }\n    });\n  }\n\n  performNextHealing();\n}\n\nfunction executeTeammateHealingAction(teammate, weapon, weaponTemplate, callback) {\n\n  const targets = getHealingTargets(weapon, weaponTemplate, teammate);\n  targets.forEach(target =&gt; {\n    if (weaponTemplate === 'A2') {\n      performTeammateSingleHealing(teammate, weapon, target);\n    } else if (weaponTemplate === 'A3') {\n      performTeammateSingleManaRestore(teammate, weapon, target);\n    } else if (weaponTemplate === 'A4') {\n      performSingleSacrificeBoost(weapon, target, teammate);\n    } else {\n      performTeammateSingleHealing(teammate, weapon, target); \n    }\n  });\n\n  setTimeout(callback, 1200);\n}\n\nfunction performTeammateSingleHealing(teammate, weapon, target) {\n  const targetName = target.type === 'player' ? battleState.player.name || 'User' : target.entity.name;\n\n  let healAmount = weapon.attack;\n\n  const critRoll = Math.random() * 100;\n  const isCrit = critRoll &lt;= weapon.critRate;\n  if (isCrit) {\n    const teammateStats = getTeammateActualStats(teammate);\n    const critMultiplier = teammateStats.baseCritMultiplier;\n    healAmount = Math.floor(healAmount * critMultiplier);\n    logBattleAction(`${teammate.name} æš´å‡»æ²»ç–—ï¼å¯¹ ${targetName} æ¢å¤ ${healAmount} ç‚¹ç”Ÿå‘½å€¼ï¼`);\n  } else {\n    logBattleAction(`${teammate.name} å¯¹ ${targetName} æ¢å¤ ${healAmount} ç‚¹ç”Ÿå‘½å€¼ï¼`);\n  }\n\n  if (target.type === 'player') {\n    const oldHp = battleState.player.hp;\n    battleState.player.hp = Math.min(battleState.player.hp + healAmount, battleState.player.maxHp);\n    const actualHeal = battleState.player.hp - oldHp;\n    showHealNumber(actualHeal);\n  } else if (target.type === 'teammate') {\n    const oldHp = target.entity.hp;\n    target.entity.hp = Math.min(target.entity.hp + healAmount, target.entity.maxHp);\n    const actualHeal = target.entity.hp - oldHp;\n    logBattleAction(`å®é™…æ¢å¤äº† ${actualHeal} ç‚¹ç”Ÿå‘½å€¼ï¼`);\n  } else if (target.type === 'enemy') {\n    const oldHp = target.entity.hp;\n    target.entity.hp = Math.min(target.entity.hp + healAmount, target.entity.maxHp);\n    const actualHeal = target.entity.hp - oldHp;\n    showHealNumberOnEnemy(actualHeal, target.entity.id);\n  }\n\n  addHealHate(teammate.id, teammate.name, healAmount);\n}\n\nfunction performTeammateSingleManaRestore(teammate, weapon, target) {\n  const targetName = target.type === 'player' ? battleState.player.name || 'User' : target.entity.name;\n\n  let manaAmount = weapon.attack;\n\n  const critRoll = Math.random() * 100;\n  const isCrit = critRoll &lt;= weapon.critRate;\n  if (isCrit) {\n    const teammateStats = getTeammateActualStats(teammate);\n    const critMultiplier = teammateStats.baseCritMultiplier;\n    manaAmount = Math.floor(manaAmount * critMultiplier);\n    logBattleAction(`${teammate.name} æš´å‡»æ¢å¤ï¼å¯¹ ${targetName} æ¢å¤ ${manaAmount} ç‚¹çµåŠ›å€¼ï¼`);\n  } else {\n    logBattleAction(`${teammate.name} å¯¹ ${targetName} æ¢å¤ ${manaAmount} ç‚¹çµåŠ›å€¼ï¼`);\n  }\n\n  if (target.type === 'player') {\n    const oldMp = battleState.player.mp;\n    battleState.player.mp = Math.min(battleState.player.mp + manaAmount, battleState.player.maxMp);\n    const actualRestore = battleState.player.mp - oldMp;\n    logBattleAction(`å®é™…æ¢å¤äº† ${actualRestore} ç‚¹çµåŠ›å€¼ï¼`);\n  } else if (target.type === 'teammate') {\n    const oldMp = target.entity.mp;\n    target.entity.mp = Math.min(target.entity.mp + manaAmount, target.entity.maxMp);\n    const actualRestore = target.entity.mp - oldMp;\n    logBattleAction(`å®é™…æ¢å¤äº† ${actualRestore} ç‚¹çµåŠ›å€¼ï¼`);\n  }\n}\n\n    &lt;/script&gt;\n  &lt;/body&gt;\n&lt;/html&gt;\n</code></pre>\n<div class=\"custom-divine-starmap-wrapper\">\n  \n  <style>/* ä¸»å®¹å™¨æ ·å¼ - ç¥åœ£æ˜Ÿå›¾ä¸»é¢˜ */\n\n.mes_text .custom-divine-starmap-wrapper {\n  background-color: #f5f2e9;\n  /* è±¡ç‰™ç™½åŸºåº• */\n  /* ä¸»ä½“èƒŒæ™¯ - æ¨¡æ‹Ÿå‘å…‰çš„åœ£æ´æ˜Ÿå›¾ */\n  background-image: radial-gradient(circle at 50% 50%, rgba(255, 230, 180, 0.25) 0%, rgba(255, 230, 180, 0) 60%),\n        linear-gradient(160deg, #fdfcf8 0%, #f5f2e9 100%);\n  /* æ ¸å¿ƒï¼šç¥åœ£å…‰æ™•ä¸é‡‘è‰²åŒå±‚è¾¹æ¡† */\n  border: 1px solid #d4c09a;\n  box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.8), \n        0 0 20px 4px rgba(220, 180, 110, 0.4);\n  /* å¤–éƒ¨é‡‘è‰²è¾‰å…‰ */\n  border-radius: 8px !important;\n  max-width: 861px !important;\n  margin: 10px auto !important;\n  padding: 0 6px 6px 6px !important;\n  box-sizing: border-box !important;\n  overflow: hidden !important;\n  font-family: 'KaiTi', 'SimSun', 'Segoe UI', 'Times New Roman', serif !important;\n  /* ä¼˜å…ˆä½¿ç”¨æ›´å…¸é›…çš„å­—ä½“ */\n  color: #5D493A !important;\n  /* æ·±é‡‘è‰²/æš–æ£•è‰²æ–‡æœ¬ */\n}\n\n/* å…¨å±€æ–‡å­—è¾‰å…‰æ•ˆæœ */\n\n.mes_text .custom-divine-starmap-wrapper,\n.mes_text .custom-divine-starmap-wrapper * {\n  text-shadow: 0 1px 1px rgba(255, 240, 215, 0.6) !important;\n}\n\n/* è¯¦æƒ…æŒ‰é’®æ ·å¼ */\n\n.mes_text .custom-details-divine-starmap {\n  border: none !important;\n  margin: 0 !important;\n  padding: 0 !important;\n  color: inherit !important;\n}\n\n/* åŸºç¡€æ‘˜è¦æ ·å¼ */\n\n.mes_text .custom-details-divine-starmap > summary {\n  display: flex !important;\n  align-items: center !important;\n  width: 100% !important;\n  cursor: pointer !important;\n  list-style: none !important;\n  outline: none !important;\n  transition: all 0.25s ease-out !important;\n  position: relative !important;\n  font-weight: 600 !important;\n  color: #5D493A !important;\n}\n\n/* ç§»é™¤é»˜è®¤æ ‡è®° */\n\n.mes_text .custom-details-divine-starmap > summary::-webkit-details-marker,\n.mes_text .custom-details-divine-starmap > summary::marker {\n  display: none !important;\n  content: '' !important;\n}\n\n/* æ ¸å¿ƒï¼šSVGç¥åœ£å…«èŠ’æ˜Ÿå›¾æ ‡å®¹å™¨ */\n\n.mes_text .custom-details-divine-starmap > summary .custom-icon-starmap {\n  display: inline-flex;\n  align-items: center;\n  justify-content: center;\n  margin-right: 10px;\n  transition: all 0.3s cubic-bezier(0.2, 0.9, 0.3, 1);\n  /* é»˜è®¤å…‰æ™• */\n  filter: drop-shadow(0 0 3px rgba(220, 180, 110, 0.7));\n}\n\n.mes_text .custom-details-divine-starmap > summary .custom-icon-starmap svg {\n  width: 20px;\n  /* SVGå°ºå¯¸ */\n  height: 20px;\n  fill: #c8a76a;\n  /* SVGé¢œè‰² */\n  transition: all 0.3s ease-out;\n}\n\n/* --- å…³é—­æ—¶çŠ¶æ€ --- */\n\n.mes_text .custom-details-divine-starmap:not([open]) > summary {\n  padding: 6px 10px !important;\n  font-size: 16px !important;\n  margin-top: 6px !important;\n  background-color: rgba(250, 245, 230, 0.7);\n  /* åŠé€æ˜è´¨æ„Ÿ */\n  border: 1px solid rgba(212, 192, 154, 0.6) !important;\n  border-radius: 6px !important;\n  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05) !important;\n}\n\n/* å…³é—­æ—¶æ‚¬åœæ•ˆæœ */\n\n.mes_text .custom-details-divine-starmap:not([open]) > summary:hover {\n  background-color: rgba(255, 250, 240, 0.9);\n  border-color: rgba(200, 167, 106, 0.8) !important;\n  transform: translateY(-1px);\n}\n\n.mes_text .custom-details-divine-starmap:not([open]) > summary:hover .custom-icon-starmap {\n  filter: drop-shadow(0 0 6px rgba(255, 200, 100, 1));\n  /* å¢å¼ºå…‰æ™• */\n}\n\n.mes_text .custom-details-divine-starmap:not([open]) > summary:hover .custom-icon-starmap svg {\n  fill: #e6c589;\n  /* æäº®å›¾æ ‡ */\n}\n\n/* --- æ‰“å¼€æ—¶çŠ¶æ€ --- */\n\n.mes_text .custom-details-divine-starmap[open] > summary {\n  padding: 12px 10px !important;\n  font-size: 18px !important;\n  margin-top: 6px !important;\n  margin-bottom: 6px !important;\n  border: 1px solid rgba(212, 192, 154, 0.7) !important;\n  border-radius: 6px !important;\n  background-color: rgba(248, 242, 230, 0.8) !important;\n  box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.08) !important;\n}\n\n/* æ‰“å¼€æ—¶å›¾æ ‡æ•ˆæœ */\n\n.mes_text .custom-details-divine-starmap[open] > summary .custom-icon-starmap {\n  transform: rotate(135deg);\n  /* æ¿€æ´»æ—‹è½¬ */\n  filter: drop-shadow(0 0 8px rgba(255, 200, 100, 1));\n}\n\n.mes_text .custom-details-divine-starmap[open] > summary .custom-icon-starmap svg {\n  fill: #f0d6a2;\n}\n\n/* ç‚¹å‡»åé¦ˆ */\n\n.mes_text .custom-details-divine-starmap > summary:active {\n  transform: translateY(0px);\n  transition-duration: 0.1s;\n}\n\n/* æ‰“å¼€æ—¶æ˜¾ç¤ºçš„å†…å®¹ - åœ£æ´çš„è±¡ç‰™ç™½ */\n\n.mes_text .custom-details-divine-starmap > div {\n  padding: 15px !important;\n  margin: 0 !important;\n  font-size: 15px !important;\n  line-height: 1.6 !important;\n  background-color: rgba(253, 252, 248, 0.85) !important;\n  /* æ›´çº¯å‡€çš„è±¡ç‰™ç™½ */\n  color: #5D493A !important;\n  border: 1px solid rgba(212, 192, 154, 0.4) !important;\n  border-radius: 6px !important;\n  font-weight: normal !important;\n  white-space: pre-wrap !important;\n  word-break: break-word !important;\n  overflow-y: auto;\n  /* å†…å®¹æº¢å‡ºæ—¶æ»šåŠ¨ */\n  max-height: 400px;\n  /* å¯æŒ‰éœ€è®¾ç½® */\n}\n\n/* å®šåˆ¶æ»šåŠ¨æ¡ (Webkitå†…æ ¸) */\n\n.mes_text .custom-details-divine-starmap > div::-webkit-scrollbar {\n  width: 10px;\n}\n\n.mes_text .custom-details-divine-starmap > div::-webkit-scrollbar-track {\n  background: rgba(245, 242, 233, 0.5);\n}\n\n.mes_text .custom-details-divine-starmap > div::-webkit-scrollbar-thumb {\n  background-color: #d4c09a;\n  border-radius: 5px;\n  border: 2px solid rgba(253, 252, 248, 0.85);\n}\n\n.mes_text .custom-details-divine-starmap > div::-webkit-scrollbar-thumb:hover {\n  background-color: #c8a76a;\n}</style>\n\n  <details class=\"custom-details-divine-starmap\">\n    <summary>\n      <span class=\"custom-icon-starmap\">\n        \n        <svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\"><path d=\"M12 1.5l2.48 5.72 5.92 1.28-4.5 4.14 1.4 6.06L12 15.4l-5.3 3.3 1.4-6.06-4.5-4.14 5.92-1.28L12 1.5z M12 8.5l-1.34 3.08-3.2 0.7 2.43 2.24-0.75 3.28L12 16.1l2.86 1.78-0.75-3.28 2.43-2.24-3.2-0.7L12 8.5z\"></path></svg>\n      </span>\n      å¤©æœºç½—ç›˜\n    </summary>\n    <div>\n      \n      **<q>ã€å¤©æ—¶ã€</q>**: ã€ä»™é€†çºªå…ƒ0014å¹´01æœˆ01æ—¥ - 09æ—¶00åˆ† - ä¸‹ç•Œ-å››åœ£æ˜ŸåŸŸ-æœ±é›€æ˜Ÿ-èµµå›½-è—¤å®¶åŸ - æ™¨é›¾ã€‘\n\n---\n\n<q>ã€å½“ä¸‹ã€</q>- æ±ä¹‹è¡Œ (U-)\n| å½“å‰äº‹ä»¶ | æ ¸å¿ƒç›®æ ‡ | çŠ¶æ€ | å½“å‰åœ°ç‚¹ |\n| :--- | :--- | :--- | :--- |\n| è·å¾—ä¿®ä»™æœºä¼š | å®Œæˆæåºœç®¡å®¶çš„è¦æ±‚ | â–¶ï¸è¿›è¡Œä¸­ | æœ±é›€æ˜Ÿ-èµµå›½-è—¤å®¶åŸ-æåºœ |\n\n<q>ã€ä¸–å±€ã€</q>- å››æµ·é£äº‘ (W-)\næ­¤ä¹ƒæ±è§†è§’ä¹‹å¤–çš„å¤©åœ°å˜è¿ï¼Œå…¶å› æœäº¦å°†æ±‡å…¥æ±ä¹‹å‘½è¿é•¿æ²³ã€‚\n| çºªäº‹ | çŠ¶æ€ | å‘ç”Ÿä¹‹å¹´ | å…³é”®äººç‰©/åŠ¿åŠ› | æ ¸å¿ƒåœ°ç‚¹ |\n| :--- | :--- | :--- | :--- | :--- |\n| W01: æ’å²³æ´¾æ”¶å¾’ | â³ æœªå‘ç”Ÿ | 14å¹´1æœˆ | ç‹æ— / æ’å²³æ´¾ | æœ±é›€æ˜Ÿ-èµµå›½-æ’å²³æ´¾ |\n| W02: å‘ç°å¤©é€†ç  | â³ æœªå‘ç”Ÿ | 14å¹´6æœˆ | ç‹æ— / é»„é¼ ç‹¼ | æœ±é›€æ˜Ÿ-èµµå›½-æ’å²³æ´¾ |\n| W03: å¼•æ°”å…¥ä½“ | â³ æœªå‘ç”Ÿ | 15å¹´ | ç‹æ— / å­™å¤§æŸ± | æœ±é›€æ˜Ÿ-èµµå›½-æ’å²³æ´¾ |\n| W04: æ–©æ€é»„é¼ ç‹¼ | â³ æœªå‘ç”Ÿ | 16å¹´2æœˆ | ç‹æ— / å¼ è™ | æœ±é›€æ˜Ÿ-èµµå›½-æ’å²³æ´¾ |\n| W05: åå±±é›†è®­ | â³ æœªå‘ç”Ÿ | 18å¹´ | ç‹æ— / å¸å¾’å— | æœ±é›€æ˜Ÿ-èµµå›½-æ’å²³æ´¾ |\n\nçºªäº‹è¯¦è¿°:\nW01-14å¹´1æœˆ: æ’å²³æ´¾æ‹›æ”¶å¼Ÿå­ï¼Œèµ„è´¨å¹³åº¸çš„ç‹æ—ï¼ˆå‡¡äººï¼‰ç”±å››å”è´¿èµ‚é•¿è€ï¼Œå¾—ä»¥æˆä¸ºè®°åå¼Ÿå­ã€‚\nW02-14å¹´6æœˆ: ç‹æ—é­æ‚å½¹è´Ÿè´£äººé»„é¼ ç‹¼ï¼ˆå‡æ°”äº”å±‚ï¼‰åˆéš¾ï¼Œä¸èˆå‹å¼ è™ï¼ˆå‡¡äººï¼‰äº¤å¥½ï¼Œå¹¶åœ¨æ‰“æ‚æ—¶å¶ç„¶å‘ç°å¤©é€†ç ã€‚\nW03-15å¹´: å­™å¤§æŸ±ï¼ˆå‡æ°”äº”å±‚ï¼‰ä¸ºå›¾è°‹çµæ¶²è‘«èŠ¦ï¼Œæ”¶ç‹æ—ä¸ºå¾’ã€‚ç‹æ—å€ŸåŠ©å¤©é€†ç ç©ºé—´å†…çš„çµæ¶²ï¼ŒæˆåŠŸå¼•æ°”å…¥ä½“ã€‚\nW04-16å¹´2æœˆ: å¼ è™ï¼ˆå‡æ°”ä¸€å±‚ï¼‰å› æ’ç ´é»„é¼ ç‹¼å—è´¿è€Œé­è¿½æ€ï¼Œåœ¨ç‹æ—ï¼ˆå‡æ°”ä¸€å±‚ï¼‰å¸®åŠ©ä¸‹åæ€å¯¹æ–¹åé€ƒç¦»ã€‚ç‹æ—æ¥æ›¿å…¶èŒä½ï¼Œè‹¦ä¿®è‡³å‡æ°”äºŒå±‚ã€‚\nW05-18å¹´: ç‹æ—åœ¨åå±±é›†è®­æœŸé—´ï¼Œäºå¤©é€†ç©ºé—´å†…ï¼Œå€ŸåŠ©çµæ¶²åŠå¸å¾’å—çš„æŒ‡å¯¼ä¿®ç‚¼è¿‘ä¸‰åå¹´ï¼Œä¿®ä¸ºè¾¾åˆ°å‡æ°”åå››å±‚ã€‚\n---\n**<q>ã€å˜æ•°ã€</q>**\næš‚æ— \n    </div>\n  </details>\n</div>\n<pre><code class=\"custom-html custom-language-html\">&lt;!DOCTYPE html&gt;\n&lt;html lang=\"zh-CN\"&gt;\n&lt;head&gt;\n  &lt;meta charset=\"UTF-8\" /&gt;\n  &lt;meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" /&gt;\n  &lt;meta name=\"color-scheme\" content=\"light dark\" /&gt;\n  &lt;title&gt;é€‰é¡¹ç¾åŒ– (CSSå›¾æ ‡åˆ‡æ¢)&lt;/title&gt;\n\n  &lt;style&gt;\n  /* å­—ä½“ */\n  @import url(\"https://fontsapi.zeoseven.com/7/main/result.css\");/* Zhuque Fangsong (technical preview) */\n  @import url(\"https://fontsapi.zeoseven.com/477/main/result.css\"); /* TsangerXWZ */\n\n  :root{\n    --outer-font: \"TsangerXWZ\",\"Microsoft YaHei\",sans-serif;\n    --container-width: 550px;\n    --border-radius: 16px;\n\n    /* æµ…è‰²ä¸»é¢˜ */\n    --paper-fallback-color:#faf8f3;\n    --text-color:rgba(35,45,60,.86);\n    --divider-color:rgba(120,130,140,.12);\n    --glow-color:rgba(255,205,120,.55);\n    --blend-color:#f4efe6;\n    --item-bg:rgba(255,255,255,.48);\n    --item-hover-bg:rgba(255,255,255,.7);\n    --item-border:rgba(160,165,170,.18);\n    --blend-opacity:.11;\n    --noise-opacity:.035;\n    --fiber-opacity:.06;\n    --base-shadow:0 10px 30px rgba(0,0,0,.08),0 5px 15px rgba(0,0,0,.05);\n    --hover-shadow:0 15px 40px rgba(100,180,220,.15),0 5px 20px rgba(100,180,220,.1);\n    --item-shadow:0 2px 8px rgba(0,0,0,.05);\n    --item-hover-shadow:0 6px 20px rgba(0,0,0,.1);\n    --transition-speed:.35s;\n    --collapse-speed:.6s;\n    --theme-change-speed:.8s;\n    --easing:cubic-bezier(.4,0,.2,1);\n    --paper-bg-image:url('https://i.postimg.cc/DZbjkx5J/meow.png');\n  }\n\n  /* æ·±è‰²ä¸»é¢˜ */\n  .post-it-container.dark-mode{\n    --paper-fallback-color:#1e232a;\n    --text-color:rgba(245,240,220,.93);\n    --divider-color:rgba(255,255,255,.09);\n    --glow-color:rgba(240,210,140,.55);\n    --blend-color:#181d23;\n    --item-bg:rgba(255,255,255,.06);\n    --item-hover-bg:rgba(255,255,255,.12);\n    --item-border:rgba(255,255,255,.1);\n    --blend-opacity:.24;\n    --noise-opacity:.032;\n    --fiber-opacity:.07;\n    --base-shadow:0 10px 40px rgba(0,0,0,.32),0 5px 20px rgba(0,0,0,.22);\n    --hover-shadow:0 15px 50px rgba(240,210,140,.10),0 5px 25px rgba(240,210,140,.06);\n    --item-shadow:0 2px 10px rgba(0,0,0,.22);\n    --item-hover-shadow:0 6px 25px rgba(100,230,230,.1);\n  }\n\n  body{\n    display: flex;\n    justify-content: center;\n    font-family:\"Zhuque Fangsong (technical preview)\",\"Microsoft YaHei\",sans-serif;\n    font-size:1.1em;line-height:1.6;color:var(--text-color);\n    transition:color var(--theme-change-speed) ease;\n  }\n\n  .post-it-container{\n    width:var(--container-width);\n    position:relative;margin:16px auto;padding:1em;padding-top:3.5em;\n    color:var(--text-color);\n    background-color:var(--paper-fallback-color);\n    background-image:var(--paper-bg-image);\n    background-position: left top;\n    background-repeat: repeat;\n    background-blend-mode:multiply;\n    border-radius:var(--border-radius);box-shadow:var(--base-shadow);\n    transition:transform var(--transition-speed) var(--easing),\n               box-shadow var(--transition-speed) var(--easing),\n               background-color var(--theme-change-speed) ease,\n               color var(--theme-change-speed) ease;\n    isolation:isolate;overflow:hidden;\n  }\n  .post-it-container.dark-mode{ background-blend-mode:soft-light; }\n\n  .post-it-container::before,\n  .post-it-container::after {\n    content:\"\"; position:absolute; inset:0; z-index:1; border-radius:inherit;\n    pointer-events:none;\n  }\n  .post-it-container::before{\n    background:\n      radial-gradient(120% 100% at 50% 0%, rgba(0,0,0,var(--fiber-opacity)) 0, rgba(0,0,0,0) 70%),\n      radial-gradient(90% 120% at 100% 20%, rgba(0,0,0,calc(var(--fiber-opacity) * .7)) 0, rgba(0,0,0,0) 65%),\n      linear-gradient(180deg, rgba(255,255,255,0) 0%, var(--blend-color) 100%);\n    opacity:var(--blend-opacity);\n    transition:background-color var(--theme-change-speed) ease,opacity var(--theme-change-speed) ease;\n  }\n  .post-it-container::after{\n    background-image:\n      repeating-linear-gradient(0deg,   rgba(0,0,0,.028) 0 1px, transparent 1px 2px),\n      repeating-linear-gradient(90deg,  rgba(0,0,0,.022) 0 1px, transparent 1px 2px);\n    opacity:var(--noise-opacity);\n  }\n\n  .cat-kaomoji{\n    position:absolute; top:20px; left:24px;\n    z-index: 2;\n    font-family:var(--outer-font);\n    font-size:16px; font-weight:600;\n    color:var(--text-color); opacity:.92;\n    text-shadow:0 1px 2px rgba(255,255,255,.22);\n    transition:transform var(--transition-speed) var(--easing),opacity var(--transition-speed) var(--easing);\n    pointer-events: none;\n  }\n  .post-it-container:hover .cat-kaomoji{opacity:1; transform:scale(1.03)}\n\n  .theme-icon{\n    position:absolute; top:8px; right:10px;\n    z-index: 2;\n    font-size:30px; line-height:1;\n    padding:6px; background:transparent; border:none; box-shadow:none; backdrop-filter:none;\n    color:inherit; cursor:pointer; user-select:none; -webkit-tap-highlight-color:transparent;\n    border-radius:8px;\n    transition:transform var(--transition-speed) var(--easing), filter var(--transition-speed) var(--easing);\n  }\n  .theme-icon:hover{ transform:scale(1.06); filter:drop-shadow(0 1px 1px rgba(0,0,0,.2)); }\n  .theme-icon:active{ transform:scale(.96); }\n  .theme-icon:focus-visible{ outline:2px solid rgba(255,215,0,.55); outline-offset:2px; }\n\n  /* --- æ–°å¢çš„ CSS è§„åˆ™ --- */\n  .theme-icon .icon-moon { display: none; }\n  .theme-icon .icon-sun { display: inline; }\n  .post-it-container.dark-mode .theme-icon .icon-sun { display: none; }\n  .post-it-container.dark-mode .theme-icon .icon-moon { display: inline; }\n  /* --- æ–°å¢ç»“æŸ --- */\n\n  .post-it-collapsible{\n    position: relative;\n    z-index: 2;\n    display:grid; grid-template-rows:0fr;\n    transition:grid-template-rows var(--collapse-speed) var(--easing);\n  }\n\n  .post-it-collapsible.open{grid-template-rows:1fr}\n  .content-wrapper{overflow:hidden; min-height:0; padding-top:1.2em; border-top:1px solid var(--divider-color); position:relative}\n  .content-wrapper::before{\n    content:\"\"; position:absolute; top:0; left:50%; transform:translateX(-50%);\n    width:50px; height:1px; background:linear-gradient(90deg,transparent,var(--glow-color),transparent); opacity:0; transition:opacity var(--transition-speed) ease;\n  }\n  .post-it-collapsible.open .content-wrapper::before{opacity:.6}\n  .post-it-collapsible.open .content-wrapper{overflow:visible; transition:overflow 0s linear var(--collapse-speed)}\n  #options-container{padding:.8em .5em; display:flex; flex-direction:column; gap:.6em}\n\n  .clickable-text{\n    cursor:pointer; padding:.85em 1.2em; border-radius:10px;\n    background:var(--item-bg); border:1px solid var(--item-border);\n    box-shadow:var(--item-shadow); backdrop-filter:blur(5px);\n    opacity:0; transform:translateX(-20px); pointer-events:none;\n    transition:transform var(--transition-speed) var(--easing),\n               box-shadow var(--transition-speed) var(--easing),\n               background-color var(--transition-speed) var(--easing),\n               border-color var(--transition-speed) var(--easing);\n    position:relative; overflow:hidden;\n  }\n  .clickable-text::before{\n    content:\"\"; position:absolute; top:0; left:-100%; width:100%; height:100%;\n    background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent); transition:left .6s ease;\n    pointer-events:none;\n  }\n  .clickable-text:hover::before{left:100%}\n  .clickable-text::after{\n    content:\"\"; position:absolute; left:var(--rx, 50%); top:var(--ry, 50%);\n    width:14px; height:14px; border-radius:50%;\n    background:radial-gradient(circle, rgba(255,202,120,.42) 0%, rgba(255,202,120,.25) 40%, rgba(255,202,120,0) 70%);\n    transform:translate(-50%,-50%) scale(0);\n    opacity:0; pointer-events:none;\n  }\n  .clickable-text.ripple::after{ opacity:1; animation:ripple .7s ease-out forwards; }\n  @keyframes ripple{ to{ transform:translate(-50%,-50%) scale(28); opacity:0; } }\n\n  .clickable-text.is-selected{\n    background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.6));\n    border-color:#ffcf6a;\n    box-shadow:0 10px 28px rgba(255,174,0,.26), var(--item-hover-shadow);\n    transform:translateX(8px) translateY(-2px) scale(1.015);\n  }\n  .clickable-text.is-selected li::before{ content:'âœ“'; color:#ffb23e; font-weight:700; }\n\n  .post-it-collapsible.open .clickable-text{opacity:1; transform:translateX(0); pointer-events:auto}\n  .post-it-collapsible.open .clickable-text:nth-child(1){transition-delay:.1s}\n  .post-it-collapsible.open .clickable-text:nth-child(2){transition-delay:.15s}\n  .post-it-collapsible.open .clickable-text:nth-child(3){transition-delay:.2s}\n  .post-it-collapsible.open .clickable-text:nth-child(4){transition-delay:.25s}\n  .post-it-collapsible.open .clickable-text:nth-child(5){transition-delay:.3s}\n\n  .clickable-text:hover{\n    background:var(--item-hover-bg);\n    box-shadow:var(--item-hover-shadow);\n    transform:translateX(8px) translateY(-2px);\n    border-color:var(--glow-color);\n  }\n  .clickable-text:active{ box-shadow:0 0 0 9999px rgba(0,0,0,.02) inset, var(--item-hover-shadow); }\n\n  .clickable-text li{\n    list-style:none; position:relative; padding-left:1.2em;\n    font-size:.95em; line-height:1.4;\n  }\n  .clickable-text li::before{\n    content:'â–¸'; position:absolute; left:0; color:var(--glow-color);\n    transition:transform var(--transition-speed) ease;\n  }\n  .clickable-text:hover li::before{ transform:translateX(4px); }\n\n  @media (prefers-reduced-motion:reduce){\n    *{animation-duration:.01ms !important; animation-iteration-count:1 !important; transition-duration:.01ms !important}\n  }\n  &lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n  &lt;div class=\"post-it-container\" id=\"post-it-card\"&gt;\n    &lt;div class=\"cat-kaomoji\"&gt;à¸…(^ãƒ»Ï‰ãƒ»^)à¸… ç‚¹å‡»é€‰æ‹©&lt;/div&gt;\n    &lt;!-- HTML ä¿®æ”¹å¤„ --&gt;\n    &lt;button id=\"theme-toggle\" class=\"theme-icon\" aria-label=\"åˆ‡æ¢ä¸»é¢˜\" title=\"åˆ‡æ¢ä¸»é¢˜\"&gt;\n      &lt;span class=\"icon-sun\"&gt;â˜€ï¸&lt;/span&gt;\n      &lt;span class=\"icon-moon\"&gt;ğŸŒ™&lt;/span&gt;\n    &lt;/button&gt;\n    &lt;div class=\"post-it-collapsible\" id=\"collapsible-content\"&gt;\n      &lt;div class=\"content-wrapper\"&gt;\n        &lt;div id=\"options-container\"&gt;&lt;/div&gt;\n      &lt;/div&gt;\n    &lt;/div&gt;\n  &lt;/div&gt;\n\n  &lt;div id=\"raw-options-data\" style=\"display:none\"&gt;&lt;details&gt;&lt;summary&gt;ğŸŠå‰§æƒ…åˆ†æ”¯&lt;/summary&gt;\n\nA.ç«‹åˆ»è¯¢é—®ä»»åŠ¡è¯¦æƒ…\nB.å°è¯•æ‹’ç»ä»»åŠ¡\nC.æå‡ºæ›´å¤šè¦æ±‚\n\n&lt;/details&gt;&lt;/div&gt;\n\n  &lt;script&gt;\n  document.addEventListener(\"DOMContentLoaded\", function(){\n    function init(){\n      const refs = { card: document.getElementById(\"post-it-card\"), themeToggle: document.getElementById(\"theme-toggle\"), collapsibleContent: document.getElementById(\"collapsible-content\"), optionsContainer: document.getElementById(\"options-container\"), rawData: document.getElementById(\"raw-options-data\") };\n      if(refs.card &amp;&amp; refs.rawData &amp;&amp; refs.optionsContainer){\n        renderOptions(refs.rawData, refs.optionsContainer);\n        setupTheme(refs.card, refs.themeToggle);\n        bindCollapsible(refs);\n      } else { console.error(\"åˆå§‹åŒ–å¤±è´¥ï¼šç¼ºå°‘å¿…è¦çš„DOMå…ƒç´ ã€‚\"); }\n    }\n\n    function renderOptions(rawNode, root){\n      const lines = rawNode.textContent.trim().split(/\\r?\\n/).filter(s=&gt;s.trim()!==\"\");\n      lines.forEach((line)=&gt;{\n        const text = line.trim().replace(/^[A-Z]\\.\\s*/i,\"\");\n        if(!text) return;\n        const item = document.createElement(\"div\");\n        item.className = \"clickable-text\";\n        item.setAttribute(\"data-action\", text);\n        item.innerHTML = `&lt;li&gt;${text}&lt;/li&gt;`;\n        item.addEventListener(\"click\", function(e){\n          e.stopPropagation();\n          const rect = this.getBoundingClientRect();\n          const x = e.clientX - rect.left;\n          const y = e.clientY - rect.top;\n          this.style.setProperty('--rx', x + 'px');\n          this.style.setProperty('--ry', y + 'px');\n          this.classList.remove('ripple'); void this.offsetWidth; this.classList.add('ripple');\n          this.classList.add('is-selected');\n          setTimeout(()=&gt;{ this.classList.remove('is-selected'); }, 700);\n          const payload = this.getAttribute(\"data-action\");\n          try {\n            const t = window.parent.document.querySelector(\"#send_textarea\");\n            const n = window.parent.triggerSlash;\n            if(t){\n              const v = t.value + payload;\n              if(n){ n(`/setinput ${v}`); }\n              else{ t.value = v; t.dispatchEvent(new Event(\"input\",{bubbles:true})); }\n            } else if(n){ n(`/setinput ${payload}`); }\n          } catch(err){ console.error(\"è®¾ç½®è¾“å…¥æ–‡æœ¬æ—¶å‡ºé”™:\", err); }\n        });\n        root.appendChild(item);\n      });\n    }\n\n    // --- JavaScript ä¿®æ”¹å¤„ ---\n    function setupTheme(card, btn){\n      const applyTheme = (mode) =&gt; {\n        card.classList.toggle(\"dark-mode\", mode === \"dark\");\n        localStorage.setItem(\"postItTheme\", mode);\n      };\n\n      btn.addEventListener(\"click\", (e)=&gt;{\n        e.stopPropagation();\n        const nextTheme = card.classList.contains(\"dark-mode\") ? \"light\" : \"dark\";\n        applyTheme(nextTheme);\n      });\n\n      const savedTheme = localStorage.getItem(\"postItTheme\") || \"light\";\n      applyTheme(savedTheme);\n    }\n    // --- ä¿®æ”¹ç»“æŸ ---\n\n    function bindCollapsible(refs){\n      const { card, collapsibleContent, themeToggle, optionsContainer } = refs;\n      card.addEventListener(\"click\", e =&gt; {\n        const exceptedElements = [themeToggle, ...optionsContainer.querySelectorAll(\".clickable-text\")];\n        const isClickOnException = exceptedElements.some(el =&gt; el &amp;&amp; el.contains(e.target));\n        if(!isClickOnException){ collapsibleContent.classList.toggle(\"open\"); }\n      });\n    }\n    init();\n  });\n  &lt;/script&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre>
